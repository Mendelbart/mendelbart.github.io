(()=>{var _t=Object.defineProperty;var Ce=(n,t,e)=>t in n?_t(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var V=(n,t)=>{for(var e in t)_t(n,e,{get:t[e],enumerable:!0})};var g=(n,t,e)=>Ce(n,typeof t!="symbol"?t+"":t,e);var h={};V(h,{extractKeys:()=>Fe,filter:()=>Le,filterKeys:()=>Ae,fromKeysValues:()=>Oe,map:()=>gt,mapKeyArrayToValues:()=>Te,mapKeys:()=>Pe,onlyKeys:()=>bt,subsetToBoolRecord:()=>Me,withoutKeys:()=>nt});var F={};V(F,{arraysEqual:()=>mt,avg:()=>ke,bisectLeft:()=>pt,cumSums:()=>ft,filterIndices:()=>st,full:()=>v,range:()=>A,rangeBetween:()=>O,sum:()=>j});function ft(n){return n.map((t=>e=>t+=e)(0))}function pt(n,t){let e=0,s=t.length,r;for(;e<s;)r=e+s>>1,t[r]<n?e=r+1:s=r;return e}function j(n){return n.reduce((t,e)=>t+e,0)}function ke(n){return n.length===0?(console.error("Cannot compute average of empty array."),0):j(n)/n.length}function mt(n,t){return n.length===t.length&&n.every((e,s)=>e===t[s])}function st(n,t){return Array.from(n.entries()).filter(([e,s])=>t(s,e,n)).map(([e,s])=>e)}function A(n,t,e=1){if(t==null&&(t=n,n=0),e===0)throw new Error("Range step cannot be 0.");let s=Math.ceil((t-n)/e);return s<=0?[]:v(s,r=>n+e*r)}function O(n,t){return n>t&&([n,t]=[t,n]),A(n,t+1)}function v(n,t){let e=new Array(n);for(let s=0;s<n;s++)e[s]=t(s,e);return e}function gt(n,t){return Object.fromEntries(Object.entries(n).map(([e,s],r)=>[e,t(s,e,r)]))}function Le(n,t){return Object.fromEntries(Object.entries(n).filter(([e,s],r)=>t(s,e,r)))}function Ae(n,t){return Object.entries(n).filter(([e,s],r)=>t(s,e,r)).map(([e,s])=>e)}function nt(n,t){typeof t=="string"&&(t=[t]);let e=Object.assign({},n);for(let s of t)delete e[s];return e}function Fe(n,t,e=!0){let s=t.map(r=>n[r]??null);return e&&s.push(nt(n,t)),s}function bt(n,t,e=!1){let s=new Set(t),r={};for(let[i,o]of Object.entries(n))s.has(i)?r[i]=o:e&&console.warn(`Filtered out key "${i}".`);return r}function Pe(n,t){return Object.fromEntries(Object.entries(n).map(([e,s])=>[t(e),s]))}function Te(n,t){return Object.fromEntries(n.map(e=>[e,t(e)]))}function Oe(n,t,e=!0){return e&&n.length>t.length&&console.warn("More keys than values."),Object.fromEntries(t.map((s,r)=>[n[r],s]))}function Me(n,t){if(n==="none")n=[];else if(n==="all")n=t;else if(typeof n=="string")throw new Error('Invalid subset string specifier - use "none" or "all".');if(Array.isArray(n)){let e=Object.fromEntries(t.map(s=>[s,!1]));for(let s of n)e[s]=!0;return e}return mt(Object.keys(n).sort(),t.sort())||(console.log(n,t),console.warn("Subset object keys don't match keys list."),console.log(Object.keys(n).sort(),t.sort())),Object.fromEntries(t.map(e=>[e,!!n[e]]))}var l={};V(l,{addClass:()=>Yt,appendChildren:()=>_e,button:()=>Ne,classIfElse:()=>W,classesToList:()=>wt,computeScaleToFit:()=>It,createElement:()=>Be,elementSize:()=>vt,forEachElement:()=>ot,getARIA:()=>Je,getTemplate:()=>yt,hide:()=>K,htmlToElement:()=>Re,htmlToElements:()=>$t,label:()=>je,registerTemplate:()=>Vt,registerTemplates:()=>Ht,removeClass:()=>qe,scaleAllToFit:()=>$e,scaleToFit:()=>Ve,setARIA:()=>Ye,setAttrOnKeys:()=>Ue,setAttrs:()=>Kt,setDefaultId:()=>zt,setOptions:()=>De,setSearchParams:()=>ze,setupPages:()=>We,show:()=>$,showPage:()=>rt,toggleShown:()=>St,transition:()=>xt,uniqueIdPrefix:()=>Wt});var Ut=0;window.hasTouch="ontouchstart"in window;var it={};function Ht(n){for(let[t,e]of Object.entries(n))Vt(t,e)}function Vt(n,t){n in it&&console.warn(`Overwriting existing template key ${n}.`);let e=document.createElement("TEMPLATE");typeof t=="string"?e.insertAdjacentHTML("beforeend",t):e.append(t),it[n]=e}function yt(n){return n in it||console.error("Unknown template key "+n),it[n].firstChild.cloneNode(!0)}Ht({buttonLabel:'<label class="button"></label>',buttonInput:'<input class="button-check form-input" autocomplete="off">'});function Ne(n,t,e=null,s=null){let r=yt("buttonInput"),i=yt("buttonLabel");return s??(s=Wt("button")+t),Kt(r,{type:n,value:t,id:s}),i.setAttribute("for",s),e&&(typeof e=="string"&&(e=document.createTextNode(e)),i.appendChild(e)),[r,i]}function je(n,t,e=null){let s=document.createElement("LABEL");return n instanceof Node&&(n=zt(n,e)),s.setAttribute("for",n),s.textContent=t,s}function $t(n){let t=document.createElement("TEMPLATE");return t.innerHTML=n,t.content.children}function Re(n){let t=$t(n);if(t.length!==1)throw new Error("HTML doesn't contain exactly one element.");return t[0]}function Be(n){let[t,...e]=n.split("."),[s,r]=t.split("#"),i=document.createElement(s);return r&&(i.id=r),i.classList.add(...e),i}function De(n,t,{selected:e=null,disabled:s=[],groups:r=[]}={}){e??(e=Object.keys(t)[0]);let i=gt(t,()=>!1),o=null;for(let{label:a,keys:c}of r){let u=document.createElement("OPTGROUP");u.label=a;for(let d of c){if(!(d in t)){console.warn(`Unknown grouped key ${d} in group ${a}.`);continue}u.append(Gt(d,t[d],e,s)),i[d]=!0}n.add(u),o||(o=u)}for(let[a,c]of Object.entries(t))i[a]||n.add(Gt(a,c,e,s),o)}function Gt(n,t,e,s){let r=document.createElement("OPTION");return r.value=n,r.textContent=t,e===n&&(r.selected="selected"),s.includes(n)&&(r.disabled="disabled"),r}function _e(n,t){for(let e of t)n.appendChild(e)}function Ue(n,t,e,s=""){if(t){typeof t=="string"&&(t=[t]);for(let r of t)n[r].setAttribute(e,s)}}var Ge=new Set(["allowfullscreen","alpha","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","shadowrootclonable","shadowrootcustomelementregistry","shadowrootdelegatesfocus","shadowrootserializable"]);function Kt(n,t){for(let[e,s]of Object.entries(t))Ge.has(e)?s?n.setAttribute(e,e):n.removeAttribute(e):e==="class"?Yt(n,s):n.setAttribute(e,s)}function Wt(n,t="_"){return Ut+=1,n+Ut+t}function zt(n,t){return n.hasAttribute("id")?(n.id=t,t):n.id}function ot(n,t){if(n)if(n instanceof Node)t(n);else for(let e of n)t(e)}function W(n,t,e,s=null){n||([e,s]=[s,e]),e=wt(e),s=wt(s),ot(t,r=>{r.classList.remove(...s),r.classList.add(...e)})}function Yt(n,t){W(!0,n,t)}function qe(n,t){W(!1,n,t)}function $(n,t="display"){ot(n,e=>{e.style.removeProperty(t)})}var He={display:"none",visibility:"hidden",opacity:"0"};function K(n,t="display"){ot(n,e=>{e.style.setProperty(t,He[t])})}function St(n,t,e=null,s="display"){n?(e&&K(e,s),$(t,s)):(K(t,s),e&&$(e,s))}function wt(n){return n??(n=[]),typeof n=="string"?n.split(" "):Array.from(n)}function vt(n,t="border-box",e=!1){let s=e?n.scrollWidth:n.clientWidth,r=e?n.scrollHeight:n.clientHeight,i=window.getComputedStyle(n),o=i.scale;return!o||o==="none"?o=1:o=parseFloat(o),t==="border-box"?(s+=o*(parseFloat(i.borderLeftWidth||0)+parseFloat(i.borderRightWidth||0)),r+=o*(parseFloat(i.borderTopWidth||0)+parseFloat(i.borderBottomWidth||0))):t==="content-box"?(s-=o*(parseFloat(i.paddingLeft||0)+parseFloat(i.paddingRight||0)),r-=o*(parseFloat(i.paddingTop||0)+parseFloat(i.paddingBottom||0))):t!=="padding-box"&&console.error("Invalid value for element size box, use padding-box, content-box or border-box."),[s,r]}function It(n,{container:t=null,dimension:e="width",elementBox:s="border-box",containerBox:r="content-box",grow:i=!1}={}){t??(t=n.parentElement);let[o,a]=vt(n,s,!0),[c,u]=vt(t,r),d=qt(o,c,i),m=qt(a,u,i);return["width","height","both"].includes(e)||(console.error("Invalid dimension, use 'width', 'height' or 'both'."),e="width"),e==="width"?d:e==="height"?m:Math.min(d,m)}function Ve(n,t={}){n.style.scale=It(n,t)}function $e(n,t={}){if(Array.isArray(n)||(n=Array.from(n)),n.length===0)return;let e=n.map(s=>It(s,t));e=Ke(e,t.maxScaleRatio??1/0);for(let[s,r]of n.entries())r.style.scale=e[s]}function Ke(n,t=1/0){if(t===1/0)return n;let e=Math.min(...n),s=Math.max(...n);if(e===0||s/e<=t)return n;let r=Math.log(t)/Math.log(s/e);return n.map(i=>(i/e)**r*e)}function qt(n,t,e=!1){if(n===0)return console.warn("getScale: Element's size is 0."),1;if(isNaN(n))return console.error("Element size is NaN."),1;if(isNaN(t))return console.error("Container size is NaN."),1;let s=t/n;return e?s:Math.min(s,1)}function We(n){rt(n.querySelector(".page-content"),n),n.querySelector(".pages-next-button").addEventListener("click",()=>xt(()=>rt(document.getElementById(n.dataset.openPage).nextElementSibling,n))),n.querySelector(".pages-back-button").addEventListener("click",()=>xt(()=>rt(document.getElementById(n.dataset.openPage).previousElementSibling,n)))}function rt(n,t=null){t??(t=n.closest(".pages-container")),K(t.querySelectorAll(".page-content")),K(t.querySelectorAll(".page-heading")),$(n),$(t.querySelector(`.page-heading[data-for="${n.id}"]`)),t.dataset.openPage=n.id,St(!!n.previousElementSibling,t.querySelector(".pages-back-button")),St(!!n.nextElementSibling,t.querySelector(".pages-next-button"),t.querySelector(".pages-finish-button")),n.nextElementSibling||t.querySelector(".pages-finish-button").focus()}function ze(n){let t=new URL(location),e=!1;for(let[s,r]of Object.entries(n)){let i=encodeURIComponent(r);t.searchParams.get(s)!==i&&(t.searchParams.set(s,i),e=!0)}e&&history.pushState({},"",t)}function xt(n,t=[]){document.startViewTransition?document.startViewTransition({update:()=>n(),types:t}):requestAnimationFrame(()=>n())}function Ye(n,t,e){n.setAttribute("aria-"+t,e)}function Je(n,t){return n.getAttribute("aria-"+t)}function Qe(n){let t=1779033703,e=3144134277,s=1013904242,r=2773480762;for(let i=0;i<n.length;i++){let o=n.charCodeAt(i);t=e^Math.imul(t^o,597399067),e=s^Math.imul(e^o,2869860233),s=r^Math.imul(s^o,951274213),r=t^Math.imul(r^o,2716044179)}return t=Math.imul(s^t>>>18,597399067),e=Math.imul(r^e>>>22,2869860233),s=Math.imul(t^s>>>17,951274213),r=Math.imul(e^r>>>19,2716044179),t^=e^s^r,e^=t,s^=t,r^=t,[t>>>0,e>>>0,s>>>0,r>>>0]}function Xe(n,t,e,s){return function(){n|=0,t|=0,e|=0,s|=0;let r=(n+t|0)+s|0;return s=s+1|0,n=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,e=e+r|0,(r>>>0)/4294967296}}function Ze(n){return Xe(...Qe(n))}var z=class{constructor(n=Math.random){this._rand=n}rand(n=null,t=null){return t===null?this._rand()*(n??1):(n??(n=0),this._rand()*(t-n)+n)}seed(n){this._rand=Ze(n)}randInt(n,t){return Math.floor(this.rand(n,t))}shuffle(n){for(let t=n.length;t>0;t--){let e=this.randInt(t);e!==t-1&&([n[t-1],n[e]]=[n[e],n[t-1]])}}randIndexFromWeights(n){let t=ft(n);return pt(this.rand(t[t.length-1]),t)}};var E={};V(E,{clearFont:()=>ee,getFontData:()=>os,loadFont:()=>Ct,loadFonts:()=>kt,setFont:()=>te,setFontProperties:()=>At,supportsStylesets:()=>Lt,supportsVariableFonts:()=>Zt});var Jt=[{family:"Noto Serif Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Hebrew",scale:1.25,shift:-.15,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Rashi Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900"}},{family:"Noto Serif",fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Japanese",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Serif Japanese",fallback:"serif",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Sans Arabic",scale:.94,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Kufi Arabic",variationSettings:{wght:"100 900"}},{family:"Noto Naskh Arabic",variationSettings:{wght:"400 700"}},{family:"Noto Sans Phoenician"},{family:"Junicode",fallback:"serif",variationSettings:{wght:"300 700",wdth:"100",ENLA:"0"},styleset:{"Early-English-futhorc":12,"Elder-futhark":13,"Younger-futhark":14,"Long-branch-to-short-twig":15,"Latin-to-Gothic":19}}];var B=Object.fromEntries(Jt.map(n=>[n.family,n])),es={display:"swap",weight:400,style:"normal"},at={},Et={family:"font-family",weight:"font-weight",scale:"--font-scale",shift:"--font-shift",styleset:"font-variant-alternates",letterSpacing:"--letter-spacing",lineHeight:"--line-height"},Qt=["shift","scale","letterSpacing"];function Ct(n){return n?typeof n=="object"?Ct(n.family):(n in at||(at[n]=ns(n),document.fonts.add(at[n])),at[n].load()):Promise.reject("No family given.")}function kt(n){return Promise.all(n.map(t=>Ct(t)))}function ss(n){let t=`/kadmos/assets/fonts/scripts/${n.replaceAll(" ","")}.woff2`,e=Zt()?"woff2-variations":"woff2";return`url("${t}") format("${e}")`}function Xt(){return"CSS"in window&&"supports"in CSS}function Lt(){return Xt()&&CSS.supports("font-variant-alternates","styleset(x)")}function Zt(){return Xt()&&CSS.supports("font-variation-settings","normal")}function ns(n){let t=Object.assign({},es,B[n]);if("styleset"in t&&Lt()&&(document.styleSheets[0].insertRule(`@font-feature-values "${n}" {@styleset {`+Object.entries(t.styleset).map(([e,s])=>`${e}: ${s};`).join("")+"}}"),delete t.styleset),"variationSettings"in t){let e=rs(t.variationSettings);delete t.variationSettings,Object.assign(t,e)}return new FontFace(n,t.url??ss(n),t)}function rs(n){let t={};return"wght"in n&&(t.weight=n.wght,n=nt(n,"wght")),Object.keys(n).length>0&&(t.variationSettings=Object.entries(n).map(([e,s])=>`"${e}" ${s}`).join(",")),t}function te(n,t,e=null){if(typeof t=="object")if("family"in t&&typeof t.family=="string"){te(n,t.family,t);return}else throw new Error("Need properties.family of type string if family argument is omitted.");if(!(t in B))throw new Error(`Unknown family ${t}.`);ee(n),as(n,t),At(n,is(e,t))}function is(n,t){let e=Object.assign({},n),s=B[t];return"shift"in s&&(e.shift=s.shift+(n.shift??0)),"scale"in s&&(e.scale=s.scale*(n.scale??1)),e}function os(n){return B[n]}function At(n,t){let e=!1;for(let[s,r]of Object.entries(t))if(s!=="family"){if(!(s in Et)){console.warn(`Unknown font property '${s}'`);continue}Qt.includes(s)&&(e=!0),s==="styleset"?"family"in t?ls(n,r,t.family):console.error("Cannot set styleset without knowing family."):n.style.setProperty(Et[s],r)}W(e,n,"font-transform")}function as(n,t){let e=B[t];n.style.fontFamily=t+", "+(e.fallback??"system-ui, sans-serif"),At(n,bt(e,Qt))}function ee(n){for(let t of Object.values(Et))n.style.removeProperty(t)}function ls(n,t,e){t=Array.isArray(t)?t:[t];let s=`styleset(${t.join(", ")})`;if(Lt())n.style.setProperty("font-variant-alternates",s);else{let i=t.map(o=>B[e].styleset[o]).map(o=>`"ss${o.toString().padStart(2,"0")}"`).join(", ");n.style.setProperty("font-feature-settings",i)}}var Y={};V(Y,{decodeBase64BoolArray:()=>us,decodeBase64Number:()=>ne,encodeBase64BoolArray:()=>cs,encodeBase64Number:()=>se});function cs(n){return re(hs(n))+"~"+se(n.length)}function us(n){let[t,e]=n.split("~");return ds(ie(t),ne(e))}function se(n){return re(fs(n))}function ne(n){return ps(ie(n))}function hs(n){let t=new Array(Math.ceil(n.length/6)),e;for(let s=0;s<t.length;s++){e=0;for(let r=0;r<6;r++)n[6*s+r]&&(e+=1<<r);t[s]=e}return t}function ds(n,t){if(Math.ceil(t/6)!==n.length)throw new Error("Lengths of base 64 values and resultant length don't match.");let e=new Array(t);for(let[s,r]of n.entries())for(let i=0;i<6;i++){let o=6*s+i;if(o>=t)break;e[o]=(r&1<<i)!==0}return e}function fs(n){let t=[];for(;n>0;)t.push(n&63),n>>=6;return t}function ps(n){let t=0;for(let[e,s]of n.entries())t+=s<<6*e;return t}function re(n){return String.fromCharCode(...n.map(t=>ms(t)))}function ie(n){let t=new Array(n.length);for(let e=0;e<n.length;e++)t[e]=gs(n.charCodeAt(e));return t}function ms(n){return n&=63,n<26?n+65:n<52?n+71:n<62?n+-5:n===62?45:95}function gs(n){if(n>=65&&n<91)return n-65;if(n>=97&&n<123)return n-97+26;if(n>=48&&n<58)return n-48+53;if(n===45)return 62;if(n===95)return 63;throw new Error("Unknown base 64 char code.")}var b=class{constructor(){this._funcs=new Set}push(...t){for(let e of t)this._funcs.add(e)}remove(t){this._funcs.delete(t)}call(...t){for(let e of this._funcs)e.call(...t)}clear(){this._funcs.clear()}};var y=class{constructor(){this.settings={},this.keys=[]}static createFrom(t,e=null){let s=new this;return s.put(t,e),s}put(t,e=null){e??(e=Object.keys(t));for(let s of e)this.add(s,t[s])}extend(t){this.put(t.settings,t.keys)}add(t,e,s="end",r=null){if(this.settings[t]=e,s==="end")this.keys.push(t);else{let i;s==="begin"?i=0:(i=this.keys.indexOf(r),s==="afterKey"?i++:s!=="beforeKey"&&console.error("Invalid insert setting insert position.")),this.keys.splice(i,0,t)}}remove(t){this.settings[t].remove(),delete this.settings[t]}removeAll(){for(let t of Object.values(this.settings))t.remove();this.settings={},this.keys=[]}replace(t,e){this.settings[t].node.replaceWith(e.node),this.settings[t].remove(),this.settings[t]=e}replaceSelf(t){this.removeAll(),this.put(t.settings)}getValues(){return h.map(this.settings,t=>t.value)}setValues(t){for(let[e,s]of Object.entries(t))this.settings[e].value=s}getValue(t){if(!(t in this.settings))throw new Error("Key not in settings collection.");return this.settings[t].value}getDefault(t,e=null){return t in this.settings?this.settings[t].value:e}getNode(t){return this.settings[t].node}getSetting(t){return this.settings[t]}nodeList(){return this.keys.map(t=>this.settings[t].node)}addUpdateListener(t,...e){if(typeof t=="function")for(let s of Object.values(this.settings))s.updateListeners.push(t,...e);else{typeof t=="string"&&(t=[t]);for(let s of t)this.settings[s].updateListeners.push(...e)}}},P=class{constructor(t){g(this,"node");g(this,"valueNode");g(this,"updateListeners");let e;if(this.constructor.isValueNode(t))e=t;else if(e=t.querySelector("input, textarea, select"),!this.constructor.isValueNode(e))throw new Error("Couldn't find element of type input, textarea or select.");this.node=l.createElement("div.setting.labeled-value-element"),this.node.append(t),this.valueNode=e,this.updateListeners=new b,this._onChange=this._onChange.bind(this),this.valueNode.addEventListener(this.constructor.updateEvent,this._onChange)}static createInput(t,e=null,s=null){let r=document.createElement("INPUT");r.type=t,s&&l.setAttrs(r,s);let i=new this(r);return e&&i.label(e),i}static createSelect(t,e={}){let s=document.createElement("select");l.setOptions(s,t,e);let r=l.createElement("div.styled-select");r.append(s);let i=new this(r);return e.id&&i.setId(e.id),e.label&&i.label(e.label),i}static isValueNode(t){let e=t.tagName;return e==="SELECT"||e==="TEXTAREA"||e==="INPUT"&&t.type!=="hidden"}isCheckbox(){return this.valueNode.tagName==="INPUT"&&this.valueNode.type==="checkbox"}get value(){return this.isCheckbox()?this.valueNode.checked:this.valueNode.value}set value(t){this.isCheckbox()?this.valueNode.checked=t:this.valueNode.value=t}_onChange(){this.updateListeners.call(this,this.value)}setDisabled(t){this.valueNode.disabled=t}setId(t={prefix:""}){let e=typeof t=="string"?t:this.constructor.generateId(t.prefix);this.valueNode.id=e;let s=this.node.querySelector("label");return s&&(s.htmlFor=e),e}static generateId(t=""){return"ve_"+t+this.idCount.toString().padStart(4,"0")}label(t){if(!t)return;let e=this.node.querySelector("label");e||(e=document.createElement("label"),this.valueNode.id||this.setId(),e.htmlFor=this.valueNode.id,this.node.prepend(e)),e.textContent=t}remove(){this.valueNode.removeEventListener(this.constructor.updateEvent,this._onChange),this.node.remove()}};g(P,"idCount",0),g(P,"updateEvent","change");l.registerTemplate("buttonGroupContainer",l.createElement("fieldset.button-group.setting"));var x=class{constructor(t,e,s=!1){g(this,"node");g(this,"inputs");this.node=t,this.updateListeners=new b,this.inputs=Object.fromEntries(Array.from(this.node.querySelectorAll("INPUT")).map(r=>[r.value,r])),this.exclusive=e,this.decheckable=s,this._onChange=this._onChange.bind(this),this.node.addEventListener("change",this._onChange)}static from(t,{exclusive:e=!1,name:s=null,checked:r=null,disabled:i=null,decheckable:o=!1,label:a=null}={}){Array.isArray(t)&&(t=Object.fromEntries(t.map(p=>[p,p])));let c=Object.keys(t),u=e?"radio":"checkbox";s??(s=this.generateName());let d=l.getTemplate("buttonGroupContainer");e&&(d.setAttribute("role","radiogroup"),typeof r=="string"&&(r=[r]),!o&&!r&&(r=[c[0]])),r=h.subsetToBoolRecord(r??"none",c),i=h.subsetToBoolRecord(i??"none",c);for(let[p,N]of Object.entries(t)){let[k,et]=l.button(u,p,N);k.name=e?s:`${s}_${p}`,k.disabled=i[p],k.checked=r[p],d.append(k,et)}e&&o&&d.addEventListener("click",p=>{p.target.tagName==="INPUT"&&p.target.checked&&(p.target.checked=!1)});let m=new this(d,e,o);return a&&m.label(a),m}static generateName(){return this.nameCount++,"buttongroup_"+this.nameCount.toString().padStart(4,"0")}_onChange(){this.updateListeners.call(this,this.value)}buttonCount(){return Object.keys(this.inputs).length}disableIfSingleButton(t=null){this.buttonCount()===1?(this.setDisabled(!0),t!==null&&(this.value=t?Object.keys(this.inputs):[])):this.setDisabled(!1)}get value(){if(this.exclusive){for(let t of Object.values(this.inputs))if(t.checked)return t.value;return null}return h.filterKeys(this.inputs,t=>t.checked)}set value(t){t=h.subsetToBoolRecord(t,Object.keys(this.inputs));for(let[e,s]of Object.entries(this.inputs))s.checked=t[e]}setDisabled(t){for(let e of Object.values(this.inputs))e.disabled=t}label(t){let e=document.createElement("LEGEND");e.textContent=t,this.node.prepend(e)}remove(){this.node.addEventListener("change",this._onChange),this.node.remove()}};g(x,"nameCount",0);l.registerTemplate("slider",`<div class="slider-container">
    <span class="range-min"></span><span class="range-value"></span><span class="range-max"></span>
    <input type="range" class="form-range">
</div>`);var R=class extends P{constructor(t,e,s){if(super(t),this.valueNode.tagName!=="INPUT"||this.valueNode.type!=="range")throw new Error("Couldn't find input type='range' element.");this.min=e,this.max=s,this.displayValue=this.displayValue.bind(this),this.updateProgress=this.updateProgress.bind(this),this.displayMinMax()}static create(t,e,s=null){let r=l.getTemplate("slider"),i=r.lastElementChild;i.min=t,i.max=e,i.setAttribute("step",1);let o=new this(r,t,e);return s!==null&&(o.value=s),o}_onChange(){super._onChange(),this.updateProgress(),this.displayValue()}updateProgress(){this.valueNode.style.setProperty("--range-progress",this.getProgress().toString())}getProgress(){return(this.value-this.min)/(this.max-this.min)}displayValue(){this.node.querySelector(".range-value").textContent=this.formatValue(this.value)}displayMinMax(){this.node.querySelector(".range-min").textContent=this.formatValue(this.min),this.node.querySelector(".range-max").textContent=this.formatValue(this.max)}isCheckbox(){return!1}set value(t){(this.min>t||this.max<t)&&console.warn("Slider value outside range."),super.value=t.toString(),this.displayValue(),this.updateProgress()}get value(){return parseFloat(this.valueNode.value)}formatValue(t){return(Math.round(t*100)/100).toString()}setMin(t){this.valueNode.value<t&&(this.valueNode.value=t,this._onChange()),this.min=t,this.valueNode.min=t,this.updateProgress(),this.displayMinMax()}setMax(t){this.valueNode.value>t&&(this.valueNode.value=t,this._onChange()),this.max=t,this.valueNode.max=t,this.updateProgress(),this.displayMinMax()}};g(R,"updateEvent","input");var lt=class{constructor(t){g(this,"_punishFactor",2);g(this,"_manualPunish",1);g(this,"_previousDampFactor",.5);this.items=t,this.rng=new z;let e=this.itemCount=t.length;this.hitCount=0,this.scores=new Array(e).fill(0),this.tries=new Array(e).fill(0),this.triesLeft=new Array(e).fill(1),this.totalTriesLeft=e,this.maxTriesLeft=e,this.currentIndex=this.rng.randInt(0,e),this.previousIndex=null}seed(t){this.rng.seed(t)}currentItem(){return this.items[this.currentIndex]}nextItem(){return this.previousIndex=this.currentIndex,this.currentIndex=this.rng.randIndexFromWeights(this.getWeights()),this.currentItem()}getWeights(){let t=this.triesLeft.slice();return this.previousIndex!==null&&(t[this.previousIndex]*=this._previousDampFactor),t}updateTotalTriesLeft(){let t=F.sum(this.triesLeft);t>this.totalTriesLeft&&(this.maxTriesLeft+=t-this.totalTriesLeft),this.totalTriesLeft=t}progress(){return 1-this.totalTriesLeft/this.maxTriesLeft}enterScore(t){let e=++this.tries[this.currentIndex];e===1&&this.hitCount++,this.scores[this.currentIndex]=Math.max(this.scores[this.currentIndex],t*this.scoreAtTryFactor(e)),this.triesLeft[this.currentIndex]+=this._triesBoost(t)-1,this.triesLeft[this.currentIndex]<=0&&(this.triesLeft[this.currentIndex]=0,this.itemCount--),this.updateTotalTriesLeft()}isEmpty(){return this.itemCount===0}_triesBoost(t){return this._punishFactor*(1-t)}scoreAtTryFactor(t){return 1/t}getItemIndex(t){return this.items.indexOf(t)}punish(t,e=1){this.triesLeft[t]+=this._manualPunish*e,this.updateTotalTriesLeft()}absoluteScore(){return F.sum(this.scores)}scoreString(t="ratio"){let e=this.absoluteScore(),s=`${ae(e,1,2)}/${this.hitCount}`,r=this.hitCount>0?oe(e/this.hitCount):oe(0);if(t==="ratio")return s;if(t==="percent")return r;if(t==="both")return`${s} (${r})`;console.error(`Unknown mode: ${t}`)}};function oe(n,t=0){return String(ae(n*100,t))+"%"}function ae(n,t=0,e=1){let s=Math.pow(10,t)*e;return Math.floor(n*s)/s}function J(n,t,e,s,r){return n<t||e<t?n>e?e+1:n+1:s===r?t:t+1}function Ft(n,t){if(n===t)return 0;if(n.length>t.length){let Ee=n;n=t,t=Ee}let e=n.length,s=t.length;for(;e>0&&n.charCodeAt(e-1)===t.charCodeAt(s-1);)e--,s--;let r=0;for(;r<e&&n.charCodeAt(r)===t.charCodeAt(r);)r++;if(e-=r,s-=r,e===0||s<3)return s;let i=0,o,a,c,u,d,m,p,N,k,et,Rt,Bt,L=new Array(2*e);for(o=0;o<e;o++)L[2*o]=o+1,L[2*o+1]=n.charCodeAt(r+o);let Dt=L.length-1;for(;i<s-3;)for(k=t.charCodeAt(r+(a=i)),et=t.charCodeAt(r+(c=i+1)),Rt=t.charCodeAt(r+(u=i+2)),Bt=t.charCodeAt(r+(d=i+3)),m=i+=4,o=0;o<Dt;o+=2)p=L[o],N=L[o+1],a=J(p,a,c,k,N),c=J(a,c,u,et,N),u=J(c,u,d,Rt,N),m=J(u,d,m,Bt,N),L[o]=m,d=u,u=c,c=a,a=p;for(;i<s;)for(k=t.charCodeAt(r+(a=i)),m=++i,o=0;o<Dt;o+=2)p=L[o],L[o]=m=J(p,a,m,k,L[o+1]),a=p;return m}var D=class{constructor(t,e,s,r){this.type=t,this.displayString=e,this.properties=s,this.form=r}},T=class{constructor(t,e){this.value=t,this.maxDist=e,this.displayString=typeof t=="string"?t:t.toString()}static fromData(t,e){let s=e.maxDist??0,r=e.type;if(r==="number")return new Pt(t,s,e.distanceMode??"linear");if(r==="string")return new ct(t,s,e.caseSensitive??!1,e.substitutions??{});if(r==="list"){let i,o={};return typeof t=="string"?i=t:("source"in t||console.error("Source of list property missing."),i=t.source,"alts"in t&&(o=t.alts)),new Q(i,s,o,e)}else console.error(`Unknown property type "${e.type}"`)}grade(t){let e=this.gradeSingle(t,this.value);return[e,t.length>0?[this.markGradedText(t,e)]:[],[this.markGradedText(this.displayString,e)]]}static passes(t){return t>=.5}gradeSingle(t,e){let s=this.distance(t,e);return s<=this.maxDist?this.maxDist===0?1:Math.pow(2,-s/this.maxDist):0}markGradedText(t,e){let s=document.createElement("SPAN");return s.dataset.correct=e===1?"true":e>0?"partially":"false",s.textContent=t,s}distance(t,e){console.error("Not implemented.")}},Pt=class extends T{constructor(t,e,s="linear"){let r,i;typeof t=="string"?(r=parseFloat(t),isNaN(r)&&console.error(`Invalid number property value "${t}"`),i=t):(r=t,i=t.toString()),s==="log"&&r===0&&console.error('Invalid value 0 for NumberProperty with distanceMode "log"'),super(r,e),this.displayString=i,this.distanceMode=s}distance(t,e){return this.distanceMode==="linear"?Math.abs(t-e):Math.abs(Math.log(t/e))}},ct=class extends T{constructor(t,e,s=!1,r={}){super(t,e),this.caseSensitive=s,this.substitutions=r}distance(t,e){return Ft(this.standardizeString(t),this.standardizeString(e))}standardizeString(t){t=t.trim();for(let[e,s]of Object.entries(this.substitutions))t=t.replaceAll(new RegExp(e,"g"),s);return t=t.normalize("NFKD").replaceAll(/\p{M}/gu,""),this.caseSensitive||(t=t.toLowerCase()),t}},Q=class extends ct{constructor(t,e,s={},{listMode:r="best",caseSensitive:i=!1,splitter:o="[,;/]",excludeFromList:a=["\\(.*?\\)"],substitutions:c={}}){t=t.trim(),super(t,e,i,c),this.splitter=o,this.values=this.constructor.getValues(t,e,this.splitter,a),s?this.alternatives=h.map(s,u=>typeof u=="string"?[u]:u):this.alternatives={},this.listMode=r}static getValues(t,e,s,r){let i=[new ut(t)];for(let o of[...r,s])i=i.map(a=>a.split(o)).flat().map(a=>a.trim()).filter(a=>a.end>a.start);return i.length===0&&console.warn("No values in list."),i}grade(t){let e=new ut(t).split(this.splitter).map(o=>o.trim()),s=new Array(e.length).fill(0),r=new Array(this.values.length).fill(0);for(let[o,a]of this.values.entries())for(let[c,u]of e.entries()){let d=this.gradeSingle(u.str,a.str);a.str in this.alternatives&&(d=Math.max(d,...this.alternatives[a.str].map(m=>this.gradeSingle(u.str,m)))),d>0&&(r[o]=Math.max(r[o],d),s[c]=Math.max(s[c],d))}return[this.listMode==="best"?Math.max(...r):F.avg(s),this.markSubStrings(e,s),this.markSubStrings(this.values,r)]}markSubStrings(t,e){if(t.length===0)return[];let s=t[0].source,r=[],i=0;for(let[o,a]of t.entries())i<a.start&&r.push(document.createTextNode(s.substring(i,a.start))),a.start<a.end&&(r.push(this.markGradedText(a.str,e[o])),i=a.end);return i<s.length&&r.push(document.createTextNode(s.substring(i))),r}},ut=class n{constructor(t,e=0,s=null){t instanceof n&&(e+=t.start,s===null?s=t.end:s+=t.start,t=t.source),s===null&&(s=t.length),this.source=t,this.str=t.substring(e,s),this.start=e,this.end=s}split(t,e=!1){let s=[],r=this.str.matchAll(t),i=0;for(let o of r)!e&&i===o.index||(s.push(new this.constructor(this,i,o.index)),i=o.index+o[0].length);return(e||i<this.end-this.start)&&s.push(new this.constructor(this,i)),s}trim(){let t=this.str.match(/^\s*/)[0].length,e=this.str.match(/\s*$/)[0].length;return t===0&&e===0?this:new this.constructor(this.source,this.start+t,this.end-e)}};l.registerTemplates({eval:`<div class="item-eval">
    <span class="submitted"></span><span class="solution"></span>
</div>`,symbolContainer:`<div class="symbol-container">
    <div class="symbol-display-container"><span class="symbol"></span></div>
    <div class="symbol-label-container"><span class="symbol-label"></span></div>
</div>`});var X=class{constructor(t,e,s,r,i=null){this.dataset=t,this.properties=s,this.language=r,this.dealer=new lt(e),this.onFinish=new b,this.variant=i,this.updateProgressBar(),this.onInputKeydown=this.onInputKeydown.bind(this),this._show=this._show.bind(this),this.loadAndUpdateSymbolFont=this.loadAndUpdateSymbolFont.bind(this)}static genericSettings(){return y.createFrom({seed:P.createInput("text","Seed (optional)",{id:"game-seed"})})}setup({defaultWeight:t=null}={}){return this.setupSymbolContainer(),this.setupInputs(),this.setupEvals(),document.getElementById("item-next-button").textContent="Next",this.setupFontSettings(t)}getInputMode(t){return t==="real"||t==="integer"?"numeric":"text"}setupSymbolContainer(){let t=document.querySelector("#symbol-current .symbol");t.classList.add("symbol-string"),t.setAttribute("lang",this.dataset.metadata.lang),t.setAttribute("dir",this.dataset.metadata.dir)}setupInputs(){this.inputs=h.mapKeyArrayToValues(this.properties,e=>{let s=document.createElement("INPUT");return l.setAttrs(s,{type:"text",inputmode:this.getInputMode(this.dataset.properties[e].type),placeholder:this.dataset.properties[e].label}),this.language&&this.language!=="default"&&s.setAttribute("lang",this.language),s});let t=document.getElementById("game-inputs");t.replaceChildren(...Object.values(this.inputs)),t.addEventListener("keydown",this.onInputKeydown)}onInputKeydown(t){let e=t.target.closest("INPUT");e&&(t.key==="Enter"?e.nextElementSibling?e.nextElementSibling.focus():document.getElementById("item-submit-button").focus():t.key==="Backspace"&&t.target.value===""&&e.previousElementSibling&&(e.previousElementSibling.focus(),t.preventDefault()))}setupEvals(){this.evals={};let t=document.getElementById("game-evals");for(let e of this.properties){let s=l.getTemplate("eval");this.evals[e]=s,t.append(s)}}updateSymbolWeight(t){document.querySelector("#game-symbols").style.setProperty("--symbol-weight",t.toString())}loadAndUpdateSymbolFont(t=null){return t??(t=this.fontSettings.getValue("family")),E.loadFont(this.dataset.getFont(t,this.variant)).then(()=>this.updateSymbolFontFamily(t)).catch(e=>console.error(e))}updateSymbolFontFamily(t){t??(t=this.fontSettings.getValue("family")),document.querySelectorAll("#game-symbols .symbol-string").forEach(e=>{this.setSymbolFont(e,t)}),this.updateSymbolWeightRange(t)}updateSymbolWeightRange(t){let e=this.dataset.getFont(t,this.variant).family,s=E.getFontData(e),r=this.fontSettings.getSetting("weight");if(s.variationSettings&&s.variationSettings.wght){let[i,o]=s.variationSettings.wght.split(" ").map(a=>parseInt(a,10));r.setMin(i),r.setMax(o),l.show(r.node)}else l.hide(r.node)}setupFontSettings(t){t??(t=500);let e=R.create(100,900,t);return e.label("Weight"),this.fontSettings=y.createFrom({family:this.dataset.fontFamilySetting(),weight:e}),document.querySelector("#font-settings").replaceChildren(...this.fontSettings.nodeList()),this.fontSettings.addUpdateListener("weight",this.updateSymbolWeight),this.fontSettings.addUpdateListener("family",()=>l.transition(this.loadAndUpdateSymbolFont)),this.updateSymbolWeight(t),this.loadAndUpdateSymbolFont()}setSymbolFont(t,e){E.setFont(t,this.dataset.getFont(e,this.variant))}setReferenceItems(t){this.referenceItems=t}seed(t){this.dealer.seed(t)}cleanup(){this.clearItemDisplay(),this.updateProgressBar(0),document.getElementById("game-inputs").removeEventListener("keydown",this.onInputKeydown),document.getElementById("game-inputs").replaceChildren(),document.getElementById("game-evals").replaceChildren()}finish(){setTimeout(()=>this.cleanup(),100),this.onFinish.call(this)}currentItem(){return this.dealer.currentItem()}submitRound(){let t=0,e=this.currentItem();for(let[s,r]of Object.entries(this.inputs)){let i=this.evals[s],o=e.properties[s],[a,c,u]=o.grade(r.value);if(t+=a,!T.passes(a)){let d=this.getReferenceItems(e.form,s,r.value);if(d.length>0){let m=this.referenceItemsNodes(d,s);document.getElementById("game-symbols").append(...m),this.updateSymbolFontFamily(this.fontSettings.getValue("family"));for(let p of m)this.scaleItemNodeContents(p);for(let p of d)this.dealer.punish(this.dealer.getItemIndex(p),1/d.length)}}i.querySelector(".submitted").replaceChildren(...c),i.querySelector(".solution").replaceChildren(...u),l.classIfElse(o instanceof Q&&o.listMode==="best",i,"best-mode")}t/=this.properties.length,this.dealer.enterScore(t),this.updateProgressBar(),this.dealer.isEmpty()&&(document.getElementById("item-next-button").textContent="Finish"),this.show("evals"),window.scrollY>0&&window.scrollTo({top:0,behavior:"smooth"})}getReferenceItems(t,e,s){if(!this.referenceItems)return[];let r=[];for(let[i,o]of this.referenceItems[t].entries()){let a=o.properties[e].grade(s)[0];T.passes(a)&&r.push([i,a])}return r.sort(([i,o],[a,c])=>c-o||i-a),r.length>0&&r[0][1]===1&&(r=r.filter(([i,o])=>o===1)),r.map(([i,o])=>this.referenceItems[t][i])}referenceItemsNodes(t,e){return t.map(s=>this.referenceItemNode(s,e))}referenceItemNode(t,e){let s=l.getTemplate("symbolContainer");return s.classList.add("symbol-reference"),s.querySelector(".symbol").classList.add("symbol-string"),this.updateItemNode(s,t,e,!1),s}updateItemNode(t,e,s=null,r=!0){s??(s=this.properties[0]),t.querySelector(".symbol").textContent=e.displayString,t.querySelector(".symbol-label").textContent=e.properties[s].displayString,r&&this.scaleItemNodeContents(t)}scaleItemNodeContents(t){l.scaleToFit(t.querySelector(".symbol")),l.scaleToFit(t.querySelector(".symbol-label"))}clearInputs(){for(let t of Object.values(this.inputs))t.value=""}show(t){this.shown=t,requestAnimationFrame(this._show)}_show(){l.toggleShown(this.shown==="inputs",[document.getElementById("game-inputs"),document.getElementById("item-submit-button")],[document.getElementById("game-evals"),document.getElementById("item-next-button")]),l.toggleShown(this.shown==="inputs",null,document.querySelector("#symbol-current .symbol-label"),"visibility"),this.shown==="inputs"?(document.querySelectorAll("#game-symbols .symbol-reference").forEach(t=>{t.remove()}),this.focus()):document.getElementById("item-next-button").focus()}updateProgressBar(t=null){t??(t=this.dealer.progress()),document.getElementById("progress-bar").style.setProperty("--progress",t)}newRound(){if(this.dealer.isEmpty()){this.finish();return}this.dealer.nextItem(),this.displayItem(this.currentItem()),this.clearInputs(),this.show("inputs")}focus(){this.inputs[this.properties[0]].focus({preventScroll:!0})}displayItem(t){this.updateItemNode(document.getElementById("symbol-current"),t)}clearItemDisplay(){document.querySelector("#symbol-current .symbol").textContent="",document.querySelector("#symbol-current .symbol-label").textContent=""}};var _={arabic:{name:"Arabic",file:"arabic.json"},elements:{name:"Atomic Elements",file:"elements.json"},cyrillic:{name:"Cyrillic",file:"cyrillic.json"},elder_futhark:{name:"Elder Futhark",file:"elder_futhark.json"},greek:{name:"Greek",file:"greek.json"},hebrew:{name:"Hebrew",file:"hebrew.json"},japanese:{name:"Japanese Kana",file:"japanese.json"},phoenician:{name:"Phoenician",file:"phoenician.json"},younger_futhark:{name:"Younger Futhark",file:"younger_futhark.json"}};function ht(n,t,e){let s=[],r=new Array(t).fill(!1);for(let[o,a]of n.entries()){if(a==="rest"){o!==n.length-1&&console.error("Can only have subset 'rest' at the end."),s.push(st(r,u=>!u));break}let c=[];for(let u of ys(a,e))if(c.push(u),u!=null){if(r[u])throw new Error(`Duplicate subset index ${u}.`);r[u]=!0}s.push(c)}let i=st(n,o=>!o);if(i.length!==0)throw new Error(`Not all indices were covered: missing ${i}.`);return s}function ys(n,t){if(typeof n=="string")return le(n,t);if(Number.isInteger(n))return[n];if(!Array.isArray(n)||n.some(e=>!Number.isInteger(e)))throw new Error("Invalid indices datatype: need string, number or number[].");return Ss(n)&&console.warn("Indices contain duplicates."),n}function Ss(n){return new Set(n).size!==n.length}function le(n,t){return[].concat(...n.split(/,\s*/g).map(e=>ws(e,t)))}function ws(n,t=parseInt){let e=n.split(":"),s=e.length;if(s.length===0||s.length>3)throw new Error("Invalid range, 2-3 numbers.");let r=e.map((i,o)=>{let a=s===3&&o===1?parseInt(i):t(i);if(!Number.isInteger(a))throw new Error(`Parsed non-integer index ${a}.`);return a});return s===1?r:A(r[0],r[s-1]+1,s===3?r[1]:1)}function ce(n,t){let e=new Array(t);for(let[s,r]of n.entries())for(let[i,o]of r.entries())e[o]=[s,i];return e}function ue(n,t){return!n||n.length===0?[]:[].concat(...n.split(/;\s*/g).map(e=>vs(e,t)))}function vs(n,t){if(n.charAt(0)!=="("||n.charAt(n.length-1)!==")")throw new Error("Invalid matrix range syntax: Need enclosing parentheses.");let e=n.substring(1,n.length-1).split("|");if(e.length!==2)throw new Error("Invalid matrix range syntax: Need (ROWS|COLUMNS)");return Tt(...e.map(s=>le(s,t)))}function Tt(n,t){let e=[];for(let s of n)for(let r of t)e.push([s,r]);return e}var Z=class{constructor(){this.sizes=new WeakMap,this.updateSize=this.updateSize.bind(this),this.updateListeners=new b,this.observer=new ResizeObserver(t=>{t.forEach(this.updateSize),this.updateListeners.call(this,t.map(e=>e.target))})}watch(t){for(let e of t)this.observer.observe(e)}unwatch(t){for(let e of t)this.observer.unobserve(e),this.sizes.has(e)&&this.sizes.delete(e)}updateSize(t){this.sizes.set(t.target,t.contentBoxSize[0])}getSize(t){return this.sizes.get(t)}teardown(){this.observer.disconnect(),this.updateListeners.clear()}},tt=class{constructor({watcher:t=null,uniformFactor:e=1/0,dimension:s="width"}={}){this.watcher=t??new Z,this.updateParents=this.updateParents.bind(this),this.watcher.updateListeners.push(this.updateParents.bind(this)),this.dimension=s,this.uniformFactor=e,this.scales=new Map,this.minScale=1/0,this.maxScale=-1/0,this.childrenFromParent=new WeakMap}fit(t){this._add(t),this.updateChildren(t)}_add(t){for(let e of t){let s=e.parentElement;this.childrenFromParent.has(s)||this.childrenFromParent.set(s,new Set),this.childrenFromParent.get(s).add(e)}this.watcher.watch(t.map(e=>e.parentElement))}updateParents(t){this.updateChildren(t.map(e=>Array.from(this.childrenFromParent.get(e))).flat())}updateChildren(t=null){let e=this.minScale,s=this.maxScale;if(t)for(let r of t)this._updateScale(r);else this.scales.forEach((r,i)=>{this._updateScale(i)});!t||(this.minScale!==e||this.maxScale!==s)&&(this.uniformityActive()||this.uniformityActive(e,s))?this._applyAllScales():this._applyScales(t)}uniformityActive(t=this.minScale,e=this.maxScale){return e/t>this.uniformFactor}_updateScale(t){let e=this.watcher.getSize(t.parentElement);if(!e)return;let s=xs(t,e,this.dimension);s!==null&&(this.scales.set(t,s),s>0&&s<this.minScale?this.minScale=s:s>this.maxScale&&(this.maxScale=s))}_applyScale(t,e=null){e??(e=this.scales.get(t)),t.style.scale=Math.min(e,this.minScale*this.uniformFactor)}_applyScales(t){for(let e of t)this._applyScale(e)}_applyAllScales(){for(let[t,e]of this.scales)this._applyScale(t,e)}teardown(){this.scales.clear(),this.watcher.updateListeners.remove(this.updateParents)}};function xs(n,t,e){if(!["width","height","both"].includes(e))throw new Error(`Invalid scale dimension ${e}.`);let s=1;if(e==="both"||e==="width"){let r=he(n.offsetWidth,t.inlineSize);if(r===null)return null;s=Math.min(s,r)}if(e==="both"||e==="height"){let r=he(n.offsetHeight,t.blockSize);if(r===null)return null;s=Math.min(s,r)}return s}function he(n,t,e=!1){if(n===0||isNaN(n)||isNaN(t))return null;let s=t/n;return e?s:Math.min(s,1)}var de=F.range,fe={buttonMinWidth:"--button-min-width",buttonMaxWidth:"--button-max-width",symbolSize:"--symbol-size",labelGap:"--label-gap",symbolMinWidth:"--symbol-min-width"},C=class{constructor(t){if(!Array.isArray(t))throw new Error("Invalid argument: SelectorBlock.items must be an array.");this.items=t,this.updateListeners=new b,this.bindListeners(),this.setupButtons()}bindListeners(){this.onButtonClick=this.onButtonClick.bind(this),this.onRangePointerDown=this.onRangePointerDown.bind(this),this.onRangePointerMove=this.onRangePointerMove.bind(this),this.onRangePointerUpCancel=this.onRangePointerUpCancel.bind(this)}setupButtons(){this.buttonIdPrefix=l.uniqueIdPrefix("selectorButton"),this.checked=new Array(this.items.length).fill(!0),this.buttons=de(this.items.length).map(t=>this.createButton(t))}createButton(t){let e=l.createElement("div.selector-button"),s=this.buttonIdPrefix+t.toString();return l.setAttrs(e,{id:s,role:"checkbox",tabindex:0,"aria-checked":this.checked[t],"aria-labelledby":s}),e.dataset.index=t.toString(),e}setupNode(){this.node=l.createElement("div.selector-block.selector-block-flex"),this.node.append(...this.buttons)}setupButtonWatcher(){this.buttonWatcher=new Z,this.buttonWatcher.watch(this.buttons)}setupContentFitter(){this.buttonWatcher||this.setupButtonWatcher(),this.contentFitter=new tt({watcher:this.buttonWatcher,uniformFactor:1.5,dimension:"width"}),this.contentFitter.fit(this.buttons.map(t=>t.querySelector(".selector-button-content")))}setupLabelFitter(){this.labelFitter=new tt({watcher:this.buttonWatcher,dimension:"width"}),this.labelFitter.fit(this.buttons.map(t=>t.querySelector(".selector-button-label")))}setupButtonContents(t){this.items.forEach((e,s)=>{let r=t(e,s);r.classList.add("selector-button-content"),this.buttons[s].prepend(r)})}labelButtons(t){for(let[e,s]of this.items.entries())this.labelButton(e,t(s,e));this.labelFitter||this.setupLabelFitter(),this.labelFitter.updateChildren()}labelButton(t,e){let s=this.buttons[t],r=s.querySelector(".selector-button-label");r||(r=l.createElement("span.selector-button-label"),s.append(r)),r.textContent=e}finishSetup(){this.setupNode(),this.setupListeners(),this.setupButtonWatcher(),this.setupContentFitter()}callUpdateListeners(){this.updateListeners.call(this,this.checked)}updateButtonContents(t){for(let[e,s]of this.buttons.entries())t(s.querySelector(".selector-button-content"),this.items[e],e);this.contentFitter.updateChildren()}applyStyle(t){"buttonWidth"in t&&(t.buttonMinWidth=t.buttonWidth,t.buttonMaxWidth=t.buttonWidth,delete t.buttonWidth);for(let[e,s]of Object.entries(t))e in fe||console.error(`Invalid selector block style property ${e}.`),this.node.style.setProperty(fe[e],s)}setARIAProperty(t,e){for(let[s,r]of this.buttons.entries())l.setARIA(r,t,e(this.items[s],s))}setChecked(t){this.items.forEach((e,s)=>this.setButtonChecked(s,t(e,s),{updateIfDisabled:!0,callUpdateListeners:!1}))}setDisabled(t){this.setARIAProperty("disabled",t)}getChecked(t=!1){return this.checked.map((e,s)=>e&&(t||!this.isDisabled(s)))}checkedCount(t=!1){return this.checked.reduce((e,s,r)=>s&&(t||!this.isDisabled(r))?e+1:e,0)}getCheckedItems(){return this.items.filter((t,e)=>this.checked[e])}getDisabled(){return this.buttons.map(t=>t.getAttribute("aria-disabled")==="true")}setButtonChecked(t,e,{updateIfDisabled:s=!1,callUpdateListeners:r=!0}={}){!s&&this.isDisabled(t)||(l.setARIA(this.buttons[t],"checked",e),this.checked[t]=e,r&&this.callUpdateListeners())}isChecked(t,e=!1){return this.checked[t]&&(e||!this.isDisabled(t))}isDisabled(t){return l.getARIA(this.buttons[t],"disabled")==="true"}allChecked(t,e=!1){return t.every(s=>!e&&this.isDisabled(s)||this.checked[s])}toggleItems(t,{updateIfDisabled:e=!1,callUpdateListeners:s=!0}={}){if(!t)return;let r=!this.allChecked(t);for(let i of t)this.setButtonChecked(i,r,{updateIfDisabled:e,callUpdateListeners:!1});s&&this.callUpdateListeners()}setupListeners(){this.node.addEventListener("click",this.onButtonClick),this.node.addEventListener("keypress",this.onButtonClick),this.resetRangeSelection(),this.node.addEventListener("pointerdown",this.onRangePointerDown)}removeListeners(){this.node.removeEventListener("click",this.onButtonClick),this.node.removeEventListener("keypress",this.onButtonClick),this.node.removeEventListener("pointerdown",this.onRangePointerDown),this.node.removeEventListener("pointermove",this.onRangePointerMove),this.removeRangeListeners()}rangeTargetIndex(t){let e=t.closest(".selector-button");return e?parseInt(e.dataset.index):null}onButtonClick(t){this.handleButtonClick(t),this.handleButtonDblClick(t)}handleButtonClick(t){if(t.type==="keypress"&&t.key!=="Enter")return;let e=t.target.closest(".selector-button, .selector-button-gap");if(e&&e.classList.contains("selector-button")){let s=e.dataset.index;this.setButtonChecked(s,!this.isChecked(s))}}handleButtonDblClick(t){let e=this.rangeTargetIndex(t.target);e!==null&&(t.type==="click"&&t.detail%2===0&&this.lastClickTargetIndex===e&&this.toggleItems(de(this.buttons.length),{updateIfDisabled:!0}),this.lastClickTargetIndex=e)}resetRangeSelection(){this.removeRangeListeners(),this.rangeIndices&&this.buttonsRemoveClass(this.rangeIndices,"active"),this.rangeIndices=null,this.rangeStartIndex=null,this.rangeStopIndex=null,this.isRangeSelecting=!1}onRangePointerMove(t){if(!this.isRangeSelecting)return;let e=document.elementFromPoint(t.clientX,t.clientY),s=this.rangeTargetIndex(e);s===null||this.rangeStopIndex===s||(this.rangeStartIndex??(this.rangeStartIndex=s),this.rangeStopIndex=s,this.updateRangeSelection())}onRangePointerDown(t){let e=this.rangeTargetIndex(t.target);e!==null&&(this.rangeStartIndex=e,this.rangeStopIndex=e,this.updateRangeSelection()),this.isRangeSelecting=!0,this.addRangeListeners()}onRangePointerUpCancel(t){this.isRangeSelecting&&(t.type==="pointerup"&&this.rangeIndices&&this.rangeStartIndex!==this.rangeStopIndex&&this.toggleItems(this.rangeIndices),this.resetRangeSelection())}updateRangeSelection(){this.rangeIndices&&this.buttonsRemoveClass(this.rangeIndices,"active"),this.rangeStartIndex!==null&&this.rangeStopIndex!==null?(this.rangeIndices=this.getRangeIndices(this.rangeStartIndex,this.rangeStopIndex),this.buttonsAddClass(this.rangeIndices,"active")):this.rangeIndices=null}getRangeIndices(t,e){return O(t,e)}addRangeListeners(){this.node.addEventListener("pointermove",this.onRangePointerMove),document.addEventListener("pointerup",this.onRangePointerUpCancel),document.addEventListener("pointercancel",this.onRangePointerUpCancel)}removeRangeListeners(){this.node.removeEventListener("pointermove",this.onRangePointerMove),document.removeEventListener("pointerup",this.onRangePointerUpCancel),document.removeEventListener("pointercancel",this.onRangePointerUpCancel)}buttonsRemoveClass(t,e){l.removeClass(this.buttonsFromIndices(t),e)}buttonsAddClass(t,e){l.addClass(this.buttonsFromIndices(t),e)}buttonsFromIndices(t){return t.map(e=>this.buttons[e])}teardown(){this.removeListeners(),this.buttonWatcher.teardown(),this.contentFitter.teardown(),this.labelFitter&&this.labelFitter.teardown()}};var U=class{constructor(t,e,s=null){this.items=t,this.subsets=ht(e,t.length),this.subsetsInverse=ce(this.subsets,t.length),this.blocks=this.subsets.map((r,i)=>{let o=r.map(a=>this.items[a]);return s?s(o,i):new C(o)}),this.updateListeners=new b,this._callUpdateListeners=this._callUpdateListeners.bind(this),this.blocks.forEach(r=>r.updateListeners.push(this._callUpdateListeners))}_callUpdateListeners(){this.updateListeners.call(this,this.getChecked())}_buttonCallback(t,e){this.blocks.forEach((s,r)=>{t(s,(i,o,a)=>e(i,o,this.subsets[r][a]))})}_itemCallback(t,e){this.blocks.forEach((s,r)=>{t(s,(i,o)=>e(i,this.subsets[r][o]))})}setupButtonContents(t){this._itemCallback((e,s)=>e.setupButtonContents(s),t)}_setupNode(){this.node=l.createElement("div.selector"),this.node.append(...this.blocks.map(t=>t.node))}finishSetup(){this.blocks.forEach(t=>t.finishSetup()),this._setupNode()}updateButtonContents(t){this._buttonCallback((e,s)=>e.updateButtonContents(s),t)}labelButtons(t){this._itemCallback((e,s)=>e.labelButtons(s),t)}setChecked(t){this._itemCallback((e,s)=>e.setChecked(s),t)}setDisabled(t){this._itemCallback((e,s)=>e.setDisabled(s),t)}getCheckedItems(){return[].concat(...this.blocks.map(t=>t.getCheckedItems()))}getChecked({includeDisabled:t=!1}={}){let e=this.blocks.map(s=>s.getChecked(t));return A(this.items.length).map(s=>{let[r,i]=this.subsetsInverse[s];return e[r][i]})}checkedCount(t=!1){return j(this.blocks.map(e=>e.checkedCount(t)))}getDisabled(){let t=this.blocks.map(e=>e.getDisabled());return A(this.items.length).map(e=>{let[s,r]=this.subsetsInverse[e];return t[s][r]})}isChecked(t){let[e,s]=this.subsetsInverse[t];return this.blocks[e].isChecked(s)}isDisabled(t){let[e,s]=this.subsetsInverse[t];return this.blocks[e].isDisabled(s)}applyStyle(t){this.blocks.forEach(e=>e.applyStyle(t))}teardown(){this.blocks.forEach(t=>t.teardown())}};var M=class{constructor(t,e,s){if(s||(s=new Array(t*e)),!Array.isArray(s)||s.length!==t*e)throw new Error("Need array of size n * m.");this.data=s,this.n=t,this.m=e}getIndex(t,e){return t*this.m+e}getColumnMajorIndex(t,e){return e*this.n+t}getCartesian(t){return[Math.floor(t/this.m),t%this.m]}getFromIndex(t){return this.get(...this.getCartesian(t))}getCartesianColumnMajor(t){return[t%this.n,Math.floor(t/this.n)]}rowToColumnMajor(t){return this.getColumnMajorIndex(...this.getCartesian(t))}columnToRowMajor(t){return this.getIndex(...this.getCartesianColumnMajor(t))}get(t,e){return this.data[this.getIndex(t,e)]}set(t,e,s){this.data[this.getIndex(t,e)]=s}fill(t){return this.data.fill(t),this}_assertValues(t,e){if(!t)return new Array(e);if(!Array.isArray(t))throw new Error("Row/column values must be array.");if(t.length!==e)throw new Error(`Row/column length ${t.length} and matrix dimension ${e} do not match.`);return t}spliceRow(t,e=0,s){s=this._assertValues(s,this.m),this.data.splice(t*this.m,e*this.m,...s),this.n+=1}spliceColumn(t,e=0,s){s=this._assertValues(s,this.n);for(let r=0;r<this.n;r++)this.data.splice(r*(this.m+1)+t,e,s[r]);this.m+=1}transpose(){let t=v(this.length,e=>{let[s,r]=this.getCartesian(e);return this.get(r,s)});return new this.constructor(this.m,this.n,t)}toRows(){return v(this.n,t=>v(this.m,e=>this.get(t,e)))}static fromRows(t){return new this(t.length,t[0].length,t.flat())}toString(){return this.toRows().toString()}map(t){return new this.constructor(this.n,this.m,this.data.map((e,s)=>t(e,...this.getCartesian(s))))}values(){return this.data}keys(){return v(this.length,t=>this.getCartesian(t))}keysColumnsFirst(){return v(this.length,t=>this.getCartesianColumnMajor(t))}entries(){return this.data.map((t,e)=>[this.getCartesian(e),t])}entriesColumnsFirst(){return v(this.length,t=>{let[e,s]=this.getCartesianColumnMajor(t);return[[e,s],this.get(e,s)]})}forEach(t){this.data.forEach((e,s)=>t(e,...this.getCartesian(s),this))}get length(){return this.n*this.m}copy(){return new this.constructor(this.n,this.m,this.data.slice())}getRow(t){return v(this.m,e=>this.get(t,e))}getColumn(t){return v(this.n,e=>this.get(e,t))}static full(t,e,s){let r=new this(t,e);for(let[i,o]of r.keys())r.set(i,o,s(i,o));return r}};var G=class extends C{createGap(t){return l.createElement(`span.selector-${t}-gap`)}generateGrid(t,e="rows"){let s=t.n,r=t.m;if(j(t.values())>this.items.length)throw Error(`Number of covered cells ${j(t.values())} exceeds number of items ${this.items.length}.`);let i=new M(s,r),o=0,a=e==="rows"?t.entries():t.entriesColumnsFirst();for(let[[c,u],d]of a)i.set(c,u,d?o:null),d&&(o+=1);this.setGrid(i)}setGrid(t){this.grid=t,this.setupGridElements()}setupGridElements(){this.elements=this.grid.map(t=>t==null?this.createGap("button"):this.buttons[t]),this.elements.forEach((t,e,s)=>{t.dataset.gridIndex=this.elements.getIndex(e,s)}),this.labelPositions=new Set}setupNode(){this.node=l.createElement("div.selector-block.selector-block-grid"),this.node.append(...this.elements.values()),this.setGridTemplateColumns()}setGridLabels(t,e,s="start"){let r=t==="row"?this.grid.n:this.grid.m;if(e.length!==r)throw new Error(`Number of labels ${e.length} and rows/columns ${r} don't match.`);if(s==="both"){this.setGridLabels(t,e,"start"),this.setGridLabels(t,e,"end");return}let i=e.map((c,u)=>c?this.createGridLabel(t,c,u):this.createGap("label")),o=t==="row"?"column":"row";this.labelPositions.has(o+"start")&&i.splice(0,0,this.createGap("label")),this.labelPositions.has(o+"end")&&i.push(this.createGap("label"));let a=this.labelPositions.has(t+s)?1:0;t==="row"?this.elements.spliceColumn(s==="end"?this.elements.m:0,a,i):this.elements.spliceRow(s==="end"?this.elements.n:0,a,i),this.labelPositions.add(t+s)}createGridLabel(t,e,s){let r=l.createElement(`span.grid-label.grid-${t}-label`);return r.setAttribute("tabindex",0),r.textContent=e,r.dataset[t]=s.toString(),r}setGridTemplateColumns(){let t=`repeat(${this.grid.m}, minmax(var(--button-min-width), var(--button-max-width)))`;this.labelPositions.has("rowstart")&&(t="auto "+t),this.labelPositions.has("rowend")&&(t+=" auto"),this.node.style.setProperty("grid-template-columns",t)}rangeTargetIndex(t){let e=t.closest(".selector-button, .selector-button-gap");return e?parseInt(e.dataset.gridIndex):null}setRangeMode(t){if(!["grid","walkRows","walkColumns"].includes(t))throw new Error(`Invalid range mode ${t}.`);this.rangeMode=t}getRangeIndices(t,e){return this.getGridRangeIndices(t,e).map(s=>this.grid.getFromIndex(s)).filter(s=>s!=null)}getGridRangeIndices(t,e){switch(this.rangeMode||"grid"){case"walkRows":return O(t,e);case"walkColumns":return O(...[t,e].map(a=>this.grid.rowToColumnMajor(a))).map(a=>this.grid.columnToRowMajor(a));case"grid":let[s,r]=this.grid.getCartesian(t),[i,o]=this.grid.getCartesian(e);return Tt(O(s,i),O(r,o)).map(([a,c])=>this.grid.getIndex(a,c))}}bindListeners(){super.bindListeners(),this.onLabelClick=this.onLabelClick.bind(this),this.onLabelPointerOverOut=this.onLabelPointerOverOut.bind(this),this.onLabelPointerUpCancel=this.onLabelPointerUpCancel.bind(this),this.onLabelPointerDown=this.onLabelPointerDown.bind(this)}setupListeners(){super.setupListeners(),this.node.addEventListener("click",this.onLabelClick),this.node.addEventListener("keypress",this.onLabelClick),this.node.addEventListener("pointerover",this.onLabelPointerOverOut),this.node.addEventListener("pointerout",this.onLabelPointerOverOut),this.node.addEventListener("pointerdown",this.onLabelPointerDown)}removeListeners(){super.removeListeners(),this.node.removeEventListener("click",this.onLabelClick),this.node.removeEventListener("keypress",this.onLabelClick),this.node.removeEventListener("pointerover",this.onLabelPointerOverOut),this.node.removeEventListener("pointerout",this.onLabelPointerOverOut),this.node.removeEventListener("pointerdown",this.onLabelPointerDown),this.removeDocumentLabelListeners()}getIndicesFromLabelEvent(t){let e=t.target.closest(".grid-label");return e?(e.classList.contains("grid-row-label")?this.grid.getRow(parseInt(e.dataset.row)):this.grid.getColumn(parseInt(e.dataset.column))).filter(r=>r!=null):void 0}onLabelClick(t){t.type==="keydown"&&t.key!=="Enter"||this.toggleItems(this.getIndicesFromLabelEvent(t))}onLabelPointerOverOut(t){let e=this.getIndicesFromLabelEvent(t);e&&(t.type==="pointerover"?this.buttonsAddClass(e,"hover"):this.buttonsRemoveClass(e,"hover"))}onLabelPointerDown(t){let e=this.getIndicesFromLabelEvent(t);e&&(this.buttonsAddClass(e,"active"),this.gridLabelActiveIndices=e,this.addDocumentLabelListeners())}onLabelPointerUpCancel(){let t=this.gridLabelActiveIndices;t&&this.buttonsRemoveClass(t,"active"),this.gridLabelActiveIndices=null,this.removeDocumentLabelListeners()}addDocumentLabelListeners(){document.addEventListener("pointerup",this.onLabelPointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onLabelPointerUpCancel,{once:!0})}removeDocumentLabelListeners(){document.removeEventListener("pointerup",this.onLabelPointerUpCancel),document.removeEventListener("pointercancel",this.onLabelPointerUpCancel)}};l.registerTemplate("headingElement",'<div class="heading-element"><span class="heading-element-number"></span><span class="heading-element-symbol"></span></div>');var Is="./json/datasets/",pe="greek",Es={gameHeading:"Kadmos",terms:{letter:"letter"},lang:"en",dir:"ltr"},me=["letter","letters"],Cs={data:{default:"Default"},exclusive:!1},ks={keys:["en"]},Ls={en:"English",de:"German"},q=class{constructor(t){var e;this.name=t.name,this.metadata=this.processMetadata(t.metadata),this.processFonts(t.fonts),this.gameConfig=t.game??{},this.forms=this.processForms(t.forms),this.properties=t.properties,this.selectorData=this.processSelectorData(t.selector),this.variants=this.processVariants(t.variants),this.languages=t.languages??ks,(e=this.languages).default??(e.default=this.languages.keys[0]),this.items=this.processItems(t.items)}static fetch(t){return t in _?t in this._cache?Promise.resolve(this._cache[t]):fetch(Is+_[t].file).then(e=>e.json()).then(e=>{let s=new this(e);return s.key=t,this._cache[t]=s,s}).catch(e=>console.error(e)):(console.error(`Invalid dataset key "${t}".`),null)}processSelectorData(t){return t??(t={}),t.blocks||(t.block??(t.block={}),t.block.indices="rest",t.blocks=[t.block],delete t.block),t}processMetadata(t){var e,s;return t=Object.assign({},Es,t),(e=t.terms).letter||(e.letter="letter"),(s=t.terms).letters||(s.letters=t.terms.letter+"s"),t}processForms(t){t??(t=Cs);for(let[e,s]of Object.entries(t.data))typeof s=="string"&&(t.data[e]={label:s});return t}processVariants(t){var e;if(!t||!t.data)return null;for(let[s,r]of Object.entries(t.data))typeof r=="string"&&(t.data[s]={label:r}),(e=t.data[s]).lang??(e.lang=s);return t}processItems({properties:t,data:e,symbolType:s="string"}){let r=new Array(e.length);for(let[i,o]of e.entries()){let a=this.processDisplayForms(o[0]),c;this.hasVariants()&&(c=this.processItemVariants(o[1]));let u=h.fromKeysValues(t,o.splice(this.hasVariants()?2:1),!1);r[i]=new Ot(s,a,u,c)}return r}processItemVariants(t){if(!t||t==="*")return Object.keys(this.variants.data);if(Array.isArray(t))return t;let e=t.substring(0,2)!=="*-";e||(t=t.substring(2));let s=h.map(this.variants.data,()=>!e);for(let r of t.split(","))if(r in this.variants.data)s[r]=e;else if(this.variants.groups&&r in this.variants.groups)for(let i of this.variants.groups[r])s[i]=e;return h.filterKeys(s,r=>r)}processDisplayForms(t){if(Object.keys(this.forms.data).length===1)return Array.isArray(t)&&(t=t[0]),Object.fromEntries([[Object.keys(this.forms.data)[0],t]]);if(typeof t=="string"&&(t=t.split("")),Array.isArray(t)){let e={},s=Object.keys(this.forms.data);for(let[r,i]of t.entries())i&&(e[s[r]]=i);return e}if(typeof t!="object")throw new Error("Invalid display format: need array or object.");return h.onlyKeys(t,Object.keys(this.forms.data),!0)}getGameSettings(t){let e={};return this.hasSetting("properties")&&(e.properties=this.propertySetting(t.properties)),this.hasSetting("language")&&(e.language=this.languageSetting(t.language)),y.createFrom(e)}getFilterSettings(t){let e={};return this.hasVariants()&&(e.variant=this.variantSetting(t.variant)),this.hasSetting("forms")&&(e.forms=this.formsSetting(t.forms)),y.createFrom(e)}propertySetting(t=null){return x.from(h.map(this.properties,e=>e.label),{label:"Properties",checked:t??h.map(this.properties,e=>!!e.active)})}languageSetting(t=null){return x.from(h.onlyKeys(Ls,this.languages.keys),{label:"Language",checked:t??this.languages.default,exclusive:!0})}ungroupedForms(){return h.filter(this.forms.data,t=>!("groupWith"in t))}formsSetting(t=null){if(!this.hasSetting("forms"))return null;let e=this.forms.label??(this.forms.exclusive?"Form":"Forms"),s=this.ungroupedForms();return x.from(h.map(s,r=>r.label),{label:e,exclusive:this.forms.exclusive,checked:t??h.map(s,r=>r.active??!this.forms.exclusive)})}variantSetting(t=null){let e=h.map(this.variants.data,r=>r.label);t||(t=this.variants.default||Object.keys(this.variants.data)[0]);let s=this.variants.setting?.label||"Variant";if(this.variants.setting?.type==="buttonGroup")return x.from(e,{label:s,exclusive:!0,checked:t});{let r=this.variants.groups?Object.values(this.variants.groups):[];return P.createSelect(e,{label:s,selected:t,groups:r})}}hasSetting(t){switch(t){case"properties":return Object.keys(this.properties).length>1;case"language":return this.languages.keys.length>1;case"variant":return this.hasVariants();case"forms":return Object.keys(this.ungroupedForms()).length>1;case"font-family":return Object.keys(this.fonts).length>1;default:throw new Error(`Invalid settings key ${t}.`)}}hasVariants(){return!!this.variants}getSelector(t){let e=this.createSelector();return this.setupSelectorButtons(e,t),e.finishSetup(),this.applySelectorFont(e,t),this.applySelectorStyles(e),e}createSelector(){let t=ht(this.selectorData.blocks.map(e=>e.indices),this.items.length,e=>parseInt(e)-1);return new U(this.items,t,(e,s)=>{let r=this.selectorData.blocks[s];if(r.grid){let i=new G(e);return this.setupSelectorGrid(i,r),r.rowLabels&&this.setupGridLabels(i,"row",r.rowLabels,r.rowLabelPosition),r.columnLabels&&this.setupGridLabels(i,"column",r.columnLabels,r.columnLabelPosition),r.rangeMode&&i.setRangeMode(r.rangeMode),i}else return new C(e)})}setupSelectorButtons(t,e){let s=this.getLang(e),r=this.getDir();t.setupButtonContents(i=>{let o=l.createElement("span.symbol-string");return o.append(...Object.values(i.getFormNodes())),s&&(o.lang=s),r&&(o.dir=r),o}),this.selectorData.label&&t.labelButtons(i=>i.getSelectorLabel(this.selectorData.label))}getLang(t=null){return t?this.variants.data[t].lang??t:this.metadata.lang}getDir(){return this.metadata.dir}applySelectorFont(t,e){let s=this.getSelectorDisplayFont(e);t.updateButtonContents(r=>{E.setFont(r,s)})}setupSelectorGrid(t,{dimensions:e,gaps:s,fillDirection:r="rows"}={}){let i=new M(...e).fill(!0);for(let[o,a]of ue(s,c=>parseInt(c)-1))i.set(o,a,!1);t.generateGrid(i,r)}setupGridLabels(t,e,s,r){typeof s=="string"&&(s=s.split("")),t.setGridLabels(e,s,r)}applySelectorStyles(t){t.node.dir=this.getDir(),this.selectorData.style&&t.applyStyle(this.selectorData.style),this.selectorData.blocks.forEach((e,s)=>{e.style&&t.blocks[s].applyStyle(e.style)})}applySettings(t,{forms:e,variant:s}){let r=this.getFormKeysFromSetting(e);t.updateButtonContents(o=>{o.querySelectorAll(".symbol-form").forEach(a=>{let c=r.includes(a.dataset.form);l.toggleShown(c,a)})});let i=this.getVariantItemIndices(s);t.setDisabled((o,a)=>!i.has(a)||o.getForms(r).length===0),this.applySelectorFont(t,s)}getVariantItemIndices(t){if(!t)return new Set(A(this.items.length));let e=new Set;return this.items.forEach((s,r)=>{s.variants.has(t)&&e.add(r)}),e}getFormKeysFromSetting(t){if(!t)return Object.keys(this.forms.data);typeof t=="string"&&(t=[t]);let e=t.slice();for(let[s,r]of Object.entries(this.forms.data))if("groupWith"in r&&t.includes(r.groupWith)){let i=e.indexOf(r.groupWith);i!==-1&&e.splice(i+1,0,s)}return e}getFont(t,e=null){return t?(typeof t=="string"&&(t={key:t}),"family"in t&&console.warn(`Found family property "${t.family}" in font: Will be overwritten!`),t.key??(t.key=this._defaultFontKey),t.key in this.fonts||(console.error(`Unknown font key "${t.key}".`),t.key=this._defaultFontKey),h.withoutKeys(Object.assign({},this.fonts[t.key],this.getVariantFontModification(t.key,e),t),["key","default","label"])):this.defaultFont()}getVariantFontModification(t,e){if(e){let s=this.variants.data[e].fonts;if(s&&t in s)return s[t]}return null}getSelectorDisplayFont(t){return this.getFont(this.selectorData.font,t)}processFonts(t){this.fonts=t;let e=Object.entries(t).find(([s,r])=>r.default);this._defaultFontKey=e?e[0]:Object.keys(t)[0]}defaultFont(){return this.fonts[this._defaultFontKey]}fontFamilySetting(t=null){let e=x.from(h.map(this.fonts,s=>s.label??s.family),{label:"Font",exclusive:!0,checked:t??this._defaultFontKey});return e.node.classList.add("font-family-setting"),e}getQuizItems(t,e,s,r=null){let i=[];for(let o of t){let a=o.getDisplayStrings(e),c=o.getItemProperties(s,this.properties,r);i.push(...Object.entries(a).map(([u,d])=>new D(o.type,d,c,u)))}return i}referencePropsData(){let t=Object.assign({},this.properties);for(let[e,s]of Object.entries(t))if("referenceMaxDist"in s){let r=Object.assign({},s);r.maxDist=s.referenceMaxDist,t[e]=r}return t}getReferenceItems(t,e=null){let s,r=this.referencePropsData();if(this.forms.exclusive){let i=this.items.map(o=>o.getItemProperties(t,r,e));return h.map(this.forms.data,(o,a)=>this.items.map((c,u)=>new D(c.type,c.getFormsDisplayString([a]),i[u],a)))}else return s=this.items.map(i=>new D(i.type,i.getFormsDisplayString(Object.keys(this.forms.data)),i.getItemProperties(t,r,e),"all")),h.map(this.forms.data,()=>s)}setupGameHeading(t,e){let s=this.metadata.gameHeading;if(E.setFont(t,this.getFont(s.font,e)),this.name==="Atomic Elements"){let r=document.createElement("div");r.classList.add("element-heading-container");let i=[];for(let[o,a]of[[19,"K"],[85,"At"],[42,"Mo"],[16,"S"]]){let c=l.getTemplate("headingElement");c.querySelector(".heading-element-symbol").textContent=a,c.querySelector(".heading-element-number").textContent=o,i.push(c)}r.replaceChildren(...i),t.replaceChildren(r)}else t.replaceChildren(s.string);t.setAttribute("lang",s.lang??this.metadata.lang),t.setAttribute("dir",s.dir??this.metadata.dir)}};g(q,"_cache",{});var Ot=class{constructor(t,e,s,r=null){this.type=t,this.displayForms=e,this.properties=s,this.variants=new Set(r)}getDisplayStrings(t){return h.onlyKeys(this.displayForms,t)}getItemProperties(t,e,s=null){let r={};for(let i of t){if(!(i in this.properties)){console.error(`Missing property key "${i}".`);continue}r[i]=this.properties[i]}if(s)for(let i of t){let o=i+"_"+s;this.properties[o]&&(r[i]=this.properties[o])}return h.map(r,(i,o)=>T.fromData(i,e[o]))}getFormNodes(t=null){return h.mapKeyArrayToValues(this.getForms(t),e=>this.getFormNode(e))}getFormNode(t){let e=l.createElement("span.symbol-form");return e.dataset.form=t,e.textContent=this.displayForms[t],e}getForms(t=null){return t?t.filter(e=>e in this.displayForms):Object.keys(this.displayForms)}getFormsDisplayString(t){return Object.values(this.getDisplayStrings(t)).join("")}countQuizItems(t){return t.reduce((e,s)=>s in this.displayForms?e+1:e,0)}getSelectorLabel({property:t=null,splitFirst:e=!0,splitter:s="[,;/]"}={}){let r=this.properties[t];return e?r.split(new RegExp(`s*(${s})s*`))[0]:r}};var S=null,f=null,I=new y,H=new y,Nt=new y,w=null,ge=null;function we(){As(),Ps(),Nt.replaceSelf(X.genericSettings()),document.getElementById("generic-game-settings").append(...Nt.nodeList()),window.addEventListener("popstate",()=>l.transition(Se)),Fs(),Se(!1)}function As(){document.getElementById("start-game-button").addEventListener("click",()=>l.transition(xe)),document.getElementById("stop-game-button").addEventListener("click",()=>{S.finish()}),document.getElementById("item-submit-button").addEventListener("click",()=>{l.transition(()=>{S.submitRound()},["game"])}),document.getElementById("item-next-button").addEventListener("click",()=>{l.transition(()=>{S.newRound()},["game"])})}function Fs(){let n=document.getElementById("datasetSelect");l.setOptions(n,h.map(_,t=>t.name)),n.addEventListener("change",t=>{let e=t.target.value;q.fetch(e).then(s=>l.transition(()=>ve(s))).catch(console.error)})}function jt(n){n||l.showPage(document.getElementById("game-filters")),l.toggleShown(n,[document.getElementById("game-container"),document.getElementById("stop-game-button"),document.getElementById("progress-bar")],[document.getElementById("new-game-settings")])}function Ps(){ge=y.createFrom({accentColor:Ms(),colorMode:Ns()}),document.querySelector("#page-settings .settings").replaceChildren(...ge.nodeList()),document.getElementById("open-settings-button").addEventListener("click",()=>{l.transition(Ts,["page-settings","ease-in"])}),document.getElementById("close-settings-button").addEventListener("click",()=>{l.transition(Os,["page-settings","ease-out"])})}function Ts(){l.show(document.getElementById("page-settings-container")),document.documentElement.style.overflowY="hidden"}function Os(){l.hide(document.getElementById("page-settings-container")),document.documentElement.style.removeProperty("overflow-y")}function Ms(){let n=window.localStorage.getItem("accentHue")||250;be(n);let t=R.create(0,360,n);return t.label("Accent Hue"),t.updateListeners.push(e=>be(e)),t.node.id="accentHueSlider",t}function be(n){document.documentElement.style.setProperty("--accent-hue",n),window.localStorage.setItem("accentHue",n)}function Ns(){let n=window.matchMedia("(prefers-color-scheme: dark)"),t=window.localStorage.getItem("colorMode")||(n.matches?"dark":"light");Mt(t);let e=x.from({dark:"Dark Mode",light:"Light Mode"},{label:"Color Mode",exclusive:!0,checked:t});return n.addEventListener("change",s=>{let r=s.matches?"dark":"light";e.value=[r],Mt(r)}),e.updateListeners.push(s=>l.transition(()=>Mt(s,{updateLocalStorage:!0}))),e}function Mt(n,{updateLocalStorage:t=!1}={}){if(n!=="dark"&&n!=="light")throw new Error(`Invalid color mode ${n}, use dark or light.`);l.classIfElse(n==="dark",document.documentElement,"dark-mode","light-mode"),t&&window.localStorage.setItem("colorMode",n)}function ve(n){f=n,l.setSearchParams({dataset:n.key}),js();let t=Gs(),e=f.metadata.gameHeading;return kt([f.getFont(e.font),f.getSelectorDisplayFont()]).then(()=>{Rs(),l.showPage(document.getElementById("game-filters")),Ds(t),f.setupGameHeading(document.querySelector("#game-heading h1"),I.getDefault("variant")),Bs(t)})}function js(){document.title=f?`${f.name} - Kadmos`:"Kadmos"}function Rs(){for(let n of me){let t=f.metadata.terms[n];document.querySelectorAll(".term-"+n).forEach(e=>{e.textContent=t})}}function Bs(n={}){w&&(w.teardown(),w.node.remove()),w=f.getSelector(),document.getElementById("dataset-filter-settings").append(w.node),n.checked&&w.setChecked((t,e)=>n.checked[e]),f.applySettings(w,I.getValues()),w.updateListeners.push(ye,dt),ye()}function Ds(n){I.replaceSelf(f.getFilterSettings(n)),H.replaceSelf(f.getGameSettings(n)),I.addUpdateListener(dt),H.addUpdateListener(dt),I.addUpdateListener(()=>l.transition(()=>{f.applySettings(w,I.getValues())})),f.hasVariants()&&I.addUpdateListener("variant",t=>{f.setupGameHeading(document.querySelector("#game-heading h1"),t)}),document.getElementById("dataset-filter-settings").replaceChildren(...I.nodeList()),document.getElementById("dataset-game-settings").replaceChildren(...H.nodeList())}function _s(){return f.hasSetting("forms")?f.getFormKeysFromSetting(I.getValue("forms")):Object.keys(f.forms.data)}function Us(){return H.getDefault("properties",Object.keys(f.properties))}function ye(){document.querySelector("#game-settings-pages .pages-next-button").disabled=w.checkedCount()===0}function xe(){S&&S.cleanup(),dt();let n=Us(),t=H.getDefault("language",null),e=f.getQuizItems(w.getCheckedItems(),_s(),n,t),s=f.getReferenceItems(n,t),r=f.hasVariants()?I.getValue("variant"):null;S=new X(f,e,n,t,r);let i=Nt.getValue("seed");i&&S.seed(i),S.setReferenceItems(s),S.onFinish.push(()=>{jt(!1)}),S.setup({defaultWeight:f.gameConfig.defaultWeight}).then(()=>{jt(!0),S.newRound(),S.focus()}).catch(o=>console.error(o))}function Se(){let n=new URLSearchParams(location.search),t=n.get("dataset");(!t||!(t in _))&&(t=pe),document.getElementById("datasetSelect").value=t,q.fetch(t).then(e=>ve(e)).then(()=>{["1","true"].includes(n.get("play"))?xe():jt(!1)})}function Ie(n){return"settings_"+(n||f.key)}function dt(){l.setSearchParams({dataset:f.key});let n=Object.assign({checked:Y.encodeBase64BoolArray(w.getChecked({includeDisabled:!0}))},I.getValues(),H.getValues());window.localStorage.setItem(Ie(),JSON.stringify(n))}function Gs(){let n=window.localStorage.getItem(Ie());if(!n)return{};try{let t=JSON.parse(n);return typeof t.checked=="string"&&(t.checked=Y.decodeBase64BoolArray(t.checked)),t}catch(t){return console.error(t),{}}}(function(){qs(),l.transition(we),document.querySelectorAll(".ribbon").forEach(n=>{Hs(n,n.classList.contains("ribbon-closable"))}),document.querySelectorAll(".pages-container").forEach(n=>{l.setupPages(n)})})();function qs(){let n=new URLSearchParams(location.search);["1","true"].includes(n.get("darkmode"))?document.documentElement.classList.add("dark-mode"):["1","true"].includes(n.get("lightmode"))&&document.documentElement.classList.add("light-mode")}function Hs(n,t=!1){let e=n.querySelector(".ribbon-contents"),s=n.querySelectorAll(".ribbon-buttons input[type=checkbox]");n.dataset.closable=t.toString();let r=n.dataset.openId;if(!r){for(let i of s)if(i.checked){r=i.dataset.contentId;break}}l.hide(e.querySelectorAll(".ribbon-content")),!r&&!t&&(r=s[0].dataset.contentId,s[0].checked=!0),r?l.show([document.getElementById(r),e]):t&&n.classList.add("contents-hidden"),n.querySelector(".ribbon-buttons").addEventListener("change",Vs)}function Vs(n){l.transition(()=>{let t=n.target,e=t.closest(".ribbon"),s=e.querySelector(".ribbon-contents");if(t.checked){let r=e.dataset.openId;!e.classList.contains("contents-hidden")&&r&&(l.hide(document.getElementById(r)),e.querySelector(`.ribbon-buttons input[data-content-id="${r}"]`).checked=!1),e.dataset.openId=t.dataset.contentId,l.show([document.getElementById(t.dataset.contentId),s]),e.classList.remove("contents-hidden")}else e.dataset.closable==="true"?(e.classList.add("contents-hidden"),l.hide(s),e.dataset.openId=""):t.checked=!0})}})();
//# sourceMappingURL=index.js.map
