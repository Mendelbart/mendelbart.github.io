(()=>{var at=Object.defineProperty;var P=(s,e)=>{for(var t in e)at(s,t,{get:e[t],enumerable:!0})};var h={};P(h,{extractKeys:()=>mt,filter:()=>dt,filterKeys:()=>ht,map:()=>oe,mapKeyArrayToValues:()=>pt,mapKeys:()=>ft,onlyKeys:()=>ae,subsetToBoolRecord:()=>gt,withoutKeys:()=>W});var b={};P(b,{arraysEqual:()=>ie,avg:()=>lt,bisectLeft:()=>re,cumSums:()=>se,filterIndices:()=>ct,range:()=>ut,sum:()=>ke});function se(s){return s.map((e=>t=>e+=t)(0))}function re(s,e){let t=0,n=e.length,r;for(;t<n;)r=t+n>>1,e[r]<s?t=r+1:n=r;return t}function ke(s){return s.reduce((e,t)=>e+t,0)}function lt(s){return s.length===0?(console.error("Cannot compute average of empty array."),0):ke(s)/s.length}function ie(s,e){return s.length===e.length&&s.every((t,n)=>t===e[n])}function ct(s,e){return Array.from(s.entries()).filter(([t,n])=>e(n,t,s)).map(([t,n])=>t)}function ut(s,e=null,t=1){e===null&&(e=s,s=0);let n=Math.ceil((e-s)/t);return new Array(n).fill(0).map((r,i)=>s+t*i)}function oe(s,e){return Object.fromEntries(Object.entries(s).map(([t,n],r)=>[t,e(n,t,r)]))}function dt(s,e){return Object.fromEntries(Object.entries(s).filter(([t,n],r)=>e(n,t,r)))}function ht(s,e){return Object.entries(s).filter(([t,n],r)=>e(n,t,r)).map(([t,n])=>t)}function W(s,e){typeof e=="string"&&(e=[e]);let t=Object.assign({},s);for(let n of e)delete t[n];return t}function mt(s,e,t=!0){let n=e.map(r=>s[r]??null);return t&&n.push(W(s,e)),n}function ae(s,e,t=!1){let n=new Set(e),r={};for(let[i,o]of Object.entries(s))n.has(i)?r[i]=o:t&&console.warn(`Filtered out key "${i}".`);return r}function ft(s,e){return Object.fromEntries(Object.entries(s).map(([t,n])=>[e(t),n]))}function pt(s,e){return Object.fromEntries(s.map(t=>[t,e(t)]))}function gt(s,e){if(s==="none")s=[];else if(s==="all")s=e;else if(typeof s=="string")throw new Error('Invalid subset string specifier - use "none" or "all".');if(Array.isArray(s)){let t=Object.fromEntries(e.map(n=>[n,!1]));for(let n of s)t[n]=!0;return t}return ie(Object.keys(s).sort(),e.sort())||(console.log(s,e),console.warn("Subset object keys don't match keys list."),console.log(Object.keys(s).sort(),e.sort())),Object.fromEntries(e.map(t=>[t,!!s[t]]))}var l={};P(l,{addClass:()=>qe,appendChildren:()=>Dt,batchUpdate:()=>jt,button:()=>kt,classIfElse:()=>M,classesToList:()=>me,computeScaleToFit:()=>pe,createElement:()=>Ct,elementSize:()=>fe,forEachElement:()=>Q,getTemplate:()=>de,hide:()=>j,htmlToElement:()=>Bt,htmlToElements:()=>Re,label:()=>At,log:()=>_t,printError:()=>Rt,registerTemplate:()=>je,registerTemplates:()=>Ne,removeClass:()=>Ot,scaleAllToFit:()=>Nt,scaleToFit:()=>Mt,setAttrOnKeys:()=>Pt,setAttrs:()=>_e,setDefaultId:()=>Ue,setOptions:()=>Ft,setSearchParams:()=>qt,setupPages:()=>Ht,show:()=>N,showPage:()=>z,toggleShown:()=>he,uniqueIdPrefix:()=>He,updateDOM:()=>Kt});var y={};P(y,{clearFont:()=>Pe,getFontData:()=>It,loadFont:()=>Ce,loadFonts:()=>T,setFont:()=>xt,setFontProperties:()=>ue,supportsStylesets:()=>ce,supportsVariableFonts:()=>De});var Ae=[{family:"Noto Serif Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Hebrew",scale:1.25,shift:-.15,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Rashi Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900"}},{family:"Noto Serif",fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Japanese",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Serif Japanese",fallback:"serif",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Sans Arabic",scale:.94,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Kufi Arabic",variationSettings:{wght:"100 900"}},{family:"Noto Naskh Arabic",variationSettings:{wght:"400 700"}},{family:"Noto Sans Phoenician"},{family:"Junicode",fallback:"serif",variationSettings:{wght:"300 700",wdth:"100",ENLA:"0"},styleset:{"Early-English-futhorc":12,"Elder-futhark":13,"Younger-futhark":14,"Long-branch-to-short-twig":15,"Latin-to-Gothic":19}}];var O=Object.fromEntries(Ae.map(s=>[s.family,s])),yt={display:"swap",weight:400,style:"normal"},$={},le={family:"font-family",weight:"font-weight",scale:"--font-scale",shift:"--font-shift",styleset:"font-variant-alternates",letterSpacing:"--letter-spacing",lineHeight:"--line-height"},Be=["shift","scale","letterSpacing"];function Ce(s){return s?(s in $||($[s]=St(s),document.fonts.add($[s])),$[s].load()):Promise.reject("No family given.")}function T(s){return Promise.all(s.map(e=>Ce(e)))}function vt(s){let e=`/kadmos/assets/fonts/${s.replaceAll(" ","")}.woff2`,t=De()?"woff2-variations":"woff2";return`url("${e}") format("${t}")`}function Fe(){return"CSS"in window&&"supports"in CSS}function ce(){return Fe()&&CSS.supports("font-variant-alternates","styleset(x)")}function De(){return Fe()&&CSS.supports("font-variation-settings","normal")}function St(s){let e=Object.assign({},yt,O[s]);if("styleset"in e&&ce()&&(document.styleSheets[0].insertRule(`@font-feature-values "${s}" {@styleset {`+Object.entries(e.styleset).map(([t,n])=>`${t}: ${n};`).join("")+"}}"),delete e.styleset),"variationSettings"in e){let t=wt(e.variationSettings);delete e.variationSettings,Object.assign(e,t)}return new FontFace(s,e.url??vt(s),e)}function wt(s){let e={};return"wght"in s&&(e.weight=s.wght,s=W(s,"wght")),Object.keys(s).length>0&&(e.variationSettings=Object.entries(s).map(([t,n])=>`"${t}" ${n}`).join(",")),e}function xt(s,e,t={}){Pe(s),Et(s,e);let n=Object.assign({},t),r=O[e];"shift"in r&&(n.shift=r.shift+(t.shift??0)),"scale"in r&&(n.scale=r.scale*(t.scale??1)),ue(s,n)}function It(s){return O[s]}function ue(s,e){let t=!1;for(let[n,r]of Object.entries(e))if(n!=="family"){if(!(n in le)){console.warn(`Unknown font property '${n}'`);continue}Be.includes(n)&&(t=!0),n==="styleset"?"family"in e?Lt(s,r,e.family):console.error("Cannot set styleset without knowing family."):s.style.setProperty(le[n],r)}M(t,s,"font-transform")}function Et(s,e){let t=O[e];s.style.fontFamily=e+", "+(t.fallback??"system-ui, sans-serif"),ue(s,ae(t,Be))}function Pe(s){for(let e of Object.values(le))s.style.removeProperty(e)}function Lt(s,e,t){e=Array.isArray(e)?e:[e];let n=`styleset(${e.join(", ")})`;if(ce())s.style.setProperty("font-variant-alternates",n);else{let i=e.map(o=>O[t].styleset[o]).map(o=>`"ss${o.toString().padStart(2,"0")}"`).join(", ");s.style.setProperty("font-feature-settings",i)}}var Oe=0;window.hasTouch="ontouchstart"in window;var Y={};function Ne(s){for(let[e,t]of Object.entries(s))je(e,t)}function je(s,e){s in Y&&console.warn(`Overwriting existing template key ${s}.`);let t=document.createElement("TEMPLATE");typeof e=="string"?t.insertAdjacentHTML("beforeend",e):t.append(e),Y[s]=t}function de(s){return s in Y||console.error("Unknown template key "+s),Y[s].firstChild.cloneNode(!0)}Ne({buttonLabel:'<label class="button"></label>',buttonInput:'<input class="button-check form-input" autocomplete="off">'});function kt(s,e,t=null,n=null){let r=de("buttonInput"),i=de("buttonLabel");return n??=He("button")+e,_e(r,{type:s,value:e,id:n}),i.setAttribute("for",n),t&&(typeof t=="string"&&(t=document.createTextNode(t)),i.appendChild(t)),[r,i]}function At(s,e,t=null){let n=document.createElement("LABEL");return s instanceof Node&&(s=Ue(s,t)),n.setAttribute("for",s),n.textContent=e,n}function Re(s){let e=document.createElement("TEMPLATE");return e.innerHTML=s,e.content.children}function Bt(s){let e=Re(s);if(e.length!==1)throw new Error("HTML doesn't contain exactly one element.");return e[0]}function Ct(s){let[e,...t]=s.split("."),[n,r]=e.split("#"),i=document.createElement(n);return r&&(i.id=r),i.classList.add(...t),i}function Ft(s,e,{selected:t=null,disabled:n=[],groups:r=[]}={}){t??=Object.keys(e)[0];let i=oe(e,()=>!1),o=null;for(let{label:a,keys:c}of r){let u=document.createElement("OPTGROUP");u.label=a;for(let d of c)u.append(Te(d,e[d],t,n)),i[d]=!0;s.add(u),o||(o=u)}for(let[a,c]of Object.entries(e))i[a]||s.add(Te(a,c,t,n),o)}function Te(s,e,t,n){let r=document.createElement("OPTION");return r.value=s,r.textContent=e,t===s&&(r.selected="selected"),n.includes(s)&&(r.disabled="disabled"),r}function Dt(s,e){for(let t of e)s.appendChild(t)}function Pt(s,e,t,n=""){if(e){typeof e=="string"&&(e=[e]);for(let r of e)s[r].setAttribute(t,n)}}function _e(s,e){for(let[t,n]of Object.entries(e))typeof n=="boolean"?n?s.setAttribute(t,t):s.removeAttribute(t):t==="class"?qe(s,n):s.setAttribute(t,n)}function He(s,e="_"){return Oe+=1,s+Oe+e}function Ue(s,e){return s.hasAttribute("id")?(s.id=e,e):s.id}function Q(s,e){if(s)if(s instanceof Node)e(s);else for(let t of s)e(t)}function M(s,e,t,n=null){s||([t,n]=[n,t]),t=me(t),n=me(n),Q(e,r=>{r.classList.remove(...n),r.classList.add(...t)})}function qe(s,e){M(!0,s,e)}function Ot(s,e){M(!1,s,e)}function N(s,e="display"){Q(s,t=>{t.style.removeProperty(e)})}var Tt={display:"none",visibility:"hidden",opacity:"0"};function j(s,e="display"){Q(s,t=>{t.style.setProperty(e,Tt[e])})}function he(s,e,t=null,n="display"){s?(t&&j(t,n),N(e,n)):(j(e,n),t&&N(t,n))}function me(s){return s??=[],typeof s=="string"?s.split(" "):Array.from(s)}function fe(s,e="border-box",t=!1){let n=t?s.scrollWidth:s.clientWidth,r=t?s.scrollHeight:s.clientHeight,i=window.getComputedStyle(s),o=i.scale;return!o||o==="none"?o=1:o=parseFloat(o),e==="border-box"?(n+=o*(parseFloat(i.borderLeftWidth||0)+parseFloat(i.borderRightWidth||0)),r+=o*(parseFloat(i.borderTopWidth||0)+parseFloat(i.borderBottomWidth||0))):e==="content-box"?(n-=o*(parseFloat(i.paddingLeft||0)+parseFloat(i.paddingRight||0)),r-=o*(parseFloat(i.paddingTop||0)+parseFloat(i.paddingBottom||0))):e!=="padding-box"&&console.error("Invalid value for element size box, use padding-box, content-box or border-box."),[n,r]}function pe(s,{container:e=null,dimension:t="width",elementBox:n="border-box",containerBox:r="content-box",grow:i=!1}={}){e??=s.parentElement;let[o,a]=fe(s,n,!0),[c,u]=fe(e,r),d=Me(o,c,i),f=Me(a,u,i);return["width","height","both"].includes(t)||(console.error("Invalid dimension, use 'width', 'height' or 'both'."),t="width"),t==="width"?d:t==="height"?f:Math.min(d,f)}function Mt(s,e={}){s.style.scale=pe(s,e)}function Nt(s,e={}){let t=e.uniform??0,n=e.containers??s.map(i=>i.parentElement);if("container"in e&&(console.warn("Can't set single container for scaleAllToFit."),delete e.container),!Array.isArray(n)||n.length!==s.length){console.error("Containers and elements length don't match.");return}let r=s.map((i,o)=>pe(i,Object.assign(e,{container:n[o]})));if(t>0){let o=Math.min(...r)/t;for(let[a,c]of r.entries())r[a]=Math.min(o,c)}for(let[i,o]of s.entries())o.style.scale=r[i]}function Me(s,e,t=!1){if(s===0)return console.warn("getScale: Element's size is 0."),console.trace(),1;if(isNaN(s))return console.error("Element size is NaN."),1;if(isNaN(e))return console.error("Container size is NaN."),1;let n=e/s;return t?n:Math.min(n,1)}function jt(s,e=[]){T(e).then(()=>requestAnimationFrame(()=>{for(let[t,...n]of s)t(...n)}),t=>console.error(t))}function Rt(s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(s.toString(),document.createElement("br")),console.error(s)}function _t(...s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(...s.map(t=>t.toString()),document.createElement("br")),console.log(...s)}function Ht(s){z(s.querySelector(".page-content"),{container:s,transition:!1}),s.querySelector(".pages-next-button").addEventListener("click",()=>{z(document.getElementById(s.dataset.openPage).nextElementSibling,{container:s})}),s.querySelector(".pages-back-button").addEventListener("click",()=>{z(document.getElementById(s.dataset.openPage).previousElementSibling,{container:s})})}function z(s,{container:e=null,transition:t=!0}={}){let n=()=>Ut(s,e??s.closest(".pages-container"));t?document.startViewTransition(n):n()}function Ut(s,e){j(e.querySelectorAll(".page-content")),j(e.querySelectorAll(".page-heading")),N(s),N(e.querySelector(`.page-heading[data-for="${s.id}"]`)),e.dataset.openPage=s.id,he(!!s.previousElementSibling,e.querySelector(".pages-back-button")),he(!!s.nextElementSibling,e.querySelector(".pages-next-button"),e.querySelector(".pages-finish-button")),s.nextElementSibling||e.querySelector(".pages-finish-button").focus()}function qt(s){let e=new URL(location),t=!1;for(let[n,r]of Object.entries(s)){let i=encodeURIComponent(r);e.searchParams.get(n)!==i&&(e.searchParams.set(n,i),t=!0)}t&&history.pushState({},"",e)}function Kt(s,{transition:e=!0,types:t=[]}={}){e&&document.startViewTransition?document.startViewTransition({update:s,types:t}):requestAnimationFrame(s)}function Gt(s){let e=1779033703,t=3144134277,n=1013904242,r=2773480762;for(let i=0;i<s.length;i++){let o=s.charCodeAt(i);e=t^Math.imul(e^o,597399067),t=n^Math.imul(t^o,2869860233),n=r^Math.imul(n^o,951274213),r=e^Math.imul(r^o,2716044179)}return e=Math.imul(n^e>>>18,597399067),t=Math.imul(r^t>>>22,2869860233),n=Math.imul(e^n>>>17,951274213),r=Math.imul(t^r>>>19,2716044179),e^=t^n^r,t^=e,n^=e,r^=e,[e>>>0,t>>>0,n>>>0,r>>>0]}function Vt(s,e,t,n){return function(){s|=0,e|=0,t|=0,n|=0;let r=(s+e|0)+n|0;return n=n+1|0,s=e^e>>>9,e=t+(t<<3)|0,t=t<<21|t>>>11,t=t+r|0,(r>>>0)/4294967296}}function Wt(s){return Vt(...Gt(s))}var R=class{constructor(s=Math.random){this._rand=s}rand(s=null,e=null){return e===null?this._rand()*(s??1):(s??=0,this._rand()*(e-s)+s)}seed(s){this._rand=Wt(s)}randInt(s,e){return Math.floor(this.rand(s,e))}shuffle(s){for(let e=s.length;e>0;e--){let t=this.randInt(e);t!==e-1&&([s[e-1],s[t]]=[s[t],s[e-1]])}}randIndexFromWeights(s){let e=se(s);return re(this.rand(e[e.length-1]),e)}};var _={};P(_,{decodeBase64BoolArray:()=>zt,decodeBase64Number:()=>Ge,encodeBase64BoolArray:()=>$t,encodeBase64Number:()=>Ke});function $t(s){return Ve(Yt(s))+"~"+Ke(s.length)}function zt(s){let[e,t]=s.split("~");return Qt(We(e),Ge(t))}function Ke(s){return Ve(Jt(s))}function Ge(s){return Xt(We(s))}function Yt(s){let e=new Array(Math.ceil(s.length/6)),t;for(let n=0;n<e.length;n++){t=0;for(let r=0;r<6;r++)s[6*n+r]&&(t+=1<<r);e[n]=t}return e}function Qt(s,e){if(Math.ceil(e/6)!==s.length)throw new Error("Lengths of base 64 values and resultant length don't match.");let t=new Array(e);for(let[n,r]of s.entries())for(let i=0;i<6;i++){let o=6*n+i;if(o>=e)break;t[o]=(r&1<<i)!==0}return t}function Jt(s){let e=[];for(;s>0;)e.push(s&63),s>>=6;return e}function Xt(s){let e=0;for(let[t,n]of s.entries())e+=n<<6*t;return e}function Ve(s){return String.fromCharCode(...s.map(e=>Zt(e)))}function We(s){let e=new Array(s.length);for(let t=0;t<s.length;t++)e[t]=en(s.charCodeAt(t));return e}function Zt(s){return s&=63,s<26?s+65:s<52?s+71:s<62?s+-5:s===62?45:95}function en(s){if(s>=65&&s<91)return s-65;if(s>=97&&s<123)return s-97+26;if(s>=48&&s<58)return s-48+53;if(s===45)return 62;if(s===95)return 63;throw new Error("Unknown base 64 char code.")}var I=class{constructor(){this._funcs=[]}push(...e){this._funcs.push(...e)}remove(e){let t=this._funcs.indexOf(e);if(t!==-1)this._funcs.splice(t,1);else throw new Error(`Unknown func ${e}.`)}call(...e){for(let t of this._funcs)t.call(...e)}};var E=class{constructor(){this.settings={},this.keys=[]}static createFrom(e,t=null){let n=new this;return n.put(e,t),n}put(e,t=null){t??=Object.keys(e);for(let n of t)this.add(n,e[n])}extend(e){this.put(e.settings,e.keys)}add(e,t,n="end",r=null){if(this.settings[e]=t,n==="end")this.keys.push(e);else{let i;n==="begin"?i=0:(i=this.keys.indexOf(r),n==="afterKey"?i++:n!=="beforeKey"&&console.error("Invalid insert setting insert position.")),this.keys.splice(i,0,e)}}remove(e){this.settings[e].remove(),delete this.settings[e]}removeAll(){for(let e of Object.values(this.settings))e.remove();this.settings={},this.keys=[]}replace(e,t){this.settings[e].node.replaceWith(t.node),this.settings[e]=t}getValues(){return h.map(this.settings,e=>e.value)}setValues(e){for(let[t,n]of Object.entries(e))this.settings[t].value=n}getValue(e){return this.settings[e].value}getNode(e){return this.settings[e].node}getSetting(e){return this.settings[e]}nodeList(){return this.keys.map(e=>this.settings[e].node)}addUpdateListener(e,...t){if(typeof e=="function")for(let n of Object.values(this.settings))n.updateListeners.push(e,...t);else{typeof e=="string"&&(e=[e]);for(let n of e)this.settings[n].updateListeners.push(...t)}}},C=class{static idCount=0;static updateEvent="change";node;valueNode;updateListeners;constructor(e){let t;if(this.constructor.isValueNode(e))t=e;else if(t=e.querySelector("input, textarea, select"),!this.constructor.isValueNode(t))throw new Error("Couldn't find element of type input, textarea or select.");this.node=l.createElement("div.setting.labeled-value-element"),this.node.append(e),this.valueNode=t,this.updateListeners=new I,this._onChange=this._onChange.bind(this),this.valueNode.addEventListener(this.constructor.updateEvent,this._onChange)}static createInput(e,t=null,n=null){let r=document.createElement("INPUT");r.type=e,n&&l.setAttrs(r,n);let i=new this(r);return t&&i.label(t),i}static createSelect(e,t={}){let n=document.createElement("select");l.setOptions(n,e,t);let r=new this(n);return t.id&&r.setId(t.id),t.label&&r.label(t.label),r}static isValueNode(e){let t=e.tagName;return t==="SELECT"||t==="TEXTAREA"||t==="INPUT"&&e.type!=="hidden"}isCheckbox(){return this.valueNode.tagName==="INPUT"&&this.valueNode.type==="checkbox"}get value(){return this.isCheckbox()?this.valueNode.checked:this.valueNode.value}set value(e){this.isCheckbox()?this.valueNode.checked=e:this.valueNode.value=e}_onChange(){this.updateListeners.call(this,this.value)}setDisabled(e){this.valueNode.disabled=e}setId(e={prefix:""}){let t=typeof e=="string"?e:this.constructor.generateId(e.prefix);this.valueNode.id=t;let n=this.node.querySelector("label");return n&&(n.htmlFor=t),t}static generateId(e=""){return"ve_"+e+this.idCount.toString().padStart(4,"0")}label(e){if(!e)return;let t=this.node.querySelector("label");t||(t=document.createElement("label"),this.valueNode.id||this.setId(),t.htmlFor=this.valueNode.id,this.node.prepend(t)),t.textContent=e}remove(){this.valueNode.removeEventListener(this.constructor.updateEvent,this._onChange),this.node.remove()}};l.registerTemplate("buttonGroupContainer",l.createElement("fieldset.button-group"));var S=class{static nameCount=0;node;inputs;constructor(e,t,n=!1){this.node=e,this.updateListeners=new I,this.inputs=Object.fromEntries(Array.from(this.node.querySelectorAll("INPUT")).map(r=>[r.value,r])),this.exclusive=t,this.decheckable=n,this._onChange=this._onChange.bind(this),this.node.addEventListener("change",this._onChange)}static from(e,{exclusive:t=!1,name:n=null,checked:r=null,disabled:i=null,decheckable:o=!1,label:a=null}={}){Array.isArray(e)&&(e=Object.fromEntries(e.map(m=>[m,m])));let c=Object.keys(e),u=t?"radio":"checkbox";n??=this.generateName();let d=l.getTemplate("buttonGroupContainer");t&&(d.setAttribute("role","radiogroup"),typeof r=="string"&&(r=[r]),!o&&!r&&(r=[c[0]])),r=h.subsetToBoolRecord(r??"none",c),i=h.subsetToBoolRecord(i??"none",c);for(let[m,B]of Object.entries(e)){let[L,V]=l.button(u,m,B);L.name=t?n:`${n}_${m}`,L.disabled=i[m],L.checked=r[m],d.append(L,V)}t&&o&&d.addEventListener("click",m=>{m.target.tagName==="INPUT"&&m.target.checked&&(m.target.checked=!1)});let f=new this(d,t,o);return a&&f.label(a),f}static generateName(){return this.nameCount++,"buttongroup_"+this.nameCount.toString().padStart(4,"0")}_onChange(){this.updateListeners.call(this,this.value)}buttonCount(){return Object.keys(this.inputs).length}disableIfSingleButton(e=null){this.buttonCount()===1?(this.setDisabled(!0),e!==null&&(this.value=e?Object.keys(this.inputs):[])):this.setDisabled(!1)}get value(){if(this.exclusive&&!this.decheckable){for(let e of Object.values(this.inputs))if(e.checked)return e.value;return null}return h.filterKeys(this.inputs,e=>e.checked)}set value(e){e=h.subsetToBoolRecord(e,Object.keys(this.inputs));for(let[t,n]of Object.entries(this.inputs))n.checked=e[t]}setDisabled(e){for(let t of Object.values(this.inputs))t.disabled=e}label(e){let t=document.createElement("LEGEND");t.textContent=e,this.node.prepend(t)}remove(){this.node.addEventListener("change",this._onChange),this.node.remove()}};l.registerTemplate("slider",`<div class="slider-container">
    <span class="range-min"></span><span class="range-value"></span><span class="range-max"></span>
    <input type="range" class="form-range">
</div>`);var F=class extends C{static updateEvent="input";constructor(e,t,n){if(super(e),this.valueNode.tagName!=="INPUT"||this.valueNode.type!=="range")throw new Error("Couldn't find input type='range' element.");this.min=t,this.max=n,this.displayValue=this.displayValue.bind(this),this.updateProgress=this.updateProgress.bind(this),this.displayMinMax()}static create(e,t,n=null){let r=l.getTemplate("slider"),i=r.lastElementChild;i.min=e,i.max=t,i.setAttribute("step",1);let o=new this(r,e,t);return n!==null&&(o.value=n),o}_onChange(){super._onChange(),this.updateProgress(),this.displayValue()}updateProgress(){this.valueNode.style.setProperty("--range-progress",this.getProgress().toString())}getProgress(){return(this.value-this.min)/(this.max-this.min)}displayValue(){this.node.querySelector(".range-value").textContent=this.formatValue(this.value)}displayMinMax(){this.node.querySelector(".range-min").textContent=this.formatValue(this.min),this.node.querySelector(".range-max").textContent=this.formatValue(this.max)}isCheckbox(){return!1}set value(e){(this.min>e||this.max<e)&&console.warn("Slider value outside range."),super.value=e.toString(),this.displayValue(),this.updateProgress()}get value(){return parseFloat(this.valueNode.value)}formatValue(e){return(Math.round(e*100)/100).toString()}setMin(e){this.valueNode.value<e&&(this.valueNode.value=e,this._onChange()),this.min=e,this.valueNode.min=e,this.updateProgress(),this.displayMinMax()}setMax(e){this.valueNode.value>e&&(this.valueNode.value=e,this._onChange()),this.max=e,this.valueNode.max=e,this.updateProgress(),this.displayMinMax()}};var J=class{_punishFactor=2;_manualPunish=1;_previousDampFactor=.5;constructor(e){this.items=e,this.rng=new R;let t=this.itemCount=e.length;this.hitCount=0,this.scores=new Array(t).fill(0),this.tries=new Array(t).fill(0),this.triesLeft=new Array(t).fill(1),this.totalTriesLeft=t,this.maxTriesLeft=t,this.currentIndex=this.rng.randInt(0,t),this.previousIndex=null}seed(e){this.rng.seed(e)}currentItem(){return this.items[this.currentIndex]}nextItem(){return this.previousIndex=this.currentIndex,this.currentIndex=this.rng.randIndexFromWeights(this.getWeights()),this.currentItem()}getWeights(){let e=this.triesLeft.slice();return this.previousIndex!==null&&(e[this.previousIndex]*=this._previousDampFactor),e}updateTotalTriesLeft(){let e=b.sum(this.triesLeft);e>this.totalTriesLeft&&(this.maxTriesLeft+=e-this.totalTriesLeft),this.totalTriesLeft=e}progress(){return 1-this.totalTriesLeft/this.maxTriesLeft}enterScore(e){let t=++this.tries[this.currentIndex];t===1&&this.hitCount++,this.scores[this.currentIndex]=Math.max(this.scores[this.currentIndex],e*this.scoreAtTryFactor(t)),this.triesLeft[this.currentIndex]+=this._triesBoost(e)-1,this.triesLeft[this.currentIndex]<=0&&(this.triesLeft[this.currentIndex]=0,this.itemCount--),this.updateTotalTriesLeft()}isEmpty(){return this.itemCount===0}_triesBoost(e){return this._punishFactor*(1-e)}scoreAtTryFactor(e){return 1/e}getItemIndex(e){return this.items.indexOf(e)}punish(e,t=1){this.triesLeft[e]+=this._manualPunish*t,this.updateTotalTriesLeft()}absoluteScore(){return b.sum(this.scores)}scoreString(e="ratio"){let t=this.absoluteScore(),n=`${ze(t,1,2)}/${this.hitCount}`,r=this.hitCount>0?$e(t/this.hitCount):$e(0);if(e==="ratio")return n;if(e==="percent")return r;if(e==="both")return`${n} (${r})`;console.error(`Unknown mode: ${e}`)}};function $e(s,e=0){return String(ze(s*100,e))+"%"}function ze(s,e=0,t=1){let n=Math.pow(10,e)*t;return Math.floor(s*n)/n}function H(s,e,t,n,r){return s<e||t<e?s>t?t+1:s+1:n===r?e:e+1}function ge(s,e){if(s===e)return 0;if(s.length>e.length){let ot=s;s=e,e=ot}let t=s.length,n=e.length;for(;t>0&&s.charCodeAt(t-1)===e.charCodeAt(n-1);)t--,n--;let r=0;for(;r<t&&s.charCodeAt(r)===e.charCodeAt(r);)r++;if(t-=r,n-=r,t===0||n<3)return n;let i=0,o,a,c,u,d,f,m,B,L,V,Ie,Ee,k=new Array(2*t);for(o=0;o<t;o++)k[2*o]=o+1,k[2*o+1]=s.charCodeAt(r+o);let Le=k.length-1;for(;i<n-3;)for(L=e.charCodeAt(r+(a=i)),V=e.charCodeAt(r+(c=i+1)),Ie=e.charCodeAt(r+(u=i+2)),Ee=e.charCodeAt(r+(d=i+3)),f=i+=4,o=0;o<Le;o+=2)m=k[o],B=k[o+1],a=H(m,a,c,L,B),c=H(a,c,u,V,B),u=H(c,u,d,Ie,B),f=H(u,d,f,Ee,B),k[o]=f,d=u,u=c,c=a,a=m;for(;i<n;)for(L=e.charCodeAt(r+(a=i)),f=++i,o=0;o<Le;o+=2)m=k[o],k[o]=f=H(m,a,f,L,k[o+1]),a=m;return f}var D=class{constructor(e,t,n){this.displayString=e,this.properties=t,this.form=n}},A=class{constructor(e,t){this.value=e,this.maxDist=t,this.displayString=typeof e=="string"?e:e.toString()}static fromData(e,t){let n=t.maxDist??0,r=t.type;if(r==="number")return new be(e,n,t.distanceMode??"linear");if(r==="string")return new X(e,n,t.caseSensitive??!1,t.substitutions??{});if(r==="list"){let i,o={};return typeof e=="string"?i=e:("source"in e||console.error("Source of list property missing."),i=e.source,"alts"in e&&(o=e.alts)),new U(i,n,o,t)}else console.error(`Unknown property type "${t.type}"`)}grade(e){let t=this.gradeSingle(e,this.value);return[t,e.length>0?[this.markGradedText(e,t)]:[],[this.markGradedText(this.displayString,t)]]}static passes(e){return e>=.5}gradeSingle(e,t){let n=this.distance(e,t);return n<=this.maxDist?this.maxDist===0?1:Math.pow(2,-n/this.maxDist):0}markGradedText(e,t){let n=document.createElement("SPAN");return n.dataset.correct=t===1?"true":t>0?"partially":"false",n.textContent=e,n}distance(e,t){console.error("Not implemented.")}},be=class extends A{constructor(e,t,n="linear"){let r,i;typeof e=="string"?(r=parseFloat(e),isNaN(r)&&console.error(`Invalid number property value "${e}"`),i=e):(r=e,i=e.toString()),n==="log"&&r===0&&console.error('Invalid value 0 for NumberProperty with distanceMode "log"'),super(r,t),this.displayString=i,this.distanceMode=n}distance(e,t){return this.distanceMode==="linear"?Math.abs(e-t):Math.abs(Math.log(e/t))}},X=class extends A{constructor(e,t,n=!1,r={}){super(e,t),this.caseSensitive=n,this.substitutions=r}distance(e,t){return ge(this.standardizeString(e),this.standardizeString(t))}standardizeString(e){e=e.trim();for(let[t,n]of Object.entries(this.substitutions))e=e.replaceAll(new RegExp(t,"g"),n);return e=e.normalize("NFKD").replaceAll(/\p{M}/gu,""),this.caseSensitive||(e=e.toLowerCase()),e}},U=class extends X{constructor(e,t,n={},{listMode:r="best",caseSensitive:i=!1,splitter:o="[,;/]",excludeFromList:a=["\\(.*?\\)"],substitutions:c={}}){e=e.trim(),super(e,t,i,c),this.splitter=o,this.values=this.constructor.getValues(e,t,this.splitter,a),n?this.alternatives=h.map(n,u=>typeof u=="string"?[u]:u):this.alternatives={},this.listMode=r}static getValues(e,t,n,r){let i=[new Z(e)];for(let o of[...r,n])i=i.map(a=>a.split(o)).flat().map(a=>a.trim()).filter(a=>a.end>a.start);return i.length===0&&console.warn("No values in list."),i}grade(e){let t=new Z(e).split(this.splitter).map(o=>o.trim()),n=new Array(t.length).fill(0),r=new Array(this.values.length).fill(0);for(let[o,a]of this.values.entries())for(let[c,u]of t.entries()){let d=this.gradeSingle(u.str,a.str);a.str in this.alternatives&&(d=Math.max(d,...this.alternatives[a.str].map(f=>this.gradeSingle(u.str,f)))),d>0&&(n[c]>0&&console.warn("Guess matches multiple values, maxDist too high."),r[o]=Math.max(r[o],d),n[c]=Math.max(n[c],d))}return[this.listMode==="best"?Math.max(...r):b.avg(n),this.markSubStrings(t,n),this.markSubStrings(this.values,r)]}markSubStrings(e,t){if(e.length===0)return[];let n=e[0].source,r=[],i=0;for(let[o,a]of e.entries())i<a.start&&r.push(document.createTextNode(n.substring(i,a.start))),a.start<a.end&&(r.push(this.markGradedText(a.str,t[o])),i=a.end);return i<n.length&&r.push(document.createTextNode(n.substring(i))),r}},Z=class s{constructor(e,t=0,n=null){e instanceof s&&(t+=e.start,n===null?n=e.end:n+=e.start,e=e.source),n===null&&(n=e.length),this.source=e,this.str=e.substring(t,n),this.start=t,this.end=n}split(e,t=!1){let n=[],r=this.str.matchAll(e),i=0;for(let o of r)!t&&i===o.index||(n.push(new this.constructor(this,i,o.index)),i=o.index+o[0].length);return(t||i<this.end-this.start)&&n.push(new this.constructor(this,i)),n}trim(){let e=this.str.match(/^\s*/)[0].length,t=this.str.match(/\s*$/)[0].length;return e===0&&t===0?this:new this.constructor(this.source,this.start+e,this.end-t)}};l.registerTemplates({eval:`<div class="item-eval">
    <span class="submitted"></span><span class="solution"></span>
</div>`,symbolContainer:`<div class="symbol-container">
    <div class="symbol-display-container"><span class="symbol"></span></div>
    <div class="symbol-label-container"><span class="symbol-label"></span></div>
</div>`});var ee=class{constructor(e,t,n,r){this.dataset=e,this.properties=n,this.language=r,this.dealer=new J(t),this.onFinish=new I,this.updateProgressBar(),this.onInputKeydown=this.onInputKeydown.bind(this),this._show=this._show.bind(this),this.loadAndUpdateSymbolFont=this.loadAndUpdateSymbolFont.bind(this)}setup(){return this.setupSymbolContainer(),this.setupInputs(),this.setupEvals(),document.getElementById("item-next-button").textContent="Next",this.setupFontSettings()}getInputMode(e){return e==="real"||e==="integer"?"numeric":"text"}setupSymbolContainer(){let e=document.querySelector("#symbol-current .symbol");e.classList.add("symbol-"+this.dataset.displayData.type),e.setAttribute("lang",this.dataset.metadata.lang),e.setAttribute("dir",this.dataset.metadata.dir)}setupInputs(){this.inputs=h.mapKeyArrayToValues(this.properties,t=>{let n=document.createElement("INPUT");return l.setAttrs(n,{type:"text",inputmode:this.getInputMode(this.dataset.propsData[t].type),placeholder:this.dataset.propsData[t].label}),this.language&&this.language!=="default"&&n.setAttribute("lang",this.language),n});let e=document.getElementById("game-inputs");e.replaceChildren(...Object.values(this.inputs)),e.addEventListener("keydown",this.onInputKeydown)}onInputKeydown(e){let t=e.target.closest("INPUT");t&&(e.key==="Enter"?t.nextElementSibling?t.nextElementSibling.focus():document.getElementById("item-submit-button").focus():e.key==="Backspace"&&e.target.value===""&&t.previousElementSibling&&(t.previousElementSibling.focus(),e.preventDefault()))}setupEvals(){this.evals={};let e=document.getElementById("game-evals");for(let t of this.properties){let n=l.getTemplate("eval");this.evals[t]=n,e.append(n)}}updateSymbolWeight(e){document.querySelector("#game-symbols").style.setProperty("--symbol-weight",e.toString())}loadAndUpdateSymbolFont(e){return e??=this.fontSettings.getValue("family"),y.loadFont(this.dataset.getFontFamily(e)).then(()=>{this.updateSymbolFontFamily(e)},t=>console.error(t))}updateSymbolFontFamily(e){e??=this.fontSettings.getValue("family"),document.querySelectorAll("#game-symbols .symbol-string").forEach(t=>{this.setSymbolFont(t,e)}),this.updateSymbolWeightRange(e)}updateSymbolWeightRange(e){let t=this.dataset.getFontFamily(e),n=y.getFontData(t),r=this.fontSettings.settings.weight;if(n.variationSettings&&n.variationSettings.wght){let[i,o]=n.variationSettings.wght.split(" ").map(a=>parseInt(a,10));r.setMin(i),r.setMax(o),l.show(r.node)}else l.hide(r.node)}setupFontSettings(){let e=this.dataset.displayData.defaultWeight??500,t=F.create(100,900,e);return t.label("Weight"),this.fontSettings=E.createFrom({family:this.dataset.fontSetting(),weight:t}),document.querySelector("#font-settings").replaceChildren(...this.fontSettings.nodeList()),this.fontSettings.addUpdateListener("weight",this.updateSymbolWeight),this.fontSettings.addUpdateListener("family",this.loadAndUpdateSymbolFont),this.updateSymbolWeight(e),this.loadAndUpdateSymbolFont()}setSymbolFont(e,t){y.setFont(e,...this.dataset.getFont(t))}setReferenceItems(e){this.referenceItems=e}seed(e){this.dealer.seed(e)}cleanup(){this.clearItemDisplay(),this.updateProgressBar(0),document.getElementById("game-inputs").removeEventListener("keydown",this.onInputKeydown),document.getElementById("game-inputs").replaceChildren(),document.getElementById("game-evals").replaceChildren()}finish(){setTimeout(()=>this.cleanup(),100),this.onFinish.call(this)}currentItem(){return this.dealer.currentItem()}submitRound(){let e=0,t=this.currentItem();for(let[n,r]of Object.entries(this.inputs)){let i=this.evals[n],o=t.properties[n],[a,c,u]=o.grade(r.value);if(e+=a,!A.passes(a)){let d=this.getReferenceItems(t.form,n,r.value);if(d.length>0){let f=this.referenceItemsNodes(d,n);document.getElementById("game-symbols").append(...f),this.updateSymbolFontFamily(this.fontSettings.getValue("family"));for(let m of f)this.scaleItemNodeContents(m);for(let m of d)this.dealer.punish(this.dealer.getItemIndex(m),1/d.length)}}i.querySelector(".submitted").replaceChildren(...c),i.querySelector(".solution").replaceChildren(...u),l.classIfElse(o instanceof U&&o.listMode==="best",i,"best-mode")}e/=this.properties.length,this.dealer.enterScore(e),this.updateProgressBar(),this.dealer.isEmpty()&&(document.getElementById("item-next-button").textContent="Finish"),this.show("evals"),window.scrollY>0&&window.scrollTo({top:0,behavior:"smooth"})}getReferenceItems(e,t,n){if(!this.referenceItems)return[];let r=[],i=[];for(let o of this.referenceItems[e]){let a=o.properties[t].grade(n)[0];A.passes(a)&&(r.push(o),i.push(i))}return Math.max(...i)===1?r.filter((o,a)=>i[a]===1):r}referenceItemsNodes(e,t){return e.map(n=>this.referenceItemNode(n,t))}referenceItemNode(e,t){let n=l.getTemplate("symbolContainer");return n.classList.add("symbol-reference"),n.querySelector(".symbol").classList.add("symbol-"+this.dataset.displayData.type),this.updateItemNode(n,e,t,!1),n}updateItemNode(e,t,n=null,r=!0){n??=this.properties[0],e.querySelector(".symbol").textContent=t.displayString,e.querySelector(".symbol-label").textContent=t.properties[n].displayString,r&&this.scaleItemNodeContents(e)}scaleItemNodeContents(e){l.scaleToFit(e.querySelector(".symbol")),l.scaleToFit(e.querySelector(".symbol-label"))}clearInputs(){for(let e of Object.values(this.inputs))e.value=""}show(e){this.shown=e,requestAnimationFrame(this._show)}_show(){l.toggleShown(this.shown==="inputs",[document.getElementById("game-inputs"),document.getElementById("item-submit-button")],[document.getElementById("game-evals"),document.getElementById("item-next-button")]),l.toggleShown(this.shown==="inputs",null,document.querySelector("#symbol-current .symbol-label"),"visibility"),this.shown==="inputs"?(document.querySelectorAll("#game-symbols .symbol-reference").forEach(e=>{e.remove()}),this.focus()):document.getElementById("item-next-button").focus()}updateProgressBar(e=null){e??=this.dealer.progress(),document.getElementById("progress-bar").style.setProperty("--progress",e)}newRound(){if(this.dealer.isEmpty()){this.finish();return}this.dealer.nextItem(),this.displayItem(this.currentItem()),this.clearInputs(),this.show("inputs")}focus(){this.inputs[this.properties[0]].focus({preventScroll:!0})}displayItem(e){this.updateItemNode(document.getElementById("symbol-current"),e)}clearItemDisplay(){document.querySelector("#symbol-current .symbol").textContent="",document.querySelector("#symbol-current .symbol-label").textContent=""}};var w=b.range,Ye={buttonMinWidth:"--button-min-width",buttonMaxWidth:"--button-max-width",symbolSize:"--symbol-size",labelGap:"--label-gap",symbolMinWidth:"--symbol-min-width"},tn=["mode","indices","transpose","nColumns","dblClickGroups","rowLabels","columnLabels","rowLabelPosition","columnLabelPosition","rangeSelectionMode"],q=class{constructor(e,t){this.items=e,this.dataset=t,this.formsData=t.formsData,this.selectorData=t.selectorData,this.updateListeners=new I,this.onBlockLabelClick=this.onBlockLabelClick.bind(this),this.onBlockButtonClick=this.onBlockButtonClick.bind(this),this.onBlockButtonEnter=this.onBlockButtonEnter.bind(this),this.onBlockLabelPointerOverOut=this.onBlockLabelPointerOverOut.bind(this),this.onBlockLabelPointerDown=this.onBlockLabelPointerDown.bind(this),this.onBlockLabelPointerUpCancel=this.onBlockLabelPointerUpCancel.bind(this),this.onBlockRangePointerDown=this.onBlockRangePointerDown.bind(this),this.onBlockRangePointerMove=this.onBlockRangePointerMove.bind(this),this.onBlockRangePointerUpCancel=this.onBlockRangePointerUpCancel.bind(this)}setup(e=null,t=null,n=null){this.node=l.createElement("div.item-selector"),n&&this.node.setAttribute("data-dataset",n),this.setupFormsSetting(t),this.setupButtons(),this.setupBlocks(),this.setActive(this.processItemsActive(e)),this.updateButtons({scale:!1})}setupButtons(){this.itemsActive=new Array(this.items.length).fill(!1),this.buttons=this.items.map((e,t)=>this.getItemButton(e,t.toString()))}setupBlocks(){let e=this.selectorData.block?[this.selectorData.block]:this.selectorData.blocks?this.selectorData.blocks:[{mode:"flex"}];this.blocks=e.map(n=>h.onlyKeys(n,tn,!0));let t=this.processIndexSubsets(e.map(n=>n.indices??"rest"),this.items.length,!0);for(let[n,r]of this.blocks.entries()){r.node=l.createElement("div.selector-block"),r.indices=t[n],this.standardizeBlockIndices(r),r.elements=[];for(let[i,o]of r.indices.entries()){let a=o===null?this._gridGapElement():this.buttons[o];r.elements.push(a),r.node.append(a),a.dataset.indexWithinBlock=i}r.mode==="grid"?(r.node.classList.add("selector-block-grid"),r.node.style.setProperty("--columns",r.nColumns)):(r.node.classList.add("selector-block-flex"),this.dataset.metadata.dir==="rtl"&&r.node.classList.add("flex-rtl")),r.node.setAttribute("data-block-index",n.toString()),this.applyBlockStyle(r,this.selectorData.style,r.style),this.processListenerIndices(r),this.setupBlockListeners(r),this.node.append(r.node);try{this.addBlockLabels(r)}catch(i){console.error("Error occured while trying to add block labels."),console.error(i)}}}addBlockLabels(e){let t=e.nColumns,n=Math.round(e.indices.length/t);if(e.rowLabels){if(typeof e.rowLabels=="string"&&(e.rowLabels=e.rowLabels.split("")),!Array.isArray(e.rowLabels)||e.rowLabels.length!==n)throw new Error("Row labels no array or don't match number of rows.");let[r,i,o]=this._processLabelPosition(e.rowLabelPosition);[e.rowLabelStart,e.rowLabelEnd]=[i,o],e.node.classList.add(`has-row-labels-${r}`);for(let[a,c]of e.rowLabels.entries()){let u=this._labelElement("row",c,a);e.rowLabelStart&&e.elements[a*t].insertAdjacentElement("beforebegin",u),e.rowLabelEnd&&(e.rowLabelStart&&(u=u.cloneNode(!0)),a===t-1?e.node.insertAdjacentElement("beforeend",u):e.elements[a*(t+1)].insertAdjacentElement("beforebegin",u))}}if(e.columnLabels){if(typeof e.columnLabels=="string"&&(e.columnLabels=e.columnLabels.split("")),!Array.isArray(e.columnLabels)||e.columnLabels.length!==t)throw new Error("Column labels no array or don't match number of columns.");let[r,i,o]=this._processLabelPosition(e.columnLabelPosition);[e.columnLabelStart,e.columnLabelEnd]=[i,o];let a=e.columnLabels.map((c,u)=>this._labelElement("column",c,u));"rowLabels"in e&&(e.rowLabelStart&&a.splice(0,0,this._gridGapElement()),e.rowLabelEnd&&a.push(this._gridGapElement())),e.columnLabelStart&&e.node.prepend(...a),e.columnLabelEnd&&(e.columnLabelStart&&(a=a.map(c=>c.cloneNode(!0))),e.node.append(...a))}}applyBlockStyle(e,...t){let n=Object.assign({},...t);"buttonWidth"in n&&(n.buttonMinWidth=n.buttonWidth,n.buttonMaxWidth=n.buttonWidth,delete n.buttonWidth);for(let[r,i]of Object.entries(n))r in Ye||console.error(`Invalid selector block style property ${r}.`),e.node.style.setProperty(Ye[r],i)}_gridGapElement(){return l.createElement("span.selector-grid-gap")}_labelElement(e,t,n){if(t===null)return this._gridGapElement();let r=l.createElement(`span.block-label.block-${e}-label`);return r.setAttribute("tabindex",0),r.textContent=t,r.dataset.index=n.toString(),r}getButtonsFromIndices(e){return e?e.filter(t=>t!==null).map(t=>this.buttons[t]):[]}buttonsClassIfElse(e,t,n,r=null){l.classIfElse(e,this.getButtonsFromIndices(t),n,r)}buttonsRemoveClass(e,t){l.removeClass(this.getButtonsFromIndices(e),t)}buttonsAddClass(e,t){l.addClass(this.getButtonsFromIndices(e),t)}_processLabelPosition(e){return e??="start",e==="both"?[e,!0,!0]:e==="end"?[e,!1,!0]:(e!=="start"&&console.error("Invalid label position, use 'start', 'end' or 'both'."),["start",!0,!1])}processListenerIndices(e){e.mode==="grid"&&(e.indicesByRow=w(e.nRows).map(t=>w(e.nColumns).map(n=>e.indices[t*e.nColumns+n]).filter(n=>n!==null)),e.indicesByColumn=w(e.nColumns).map(t=>w(e.nRows).map(n=>e.indices[n*e.nColumns+t]).filter(n=>n!==null))),e.dblClickGroups??=[w(e.indices.length)],e.dblClickGroups=this.processIndexSubsets(e.dblClickGroups,e.indices.length);for(let[t,n]of e.dblClickGroups.entries())for(let r of n)e.elements[r].dataset.dblClickGroup=t;e.dblClickGroups=e.dblClickGroups.map(t=>t.map(n=>e.indices[n]).filter(n=>n!==null))}setupBlockListeners(e){e.node.addEventListener("click",this.onBlockButtonClick),e.node.addEventListener("keydown",this.onBlockButtonEnter),this.resetRangeSelection(),e.node.addEventListener("pointerdown",this.onBlockRangePointerDown),e.mode==="grid"&&(e.node.addEventListener("click",this.onBlockLabelClick),e.node.addEventListener("keydown",this.onBlockLabelClick),e.node.addEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerdown",this.onBlockLabelPointerDown))}removeBlockListeners(e){e.node.removeEventListener("click",this.onBlockButtonClick),e.node.removeEventListener("keydown",this.onBlockButtonClick),e.node.removeEventListener("pointerdown",this.onBlockRangePointerDown),e.node.removeEventListener("pointermove",this.onBlockRangePointerMove),e.mode==="grid"&&(e.node.removeEventListener("click",this.onBlockLabelClick),e.node.removeEventListener("keydown",this.onBlockLabelClick),e.node.removeEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerdown",this.onBlockLabelPointerDown))}onBlockButtonClick(e){let t=e.target.closest(".selector-item-button, .selector-grid-gap");if(!t)return;let n=this.getBlockIndexFromEvent(e);if(e.detail%2===0&&this.lastBlockClicked===n&&this.lastButtonClicked===t.dataset.indexWithinBlock){let r=this.getBlockFromEvent(e),i=t.dataset.dblClickGroup,o=r.dblClickGroups[i];this.toggleItems(o)}this.lastButtonClicked=t.dataset.indexWithinBlock,this.lastBlockClicked=n}onBlockButtonEnter(e){if(e.key!=="Enter")return;let t=e.target.closest(".selector-item-button");t&&this.toggleItems([t.dataset.index])}getBlockIndexFromEvent(e){let t=e.target.closest(".selector-block");return t?t.dataset.blockIndex:null}getBlockFromEvent(e){let t=this.getBlockIndexFromEvent(e);return t!==null?this.blocks[t]:null}getIndicesFromBlockLabelEvent(e){let t=e.target.closest(".block-label");if(!t)return;let n=t.classList.contains("block-row-label")?"indicesByRow":"indicesByColumn",r=t.dataset.index;return this.getBlockFromEvent(e)[n][r]}onBlockLabelClick(e){if(e.type==="keydown"&&e.key!=="Enter")return;let t=this.getIndicesFromBlockLabelEvent(e);t&&this.toggleItems(t)}onBlockLabelPointerOverOut(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&this.buttonsClassIfElse(e.type==="pointerover",t,"hover")}onBlockLabelPointerDown(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&(this.buttonsAddClass(t,"active"),this.blockLabelActiveIndices=t,document.addEventListener("pointerup",this.onBlockLabelPointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockLabelPointerUpCancel,{once:!0}))}onBlockLabelPointerUpCancel(){let e=this.blockLabelActiveIndices;e&&this.buttonsRemoveClass(e,"active"),this.blockLabelActiveIndices=null,this.removeDocumentLabelListeners()}resetRangeSelection(){this.rangeSelectingBlockIndex=null,this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=null,this.rangeSelectStartIndex=null,this.rangeSelectStopIndex=null,this.rangeSelectionActiveIndices=null}onBlockRangePointerMove(e){if(this.rangeSelectingBlockIndex===null)return;let n=document.elementFromPoint(e.clientX,e.clientY).closest(".selector-item-button, .selector-grid-gap");if(!n||n.closest(".selector-block").dataset.blockIndex!==this.rangeSelectingBlockIndex)return;let i=n.dataset.indexWithinBlock;this.rangeSelectStopIndex!==i&&(this.rangeSelectStartIndex??=i,this.rangeSelectStopIndex=i,this.updateRangeSelection())}onBlockRangePointerDown(e){let t=this.getBlockIndexFromEvent(e);if(t===null)return;this.rangeSelectingBlockIndex=t;let n=e.target.closest(".selector-item-button, .selector-grid-gap");n&&(this.rangeSelectStartIndex=n.dataset.indexWithinBlock,this.rangeSelectStopIndex=this.rangeSelectStartIndex,this.updateRangeSelection()),document.addEventListener("pointerup",this.onBlockRangePointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockRangePointerUpCancel,{once:!0}),this.blocks[t].node.addEventListener("pointermove",this.onBlockRangePointerMove)}onBlockRangePointerUpCancel(e){this.rangeSelectingBlockIndex!==null&&(e.type==="pointerup"&&this.getBlockIndexFromEvent(e)===this.rangeSelectingBlockIndex&&this.rangeSelectionActiveIndices&&this.toggleItems(this.rangeSelectionActiveIndices),this.blocks[this.rangeSelectingBlockIndex].node.removeEventListener("pointermove",this.onBlockRangePointerMove),this.removeDocumentRangeListeners(),this.resetRangeSelection())}removeDocumentLabelListeners(){document.removeEventListener("pointerup",this.onBlockLabelPointerUpCancel),document.removeEventListener("pointercancel",this.onBlockLabelPointerUpCancel)}removeDocumentRangeListeners(){document.removeEventListener("pointerup",this.onBlockRangePointerUpCancel),document.removeEventListener("pointercancel",this.onBlockRangePointerUpCancel)}updateRangeSelection(){this.rangeSelectionActiveIndices&&this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=this.getIndicesInRangeSelection(),this.buttonsAddClass(this.rangeSelectionActiveIndices,"active")}getIndicesInRangeSelection(){if(this.rangeSelectStartIndex===null||this.rangeSelectStopIndex===null)return[];let[e,t]=te(this.rangeSelectStartIndex,this.rangeSelectStopIndex),n=this.blocks[this.rangeSelectingBlockIndex];if(n.mode==="grid")if(n.rangeSelectionMode??="grid",n.rangeSelectionMode==="grid"){let[r,i]=ye(e,n.nColumns),[o,a]=ye(t,n.nColumns);return[r,o]=te(r,o),[i,a]=te(i,a),w(r,o+1).map(c=>w(c*n.nColumns+i,c*n.nColumns+a+1)).flat().map(c=>n.indices[c])}else if(n.rangeSelectionMode==="walkColumns"){let r=this.transposeIndex(e,n.nRows,n.nColumns),i=this.transposeIndex(t,n.nRows,n.nColumns);[r,i]=te(r,i);let o=this.transposedRange(n.nColumns,n.nRows);return w(r,i+1).map(a=>o[a]).map(a=>n.indices[a])}else n.rangeSelectionMode!=="walkRows"&&console.error("Invalid range selection mode, use grid, walkRows or walkColumns.");return w(e,t+1).map(r=>n.indices[r])}standardizeBlockIndices(e){if(e.mode==="grid"){if(!e.nColumns)throw new Error("Block columns not set.");e.nRows=Math.ceil(e.indices.length/e.nColumns);let t=e.indices.length%e.nColumns;if(t!==0){let n=e.nColumns-t;e.indices.push(...new Array(n).fill(null))}e.transpose&&this.transposeBlock(e)}}transposeBlock(e){e.indices=this.transposeIndices(e.indices,e.nRows,e.nColumns)}transposeIndices(e,t,n){if(e.length!==t*n)throw new Error("Dimensions don't match.");return this.transposedRange(t,n).map(r=>e[r])}transposedRange(e,t){return w(e*t).map(n=>this.transposeIndex(n,e,t))}transposeIndex(e,t,n){let[r,i]=ye(e,n);return i*t+r}processIndexSubsets(e,t,n=!1){let r=[],i=new Array(t).fill(!1);for(let[a,c]of e.entries()){if(c==="rest"){a!==e.length-1&&console.error("Can only have subset 'rest' at the end."),r.push(b.filterIndices(i,d=>!d));break}let u=[];for(let d of this.processIndices(c,n))if(u.push(d),d!==null){if(i[d])throw new Error(`Duplicate subset index ${d}.`);i[d]=!0}r.push(u)}let o=b.filterIndices(e,a=>!a);if(o.length!==0)throw new Error(`Not all indices were covered: missing ${o}.`);return r}updateButtons({scale:e=!0}={}){l.updateDOM(()=>{let t=this.activeForms();for(let[n,r]of this.items.entries())r.countQuizItems(t)===0?(this.updateButtonForms(n,this.formsData.keys),this.buttons[n].classList.add("disabled")):(this.updateButtonForms(n,t),this.buttons[n].classList.remove("disabled"));e&&this.scaleButtons()},{transition:!1})}updateButtonForms(e,t){let n=this.items[e].getFormsDisplayString(t);this.buttons[e].querySelector(".symbol").replaceChildren(n)}toggleItems(e,{updateIfDisabled:t=!1}={}){e=e.filter(r=>r!==null);let n=e.map(r=>this.itemsActive[r]).includes(!1);for(let r of e)this.updateItem(r,n,{updateIfDisabled:t,callUpdateListeners:!1});this.updateListeners.call(this)}updateItem(e,t,{updateIfDisabled:n=!1,callUpdateListeners:r=!0}={}){this.itemsActive[e]=t,(!this.buttons[e].classList.contains("disabled")||n)&&this.buttons[e].setAttribute("aria-checked",t.toString()),r&&this.updateListeners.call(this)}activeQuizItemCount(){let e=this.activeForms(),t=0;for(let[n,r]of this.items.entries())this.itemsActive[n]&&(t+=r.countQuizItems(e));return t}scaleButtons(){for(let e of this.blocks){let t=e.indices.filter(n=>n!==null).map(n=>this.buttons[n]).filter(n=>!n.classList.contains("disabled"));l.scaleAllToFit(t.map(n=>n.querySelector(".symbol")),{containers:t,uniform:.75}),this.selectorData.label&&l.scaleAllToFit(t.map(n=>n.querySelector(".selector-item-label")),{containers:t,uniform:.75})}}processItemsActive(e){return!e||!Array.isArray(e)||e.length!==this.items.length?(e&&console.error("Invalid active items array. Must be boolean array of same length as items."),this.defaultItemsActive()):e.map(t=>([!0,!1,0,1].includes(t)||console.warn("Invalid itemsActive, should be array of booleans or 0s and 1s."),!!t))}setActive(e){if(!Array.isArray(e)||e.length!==this.items.length){console.error("Invalid active items.");return}for(let[t,n]of e.entries())this.updateItem(t,n,{callUpdateListeners:!1});this.itemsActive=e}defaultItemsActive(){let e=this.selectorData.defaultActive??"all";if(e==="all"||e==="none")return new Array(this.items.length).fill(e==="all");let t=new Array(this.items.length).fill(!1);if(e.substring(0,5)==="block")try{e=this.processIndices(e.substring(5)).map(r=>this.blocks[r].indices).flat()}catch(n){return console.error(n),t}if(!Array.isArray(e))return console.error("Invalid defaultActive."),t;for(let n of e)t[n]=!0;return t}getItemButton(e,t){let n=l.createElement("div.selector-item-button"),r=l.uniqueIdPrefix("selectorButton")+t.toString();l.setAttrs(n,{id:r,role:"checkbox",tabindex:"0","aria-checked":"false","aria-labelledby":r});let i=l.createElement("span.symbol.symbol-string");if(y.setFont(i,...this.dataset.getSelectorDisplayFont()),l.setAttrs(i,{lang:this.dataset.metadata.lang,dir:this.dataset.metadata.dir}),n.append(i),this.selectorData.label){let o=l.createElement("span.selector-item-label"),a=this.selectorData.label,c=e.properties[a.property];if(a.splitFirst??!0){let u=a.splitter??"[,;/]";c=c.split(new RegExp(`s*(${u})s*`))[0]}o.textContent=c,n.append(o)}return n.dataset.index=t.toString(),n}setupFormsSetting(e=null){if(!(this.formsData.showSetting??Object.keys(this.formsData.setting).length>1))return;let t=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");this.formsSetting=S.from(h.map(this.formsData.setting,n=>n.label),{label:t,exclusive:!!this.formsData.exclusive,checked:e??h.map(this.formsData.setting,n=>n.active)}),this.formsSetting.updateListeners.push(this.updateButtons.bind(this),()=>this.updateListeners.call(this)),this.node.prepend(this.formsSetting.node)}removeListeners(){for(let e of this.blocks)this.removeBlockListeners(e);this.removeDocumentRangeListeners(),this.removeDocumentLabelListeners()}activeForms(){if(!this.formsSetting)return Object.keys(this.formsData.setting);let e=[],t=this.formsSetting.value;this.formsSetting.exclusive&&(t=[t]);for(let n of t)"keys"in this.formsData.setting[n]?e.push(...this.formsData.setting[n].keys):e.push(n);return e}activeIndices(){return b.filterIndices(this.itemsActive,e=>e)}processIndices(e,t=!1){if(typeof e=="string")return this.parseRanges(e,t);if(typeof e=="number")return[e];if(!Array.isArray(e))throw new Error("Invalid indices datatype: need string, number or Array<number>.");e=e.sort();let n=e.length;return e=e.filter((r,i,o)=>i===0||r!==o[i-1]),e.length!==n&&console.warn("Indices contain duplicates."),e}parseRanges(e,t=!1){return[].concat(...e.split(",").map(n=>{if(t&&n.substring(0,3)==="gap"){let r=n.length===3?1:this.parseInt(n.substring(3));return new Array(r).fill(null)}return this.parseRange(n)}))}parseRange(e){let t=e.split(":").map(o=>this.parseInt(o));if(t.length===1)return t;if(t.length===0||t.length>3)throw new Error("Invalid range, 2-3 numbers.");let n=t[0],r=t[t.length-1],i=t.length===3?t[1]:1;if(r<n||i<1)throw new Error("Invalid range, must have start <= stop and step >= 1.");return w(n,r+1,i)}parseInt(e){let t=parseInt(e);if(isNaN(t))throw new Error("Not a number.");return t}};function ye(s,e){let t=s%e;return[Math.round((s-t)/e),t]}function te(s,e){return[Math.min(s,e),Math.max(s,e)]}var K={arabic:{name:"Arabic",file:"arabic.json"},elements:{name:"Atomic Elements",file:"elements.json"},cyrillic:{name:"Cyrillic",file:"cyrillic.json"},elder_futhark:{name:"Elder Futhark",file:"elder_futhark.json"},greek:{name:"Greek",file:"greek.json"},hebrew:{name:"Hebrew",file:"hebrew.json"},japanese:{name:"Japanese Kana",file:"japanese.json"},phoenician:{name:"Phoenician",file:"phoenician.json"}};l.registerTemplate("headingElement",'<div class="heading-element"><span class="heading-element-number"></span><span class="heading-element-symbol"></span></div>');var sn="./json/datasets/",Qe="elder_futhark",rn={gameHeading:"Kadmos",terms:{letter:"letter"},lang:"en",dir:"ltr"},Je=["letter","letters"],on={keys:["default"],setting:{default:{label:"Default",active:!0}},defaultForm:"default",singleForm:!0},an={languages:["en"],default:"en"},ln={en:"English",de:"German"},G=class{static _cache={};constructor(e){this.name=e.name,this.metadata=this.processMetadata(e.metadata),this.processFonts(e.fonts),this.displayData=e.displayData??{},this.displayData.type??="string",this.formsData=e.formsData??on,this.propsData=e.propsData,this.selectorData=e.selectorData??{},this.variantsData=this.processVariants(e.variantsData),this.languageData=e.languageData??an,this.languageData.default??=this.languageData.languages[0],this.items=this.processItems(e.symbolsData)}static fromKey(e){return e in K?e in this._cache?Promise.resolve(this._cache[e]):fetch(sn+K[e].file).then(t=>t.json()).then(t=>{let n=new this(t);return this._cache[e]=n,n}).catch(l.printError):(console.error(`Invalid dataset key "${e}".`),null)}processMetadata(e){return e=Object.assign({},rn,e),e.terms.letter??="letter",e.terms.letters??=e.terms.letter+"s",e}processVariants(e){if(!e)return null;for(let[t,n]of Object.entries(e.variants))typeof n=="string"&&(e.variants[t]={label:n});return e}getGameSettings(e){let t={};return this.hasPropsSetting()&&(t.properties=this.propertySetting(e.properties)),this.hasLanguageSetting()&&(t.language=this.languageSetting(e.language)),E.createFrom(t)}getFilterSettings(e){let t={};this.hasFormsSetting()&&(t.forms=this.formsSetting(e.forms)),this.hasVariantSetting()&&(t.variant=this.variantSetting(e.variant))}getSettings(e,t){return E.createFrom({properties:this.propertySetting(e),language:this.languageSetting(t)})}propertySetting(e=null){return S.from(h.map(this.propsData,t=>t.label),{label:"Properties",checked:e??h.map(this.propsData,t=>!!t.active)})}languageSetting(e=null){return S.from(h.onlyKeys(ln,this.languageData.languages),{label:"Language",checked:e??this.languageData.default,exclusive:!0})}formsSetting(e=null){let t=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");return S.from(h.map(this.formsData.setting,n=>n.label),{label:t,exclusive:!!this.formsData.exclusive,checked:e??h.map(this.formsData.setting,n=>n.active)})}variantSetting(e=null){let t=this.variantsData.variants;return C.createSelect(h.map(t,n=>n.label),{label:"Variants",selected:e??this.variantsData.default??Object.keys(t)[0],groups:t.groups??[]})}hasPropsSetting(){return this.propsData.keys.length>1}hasLanguageSetting(){return this.languageData.languages.length>1}hasVariantSetting(){return!!this.variantsData}hasFormsSetting(){return Object.keys(this.formsData.setting).length>1}hasFontSetting(){return Object.keys(this.fonts).length>1}getItemSelector(){return new q(this.items,this)}_getFont(e){return e?(typeof e=="string"&&(e={key:e}),e.key??=this._defaultFontKey,!e.key in this.fonts&&(console.error(`Unknown font key "${e.key}".`),e.key=this._defaultFontKey),Object.assign({},this.fonts[e.key],h.withoutKeys(e,["key"]))):this.defaultFont()}getFont(e){let t=h.withoutKeys(this._getFont(e),["default","label"]);return[t.family,t]}getFontFamily(e){return this.getFont(e)[0]}getSelectorDisplayFont(){return this.getFont(this.selectorData.font)}processFonts(e){this.fonts=e;let t=Object.entries(e).find(([n,r])=>r.default);this._defaultFontKey=t?t[0]:Object.keys(e)[0]}defaultFont(){return this.fonts[this._defaultFontKey]}fontSetting(e=null){let t=S.from(h.map(this.fonts,n=>n.label??n.family),{label:"Font",exclusive:!0,checked:e??this._defaultFontKey});return t.node.classList.add("font-family-setting"),t}processItems(e){let t=e.rows;if(!Array.isArray(t))throw new Error("symbol rows must be an array.");e.template&&this.applyTemplateToRows(t,e.template);let n=new Array(t.length),r;for(let[i,o]of t.entries()){try{r=this.processItem(o)}catch(a){console.warn("Error occured processing item with key",key),console.error(a);continue}n[i]=r}return n}applyTemplateToRows(e,t){for(let[n,r]of e.entries()){if(!Array.isArray(r))continue;let i={};for(let[o,a]of r.entries())i[t[o]]=a;e[n]=i}return e}processItem(e){return new ve(this.processDisplayForms(e.display),this.processItemProperties(e))}processItemProperties(e){let t={};for(let[n,r]of Object.entries(e))if(n.includes(":")){let i=n.split(":");if(i.length!==2){console.warn("Ignored invalid symbol key.");continue}let[o,a]=i;o==="p"?t[a]=r:console.warn("Ignored invalid tagged symbol key.")}return t}processDisplayForms(e){if(this.formsData.singleForm)return Object.fromEntries([[this.formsData.defaultForm,e]]);if(typeof e=="string"&&(e=e.split("")),Array.isArray(e)){let n={};for(let[r,i]of e.entries())i&&(n[this.formsData.keys[r]]=i);return n}if(typeof e!="object")throw new Error("Invalid display format: need array or object.");let t=Object.keys(e).filter(n=>!this.formsData.keys.includes(n));if(t.length>0)throw new Error(`Invalid display Form key "${t[0]}".`);return e}getQuizItems(e,t,n,r="default"){let i=[];for(let o of e){let a=this.items[o].getDisplayString(t),c=this.items[o].getItemProperties(n,this.propsData,r);i.push(...Object.entries(a).map(([u,d])=>new D(d,c,u)))}return i}referencePropsData(){let e=Object.assign({},this.propsData);for(let[t,n]of Object.entries(e))if("referenceMaxDist"in n){let r=Object.assign({},n);r.maxDist=n.referenceMaxDist,e[t]=r}return e}getReferenceItems(e,t="default"){let n,r=this.referencePropsData();if(this.formsData.exclusive){let i=this.items.map(a=>a.getItemProperties(e,r,t)),o={};for(let a of this.formsData.keys)o[a]=this.items.map((c,u)=>new D(c.getFormsDisplayString([a]),i[u],a));return o}else return n=this.items.map(i=>new D(i.getFormsDisplayString(this.formsData.keys),i.getItemProperties(e,r,t),"all")),Object.fromEntries(this.formsData.keys.map(i=>[i,n]))}setupGameHeading(e){let t=this.metadata.gameHeading;if(y.setFont(e,...this.getFont(t.font)),this.name==="Atomic Elements"){let n=document.createElement("div");n.classList.add("element-heading-container");let r=[];for(let[i,o]of[[19,"K"],[85,"At"],[42,"Mo"],[16,"S"]]){let a=l.getTemplate("headingElement");a.querySelector(".heading-element-symbol").textContent=o,a.querySelector(".heading-element-number").textContent=i,r.push(a)}n.replaceChildren(...r),e.replaceChildren(n)}else e.replaceChildren(t.string);e.setAttribute("lang",t.lang??this.metadata.lang),e.setAttribute("dir",t.dir??this.metadata.dir)}},ve=class{constructor(e,t){this.displayForms=e,this.properties=t}getDisplayString(e){return h.onlyKeys(this.displayForms,e)}getItemProperties(e,t,n="default"){let r={};for(let i of e){if(!(i in this.properties)){console.error(`Missing property key "${i}".`);continue}r[i]=this.properties[i]}if(n!=="default")for(let i of e){let o=i+"_"+n;this.properties[o]&&(r[i]=this.properties[o])}return h.map(r,(i,o)=>A.fromData(i,t[o]))}getFormsDisplayString(e){return Object.values(this.getDisplayString(e)).join("")}countQuizItems(e){return e.reduce((t,n)=>n in this.displayForms?t+1:t,0)}};var v=null,ne=null,x=null,g=null,p=null,Xe=null;function cn(){return E.createFrom({seed:C.createInput("text","Seed (optional)",{id:"game-seed"})})}function un(){let s=window.localStorage.getItem(rt());if(!s)return{};try{let e=JSON.parse(s);return typeof e.items=="string"&&(e.items=_.decodeBase64BoolArray(e.items)),e}catch(e){return console.error(e),{}}}function nt(){l.updateDOM(()=>{hn(),tt(!1)},{transition:!0}),dn(),mn(),window.addEventListener("popstate",tt),window.addEventListener("resize",()=>{p&&p.scaleButtons()})}function dn(){document.getElementById("start-game-button").addEventListener("click",it),document.getElementById("stop-game-button").addEventListener("click",()=>{v.finish()}),document.getElementById("item-submit-button").addEventListener("click",()=>{v.submitRound()}),document.getElementById("item-next-button").addEventListener("click",()=>{v.newRound()})}function hn(){let s=document.getElementById("datasetSelect");l.setOptions(s,h.map(K,e=>e.name)),s.addEventListener("change",e=>{let t=e.target.value;G.fromKey(t).then(n=>{st(t,n)}).catch(console.error)})}function mn(){Xe=E.createFrom({accentColor:gn(),colorMode:bn()}),document.querySelector("#page-settings .settings").replaceChildren(...Xe.nodeList()),document.getElementById("open-settings-button").addEventListener("click",()=>{l.updateDOM(fn,{types:["page-settings","ease-in"]})}),document.getElementById("close-settings-button").addEventListener("click",()=>{l.updateDOM(pn,{types:["page-settings","ease-out"]})})}function fn(){l.show(document.getElementById("page-settings-container")),document.documentElement.style.overflowY="hidden"}function pn(){l.hide(document.getElementById("page-settings-container")),document.documentElement.style.removeProperty("overflow-y")}function gn(){let s=window.localStorage.getItem("accentHue")||250;Ze(s);let e=F.create(0,360,s);return e.label("Accent Hue"),e.updateListeners.push(t=>Ze(t)),e.node.id="accentHueSlider",e}function Ze(s){document.documentElement.style.setProperty("--accent-hue",s),window.localStorage.setItem("accentHue",s)}function bn(){let s=window.matchMedia("(prefers-color-scheme: dark)"),e=window.localStorage.getItem("colorMode")||(s.matches?"dark":"light");Se(e,{transition:!1});let t=S.from({dark:"Dark Mode",light:"Light Mode"},{label:"Color Mode",exclusive:!0,checked:e});return s.addEventListener("change",n=>{let r=n.matches?"dark":"light";t.value=[r],Se(r,{transition:!1})}),t.updateListeners.push(n=>Se(n,{updateLocalStorage:!0})),t}function Se(s,{updateLocalStorage:e=!1,transition:t=!0}={}){if(s!=="dark"&&s!=="light")throw new Error(`Invalid color mode ${s}, use dark or light.`);l.updateDOM(()=>{l.classIfElse(s==="dark",document.documentElement,"dark-mode","light-mode")},{transition:t}),e&&window.localStorage.setItem("colorMode",s)}function st(s,e){x=e,ne=s,l.setSearchParams({dataset:s});let t=un(),n=x.metadata.gameHeading;return vn(t),Sn(t),l.updateDOM(()=>{yn(),T([x.getFontFamily(n.font),x.getSelectorDisplayFont()[0]]).then(()=>{x.setupGameHeading(document.querySelector("#game-heading h1")),document.getElementById("game-filters").replaceChildren(p.node),p.scaleButtons(),document.getElementById("game-settings").replaceChildren(...g.nodeList())}),l.showPage(document.getElementById("game-filters"),{transition:!1})},{transition:!0})}function yn(){for(let s of Je){let e=x.metadata.terms[s];document.querySelectorAll(".term-"+s).forEach(t=>{t.textContent=e})}}function vn(s){p&&p.removeListeners(),p=x.getItemSelector(),p.setup(s.items,s.forms,ne),p.updateListeners.push(et,xe),et()}function et(){l.setAttrs(document.querySelector(".pages-next-button"),{disabled:p.activeQuizItemCount()===0})}function Sn(s){g=x.getSettings(s.properties,s.language),g.extend(cn());for(let e of["language"]){let t=g.getSetting(e).buttonCount()===1;t&&l.hide(g.getNode(e)),l.classIfElse(t,g.getNode(e),"hidden")}g.getSetting("properties").disableIfSingleButton(!0),g.addUpdateListener(()=>{xe()})}function rt(s=ne){return"settings_"+s}function xe(){l.setSearchParams({dataset:ne}),window.localStorage.setItem(rt(),JSON.stringify({items:_.encodeBase64BoolArray(p.itemsActive),forms:p.activeForms(),properties:g.getValue("properties"),language:g.getValue("language")}))}function it(s){v&&v.cleanup(),xe();let e=g.getValue("properties"),t=g.getValue("language"),n=x.getQuizItems(p.activeIndices(),p.activeForms(),e,t),r=x.getReferenceItems(e,t);v=new ee(x,n,e,t);let i=g.getValue("seed");i&&v.seed(i),v.setReferenceItems(r),v.onFinish.push(()=>{we(!1)}),v.setup().then(()=>{v.newRound(),we(!0,s),v.focus()},o=>console.error(o))}function we(s,e=!0){l.updateDOM(()=>wn(s),{transition:e})}function wn(s){s||l.showPage(document.getElementById("game-filters"),{transition:!1}),l.toggleShown(s,[document.getElementById("game-container"),document.getElementById("stop-game-button"),document.getElementById("progress-bar")],[document.getElementById("new-game-settings")])}function tt(s=!0){let e=new URLSearchParams(location.search),t=e.get("dataset")??Qe;document.getElementById("datasetSelect").value=t,G.fromKey(t).then(n=>{st(t,n),["1","true"].includes(e.get("play"))?it(s):we(!1,s)})}(function(){xn(),nt(),document.querySelectorAll(".ribbon").forEach(s=>{In(s,s.classList.contains("ribbon-closable"))}),document.querySelectorAll(".pages-container").forEach(s=>{l.setupPages(s)})})();function xn(){let s=new URLSearchParams(location.search);["1","true"].includes(s.get("darkmode"))?document.documentElement.classList.add("dark-mode"):["1","true"].includes(s.get("lightmode"))&&document.documentElement.classList.add("light-mode")}function In(s,e=!1){let t=s.querySelector(".ribbon-contents"),n=s.querySelectorAll(".ribbon-buttons input[type=checkbox]");s.dataset.closable=e.toString();let r=s.dataset.openId;if(!r){for(let i of n)if(i.checked){r=i.dataset.contentId;break}}l.hide(t.querySelectorAll(".ribbon-content")),!r&&!e&&(r=n[0].dataset.contentId,n[0].checked=!0),r?l.show([document.getElementById(r),t]):e&&s.classList.add("contents-hidden"),s.querySelector(".ribbon-buttons").addEventListener("change",En)}function En(s){l.updateDOM(()=>{let e=s.target,t=e.closest(".ribbon"),n=t.querySelector(".ribbon-contents");if(e.checked){let r=t.dataset.openId;!t.classList.contains("contents-hidden")&&r&&(l.hide(document.getElementById(r)),t.querySelector(`.ribbon-buttons input[data-content-id="${r}"]`).checked=!1),t.dataset.openId=e.dataset.contentId,l.show([document.getElementById(e.dataset.contentId),n]),t.classList.remove("contents-hidden")}else t.dataset.closable==="true"?(t.classList.add("contents-hidden"),l.hide(n),t.dataset.openId=""):e.checked=!0},{transition:!0})}})();
//# sourceMappingURL=index.js.map
