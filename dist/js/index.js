(()=>{var qt=Object.defineProperty;var A=(n,t)=>{for(var e in t)qt(n,e,{get:t[e],enumerable:!0})};var d={};A(d,{extractKeys:()=>Vt,filter:()=>Gt,filterKeys:()=>Wt,map:()=>Z,mapKeyArrayToValues:()=>zt,mapKeys:()=>$t,onlyKeys:()=>tt,subsetToBoolRecord:()=>Jt,withoutKeys:()=>gt});var p={};A(p,{arraysEqual:()=>X,avg:()=>Ut,bisectLeft:()=>Y,cumSums:()=>Q,filterIndices:()=>Ht,range:()=>Kt,sum:()=>pt});function Q(n){return n.map((t=>e=>t+=e)(0))}function Y(n,t){let e=0,s=t.length,i;for(;e<s;)i=e+s>>1,t[i]<n?e=i+1:s=i;return e}function pt(n){return n.reduce((t,e)=>t+e,0)}function Ut(n){return n.length===0?(console.error("Cannot compute average of empty array."),0):pt(n)/n.length}function X(n,t){return n.length===t.length&&n.every((e,s)=>e===t[s])}function Ht(n,t){return Array.from(n.entries()).filter(([e,s])=>t(s,e,n)).map(([e,s])=>e)}function Kt(n,t=null,e=1){t===null&&(t=n,n=0);let s=Math.ceil((t-n)/e);return new Array(s).fill(0).map((i,r)=>n+e*r)}function Z(n,t){return Object.fromEntries(Object.entries(n).map(([e,s],i)=>[e,t(s,e,i)]))}function Gt(n,t){return Object.fromEntries(Object.entries(n).filter(([e,s],i)=>t(s,e,i)))}function Wt(n,t){return Object.entries(n).filter(([e,s],i)=>t(s,e,i)).map(([e,s])=>e)}function gt(n,t){let e=Object.assign({},n);for(let s of t)delete e[s];return e}function Vt(n,t,e=!0){let s=t.map(i=>n[i]??null);return e&&s.push(gt(n,t)),s}function tt(n,t,e=!1){let s=new Set(t),i={};for(let[r,o]of Object.entries(n))s.has(r)?i[r]=o:e&&console.warn(`Filtered out key "${r}".`);return i}function $t(n,t){return Object.fromEntries(Object.entries(n).map(([e,s])=>[t(e),s]))}function zt(n,t){return Object.fromEntries(n.map(e=>[e,t(e)]))}function Jt(n,t){if(n==="none")n=[];else if(n==="all")n=t;else if(typeof n=="string")throw new Error('Invalid subset string specifier - use "none" or "all".');if(Array.isArray(n)){let e=Object.fromEntries(t.map(s=>[s,!1]));for(let s of n)e[s]=!0;return e}return X(Object.keys(n).sort(),t.sort())||(console.log(n,t),console.warn("Subset object keys don't match keys list."),console.log(Object.keys(n).sort(),t.sort())),Object.fromEntries(t.map(e=>[e,!!n[e]]))}var l={};A(l,{addClass:()=>kt,appendChildren:()=>ee,batchUpdate:()=>ae,button:()=>Qt,classIfElse:()=>F,classesToList:()=>nt,computeScaleToFit:()=>rt,createElement:()=>Zt,elementSize:()=>it,forEachElement:()=>q,getTemplate:()=>et,hide:()=>B,htmlToElement:()=>Xt,htmlToElements:()=>It,label:()=>Yt,log:()=>ce,printError:()=>le,registerTemplate:()=>xt,registerTemplates:()=>St,removeClass:()=>ne,scaleAllToFit:()=>oe,scaleToFit:()=>re,setAttrOnKeys:()=>se,setAttrs:()=>wt,setDefaultId:()=>Lt,setOptions:()=>te,setSearchParams:()=>he,setupPages:()=>ue,show:()=>C,showPage:()=>M,toggleShown:()=>st,uniqueIdPrefix:()=>Et});var bt=0;window.hasTouch="ontouchstart"in window;var _={};function St(n){for(let[t,e]of Object.entries(n))xt(t,e)}function xt(n,t){n in _&&console.warn(`Overwriting existing template key ${n}.`);let e=document.createElement("TEMPLATE");typeof t=="string"?e.insertAdjacentHTML("beforeend",t):e.append(t),_[n]=e}function et(n){return n in _||console.error("Unknown template key "+n),_[n].firstChild.cloneNode(!0)}St({buttonLabel:'<label class="button"></label>',buttonInput:'<input class="button-check form-input" autocomplete="off">'});function Qt(n,t,e=null,s=null){let i=et("buttonInput"),r=et("buttonLabel");return s??=Et("button")+t,wt(i,{type:n,value:t,id:s}),r.setAttribute("for",s),e&&(typeof e=="string"&&(e=document.createTextNode(e)),r.appendChild(e)),[i,r]}function Yt(n,t,e=null){let s=document.createElement("LABEL");return n instanceof Node&&(n=Lt(n,e)),s.setAttribute("for",n),s.textContent=t,s}function It(n){let t=document.createElement("TEMPLATE");return t.innerHTML=n,t.content.children}function Xt(n){let t=It(n);if(t.length!==1)throw new Error("HTML doesn't contain exactly one element.");return t[0]}function Zt(n){let[t,...e]=n.split("."),[s,i]=t.split("#"),r=document.createElement(s);return i&&(r.id=i),r.classList.add(...e),r}function te(n,t,{selected:e=null,disabled:s=[],groups:i=[]}={}){e??=Object.keys(t)[0];let r=Z(t,()=>!1),o=null;for(let{label:a,keys:c}of i){let u=document.createElement("OPTGROUP");u.label=a;for(let h of c)u.append(yt(h,t[h],e,s)),r[h]=!0;n.add(u),o||(o=u)}for(let[a,c]of Object.entries(t))r[a]||n.add(yt(a,c,e,s),o)}function yt(n,t,e,s){let i=document.createElement("OPTION");return i.value=n,i.textContent=t,e===n&&(i.selected="selected"),s.includes(n)&&(i.disabled="disabled"),i}function ee(n,t){for(let e of t)n.appendChild(e)}function se(n,t,e,s=""){if(t){typeof t=="string"&&(t=[t]);for(let i of t)n[i].setAttribute(e,s)}}function wt(n,t){for(let[e,s]of Object.entries(t))typeof s=="boolean"?s?n.setAttribute(e,e):n.removeAttribute(e):e==="class"?kt(n,s):n.setAttribute(e,s)}function Et(n,t="_"){return bt+=1,n+bt+t}function Lt(n,t){return n.hasAttribute("id")?(n.id=t,t):n.id}function q(n,t){if(n)if(n instanceof Node)t(n);else for(let e of n)t(e)}function F(n,t,e,s=null){n||([e,s]=[s,e]),e=nt(e),s=nt(s),q(t,i=>{i.classList.remove(...s),i.classList.add(...e)})}function kt(n,t){F(!0,n,t)}function ne(n,t){F(!1,n,t)}function C(n,t="display"){q(n,e=>{e.style.removeProperty(t)})}var ie={display:"none",visibility:"hidden",opacity:"0"};function B(n,t="display"){q(n,e=>{e.style.setProperty(t,ie[t])})}function st(n,t,e=null,s="display"){n?(e&&B(e,s),C(t,s)):(B(t,s),e&&C(e,s))}function nt(n){return n??=[],typeof n=="string"?n.split(" "):Array.from(n)}function it(n,t="border-box",e=!1){let s=e?n.scrollWidth:n.clientWidth,i=e?n.scrollHeight:n.clientHeight,r=window.getComputedStyle(n),o=r.scale;return!o||o==="none"?o=1:o=parseFloat(o),t==="border-box"?(s+=o*(parseFloat(r.borderLeftWidth||0)+parseFloat(r.borderRightWidth||0)),i+=o*(parseFloat(r.borderTopWidth||0)+parseFloat(r.borderBottomWidth||0))):t==="content-box"?(s-=o*(parseFloat(r.paddingLeft||0)+parseFloat(r.paddingRight||0)),i-=o*(parseFloat(r.paddingTop||0)+parseFloat(r.paddingBottom||0))):t!=="padding-box"&&console.error("Invalid value for element size box, use padding-box, content-box or border-box."),[s,i]}function rt(n,{container:t=null,dimension:e="width",elementBox:s="border-box",containerBox:i="content-box",grow:r=!1}={}){t??=n.parentElement;let[o,a]=it(n,s,!0),[c,u]=it(t,i),h=vt(o,c,r),f=vt(a,u,r);return["width","height","both"].includes(e)||(console.error("Invalid dimension, use 'width', 'height' or 'both'."),e="width"),e==="width"?h:e==="height"?f:Math.min(h,f)}function re(n,t={}){n.style.scale=rt(n,t)}function oe(n,t={}){let e=t.uniform??0,s=t.containers??n.map(r=>r.parentElement);if("container"in t&&(console.warn("Can't set single container for scaleAllToFit."),delete t.container),!Array.isArray(s)||s.length!==n.length){console.error("Containers and elements length don't match.");return}let i=n.map((r,o)=>rt(r,Object.assign(t,{container:s[o]})));if(e>0){let o=Math.min(...i)/e;for(let[a,c]of i.entries())i[a]=Math.min(o,c)}for(let[r,o]of n.entries())o.style.scale=i[r]}function vt(n,t,e=!1){if(n===0)return console.warn("getScale: Element's size is 0."),1;if(isNaN(n))return console.error("Element size is NaN."),1;if(isNaN(t))return console.error("Container size is NaN."),1;let s=t/n;return e?s:Math.min(s,1)}function ae(n,t=[]){Promise.all(t.map(e=>document.fonts.load(`16px "${e}"`))).then(()=>{requestAnimationFrame(()=>{for(let[e,...s]of n)e(...s)})})}function le(n){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(n.toString(),document.createElement("br")),console.error(n)}function ce(...n){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(...n.map(e=>e.toString()),document.createElement("br")),console.log(...n)}function ue(n){M(n.querySelector(".page-content"),n),n.querySelector(".pages-next-button").addEventListener("click",()=>{M(document.getElementById(n.dataset.openPage).nextElementSibling,n)}),n.querySelector(".pages-back-button").addEventListener("click",()=>{M(document.getElementById(n.dataset.openPage).previousElementSibling,n)})}function M(n,t=null){t??=n.closest(".pages-container"),B(t.querySelectorAll(".page-content")),B(t.querySelectorAll(".page-heading")),C(n),C(t.querySelector(`.page-heading[data-for="${n.id}"]`)),t.dataset.openPage=n.id,st(!!n.previousElementSibling,t.querySelector(".pages-back-button")),st(!!n.nextElementSibling,t.querySelector(".pages-next-button"),t.querySelector(".pages-finish-button"))}function he(n){let t=new URL(location),e=!1;for(let[s,i]of Object.entries(n)){let r=encodeURIComponent(i);t.searchParams.get(s)!==r&&(t.searchParams.set(s,r),e=!0)}e&&history.pushState({},"",t)}function de(n){let t=1779033703,e=3144134277,s=1013904242,i=2773480762;for(let r=0;r<n.length;r++){let o=n.charCodeAt(r);t=e^Math.imul(t^o,597399067),e=s^Math.imul(e^o,2869860233),s=i^Math.imul(s^o,951274213),i=t^Math.imul(i^o,2716044179)}return t=Math.imul(s^t>>>18,597399067),e=Math.imul(i^e>>>22,2869860233),s=Math.imul(t^s>>>17,951274213),i=Math.imul(e^i>>>19,2716044179),t^=e^s^i,e^=t,s^=t,i^=t,[t>>>0,e>>>0,s>>>0,i>>>0]}function me(n,t,e,s){return function(){n|=0,t|=0,e|=0,s|=0;let i=(n+t|0)+s|0;return s=s+1|0,n=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,e=e+i|0,(i>>>0)/4294967296}}function fe(n){return me(...de(n))}var P=class{constructor(n=Math.random){this._rand=n}rand(n=null,t=null){return t===null?this._rand()*(n??1):(n??=0,this._rand()*(t-n)+n)}seed(n){this._rand=fe(n)}randInt(n,t){return Math.floor(this.rand(n,t))}shuffle(n){for(let t=n.length;t>0;t--){let e=this.randInt(t);e!==t-1&&([n[t-1],n[e]]=[n[e],n[t-1]])}}randIndexFromWeights(n){let t=Q(n);return Y(this.rand(t[t.length-1]),t)}};var b={};A(b,{clearFont:()=>Ft,getFontData:()=>be,setFont:()=>ge,setFontFamily:()=>Bt,setFontProperties:()=>at});var At=[{family:"Noto Serif Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Hebrew",scale:1.25,shift:-.15,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Rashi Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900"}},{family:"Noto Serif",fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Japanese",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Serif Japanese",fallback:"serif",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Sans Arabic",scale:.94,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Kufi Arabic",variationSettings:{wght:"100 900"}},{family:"Noto Naskh Arabic",variationSettings:{wght:"400 700"}},{family:"Noto Sans Phoenician"},{family:"Junicode",fallback:"serif",variationSettings:{wght:"300 700",wdth:"100",ENLA:"0"},styleset:{"Early-English-futhorc":12,"Elder-futhark":13,"Younger-futhark":14,"Long-branch-to-short-twig":15,"Latin-to-Gothic":19}}];var U=Object.fromEntries(At.map(n=>[n.family,n])),ot={family:"font-family",weight:"font-weight",scale:"--font-scale",shift:"--font-shift",styleset:"font-variant-alternates",letterSpacing:"--letter-spacing",lineHeight:"--line-height"},Ct=["shift","scale","letterSpacing"];function ge(n,t){if(Ft(n),!t.family)throw new Error("Key 'family' in properties required. Otherwise use setFontProperties instead.");let e=t.family;Bt(n,e);let s=Object.assign({},t),i=U[e];"shift"in i&&(s.shift=i.shift+(t.shift??0)),"scale"in i&&(s.scale=i.scale*(t.scale??1)),at(n,s)}function be(n){return U[n]}function at(n,t){let e=!1;for(let[s,i]of Object.entries(t))if(s!=="family"){if(!(s in ot)){console.warn(`Unknown font property '${s}'`);continue}Ct.includes(s)&&(e=!0),s==="styleset"?"family"in t?ye(n,i,t.family):console.error("Cannot set styleset without knowing family."):n.style.setProperty(ot[s],i)}F(e,n,"font-transform")}function Bt(n,t){let e=U[t];n.style.fontFamily=t+", "+(e.fallback??"system-ui, sans-serif"),at(n,tt(e,Ct))}function Ft(n){for(let t of Object.values(ot))n.style.removeProperty(t)}function ye(n,t,e){t=Array.isArray(t)?t:[t];let s=`styleset(${t.join(", ")})`;if(window.CSS.supports("font-variant-alternates",s))n.style.setProperty("font-variant-alternates",s);else{let r=t.map(o=>U[e].styleset[o]).map(o=>`"ss${o.toString().padStart(2,"0")}"`).join(", ");n.style.setProperty("font-feature-settings",r)}}var D={};A(D,{decodeBase64BoolArray:()=>Se,decodeBase64Number:()=>Dt,encodeBase64BoolArray:()=>ve,encodeBase64Number:()=>Pt});function ve(n){return Ot(xe(n))+"~"+Pt(n.length)}function Se(n){let[t,e]=n.split("~");return Ie(Nt(t),Dt(e))}function Pt(n){return Ot(we(n))}function Dt(n){return Ee(Nt(n))}function xe(n){let t=new Array(Math.ceil(n.length/6)),e;for(let s=0;s<t.length;s++){e=0;for(let i=0;i<6;i++)n[6*s+i]&&(e+=1<<i);t[s]=e}return t}function Ie(n,t){if(Math.ceil(t/6)!==n.length)throw new Error("Lengths of base 64 values and resultant length don't match.");let e=new Array(t);for(let[s,i]of n.entries())for(let r=0;r<6;r++){let o=6*s+r;if(o>=t)break;e[o]=(i&1<<r)!==0}return e}function we(n){let t=[];for(;n>0;)t.push(n&63),n>>=6;return t}function Ee(n){let t=0;for(let[e,s]of n.entries())t+=s<<6*e;return t}function Ot(n){return String.fromCharCode(...n.map(t=>Le(t)))}function Nt(n){let t=new Array(n.length);for(let e=0;e<n.length;e++)t[e]=ke(n.charCodeAt(e));return t}function Le(n){return n&=63,n<26?n+65:n<52?n+71:n<62?n+-5:n===62?45:95}function ke(n){if(n>=65&&n<91)return n-65;if(n>=97&&n<123)return n-97+26;if(n>=48&&n<58)return n-48+53;if(n===45)return 62;if(n===95)return 63;throw new Error("Unknown base 64 char code.")}var y=class{constructor(){this._funcs=[]}push(...t){this._funcs.push(...t)}remove(t){let e=this._funcs.indexOf(t);if(e!==-1)this._funcs.splice(e,1);else throw new Error(`Unknown func ${t}.`)}call(...t){for(let e of this._funcs)e.call(...t)}};var x=class{constructor(){this.settings={},this.keys=[]}static createFrom(t,e=null){let s=new this;return s.put(t,e),s}put(t,e=null){e??=Object.keys(t);for(let s of e)this.add(s,t[s])}extend(t){this.put(t.settings,t.keys)}add(t,e,s="end",i=null){if(this.settings[t]=e,s==="end")this.keys.push(t);else{let r;s==="begin"?r=0:(r=this.keys.indexOf(i),s==="afterKey"?r++:s!=="beforeKey"&&console.error("Invalid insert setting insert position.")),this.keys.splice(r,0,t)}}remove(t){this.settings[t].remove(),delete this.settings[t]}removeAll(){for(let t of Object.values(this.settings))t.remove();this.settings={},this.keys=[]}replace(t,e){this.settings[t].node.replaceWith(e.node),this.settings[t]=e}getValues(){return d.map(this.settings,t=>t.value)}setValues(t){for(let[e,s]of Object.entries(t))this.settings[e].value=s}getValue(t){return this.settings[t].value}getNode(t){return this.settings[t].node}getSetting(t){return this.settings[t]}nodeList(){return this.keys.map(t=>this.settings[t].node)}addUpdateListener(t,...e){if(typeof t=="function")for(let s of Object.values(this.settings))s.updateListeners.push(t,...e);else{typeof t=="string"&&(t=[t]);for(let s of t)this.settings[s].updateListeners.push(...e)}}},L=class{static idCount=0;static updateEvent="change";node;valueNode;constructor(t){let e;if(this.constructor.isValueNode(t))e=t;else if(e=t.querySelector("input, textarea, select"),!this.constructor.isValueNode(e))throw new Error("Couldn't find element of type input, textarea or select.");this.node=l.createElement("div.setting.labeled-value-element"),this.node.append(t),this.valueNode=e,this.updateListeners=new y,this._onChange=this._onChange.bind(this),this.valueNode.addEventListener(this.constructor.updateEvent,this._onChange)}static createInput(t,e=null,s=null){let i=document.createElement("INPUT");i.type=t,s&&l.setAttrs(i,s);let r=new this(i);return e&&r.label(e),r}static createSelect(t,e={}){let s=document.createElement("select");l.setOptions(s,t,e);let i=new this(s);return e.id&&i.setId(e.id),e.label&&i.label(e.label),i}static isValueNode(t){let e=t.tagName;return e==="SELECT"||e==="TEXTAREA"||e==="INPUT"&&t.type!=="hidden"}isCheckbox(){return this.valueNode.tagName==="INPUT"&&this.valueNode.type==="checkbox"}get value(){return this.isCheckbox()?this.valueNode.checked:this.valueNode.value}set value(t){this.isCheckbox()?this.valueNode.checked=t:this.valueNode.value=t}_onChange(){this.updateListeners.call(this,this.value)}setDisabled(t){this.valueNode.disabled=t}setId(t={prefix:""}){let e=typeof t=="string"?t:this.constructor.generateId(t.prefix);this.valueNode.id=e;let s=this.node.querySelector("label");return s&&(s.htmlFor=e),e}static generateId(t=""){return"ve_"+t+this.idCount.toString().padStart(4,"0")}label(t){if(!t)return;let e=this.node.querySelector("label");e||(e=document.createElement("label"),this.valueNode.id||this.setId(),e.htmlFor=this.valueNode.id,this.node.prepend(e)),e.textContent=t}remove(){this.valueNode.removeEventListener(this.constructor.updateEvent,this._onChange),this.node.remove()}};l.registerTemplate("buttonGroupContainer",l.createElement("fieldset.button-group"));var I=class{static nameCount=0;node;inputs;constructor(t,e,s=!1){this.node=t,this.updateListeners=new y,this.inputs=Object.fromEntries(Array.from(this.node.querySelectorAll("INPUT")).map(i=>[i.value,i])),this.exclusive=e,this.decheckable=s,this._onChange=this._onChange.bind(this),this.node.addEventListener("change",this._onChange)}static from(t,{exclusive:e=!1,name:s=null,checked:i=null,disabled:r=null,decheckable:o=!1,label:a=null}={}){Array.isArray(t)&&(t=Object.fromEntries(t.map(m=>[m,m])));let c=Object.keys(t),u=e?"radio":"checkbox";s??=this.generateName();let h=l.getTemplate("buttonGroupContainer");e&&(h.setAttribute("role","radiogroup"),typeof i=="string"&&(i=[i]),!o&&!i&&(i=[c[0]])),i=d.subsetToBoolRecord(i??"none",c),r=d.subsetToBoolRecord(r??"none",c);for(let[m,E]of Object.entries(t)){let[v,R]=l.button(u,m,E);v.name=e?s:`${s}_${m}`,v.disabled=r[m],v.checked=i[m],h.append(v,R)}e&&o&&h.addEventListener("click",m=>{m.target.tagName==="INPUT"&&m.target.checked&&(m.target.checked=!1)});let f=new this(h,e,o);return a&&f.label(a),f}static generateName(){return this.nameCount++,"buttongroup_"+this.nameCount.toString().padStart(4,"0")}_onChange(){this.updateListeners.call(this,this.value)}buttonCount(){return Object.keys(this.inputs).length}disableIfSingleButton(t=null){this.buttonCount()===1?(this.setDisabled(!0),t!==null&&(this.value=t?Object.keys(this.inputs):[])):this.setDisabled(!1)}get value(){if(this.exclusive&&!this.decheckable){for(let t of Object.values(this.inputs))if(t.checked)return t.value;return null}return d.filterKeys(this.inputs,t=>t.checked)}set value(t){t=d.subsetToBoolRecord(t,Object.keys(this.inputs));for(let[e,s]of Object.entries(this.inputs))s.checked=t[e]}setDisabled(t){for(let e of Object.values(this.inputs))e.disabled=t}label(t){let e=document.createElement("LEGEND");e.textContent=t,this.node.prepend(e)}remove(){this.node.addEventListener("change",this._onChange),this.node.remove()}};l.registerTemplate("slider",`<div class="slider-container">
    <span class="range-min"></span><span class="range-value"></span><span class="range-max"></span>
    <input type="range" class="form-range">
</div>`);var H=class extends L{static updateEvent="input";constructor(t,e,s){if(super(t),this.valueNode.tagName!=="INPUT"||this.valueNode.type!=="range")throw new Error("Couldn't find input type='range' element.");this.min=e,this.max=s,this.displayValue=this.displayValue.bind(this),this.updateProgress=this.updateProgress.bind(this),this.displayMinMax()}static create(t,e,s=null){let i=l.getTemplate("slider"),r=i.lastElementChild;r.min=t,r.max=e,r.setAttribute("step",1);let o=new this(i,t,e);return s!==null&&(o.value=s),o}_onChange(){super._onChange(),this.updateProgress(),this.displayValue()}updateProgress(){this.valueNode.style.setProperty("--range-progress",this.getProgress().toString())}getProgress(){return(this.value-this.min)/(this.max-this.min)}displayValue(){this.node.querySelector(".range-value").textContent=this.formatValue(this.value)}displayMinMax(){this.node.querySelector(".range-min").textContent=this.formatValue(this.min),this.node.querySelector(".range-max").textContent=this.formatValue(this.max)}isCheckbox(){return!1}set value(t){(this.min>t||this.max<t)&&console.warn("Slider value outside range."),super.value=t.toString(),this.displayValue(),this.updateProgress()}get value(){return parseFloat(this.valueNode.value)}formatValue(t){return(Math.round(t*100)/100).toString()}setMin(t){this.valueNode.value<t&&(this.valueNode.value=t,this._onChange()),this.min=t,this.valueNode.min=t,this.updateProgress(),this.displayMinMax()}setMax(t){this.valueNode.value>t&&(this.valueNode.value=t,this._onChange()),this.max=t,this.valueNode.max=t,this.updateProgress(),this.displayMinMax()}};var K=class{_punishFactor=2;_manualPunish=1;_previousDampFactor=.5;constructor(t){this.items=t,this.rng=new P;let e=this.itemCount=t.length;this.hitCount=0,this.scores=new Array(e).fill(0),this.tries=new Array(e).fill(0),this.triesLeft=new Array(e).fill(1),this.totalTriesLeft=e,this.maxTriesLeft=e,this.currentIndex=this.rng.randInt(0,e),this.previousIndex=null}seed(t){this.rng.seed(t)}currentItem(){return this.items[this.currentIndex]}nextItem(){return this.previousIndex=this.currentIndex,this.currentIndex=this.rng.randIndexFromWeights(this.getWeights()),this.currentItem()}getWeights(){let t=this.triesLeft.slice();return this.previousIndex!==null&&(t[this.previousIndex]*=this._previousDampFactor),t}updateTotalTriesLeft(){let t=p.sum(this.triesLeft);t>this.totalTriesLeft&&(this.maxTriesLeft+=t-this.totalTriesLeft),this.totalTriesLeft=t}progress(){return 1-this.totalTriesLeft/this.maxTriesLeft}enterScore(t){let e=++this.tries[this.currentIndex];e===1&&this.hitCount++,this.scores[this.currentIndex]=Math.max(this.scores[this.currentIndex],t*this.scoreAtTryFactor(e)),this.triesLeft[this.currentIndex]+=this._triesBoost(t)-1,this.triesLeft[this.currentIndex]<=0&&(this.triesLeft[this.currentIndex]=0,this.itemCount--),this.updateTotalTriesLeft()}isEmpty(){return this.itemCount===0}_triesBoost(t){return this._punishFactor*(1-t)}scoreAtTryFactor(t){return 1/t}getItemIndex(t){return this.items.indexOf(t)}punish(t,e=1){this.triesLeft[t]+=this._manualPunish*e,this.updateTotalTriesLeft()}absoluteScore(){return p.sum(this.scores)}scoreString(t="ratio"){let e=this.absoluteScore(),s=`${jt(e,1,2)}/${this.hitCount}`,i=this.hitCount>0?Tt(e/this.hitCount):Tt(0);if(t==="ratio")return s;if(t==="percent")return i;if(t==="both")return`${s} (${i})`;console.error(`Unknown mode: ${t}`)}};function Tt(n,t=0){return String(jt(n*100,t))+"%"}function jt(n,t=0,e=1){let s=Math.pow(10,t)*e;return Math.floor(n*s)/s}function O(n,t,e,s,i){return n<t||e<t?n>e?e+1:n+1:s===i?t:t+1}function lt(n,t){if(n===t)return 0;if(n.length>t.length){let _t=n;n=t,t=_t}let e=n.length,s=t.length;for(;e>0&&n.charCodeAt(e-1)===t.charCodeAt(s-1);)e--,s--;let i=0;for(;i<e&&n.charCodeAt(i)===t.charCodeAt(i);)i++;if(e-=i,s-=i,e===0||s<3)return s;let r=0,o,a,c,u,h,f,m,E,v,R,dt,mt,S=new Array(2*e);for(o=0;o<e;o++)S[2*o]=o+1,S[2*o+1]=n.charCodeAt(i+o);let ft=S.length-1;for(;r<s-3;)for(v=t.charCodeAt(i+(a=r)),R=t.charCodeAt(i+(c=r+1)),dt=t.charCodeAt(i+(u=r+2)),mt=t.charCodeAt(i+(h=r+3)),f=r+=4,o=0;o<ft;o+=2)m=S[o],E=S[o+1],a=O(m,a,c,v,E),c=O(a,c,u,R,E),u=O(c,u,h,dt,E),f=O(u,h,f,mt,E),S[o]=f,h=u,u=c,c=a,a=m;for(;r<s;)for(v=t.charCodeAt(i+(a=r)),f=++r,o=0;o<ft;o+=2)m=S[o],S[o]=f=O(m,a,f,v,S[o+1]),a=m;return f}var k=class{constructor(t,e,s){this.displayString=t,this.properties=e,this.form=s}},w=class{constructor(t,e){this.value=t,this.maxDist=e,this.displayString=typeof t=="string"?t:t.toString()}static fromData(t,e){let s=e.maxDist??0,i=e.type;if(i==="number")return new ct(t,s,e.distanceMode??"linear");if(i==="string")return new G(t,s,e.caseSensitive??!1,e.substitutions??{});if(i==="list"){let r,o={};return typeof t=="string"?r=t:("source"in t||console.error("Source of list property missing."),r=t.source,"alts"in t&&(o=t.alts)),new N(r,s,o,e)}else console.error(`Unknown property type "${e.type}"`)}grade(t){let e=this.gradeSingle(t,this.value);return[e,t.length>0?[this.markGradedText(t,e)]:[],[this.markGradedText(this.displayString,e)]]}static passes(t){return t>=.5}gradeSingle(t,e){let s=this.distance(t,e);return s<=this.maxDist?this.maxDist===0?1:Math.pow(2,-s/this.maxDist):0}markGradedText(t,e){let s=document.createElement("SPAN");return s.dataset.correct=e===1?"true":e>0?"partially":"false",s.textContent=t,s}distance(t,e){console.error("Not implemented.")}},ct=class extends w{constructor(t,e,s="linear"){let i,r;typeof t=="string"?(i=parseFloat(t),isNaN(i)&&console.error(`Invalid number property value "${t}"`),r=t):(i=t,r=t.toString()),s==="log"&&i===0&&console.error('Invalid value 0 for NumberProperty with distanceMode "log"'),super(i,e),this.displayString=r,this.distanceMode=s}distance(t,e){return this.distanceMode==="linear"?Math.abs(t-e):Math.abs(Math.log(t/e))}},G=class extends w{constructor(t,e,s=!1,i={}){super(t,e),this.caseSensitive=s,this.substitutions=i}distance(t,e){return lt(this.standardizeString(t),this.standardizeString(e))}standardizeString(t){t=t.trim();for(let[e,s]of Object.entries(this.substitutions))t=t.replaceAll(new RegExp(e,"g"),s);return t=t.normalize("NFKD").replaceAll(/\p{M}/gu,""),this.caseSensitive||(t=t.toLowerCase()),t}},N=class extends G{constructor(t,e,s={},{listMode:i="best",caseSensitive:r=!1,splitter:o="[,;/]",excludeFromList:a=["\\(.*?\\)"],substitutions:c={}}){t=t.trim(),super(t,e,r,c),this.splitter=o,this.values=this.constructor.getValues(t,e,this.splitter,a),s?this.alternatives=d.map(s,u=>typeof u=="string"?[u]:u):this.alternatives={},this.listMode=i}static getValues(t,e,s,i){let r=[new W(t)];for(let o of[...i,s])r=r.map(a=>a.split(o)).flat().map(a=>a.trim()).filter(a=>a.end>a.start);return r.length===0&&console.warn("No values in list."),r}grade(t){let e=new W(t).split(this.splitter).map(o=>o.trim()),s=new Array(e.length).fill(0),i=new Array(this.values.length).fill(0);for(let[o,a]of this.values.entries())for(let[c,u]of e.entries()){let h=this.gradeSingle(u.str,a.str);a.str in this.alternatives&&(h=Math.max(h,...this.alternatives[a.str].map(f=>this.gradeSingle(u.str,f)))),h>0&&(s[c]>0&&console.warn("Guess matches multiple values, maxDist too high."),i[o]=Math.max(i[o],h),s[c]=Math.max(s[c],h))}return[this.listMode==="best"?Math.max(...i):p.avg(s),this.markSubStrings(e,s),this.markSubStrings(this.values,i)]}markSubStrings(t,e){if(t.length===0)return[];let s=t[0].source,i=[],r=0;for(let[o,a]of t.entries())r<a.start&&i.push(document.createTextNode(s.substring(r,a.start))),a.start<a.end&&(i.push(this.markGradedText(a.str,e[o])),r=a.end);return r<s.length&&i.push(document.createTextNode(s.substring(r))),i}},W=class n{constructor(t,e=0,s=null){t instanceof n&&(e+=t.start,s===null?s=t.end:s+=t.start,t=t.source),s===null&&(s=t.length),this.source=t,this.str=t.substring(e,s),this.start=e,this.end=s}split(t,e=!1){let s=[],i=this.str.matchAll(t),r=0;for(let o of i)!e&&r===o.index||(s.push(new this.constructor(this,r,o.index)),r=o.index+o[0].length);return(e||r<this.end-this.start)&&s.push(new this.constructor(this,r)),s}trim(){let t=this.str.match(/^\s*/)[0].length,e=this.str.match(/\s*$/)[0].length;return t===0&&e===0?this:new this.constructor(this.source,this.start+t,this.end-e)}};l.registerTemplates({eval:`<div class="item-eval">
    <span class="submitted"></span><span class="solution"></span>
</div>`,symbolContainer:`<div class="symbol-container">
    <div class="symbol-display-container"><span class="symbol"></span></div>
    <div class="symbol-label-container"><span class="symbol-label"></span></div>
</div>`});var V=class{constructor(t,e,s,i){this.dataset=t,this.properties=s,this.language=i,this.dealer=new K(e),this.onFinish=new y,this.updateProgressBar(),this.onInputKeydown=this.onInputKeydown.bind(this),this._show=this._show.bind(this),this.updateSymbolFontFamily=this.updateSymbolFontFamily.bind(this)}setup(){this.setupSymbolContainer(),this.setupInputs(),this.setupEvals(),this.setupFontSettings(),document.getElementById("item-next-button").textContent="Next"}getInputMode(t){return t==="real"||t==="integer"?"numeric":"text"}setupSymbolContainer(){let t=document.querySelector("#symbol-current .symbol");t.classList.add("symbol-"+this.dataset.displayData.type),t.setAttribute("lang",this.dataset.metadata.lang),t.setAttribute("dir",this.dataset.metadata.dir)}setupInputs(){this.inputs=d.mapKeyArrayToValues(this.properties,e=>{let s=document.createElement("INPUT");return l.setAttrs(s,{type:"text",inputmode:this.getInputMode(this.dataset.propsData[e].type),placeholder:this.dataset.propsData[e].label}),this.language&&this.language!=="default"&&s.setAttribute("lang",this.language),s});let t=document.getElementById("game-inputs");t.replaceChildren(...Object.values(this.inputs)),t.addEventListener("keydown",this.onInputKeydown)}onInputKeydown(t){let e=t.target.closest("INPUT");e&&(t.key==="Enter"?e.nextElementSibling?e.nextElementSibling.focus():document.getElementById("item-submit-button").focus():t.key==="Backspace"&&t.target.value===""&&e.previousElementSibling&&(e.previousElementSibling.focus(),t.preventDefault()))}setupEvals(){this.evals={};let t=document.getElementById("game-evals");for(let e of this.properties){let s=l.getTemplate("eval");this.evals[e]=s,t.append(s)}}updateSymbolWeight(t){document.querySelector("#game-symbols").style.setProperty("--symbol-weight",t.toString())}updateSymbolFontFamily(t){document.querySelectorAll("#game-symbols .symbol-string").forEach(e=>{this.setSymbolFont(e,t)}),this.updateSymbolWeightRange(t)}updateSymbolWeightRange(t){let e=this.dataset.getFont(t),s=b.getFontData(e.family),i=this.fontSettings.settings.weight;if(s.variationSettings&&s.variationSettings.wght){let[r,o]=s.variationSettings.wght.split(" ").map(a=>parseInt(a,10));i.setMin(r),i.setMax(o),l.show(i.node)}else l.hide(i.node)}setupFontSettings(){let t=this.dataset.displayData.defaultWeight??500,e=H.create(100,900,t);e.label("Weight"),this.fontSettings=x.createFrom({family:this.dataset.fontSetting(),weight:e}),document.querySelector("#font-settings").replaceChildren(...this.fontSettings.nodeList()),this.fontSettings.addUpdateListener("weight",this.updateSymbolWeight),this.fontSettings.addUpdateListener("family",this.updateSymbolFontFamily),this.updateSymbolFontFamily(this.fontSettings.getValue("family")),this.updateSymbolWeight(t)}setSymbolFont(t,e){b.setFont(t,this.dataset.getFont(e))}setReferenceItems(t){this.referenceItems=t}seed(t){this.dealer.seed(t)}cleanup(){this.clearItemDisplay(),this.updateProgressBar(0),document.getElementById("game-inputs").removeEventListener("keydown",this.onInputKeydown),document.getElementById("game-inputs").replaceChildren(),document.getElementById("game-evals").replaceChildren()}finish(){setTimeout(()=>this.cleanup(),100),this.onFinish.call(this)}currentItem(){return this.dealer.currentItem()}submitRound(){let t=0,e=this.currentItem();for(let[s,i]of Object.entries(this.inputs)){let r=this.evals[s],o=e.properties[s],[a,c,u]=o.grade(i.value);if(t+=a,!w.passes(a)){let h=this.getReferenceItems(e.form,s,i.value);if(h.length>0){let f=this.referenceItemsNodes(h,s);document.getElementById("game-symbols").append(...f),this.updateSymbolFontFamily(this.fontSettings.getValue("family"));for(let m of f)this.scaleItemNodeContents(m);for(let m of h)this.dealer.punish(this.dealer.getItemIndex(m),1/h.length)}}r.querySelector(".submitted").replaceChildren(...c),r.querySelector(".solution").replaceChildren(...u),l.classIfElse(o instanceof N&&o.listMode==="best",r,"best-mode")}t/=this.properties.length,this.dealer.enterScore(t),this.updateProgressBar(),this.dealer.isEmpty()&&(document.getElementById("item-next-button").textContent="Finish"),this.show("evals"),window.scrollY>0&&window.scrollTo({top:0,behavior:"smooth"})}getReferenceItems(t,e,s){if(!this.referenceItems)return[];let i=[],r=[];for(let o of this.referenceItems[t]){let a=o.properties[e].grade(s)[0];w.passes(a)&&(i.push(o),r.push(r))}return Math.max(...r)===1?i.filter((o,a)=>r[a]===1):i}referenceItemsNodes(t,e){return t.map(s=>this.referenceItemNode(s,e))}referenceItemNode(t,e){let s=l.getTemplate("symbolContainer");return s.classList.add("symbol-reference"),s.querySelector(".symbol").classList.add("symbol-"+this.dataset.displayData.type),this.updateItemNode(s,t,e,!1),s}updateItemNode(t,e,s=null,i=!0){s??=this.properties[0],t.querySelector(".symbol").textContent=e.displayString,t.querySelector(".symbol-label").textContent=e.properties[s].displayString,i&&this.scaleItemNodeContents(t)}scaleItemNodeContents(t){l.scaleToFit(t.querySelector(".symbol")),l.scaleToFit(t.querySelector(".symbol-label"))}clearInputs(){for(let t of Object.values(this.inputs))t.value=""}show(t){this.shown=t,requestAnimationFrame(this._show)}_show(){l.toggleShown(this.shown==="inputs",[document.getElementById("game-inputs"),document.getElementById("item-submit-button")],[document.getElementById("game-evals"),document.getElementById("item-next-button")]),l.toggleShown(this.shown==="inputs",null,document.querySelector("#symbol-current .symbol-label"),"visibility"),this.shown==="inputs"?(document.querySelectorAll("#game-symbols .symbol-reference").forEach(t=>{t.remove()}),this.focus()):document.getElementById("item-next-button").focus()}updateProgressBar(t=null){t??=this.dealer.progress(),document.getElementById("progress-bar").style.setProperty("--progress",t)}newRound(){if(this.dealer.isEmpty()){this.finish();return}this.dealer.nextItem(),this.displayItem(this.currentItem()),this.clearInputs(),this.show("inputs")}focus(){this.inputs[this.properties[0]].focus({preventScroll:!0})}displayItem(t){this.updateItemNode(document.getElementById("symbol-current"),t)}clearItemDisplay(){document.querySelector("#symbol-current .symbol").textContent="",document.querySelector("#symbol-current .symbol-label").textContent=""}};var g=p.range,Rt={buttonMinWidth:"--button-min-width",buttonMaxWidth:"--button-max-width",symbolSize:"--symbol-size",labelGap:"--label-gap",symbolMinWidth:"--symbol-min-width"},Ae=["mode","indices","transpose","nColumns","dblClickGroups","rowLabels","columnLabels","rowLabelPosition","columnLabelPosition","rangeSelectionMode"],T=class{constructor(t,e){this.items=t,this.dataset=e,this.formsData=e.formsData,this.selectorData=e.selectorData,this.updateListeners=new y,this.onBlockLabelClick=this.onBlockLabelClick.bind(this),this.onBlockButtonClick=this.onBlockButtonClick.bind(this),this.onBlockLabelPointerOverOut=this.onBlockLabelPointerOverOut.bind(this),this.onBlockLabelPointerDown=this.onBlockLabelPointerDown.bind(this),this.onBlockLabelPointerUpCancel=this.onBlockLabelPointerUpCancel.bind(this),this.onBlockRangePointerDown=this.onBlockRangePointerDown.bind(this),this.onBlockRangePointerMove=this.onBlockRangePointerMove.bind(this),this.onBlockRangePointerUpCancel=this.onBlockRangePointerUpCancel.bind(this)}setup(t=null,e=null,s=null){this.node=l.createElement("div.item-selector"),s&&this.node.setAttribute("data-dataset",s),this.setupFormsSetting(e),this.setupButtons(),this.setupBlocks(),this.setActive(this.processItemsActive(t)),this.updateButtons(!1)}setupButtons(){this.itemsActive=new Array(this.items.length).fill(!1),this.buttons=this.items.map((t,e)=>this.getItemButton(t,e.toString()))}setupBlocks(){let t=this.selectorData.block?[this.selectorData.block]:this.selectorData.blocks?this.selectorData.blocks:[{mode:"flex"}];this.blocks=t.map(s=>d.onlyKeys(s,Ae,!0));let e=this.processIndexSubsets(t.map(s=>s.indices??"rest"),this.items.length,!0);for(let[s,i]of this.blocks.entries()){i.node=l.createElement("div.selector-block"),i.indices=e[s],this.standardizeBlockIndices(i),i.elements=[];for(let[r,o]of i.indices.entries()){let a=o===null?this._gridGapElement():this.buttons[o];i.elements.push(a),i.node.append(a),a.dataset.indexWithinBlock=r}i.mode==="grid"?(i.node.classList.add("selector-block-grid"),i.node.style.setProperty("--columns",i.nColumns)):(i.node.classList.add("selector-block-flex"),this.dataset.metadata.dir==="rtl"&&i.node.classList.add("flex-rtl")),this.selectorData.label&&this.selectorData.label.position==="right"&&this.node.classList.add("labels-right"),i.node.setAttribute("data-block-index",s.toString()),this.applyBlockStyle(i,this.selectorData.style,i.style),this.processListenerIndices(i),this.setupBlockListeners(i),this.node.append(i.node);try{this.addBlockLabels(i)}catch(r){console.error("Error occured while trying to add block labels."),console.error(r)}}}addBlockLabels(t){let e=t.nColumns,s=Math.round(t.indices.length/e);if(t.rowLabels){if(typeof t.rowLabels=="string"&&(t.rowLabels=t.rowLabels.split("")),!Array.isArray(t.rowLabels)||t.rowLabels.length!==s)throw new Error("Row labels no array or don't match number of rows.");let[i,r,o]=this._processLabelPosition(t.rowLabelPosition);[t.rowLabelStart,t.rowLabelEnd]=[r,o],t.node.classList.add(`has-row-labels-${i}`);for(let[a,c]of t.rowLabels.entries()){let u=this._labelElement("row",c,a);t.rowLabelStart&&t.elements[a*e].insertAdjacentElement("beforebegin",u),t.rowLabelEnd&&(t.rowLabelStart&&(u=u.cloneNode(!0)),a===e-1?t.node.insertAdjacentElement("beforeend",u):t.elements[a*(e+1)].insertAdjacentElement("beforebegin",u))}}if(t.columnLabels){if(typeof t.columnLabels=="string"&&(t.columnLabels=t.columnLabels.split("")),!Array.isArray(t.columnLabels)||t.columnLabels.length!==e)throw new Error("Column labels no array or don't match number of columns.");let[i,r,o]=this._processLabelPosition(t.columnLabelPosition);[t.columnLabelStart,t.columnLabelEnd]=[r,o];let a=t.columnLabels.map((c,u)=>this._labelElement("column",c,u));"rowLabels"in t&&(t.rowLabelStart&&a.splice(0,0,this._gridGapElement()),t.rowLabelEnd&&a.push(this._gridGapElement())),t.columnLabelStart&&t.node.prepend(...a),t.columnLabelEnd&&(t.columnLabelStart&&(a=a.map(c=>c.cloneNode(!0))),t.node.append(...a))}}applyBlockStyle(t,...e){let s=Object.assign({},...e);"buttonWidth"in s&&(s.buttonMinWidth=s.buttonWidth,s.buttonMaxWidth=s.buttonWidth,delete s.buttonWidth);for(let[i,r]of Object.entries(s))i in Rt||console.error(`Invalid selector block style property ${i}.`),t.node.style.setProperty(Rt[i],r)}_gridGapElement(){return l.createElement("span.selector-grid-gap")}_labelElement(t,e,s){if(e===null)return this._gridGapElement();let i=l.createElement(`span.block-label.block-${t}-label`);return i.textContent=e,i.dataset.index=s.toString(),i}getButtonsFromIndices(t){return t?t.filter(e=>e!==null).map(e=>this.buttons[e]):[]}buttonsClassIfElse(t,e,s,i=null){l.classIfElse(t,this.getButtonsFromIndices(e),s,i)}buttonsRemoveClass(t,e){l.removeClass(this.getButtonsFromIndices(t),e)}buttonsAddClass(t,e){l.addClass(this.getButtonsFromIndices(t),e)}_processLabelPosition(t){return t??="start",t==="both"?[t,!0,!0]:t==="end"?[t,!1,!0]:(t!=="start"&&console.error("Invalid label position, use 'start', 'end' or 'both'."),["start",!0,!1])}processListenerIndices(t){t.mode==="grid"&&(t.indicesByRow=g(t.nRows).map(e=>g(t.nColumns).map(s=>t.indices[e*t.nColumns+s]).filter(s=>s!==null)),t.indicesByColumn=g(t.nColumns).map(e=>g(t.nRows).map(s=>t.indices[s*t.nColumns+e]).filter(s=>s!==null))),t.dblClickGroups??=[g(t.indices.length)],t.dblClickGroups=this.processIndexSubsets(t.dblClickGroups,t.indices.length);for(let[e,s]of t.dblClickGroups.entries())for(let i of s)t.elements[i].dataset.dblClickGroup=e;t.dblClickGroups=t.dblClickGroups.map(e=>e.map(s=>t.indices[s]).filter(s=>s!==null))}setupBlockListeners(t){t.node.addEventListener("click",this.onBlockButtonClick),this.resetRangeSelection(),t.node.addEventListener("pointerdown",this.onBlockRangePointerDown),t.mode==="grid"&&(t.node.addEventListener("click",this.onBlockLabelClick),t.node.addEventListener("pointerover",this.onBlockLabelPointerOverOut),t.node.addEventListener("pointerout",this.onBlockLabelPointerOverOut),t.node.addEventListener("pointerdown",this.onBlockLabelPointerDown))}removeBlockListeners(t){t.node.removeEventListener("click",this.onBlockButtonClick),t.node.removeEventListener("pointerdown",this.onBlockRangePointerDown),t.node.removeEventListener("pointermove",this.onBlockRangePointerMove),t.mode==="grid"&&(t.node.removeEventListener("click",this.onBlockLabelClick),t.node.removeEventListener("pointerover",this.onBlockLabelPointerOverOut),t.node.removeEventListener("pointerout",this.onBlockLabelPointerOverOut),t.node.removeEventListener("pointerdown",this.onBlockLabelPointerDown))}onBlockButtonClick(t){let e=t.target.closest(".selector-item-button, .selector-grid-gap");if(!e)return;let s=this.getBlockIndexFromEvent(t);if(t.detail%2===0&&this.lastBlockClicked===s&&this.lastButtonClicked===e.dataset.indexWithinBlock){let i=this.getBlockFromEvent(t),r=e.dataset.dblClickGroup,o=i.dblClickGroups[r];this.toggleItems(o)}this.lastButtonClicked=e.dataset.indexWithinBlock,this.lastBlockClicked=s}getBlockIndexFromEvent(t){let e=t.target.closest(".selector-block");return e?e.dataset.blockIndex:null}getBlockFromEvent(t){let e=this.getBlockIndexFromEvent(t);return e!==null?this.blocks[e]:null}getIndicesFromBlockLabelEvent(t){let e=t.target.closest(".block-label");if(!e)return;let s=e.classList.contains("block-row-label")?"indicesByRow":"indicesByColumn",i=e.dataset.index;return this.getBlockFromEvent(t)[s][i]}onBlockLabelClick(t){let e=this.getIndicesFromBlockLabelEvent(t);e&&this.toggleItems(e)}onBlockLabelPointerOverOut(t){let e=this.getIndicesFromBlockLabelEvent(t);e&&this.buttonsClassIfElse(t.type==="pointerover",e,"hover")}onBlockLabelPointerDown(t){let e=this.getIndicesFromBlockLabelEvent(t);e&&(this.buttonsAddClass(e,"active"),this.blockLabelActiveIndices=e,document.addEventListener("pointerup",this.onBlockLabelPointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockLabelPointerUpCancel,{once:!0}))}onBlockLabelPointerUpCancel(){let t=this.blockLabelActiveIndices;t&&this.buttonsRemoveClass(t,"active"),this.blockLabelActiveIndices=null,this.removeDocumentLabelListeners()}resetRangeSelection(){this.rangeSelectingBlockIndex=null,this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=null,this.rangeSelectStartIndex=null,this.rangeSelectStopIndex=null,this.rangeSelectionActiveIndices=null}onBlockRangePointerMove(t){if(this.rangeSelectingBlockIndex===null)return;let s=document.elementFromPoint(t.clientX,t.clientY).closest(".selector-item-button, .selector-grid-gap");if(!s||s.closest(".selector-block").dataset.blockIndex!==this.rangeSelectingBlockIndex)return;let r=s.dataset.indexWithinBlock;this.rangeSelectStopIndex!==r&&(this.rangeSelectStartIndex??=r,this.rangeSelectStopIndex=r,this.updateRangeSelection())}onBlockRangePointerDown(t){let e=this.getBlockIndexFromEvent(t);if(e===null)return;this.rangeSelectingBlockIndex=e;let s=t.target.closest(".selector-item-button, .selector-grid-gap");s&&(this.rangeSelectStartIndex=s.dataset.indexWithinBlock,this.rangeSelectStopIndex=this.rangeSelectStartIndex,this.updateRangeSelection()),document.addEventListener("pointerup",this.onBlockRangePointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockRangePointerUpCancel,{once:!0}),this.blocks[e].node.addEventListener("pointermove",this.onBlockRangePointerMove)}onBlockRangePointerUpCancel(t){this.rangeSelectingBlockIndex!==null&&(t.type==="pointerup"&&this.getBlockIndexFromEvent(t)===this.rangeSelectingBlockIndex&&this.rangeSelectionActiveIndices&&this.toggleItems(this.rangeSelectionActiveIndices),this.blocks[this.rangeSelectingBlockIndex].node.removeEventListener("pointermove",this.onBlockRangePointerMove),this.removeDocumentRangeListeners(),this.resetRangeSelection())}removeDocumentLabelListeners(){document.removeEventListener("pointerup",this.onBlockLabelPointerUpCancel),document.removeEventListener("pointercancel",this.onBlockLabelPointerUpCancel)}removeDocumentRangeListeners(){document.removeEventListener("pointerup",this.onBlockRangePointerUpCancel),document.removeEventListener("pointercancel",this.onBlockRangePointerUpCancel)}updateRangeSelection(){this.rangeSelectionActiveIndices&&this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=this.getIndicesInRangeSelection(),this.buttonsAddClass(this.rangeSelectionActiveIndices,"active")}getIndicesInRangeSelection(){if(this.rangeSelectStartIndex===null||this.rangeSelectStopIndex===null)return[];let[t,e]=$(this.rangeSelectStartIndex,this.rangeSelectStopIndex),s=this.blocks[this.rangeSelectingBlockIndex];if(s.mode==="grid")if(s.rangeSelectionMode??="grid",s.rangeSelectionMode==="grid"){let[i,r]=ut(t,s.nColumns),[o,a]=ut(e,s.nColumns);return[i,o]=$(i,o),[r,a]=$(r,a),g(i,o+1).map(c=>g(c*s.nColumns+r,c*s.nColumns+a+1)).flat().map(c=>s.indices[c])}else if(s.rangeSelectionMode==="walkColumns"){let i=this.transposeIndex(t,s.nRows,s.nColumns),r=this.transposeIndex(e,s.nRows,s.nColumns);[i,r]=$(i,r);let o=this.transposedRange(s.nColumns,s.nRows);return g(i,r+1).map(a=>o[a]).map(a=>s.indices[a])}else s.rangeSelectionMode!=="walkRows"&&console.error("Invalid range selection mode, use grid, walkRows or walkColumns.");return g(t,e+1).map(i=>s.indices[i])}standardizeBlockIndices(t){if(t.mode==="grid"){if(!t.nColumns)throw new Error("Block columns not set.");t.nRows=Math.ceil(t.indices.length/t.nColumns);let e=t.indices.length%t.nColumns;if(e!==0){let s=t.nColumns-e;t.indices.push(...new Array(s).fill(null))}t.transpose&&this.transposeBlock(t)}}transposeBlock(t){t.indices=this.transposeIndices(t.indices,t.nRows,t.nColumns)}transposeIndices(t,e,s){if(t.length!==e*s)throw new Error("Dimensions don't match.");return this.transposedRange(e,s).map(i=>t[i])}transposedRange(t,e){return g(t*e).map(s=>this.transposeIndex(s,t,e))}transposeIndex(t,e,s){let[i,r]=ut(t,s);return r*e+i}processIndexSubsets(t,e,s=!1){let i=[],r=new Array(e).fill(!1);for(let[a,c]of t.entries()){if(c==="rest"){a!==t.length-1&&console.error("Can only have subset 'rest' at the end."),i.push(p.filterIndices(r,h=>!h));break}let u=[];for(let h of this.processIndices(c,s))if(u.push(h),h!==null){if(r[h])throw new Error(`Duplicate subset index ${h}.`);r[h]=!0}i.push(u)}let o=p.filterIndices(t,a=>!a);if(o.length!==0)throw new Error(`Not all indices were covered: missing ${o}.`);return i}updateButtons(t=!0){let e=this.activeForms();for(let[s,i]of this.items.entries())i.countQuizItems(e)===0?(this.updateButtonForms(s,this.formsData.keys),this.buttons[s].classList.add("disabled")):(this.updateButtonForms(s,e),this.buttons[s].classList.remove("disabled"));t&&this.scaleButtons()}updateButtonForms(t,e){let s=this.items[t].getFormsDisplayString(e);this.buttons[t].querySelector(".symbol").replaceChildren(s)}toggleItems(t,{updateIfDisabled:e=!1}={}){t=t.filter(i=>i!==null);let s=t.map(i=>this.itemsActive[i]).includes(!1);for(let i of t)this.updateItem(i,s,{updateIfDisabled:e,callUpdateListeners:!1});this.updateListeners.call(this)}updateItem(t,e,{updateIfDisabled:s=!1,callUpdateListeners:i=!0}={}){this.itemsActive[t]=e,(!this.buttons[t].classList.contains("disabled")||s)&&this.buttons[t].setAttribute("aria-checked",e.toString()),i&&this.updateListeners.call(this)}activeQuizItemCount(){let t=this.activeForms(),e=0;for(let[s,i]of this.items.entries())this.itemsActive[s]&&(e+=i.countQuizItems(t));return e}scaleButtons(){for(let t of this.blocks){let e=t.indices.filter(s=>s!==null).map(s=>this.buttons[s]).filter(s=>!s.classList.contains("disabled"));l.scaleAllToFit(e.map(s=>s.querySelector(".symbol")),{containers:e,uniform:.75}),this.selectorData.label&&l.scaleAllToFit(e.map(s=>s.querySelector(".selector-item-label")),{containers:e,uniform:.75})}}processItemsActive(t){return!t||!Array.isArray(t)||t.length!==this.items.length?(t&&console.error("Invalid active items array. Must be boolean array of same length as items."),this.defaultItemsActive()):t.map(e=>([!0,!1,0,1].includes(e)||console.warn("Invalid itemsActive, should be array of booleans or 0s and 1s."),!!e))}setActive(t){if(!Array.isArray(t)||t.length!==this.items.length){console.error("Invalid active items.");return}for(let[e,s]of t.entries())this.updateItem(e,s,{callUpdateListeners:!1});this.itemsActive=t}defaultItemsActive(){let t=this.selectorData.defaultActive??"all";if(t==="all"||t==="none")return new Array(this.items.length).fill(t==="all");let e=new Array(this.items.length).fill(!1);if(t.substring(0,5)==="block")try{t=this.processIndices(t.substring(5)).map(i=>this.blocks[i].indices).flat()}catch(s){return console.error(s),e}if(!Array.isArray(t))return console.error("Invalid defaultActive."),e;for(let s of t)e[s]=!0;return e}getItemButton(t,e){let s=l.createElement("div.selector-item-button"),i=l.uniqueIdPrefix("selectorButton")+e.toString();l.setAttrs(s,{id:i,role:"checkbox",tabindex:"0","aria-checked":"false","aria-labelledby":i});let r=l.createElement("span.symbol.symbol-string");if(b.setFont(r,this.dataset.getFont(this.selectorData.font)),l.setAttrs(r,{lang:this.dataset.metadata.lang,dir:this.dataset.metadata.dir}),s.append(r),this.selectorData.label){let o=l.createElement("span.selector-item-label"),a=this.selectorData.label,c=t.properties[a.property];if(a.splitFirst??!0){let u=a.splitter??"[,;/]";c=c.split(new RegExp(`s*(${u})s*`))[0]}o.textContent=c,s.append(o)}return s.dataset.index=e.toString(),s}setupFormsSetting(t=null){if(!(this.formsData.showSetting??Object.keys(this.formsData.setting).length>1))return;let e=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");this.formsSetting=I.from(d.map(this.formsData.setting,s=>s.label),{label:e,exclusive:!!this.formsData.exclusive,checked:t??d.map(this.formsData.setting,s=>s.active)}),this.formsSetting.updateListeners.push(this.updateButtons.bind(this),()=>this.updateListeners.call(this)),this.node.prepend(this.formsSetting.node)}destroy(){for(let t of this.blocks)this.removeBlockListeners(t);this.removeDocumentRangeListeners(),this.removeDocumentLabelListeners(),this.node.remove()}activeForms(){if(!this.formsSetting)return Object.keys(this.formsData.setting);let t=[],e=this.formsSetting.value;this.formsSetting.exclusive&&(e=[e]);for(let s of e)"keys"in this.formsData.setting[s]?t.push(...this.formsData.setting[s].keys):t.push(s);return t}activeIndices(){return p.filterIndices(this.itemsActive,t=>t)}processIndices(t,e=!1){if(typeof t=="string")return this.parseRanges(t,e);if(typeof t=="number")return[t];if(!Array.isArray(t))throw new Error("Invalid indices datatype: need string, number or Array<number>.");t=t.sort();let s=t.length;return t=t.filter((i,r,o)=>r===0||i!==o[r-1]),t.length!==s&&console.warn("Indices contain duplicates."),t}parseRanges(t,e=!1){return[].concat(...t.split(",").map(s=>{if(e&&s.substring(0,3)==="gap"){let i=s.length===3?1:this.parseInt(s.substring(3));return new Array(i).fill(null)}return this.parseRange(s)}))}parseRange(t){let e=t.split(":").map(o=>this.parseInt(o));if(e.length===1)return e;if(e.length===0||e.length>3)throw new Error("Invalid range, 2-3 numbers.");let s=e[0],i=e[e.length-1],r=e.length===3?e[1]:1;if(i<s||r<1)throw new Error("Invalid range, must have start <= stop and step >= 1.");return g(s,i+1,r)}parseInt(t){let e=parseInt(t);if(isNaN(e))throw new Error("Not a number.");return e}};function ut(n,t){let e=n%t;return[Math.round((n-e)/t),e]}function $(n,t){return[Math.min(n,t),Math.max(n,t)]}l.registerTemplate("headingElement",'<div class="heading-element"><span class="heading-element-number"></span><span class="heading-element-symbol"></span></div>');var z={arabic:{name:"Arabic",file:"./json/datasets/arabic.json"},elements:{name:"Atomic Elements",file:"./json/datasets/elements.json"},cyrillic:{name:"Cyrillic",file:"./json/datasets/cyrillic.json"},elder_futhark:{name:"Elder Futhark",file:"./json/datasets/elder_futhark.json"},greek:{name:"Greek",file:"./json/datasets/greek.json"},hebrew:{name:"Hebrew",file:"./json/datasets/hebrew.json"},japanese:{name:"Japanese Kana",file:"./json/datasets/japanese.json"},phoenician:{name:"Phoenician",file:"./json/datasets/phoenician.json"}},Mt="elder_futhark",Ce={gameHeading:"Kadmos",terms:{symbol:"symbol",symbols:"symbols"},lang:"en",dir:"ltr"},Be={keys:["default"],setting:{default:{label:"Default",active:!0}},defaultForm:"default",singleForm:!0},Fe={languages:["en"],default:"en"},Pe={en:"English",de:"German"},j=class{static _cache={};constructor(t){this.name=t.name,this.metadata=Object.assign({},Ce,t.metadata),this.fonts=t.fonts,this.setupFonts(),this.displayData=t.displayData??{},this.displayData.type??="string",this.formsData=t.formsData??Be,this.propsData=t.propsData,this.selectorData=t.selectorData??{},this.variantsData=this.processVariants(t.variantsData),this.languageData=t.languageData??Fe,this.languageData.default??=this.languageData.languages[0],this.items=this.processItems(t.symbolsData)}static fromKey(t){return t in z?t in this._cache?new Promise(e=>e(this._cache[t])):fetch(z[t].file).then(e=>e.json()).then(e=>{let s=new this(e);return this._cache[t]=s,s}).catch(l.printError):(console.error(`Invalid dataset key "${t}".`),null)}processVariants(t){if(!t)return null;for(let[e,s]of Object.entries(t.variants))typeof s=="string"&&(t.variants[e]={label:s});return t}getGameSettings(t){let e={};return this.hasPropsSetting()&&(e.properties=this.propertySetting(t.properties)),this.hasLanguageSetting()&&(e.language=this.languageSetting(t.language)),x.createFrom(e)}getFilterSettings(t){let e={};this.hasFormsSetting()&&(e.forms=this.formsSetting(t.forms)),this.hasVariantSetting()&&(e.variant=this.variantSetting(t.variant))}getSettings(t,e){return x.createFrom({properties:this.propertySetting(t),language:this.languageSetting(e)})}propertySetting(t=null){return I.from(d.map(this.propsData,e=>e.label),{label:"Properties",checked:t??d.map(this.propsData,e=>!!e.active)})}languageSetting(t=null){return I.from(d.onlyKeys(Pe,this.languageData.languages),{label:"Language",checked:t??this.languageData.default,exclusive:!0})}formsSetting(t=null){let e=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");return I.from(d.map(this.formsData.setting,s=>s.label),{label:e,exclusive:!!this.formsData.exclusive,checked:t??d.map(this.formsData.setting,s=>s.active)})}variantSetting(t=null){let e=this.variantsData.variants;return L.createSelect(d.map(e,s=>s.label),{label:"Variants",selected:t??this.variantsData.default??Object.keys(e)[0],groups:e.groups??[]})}hasPropsSetting(){return this.propsData.keys.length>1}hasLanguageSetting(){return this.languageData.languages.length>1}hasVariantSetting(){return!!this.variantsData}hasFormsSetting(){return Object.keys(this.formsData.setting).length>1}hasFontSetting(){return Object.keys(this.fonts).length>1}getItemSelector(){return new T(this.items,this)}_getFont(t){if(!t)return this.defaultFont();if(typeof t=="string")return t in this.fonts?this.fonts[t]:(console.warn(`Unknown font key "${t}".`),this.defaultFont());if(t.key||!t.family){let e=t.key?this.fonts[t.key]:this.defaultFont();return Object.assign({},e,d.withoutKeys(t,["key"]))}return t}getFont(t){return d.withoutKeys(this._getFont(t),["default","label"])}setupFonts(){for(let[t,e]of Object.entries(this.fonts))if(e.default){this._defaultFont=t;return}this._defaultFont=Object.keys(this.fonts)[0]}defaultFont(){return this.fonts[this._defaultFont]}fontSetting(t=null){let e=I.from(d.map(this.fonts,s=>s.label??s.family),{label:"Font",exclusive:!0,checked:t??this._defaultFont});return e.node.classList.add("font-family-setting"),e}processItems(t){let e=t.rows;if(!Array.isArray(e))throw new Error("symbol rows must be an array.");t.template&&this.applyTemplateToRows(e,t.template);let s=new Array(e.length),i;for(let[r,o]of e.entries()){try{i=this.processItem(o)}catch(a){console.warn("Error occured processing item with key",key),console.error(a);continue}s[r]=i}return s}applyTemplateToRows(t,e){for(let[s,i]of t.entries()){if(!Array.isArray(i))continue;let r={};for(let[o,a]of i.entries())r[e[o]]=a;t[s]=r}return t}processItem(t){return new ht(this.processDisplayForms(t.display),this.processItemProperties(t))}processItemProperties(t){let e={};for(let[s,i]of Object.entries(t))if(s.includes(":")){let r=s.split(":");if(r.length!==2){console.warn("Ignored invalid symbol key.");continue}let[o,a]=r;o==="p"?e[a]=i:console.warn("Ignored invalid tagged symbol key.")}return e}processDisplayForms(t){if(this.formsData.singleForm)return Object.fromEntries([[this.formsData.defaultForm,t]]);if(typeof t=="string"&&(t=t.split("")),Array.isArray(t)){let s={};for(let[i,r]of t.entries())r&&(s[this.formsData.keys[i]]=r);return s}if(typeof t!="object")throw new Error("Invalid display format: need array or object.");let e=Object.keys(t).filter(s=>!this.formsData.keys.includes(s));if(e.length>0)throw new Error(`Invalid display Form key "${e[0]}".`);return t}getQuizItems(t,e,s,i="default"){let r=[];for(let o of t){let a=this.items[o].getDisplayString(e),c=this.items[o].getItemProperties(s,this.propsData,i);r.push(...Object.entries(a).map(([u,h])=>new k(h,c,u)))}return r}referencePropsData(){let t=Object.assign({},this.propsData);for(let[e,s]of Object.entries(t))if("referenceMaxDist"in s){let i=Object.assign({},s);i.maxDist=s.referenceMaxDist,t[e]=i}return t}getReferenceItems(t,e="default"){let s,i=this.referencePropsData();if(this.formsData.exclusive){let r=this.items.map(a=>a.getItemProperties(t,i,e)),o={};for(let a of this.formsData.keys)o[a]=this.items.map((c,u)=>new k(c.getFormsDisplayString([a]),r[u],a));return o}else return s=this.items.map(r=>new k(r.getFormsDisplayString(this.formsData.keys),r.getItemProperties(t,i,e),"all")),Object.fromEntries(this.formsData.keys.map(r=>[r,s]))}setupGameHeading(t){try{let e=this.metadata.gameHeading;if("font"in e?b.setFont(t,this.getFont(e.font)):b.clearFont(t),this.name==="Atomic Elements"){let s=document.createElement("div");s.classList.add("element-heading-container");let i=[];for(let[r,o]of[[19,"K"],[85,"At"],[42,"Mo"],[16,"S"]]){let a=l.getTemplate("headingElement");a.querySelector(".heading-element-symbol").textContent=o,a.querySelector(".heading-element-number").textContent=r,i.push(a)}s.replaceChildren(...i),t.replaceChildren(s)}else t.replaceChildren(e.string);t.setAttribute("lang",e.lang??this.metadata.lang),t.setAttribute("dir",e.dir??this.metadata.dir)}catch(e){console.error(e),t.replaceChildren("Kadmos"),t.removeAttribute("lang"),t.removeAttribute("dir")}}},ht=class{constructor(t,e){this.displayForms=t,this.properties=e}getDisplayString(t){return d.onlyKeys(this.displayForms,t)}getItemProperties(t,e,s="default"){let i={};for(let r of t){if(!(r in this.properties)){console.error(`Missing property key "${r}".`);continue}i[r]=this.properties[r]}if(s!=="default")for(let r of t){let o=r+"_"+s;this.properties[o]&&(i[r]=this.properties[o])}return d.map(i,(r,o)=>w.fromData(r,e[o]))}getFormsDisplayString(t){return Object.values(this.getDisplayString(t)).join("")}countQuizItems(t){return t.reduce((e,s)=>s in this.displayForms?e+1:e,0)}};var J=class{constructor(){this.game=null,this.datasetKey=null,this.dataset=null,this.sc=null,this.genericSettings=this.constructor.generateGenericSettings(),this.itemSelector=null,this.checkPagesNextButton=this.checkPagesNextButton.bind(this),this.saveSettings=this.saveSettings.bind(this),this.readFromSearchParams=this.readFromSearchParams.bind(this),this.startGame=this.startGame.bind(this)}static generateGenericSettings(){return x.createFrom({seed:L.createInput("text","Seed (optional)",{id:"game-seed"})})}getCachedSettings(){let t=window.localStorage.getItem(this.localStorageSettingsKey());if(!t)return{};try{let e=JSON.parse(t);return typeof e.items=="string"&&(e.items=D.decodeBase64BoolArray(e.items)),e}catch(e){return console.error(e),{}}}setup(){this.setupDatasetSelect(),this.readFromSearchParams(),this.setupButtonListeners(),window.addEventListener("popstate",this.readFromSearchParams),window.addEventListener("resize",()=>{this.itemSelector&&this.itemSelector.scaleButtons()})}setupButtonListeners(){document.getElementById("start-game-button").addEventListener("click",this.startGame),document.getElementById("stop-game-button").addEventListener("click",()=>{this.game.finish()}),document.getElementById("item-submit-button").addEventListener("click",()=>{this.game.submitRound()}),document.getElementById("item-next-button").addEventListener("click",()=>{this.game.newRound()})}setupDatasetSelect(){let t=document.getElementById("datasetSelect");l.setOptions(t,d.map(z,e=>e.name)),t.addEventListener("change",e=>{let s=e.target.value;j.fromKey(s).then(i=>{this.selectDataset(s,i)}).catch(console.error)})}selectDataset(t,e){this.dataset=e,this.datasetKey=t,l.setSearchParams({dataset:t});let s=this.getCachedSettings();this.setupSelector(s),this.setupSettingsCollection(s);let i=this.dataset.metadata.gameHeading,r="font"in i&&"family"in i.font?[i.font.family]:[];l.batchUpdate([[this.dataset.setupGameHeading.bind(this.dataset),document.querySelector("#game-heading h1")],[(o,a)=>{o.replaceChildren(a.node),a.scaleButtons()},document.getElementById("game-filters"),this.itemSelector],[(o,...a)=>o.replaceChildren(...a),document.getElementById("game-settings"),...this.sc.nodeList()]],r),l.showPage(document.getElementById("game-filters"))}setupSelector(t){this.itemSelector&&this.itemSelector.destroy(),this.itemSelector=this.dataset.getItemSelector(),this.itemSelector.setup(t.items,t.forms,this.datasetKey),this.itemSelector.updateListeners.push(this.checkPagesNextButton,this.saveSettings),this.checkPagesNextButton()}checkPagesNextButton(){l.setAttrs(document.querySelector(".pages-next-button"),{disabled:this.itemSelector.activeQuizItemCount()===0})}setupSettingsCollection(t){this.sc=this.dataset.getSettings(t.properties,t.language),this.sc.extend(this.genericSettings);for(let e of["language"]){let s=this.sc.getSetting(e).buttonCount()===1;s&&l.hide(this.sc.getNode(e)),l.classIfElse(s,this.sc.getNode(e),"hidden")}this.sc.getSetting("properties").disableIfSingleButton(!0),this.sc.addUpdateListener(()=>{this.saveSettings()})}localStorageSettingsKey(t=this.datasetKey){return"settings_"+t}saveSettings(){l.setSearchParams({dataset:this.datasetKey}),window.localStorage.setItem(this.localStorageSettingsKey(),JSON.stringify({items:D.encodeBase64BoolArray(this.itemSelector.itemsActive),forms:this.itemSelector.activeForms(),properties:this.sc.getValue("properties"),language:this.sc.getValue("language")}))}startGame(){this.game&&this.game.cleanup(),this.saveSettings();let t=this.sc.getValue("properties"),e=this.sc.getValue("language"),s=this.dataset.getQuizItems(this.itemSelector.activeIndices(),this.itemSelector.activeForms(),t,e),i=this.dataset.getReferenceItems(t,e);this.game=new V(this.dataset,s,t,e);let r=this.sc.getValue("seed");r&&this.game.seed(r),this.game.setReferenceItems(i),this.game.setup(),this.game.newRound(),this.setPlaying(!0),this.game.focus(),this.game.onFinish.push(()=>{this.setPlaying(!1)})}setPlaying(t){t||l.showPage(document.getElementById("game-filters")),l.classIfElse(t,document.body,"playing")}readFromSearchParams(){let t=new URLSearchParams(location.search),e=t.get("dataset")??Mt;document.getElementById("datasetSelect").value=e,j.fromKey(e).then(s=>{this.selectDataset(e,s),["1","true"].includes(t.get("play"))?this.startGame():this.setPlaying(!1)})}};(function(){De(),new J().setup(),document.querySelectorAll(".ribbon").forEach(t=>{Oe(t,t.classList.contains("ribbon-closable"))}),document.querySelectorAll(".pages-container").forEach(t=>{l.setupPages(t)})})();function De(){let n=new URLSearchParams(location.search);["1","true"].includes(n.get("darkmode"))?document.documentElement.classList.add("dark-mode"):["1","true"].includes(n.get("lightmode"))&&document.documentElement.classList.add("light-mode")}function Oe(n,t=!1){let e=n.querySelector(".ribbon-contents"),s=n.querySelectorAll(".ribbon-buttons input[type=checkbox]");n.dataset.closable=t.toString();let i=n.dataset.openId;if(!i){for(let r of s)if(r.checked){i=r.dataset.contentId;break}}l.addClass(e.querySelectorAll(".ribbon-content"),"hidden"),!i&&!(t&&e.classList.contains("hidden"))&&(i=s[0].dataset.contentId,s[0].checked=!0),i&&(document.getElementById(i).classList.remove("hidden"),e.classList.remove("hidden"),n.dataset.openId=i),n.querySelector(".ribbon-buttons").addEventListener("change",Ne)}function Ne(n){let t=n.target,e=t.closest(".ribbon"),s=e.querySelector(".ribbon-contents");if(t.checked){let i=e.dataset.openId;!s.classList.contains("hidden")&&i&&(l.addClass(document.getElementById(i),"hidden"),e.querySelector(`.ribbon-buttons input[data-content-id="${i}"]`).checked=!1),document.getElementById(t.dataset.contentId).classList.remove("hidden"),e.dataset.openId=t.dataset.contentId,s.classList.remove("hidden")}else e.dataset.closable==="true"?(s.classList.add("hidden"),e.dataset.openId=""):t.checked=!0}})();
//# sourceMappingURL=index.js.map
