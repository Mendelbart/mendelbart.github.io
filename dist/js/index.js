(()=>{var ut=Object.defineProperty;var N=(s,e)=>{for(var t in e)ut(s,t,{get:e[t],enumerable:!0})};var h={};N(h,{extractKeys:()=>gt,filter:()=>ft,filterKeys:()=>pt,map:()=>oe,mapKeyArrayToValues:()=>yt,mapKeys:()=>bt,onlyKeys:()=>ae,subsetToBoolRecord:()=>St,withoutKeys:()=>W});var g={};N(g,{arraysEqual:()=>ie,avg:()=>dt,bisectLeft:()=>re,cumSums:()=>se,filterIndices:()=>ht,range:()=>mt,sum:()=>Be});function se(s){return s.map((e=>t=>e+=t)(0))}function re(s,e){let t=0,n=e.length,r;for(;t<n;)r=t+n>>1,e[r]<s?t=r+1:n=r;return t}function Be(s){return s.reduce((e,t)=>e+t,0)}function dt(s){return s.length===0?(console.error("Cannot compute average of empty array."),0):Be(s)/s.length}function ie(s,e){return s.length===e.length&&s.every((t,n)=>t===e[n])}function ht(s,e){return Array.from(s.entries()).filter(([t,n])=>e(n,t,s)).map(([t,n])=>t)}function mt(s,e=null,t=1){e===null&&(e=s,s=0);let n=Math.ceil((e-s)/t);return new Array(n).fill(0).map((r,i)=>s+t*i)}function oe(s,e){return Object.fromEntries(Object.entries(s).map(([t,n],r)=>[t,e(n,t,r)]))}function ft(s,e){return Object.fromEntries(Object.entries(s).filter(([t,n],r)=>e(n,t,r)))}function pt(s,e){return Object.entries(s).filter(([t,n],r)=>e(n,t,r)).map(([t,n])=>t)}function W(s,e){typeof e=="string"&&(e=[e]);let t=Object.assign({},s);for(let n of e)delete t[n];return t}function gt(s,e,t=!0){let n=e.map(r=>s[r]??null);return t&&n.push(W(s,e)),n}function ae(s,e,t=!1){let n=new Set(e),r={};for(let[i,o]of Object.entries(s))n.has(i)?r[i]=o:t&&console.warn(`Filtered out key "${i}".`);return r}function bt(s,e){return Object.fromEntries(Object.entries(s).map(([t,n])=>[e(t),n]))}function yt(s,e){return Object.fromEntries(s.map(t=>[t,e(t)]))}function St(s,e){if(s==="none")s=[];else if(s==="all")s=e;else if(typeof s=="string")throw new Error('Invalid subset string specifier - use "none" or "all".');if(Array.isArray(s)){let t=Object.fromEntries(e.map(n=>[n,!1]));for(let n of s)t[n]=!0;return t}return ie(Object.keys(s).sort(),e.sort())||(console.log(s,e),console.warn("Subset object keys don't match keys list."),console.log(Object.keys(s).sort(),e.sort())),Object.fromEntries(e.map(t=>[t,!!s[t]]))}var l={};N(l,{addClass:()=>Re,appendChildren:()=>At,button:()=>vt,classIfElse:()=>R,classesToList:()=>ue,computeScaleToFit:()=>he,createElement:()=>Et,elementSize:()=>de,forEachElement:()=>J,getTemplate:()=>le,hide:()=>M,htmlToElement:()=>It,htmlToElements:()=>Oe,label:()=>wt,log:()=>Pt,printError:()=>Dt,registerTemplate:()=>Te,registerTemplates:()=>Pe,removeClass:()=>kt,scaleAllToFit:()=>Ft,scaleToFit:()=>Ct,setAttrOnKeys:()=>Lt,setAttrs:()=>Ne,setDefaultId:()=>Me,setOptions:()=>xt,setSearchParams:()=>Nt,setupPages:()=>Tt,show:()=>j,showPage:()=>z,toggleShown:()=>ce,transition:()=>jt,uniqueIdPrefix:()=>je});var Ce=0;window.hasTouch="ontouchstart"in window;var Y={};function Pe(s){for(let[e,t]of Object.entries(s))Te(e,t)}function Te(s,e){s in Y&&console.warn(`Overwriting existing template key ${s}.`);let t=document.createElement("TEMPLATE");typeof e=="string"?t.insertAdjacentHTML("beforeend",e):t.append(e),Y[s]=t}function le(s){return s in Y||console.error("Unknown template key "+s),Y[s].firstChild.cloneNode(!0)}Pe({buttonLabel:'<label class="button"></label>',buttonInput:'<input class="button-check form-input" autocomplete="off">'});function vt(s,e,t=null,n=null){let r=le("buttonInput"),i=le("buttonLabel");return n??=je("button")+e,Ne(r,{type:s,value:e,id:n}),i.setAttribute("for",n),t&&(typeof t=="string"&&(t=document.createTextNode(t)),i.appendChild(t)),[r,i]}function wt(s,e,t=null){let n=document.createElement("LABEL");return s instanceof Node&&(s=Me(s,t)),n.setAttribute("for",s),n.textContent=e,n}function Oe(s){let e=document.createElement("TEMPLATE");return e.innerHTML=s,e.content.children}function It(s){let e=Oe(s);if(e.length!==1)throw new Error("HTML doesn't contain exactly one element.");return e[0]}function Et(s){let[e,...t]=s.split("."),[n,r]=e.split("#"),i=document.createElement(n);return r&&(i.id=r),i.classList.add(...t),i}function xt(s,e,{selected:t=null,disabled:n=[],groups:r=[]}={}){t??=Object.keys(e)[0];let i=oe(e,()=>!1),o=null;for(let{label:a,keys:c}of r){let u=document.createElement("OPTGROUP");u.label=a;for(let d of c){if(!(d in e)){console.warn(`Unknown grouped key ${d} in group ${a}.`);continue}u.append(Fe(d,e[d],t,n)),i[d]=!0}s.add(u),o||(o=u)}for(let[a,c]of Object.entries(e))i[a]||s.add(Fe(a,c,t,n),o)}function Fe(s,e,t,n){let r=document.createElement("OPTION");return r.value=s,r.textContent=e,t===s&&(r.selected="selected"),n.includes(s)&&(r.disabled="disabled"),r}function At(s,e){for(let t of e)s.appendChild(t)}function Lt(s,e,t,n=""){if(e){typeof e=="string"&&(e=[e]);for(let r of e)s[r].setAttribute(t,n)}}function Ne(s,e){for(let[t,n]of Object.entries(e))typeof n=="boolean"?n?s.setAttribute(t,t):s.removeAttribute(t):t==="class"?Re(s,n):s.setAttribute(t,n)}function je(s,e="_"){return Ce+=1,s+Ce+e}function Me(s,e){return s.hasAttribute("id")?(s.id=e,e):s.id}function J(s,e){if(s)if(s instanceof Node)e(s);else for(let t of s)e(t)}function R(s,e,t,n=null){s||([t,n]=[n,t]),t=ue(t),n=ue(n),J(e,r=>{r.classList.remove(...n),r.classList.add(...t)})}function Re(s,e){R(!0,s,e)}function kt(s,e){R(!1,s,e)}function j(s,e="display"){J(s,t=>{t.style.removeProperty(e)})}var Bt={display:"none",visibility:"hidden",opacity:"0"};function M(s,e="display"){J(s,t=>{t.style.setProperty(e,Bt[e])})}function ce(s,e,t=null,n="display"){s?(t&&M(t,n),j(e,n)):(M(e,n),t&&j(t,n))}function ue(s){return s??=[],typeof s=="string"?s.split(" "):Array.from(s)}function de(s,e="border-box",t=!1){let n=t?s.scrollWidth:s.clientWidth,r=t?s.scrollHeight:s.clientHeight,i=window.getComputedStyle(s),o=i.scale;return!o||o==="none"?o=1:o=parseFloat(o),e==="border-box"?(n+=o*(parseFloat(i.borderLeftWidth||0)+parseFloat(i.borderRightWidth||0)),r+=o*(parseFloat(i.borderTopWidth||0)+parseFloat(i.borderBottomWidth||0))):e==="content-box"?(n-=o*(parseFloat(i.paddingLeft||0)+parseFloat(i.paddingRight||0)),r-=o*(parseFloat(i.paddingTop||0)+parseFloat(i.paddingBottom||0))):e!=="padding-box"&&console.error("Invalid value for element size box, use padding-box, content-box or border-box."),[n,r]}function he(s,{container:e=null,dimension:t="width",elementBox:n="border-box",containerBox:r="content-box",grow:i=!1}={}){e??=s.parentElement;let[o,a]=de(s,n,!0),[c,u]=de(e,r),d=De(o,c,i),p=De(a,u,i);return["width","height","both"].includes(t)||(console.error("Invalid dimension, use 'width', 'height' or 'both'."),t="width"),t==="width"?d:t==="height"?p:Math.min(d,p)}function Ct(s,e={}){s.style.scale=he(s,e)}function Ft(s,e={}){let t=e.uniform??0,n=e.containers??s.map(i=>i.parentElement);if("container"in e&&(console.warn("Can't set single container for scaleAllToFit."),delete e.container),!Array.isArray(n)||n.length!==s.length){console.error("Containers and elements length don't match.");return}let r=s.map((i,o)=>he(i,Object.assign(e,{container:n[o]})));if(t>0){let o=Math.min(...r)/t;for(let[a,c]of r.entries())r[a]=Math.min(o,c)}for(let[i,o]of s.entries())o.style.scale=r[i]}function De(s,e,t=!1){if(s===0)return console.warn("getScale: Element's size is 0."),1;if(isNaN(s))return console.error("Element size is NaN."),1;if(isNaN(e))return console.error("Container size is NaN."),1;let n=e/s;return t?n:Math.min(n,1)}function Dt(s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(s.toString(),document.createElement("br")),console.error(s)}function Pt(...s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(...s.map(t=>t.toString()),document.createElement("br")),console.log(...s)}function Tt(s){z(s.querySelector(".page-content"),{container:s,transition:!1}),s.querySelector(".pages-next-button").addEventListener("click",()=>{z(document.getElementById(s.dataset.openPage).nextElementSibling,{container:s})}),s.querySelector(".pages-back-button").addEventListener("click",()=>{z(document.getElementById(s.dataset.openPage).previousElementSibling,{container:s})})}function z(s,{container:e=null,transition:t=!0}={}){let n=()=>Ot(s,e??s.closest(".pages-container"));t?document.startViewTransition(n):n()}function Ot(s,e){M(e.querySelectorAll(".page-content")),M(e.querySelectorAll(".page-heading")),j(s),j(e.querySelector(`.page-heading[data-for="${s.id}"]`)),e.dataset.openPage=s.id,ce(!!s.previousElementSibling,e.querySelector(".pages-back-button")),ce(!!s.nextElementSibling,e.querySelector(".pages-next-button"),e.querySelector(".pages-finish-button")),s.nextElementSibling||e.querySelector(".pages-finish-button").focus()}function Nt(s){let e=new URL(location),t=!1;for(let[n,r]of Object.entries(s)){let i=encodeURIComponent(r);e.searchParams.get(n)!==i&&(e.searchParams.set(n,i),t=!0)}t&&history.pushState({},"",e)}function jt(s,e=[]){document.startViewTransition?document.startViewTransition({update:()=>s(),types:e}):requestAnimationFrame(()=>s())}function Mt(s){let e=1779033703,t=3144134277,n=1013904242,r=2773480762;for(let i=0;i<s.length;i++){let o=s.charCodeAt(i);e=t^Math.imul(e^o,597399067),t=n^Math.imul(t^o,2869860233),n=r^Math.imul(n^o,951274213),r=e^Math.imul(r^o,2716044179)}return e=Math.imul(n^e>>>18,597399067),t=Math.imul(r^t>>>22,2869860233),n=Math.imul(e^n>>>17,951274213),r=Math.imul(t^r>>>19,2716044179),e^=t^n^r,t^=e,n^=e,r^=e,[e>>>0,t>>>0,n>>>0,r>>>0]}function Rt(s,e,t,n){return function(){s|=0,e|=0,t|=0,n|=0;let r=(s+e|0)+n|0;return n=n+1|0,s=e^e>>>9,e=t+(t<<3)|0,t=t<<21|t>>>11,t=t+r|0,(r>>>0)/4294967296}}function _t(s){return Rt(...Mt(s))}var _=class{constructor(s=Math.random){this._rand=s}rand(s=null,e=null){return e===null?this._rand()*(s??1):(s??=0,this._rand()*(e-s)+s)}seed(s){this._rand=_t(s)}randInt(s,e){return Math.floor(this.rand(s,e))}shuffle(s){for(let e=s.length;e>0;e--){let t=this.randInt(e);t!==e-1&&([s[e-1],s[t]]=[s[t],s[e-1]])}}randIndexFromWeights(s){let e=se(s);return re(this.rand(e[e.length-1]),e)}};var v={};N(v,{clearFont:()=>Ge,getFontData:()=>$t,loadFont:()=>fe,loadFonts:()=>pe,setFont:()=>Ve,setFontProperties:()=>be,supportsStylesets:()=>ge,supportsVariableFonts:()=>qe});var _e=[{family:"Noto Serif Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Hebrew",scale:1.25,shift:-.15,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Rashi Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900"}},{family:"Noto Serif",fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Japanese",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Serif Japanese",fallback:"serif",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Sans Arabic",scale:.94,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Kufi Arabic",variationSettings:{wght:"100 900"}},{family:"Noto Naskh Arabic",variationSettings:{wght:"400 700"}},{family:"Noto Sans Phoenician"},{family:"Junicode",fallback:"serif",variationSettings:{wght:"300 700",wdth:"100",ENLA:"0"},styleset:{"Early-English-futhorc":12,"Elder-futhark":13,"Younger-futhark":14,"Long-branch-to-short-twig":15,"Latin-to-Gothic":19}}];var F=Object.fromEntries(_e.map(s=>[s.family,s])),Ut={display:"swap",weight:400,style:"normal"},Q={},me={family:"font-family",weight:"font-weight",scale:"--font-scale",shift:"--font-shift",styleset:"font-variant-alternates",letterSpacing:"--letter-spacing",lineHeight:"--line-height"},He=["shift","scale","letterSpacing"];function fe(s){return s?typeof s=="object"?fe(s.family):(s in Q||(Q[s]=Vt(s),document.fonts.add(Q[s])),Q[s].load()):Promise.reject("No family given.")}function pe(s){return Promise.all(s.map(e=>fe(e)))}function qt(s){let e=`/kadmos/assets/fonts/${s.replaceAll(" ","")}.woff2`,t=qe()?"woff2-variations":"woff2";return`url("${e}") format("${t}")`}function Ue(){return"CSS"in window&&"supports"in CSS}function ge(){return Ue()&&CSS.supports("font-variant-alternates","styleset(x)")}function qe(){return Ue()&&CSS.supports("font-variation-settings","normal")}function Vt(s){let e=Object.assign({},Ut,F[s]);if("styleset"in e&&ge()&&(document.styleSheets[0].insertRule(`@font-feature-values "${s}" {@styleset {`+Object.entries(e.styleset).map(([t,n])=>`${t}: ${n};`).join("")+"}}"),delete e.styleset),"variationSettings"in e){let t=Gt(e.variationSettings);delete e.variationSettings,Object.assign(e,t)}return new FontFace(s,e.url??qt(s),e)}function Gt(s){let e={};return"wght"in s&&(e.weight=s.wght,s=W(s,"wght")),Object.keys(s).length>0&&(e.variationSettings=Object.entries(s).map(([t,n])=>`"${t}" ${n}`).join(",")),e}function Ve(s,e,t=null){if(typeof e=="object")if("family"in e&&typeof e.family=="string"){Ve(s,e.family,e);return}else throw new Error("Need properties.family of type string if family argument is omitted.");if(!(e in F))throw new Error(`Unknown family ${e}.`);Ge(s),Wt(s,e),be(s,Kt(t,e))}function Kt(s,e){let t=Object.assign({},s),n=F[e];return"shift"in n&&(t.shift=n.shift+(s.shift??0)),"scale"in n&&(t.scale=n.scale*(s.scale??1)),t}function $t(s){return F[s]}function be(s,e){let t=!1;for(let[n,r]of Object.entries(e))if(n!=="family"){if(!(n in me)){console.warn(`Unknown font property '${n}'`);continue}He.includes(n)&&(t=!0),n==="styleset"?"family"in e?zt(s,r,e.family):console.error("Cannot set styleset without knowing family."):s.style.setProperty(me[n],r)}R(t,s,"font-transform")}function Wt(s,e){let t=F[e];s.style.fontFamily=e+", "+(t.fallback??"system-ui, sans-serif"),be(s,ae(t,He))}function Ge(s){for(let e of Object.values(me))s.style.removeProperty(e)}function zt(s,e,t){e=Array.isArray(e)?e:[e];let n=`styleset(${e.join(", ")})`;if(ge())s.style.setProperty("font-variant-alternates",n);else{let i=e.map(o=>F[t].styleset[o]).map(o=>`"ss${o.toString().padStart(2,"0")}"`).join(", ");s.style.setProperty("font-feature-settings",i)}}var H={};N(H,{decodeBase64BoolArray:()=>Jt,decodeBase64Number:()=>$e,encodeBase64BoolArray:()=>Yt,encodeBase64Number:()=>Ke});function Yt(s){return We(Qt(s))+"~"+Ke(s.length)}function Jt(s){let[e,t]=s.split("~");return Xt(ze(e),$e(t))}function Ke(s){return We(Zt(s))}function $e(s){return en(ze(s))}function Qt(s){let e=new Array(Math.ceil(s.length/6)),t;for(let n=0;n<e.length;n++){t=0;for(let r=0;r<6;r++)s[6*n+r]&&(t+=1<<r);e[n]=t}return e}function Xt(s,e){if(Math.ceil(e/6)!==s.length)throw new Error("Lengths of base 64 values and resultant length don't match.");let t=new Array(e);for(let[n,r]of s.entries())for(let i=0;i<6;i++){let o=6*n+i;if(o>=e)break;t[o]=(r&1<<i)!==0}return t}function Zt(s){let e=[];for(;s>0;)e.push(s&63),s>>=6;return e}function en(s){let e=0;for(let[t,n]of s.entries())e+=n<<6*t;return e}function We(s){return String.fromCharCode(...s.map(e=>tn(e)))}function ze(s){let e=new Array(s.length);for(let t=0;t<s.length;t++)e[t]=nn(s.charCodeAt(t));return e}function tn(s){return s&=63,s<26?s+65:s<52?s+71:s<62?s+-5:s===62?45:95}function nn(s){if(s>=65&&s<91)return s-65;if(s>=97&&s<123)return s-97+26;if(s>=48&&s<58)return s-48+53;if(s===45)return 62;if(s===95)return 63;throw new Error("Unknown base 64 char code.")}var I=class{constructor(){this._funcs=new Set}push(...e){for(let t of e)this._funcs.add(t)}remove(e){this._funcs.delete(e)}call(...e){for(let t of this._funcs)t.call(...e)}clear(){this._funcs.clear()}};var b=class{constructor(){this.settings={},this.keys=[]}static createFrom(e,t=null){let n=new this;return n.put(e,t),n}put(e,t=null){t??=Object.keys(e);for(let n of t)this.add(n,e[n])}extend(e){this.put(e.settings,e.keys)}add(e,t,n="end",r=null){if(this.settings[e]=t,n==="end")this.keys.push(e);else{let i;n==="begin"?i=0:(i=this.keys.indexOf(r),n==="afterKey"?i++:n!=="beforeKey"&&console.error("Invalid insert setting insert position.")),this.keys.splice(i,0,e)}}remove(e){this.settings[e].remove(),delete this.settings[e]}removeAll(){for(let e of Object.values(this.settings))e.remove();this.settings={},this.keys=[]}replace(e,t){this.settings[e].node.replaceWith(t.node),this.settings[e].remove(),this.settings[e]=t}replaceSelf(e){this.removeAll(),this.put(e.settings)}getValues(){return h.map(this.settings,e=>e.value)}setValues(e){for(let[t,n]of Object.entries(e))this.settings[t].value=n}getValue(e){if(!(e in this.settings))throw new Error("Key not in settings collection.");return this.settings[e].value}getDefault(e,t=null){return e in this.settings?this.settings[e].value:t}getNode(e){return this.settings[e].node}getSetting(e){return this.settings[e]}nodeList(){return this.keys.map(e=>this.settings[e].node)}addUpdateListener(e,...t){if(typeof e=="function")for(let n of Object.values(this.settings))n.updateListeners.push(e,...t);else{typeof e=="string"&&(e=[e]);for(let n of e)this.settings[n].updateListeners.push(...t)}}},C=class{static idCount=0;static updateEvent="change";node;valueNode;updateListeners;constructor(e){let t;if(this.constructor.isValueNode(e))t=e;else if(t=e.querySelector("input, textarea, select"),!this.constructor.isValueNode(t))throw new Error("Couldn't find element of type input, textarea or select.");this.node=l.createElement("div.setting.labeled-value-element"),this.node.append(e),this.valueNode=t,this.updateListeners=new I,this._onChange=this._onChange.bind(this),this.valueNode.addEventListener(this.constructor.updateEvent,this._onChange)}static createInput(e,t=null,n=null){let r=document.createElement("INPUT");r.type=e,n&&l.setAttrs(r,n);let i=new this(r);return t&&i.label(t),i}static createSelect(e,t={}){let n=document.createElement("select");l.setOptions(n,e,t);let r=l.createElement("div.styled-select");r.append(n);let i=new this(r);return t.id&&i.setId(t.id),t.label&&i.label(t.label),i}static isValueNode(e){let t=e.tagName;return t==="SELECT"||t==="TEXTAREA"||t==="INPUT"&&e.type!=="hidden"}isCheckbox(){return this.valueNode.tagName==="INPUT"&&this.valueNode.type==="checkbox"}get value(){return this.isCheckbox()?this.valueNode.checked:this.valueNode.value}set value(e){this.isCheckbox()?this.valueNode.checked=e:this.valueNode.value=e}_onChange(){this.updateListeners.call(this,this.value)}setDisabled(e){this.valueNode.disabled=e}setId(e={prefix:""}){let t=typeof e=="string"?e:this.constructor.generateId(e.prefix);this.valueNode.id=t;let n=this.node.querySelector("label");return n&&(n.htmlFor=t),t}static generateId(e=""){return"ve_"+e+this.idCount.toString().padStart(4,"0")}label(e){if(!e)return;let t=this.node.querySelector("label");t||(t=document.createElement("label"),this.valueNode.id||this.setId(),t.htmlFor=this.valueNode.id,this.node.prepend(t)),t.textContent=e}remove(){this.valueNode.removeEventListener(this.constructor.updateEvent,this._onChange),this.node.remove()}};l.registerTemplate("buttonGroupContainer",l.createElement("fieldset.button-group"));var A=class{static nameCount=0;node;inputs;constructor(e,t,n=!1){this.node=e,this.updateListeners=new I,this.inputs=Object.fromEntries(Array.from(this.node.querySelectorAll("INPUT")).map(r=>[r.value,r])),this.exclusive=t,this.decheckable=n,this._onChange=this._onChange.bind(this),this.node.addEventListener("change",this._onChange)}static from(e,{exclusive:t=!1,name:n=null,checked:r=null,disabled:i=null,decheckable:o=!1,label:a=null}={}){Array.isArray(e)&&(e=Object.fromEntries(e.map(f=>[f,f])));let c=Object.keys(e),u=t?"radio":"checkbox";n??=this.generateName();let d=l.getTemplate("buttonGroupContainer");t&&(d.setAttribute("role","radiogroup"),typeof r=="string"&&(r=[r]),!o&&!r&&(r=[c[0]])),r=h.subsetToBoolRecord(r??"none",c),i=h.subsetToBoolRecord(i??"none",c);for(let[f,B]of Object.entries(e)){let[E,$]=l.button(u,f,B);E.name=t?n:`${n}_${f}`,E.disabled=i[f],E.checked=r[f],d.append(E,$)}t&&o&&d.addEventListener("click",f=>{f.target.tagName==="INPUT"&&f.target.checked&&(f.target.checked=!1)});let p=new this(d,t,o);return a&&p.label(a),p}static generateName(){return this.nameCount++,"buttongroup_"+this.nameCount.toString().padStart(4,"0")}_onChange(){this.updateListeners.call(this,this.value)}buttonCount(){return Object.keys(this.inputs).length}disableIfSingleButton(e=null){this.buttonCount()===1?(this.setDisabled(!0),e!==null&&(this.value=e?Object.keys(this.inputs):[])):this.setDisabled(!1)}get value(){if(this.exclusive&&!this.decheckable){for(let e of Object.values(this.inputs))if(e.checked)return e.value;return null}return h.filterKeys(this.inputs,e=>e.checked)}set value(e){e=h.subsetToBoolRecord(e,Object.keys(this.inputs));for(let[t,n]of Object.entries(this.inputs))n.checked=e[t]}setDisabled(e){for(let t of Object.values(this.inputs))t.disabled=e}label(e){let t=document.createElement("LEGEND");t.textContent=e,this.node.prepend(t)}remove(){this.node.addEventListener("change",this._onChange),this.node.remove()}};l.registerTemplate("slider",`<div class="slider-container">
    <span class="range-min"></span><span class="range-value"></span><span class="range-max"></span>
    <input type="range" class="form-range">
</div>`);var D=class extends C{static updateEvent="input";constructor(e,t,n){if(super(e),this.valueNode.tagName!=="INPUT"||this.valueNode.type!=="range")throw new Error("Couldn't find input type='range' element.");this.min=t,this.max=n,this.displayValue=this.displayValue.bind(this),this.updateProgress=this.updateProgress.bind(this),this.displayMinMax()}static create(e,t,n=null){let r=l.getTemplate("slider"),i=r.lastElementChild;i.min=e,i.max=t,i.setAttribute("step",1);let o=new this(r,e,t);return n!==null&&(o.value=n),o}_onChange(){super._onChange(),this.updateProgress(),this.displayValue()}updateProgress(){this.valueNode.style.setProperty("--range-progress",this.getProgress().toString())}getProgress(){return(this.value-this.min)/(this.max-this.min)}displayValue(){this.node.querySelector(".range-value").textContent=this.formatValue(this.value)}displayMinMax(){this.node.querySelector(".range-min").textContent=this.formatValue(this.min),this.node.querySelector(".range-max").textContent=this.formatValue(this.max)}isCheckbox(){return!1}set value(e){(this.min>e||this.max<e)&&console.warn("Slider value outside range."),super.value=e.toString(),this.displayValue(),this.updateProgress()}get value(){return parseFloat(this.valueNode.value)}formatValue(e){return(Math.round(e*100)/100).toString()}setMin(e){this.valueNode.value<e&&(this.valueNode.value=e,this._onChange()),this.min=e,this.valueNode.min=e,this.updateProgress(),this.displayMinMax()}setMax(e){this.valueNode.value>e&&(this.valueNode.value=e,this._onChange()),this.max=e,this.valueNode.max=e,this.updateProgress(),this.displayMinMax()}};var X=class{_punishFactor=2;_manualPunish=1;_previousDampFactor=.5;constructor(e){this.items=e,this.rng=new _;let t=this.itemCount=e.length;this.hitCount=0,this.scores=new Array(t).fill(0),this.tries=new Array(t).fill(0),this.triesLeft=new Array(t).fill(1),this.totalTriesLeft=t,this.maxTriesLeft=t,this.currentIndex=this.rng.randInt(0,t),this.previousIndex=null}seed(e){this.rng.seed(e)}currentItem(){return this.items[this.currentIndex]}nextItem(){return this.previousIndex=this.currentIndex,this.currentIndex=this.rng.randIndexFromWeights(this.getWeights()),this.currentItem()}getWeights(){let e=this.triesLeft.slice();return this.previousIndex!==null&&(e[this.previousIndex]*=this._previousDampFactor),e}updateTotalTriesLeft(){let e=g.sum(this.triesLeft);e>this.totalTriesLeft&&(this.maxTriesLeft+=e-this.totalTriesLeft),this.totalTriesLeft=e}progress(){return 1-this.totalTriesLeft/this.maxTriesLeft}enterScore(e){let t=++this.tries[this.currentIndex];t===1&&this.hitCount++,this.scores[this.currentIndex]=Math.max(this.scores[this.currentIndex],e*this.scoreAtTryFactor(t)),this.triesLeft[this.currentIndex]+=this._triesBoost(e)-1,this.triesLeft[this.currentIndex]<=0&&(this.triesLeft[this.currentIndex]=0,this.itemCount--),this.updateTotalTriesLeft()}isEmpty(){return this.itemCount===0}_triesBoost(e){return this._punishFactor*(1-e)}scoreAtTryFactor(e){return 1/e}getItemIndex(e){return this.items.indexOf(e)}punish(e,t=1){this.triesLeft[e]+=this._manualPunish*t,this.updateTotalTriesLeft()}absoluteScore(){return g.sum(this.scores)}scoreString(e="ratio"){let t=this.absoluteScore(),n=`${Je(t,1,2)}/${this.hitCount}`,r=this.hitCount>0?Ye(t/this.hitCount):Ye(0);if(e==="ratio")return n;if(e==="percent")return r;if(e==="both")return`${n} (${r})`;console.error(`Unknown mode: ${e}`)}};function Ye(s,e=0){return String(Je(s*100,e))+"%"}function Je(s,e=0,t=1){let n=Math.pow(10,e)*t;return Math.floor(s*n)/n}function U(s,e,t,n,r){return s<e||t<e?s>t?t+1:s+1:n===r?e:e+1}function ye(s,e){if(s===e)return 0;if(s.length>e.length){let ct=s;s=e,e=ct}let t=s.length,n=e.length;for(;t>0&&s.charCodeAt(t-1)===e.charCodeAt(n-1);)t--,n--;let r=0;for(;r<t&&s.charCodeAt(r)===e.charCodeAt(r);)r++;if(t-=r,n-=r,t===0||n<3)return n;let i=0,o,a,c,u,d,p,f,B,E,$,Ae,Le,x=new Array(2*t);for(o=0;o<t;o++)x[2*o]=o+1,x[2*o+1]=s.charCodeAt(r+o);let ke=x.length-1;for(;i<n-3;)for(E=e.charCodeAt(r+(a=i)),$=e.charCodeAt(r+(c=i+1)),Ae=e.charCodeAt(r+(u=i+2)),Le=e.charCodeAt(r+(d=i+3)),p=i+=4,o=0;o<ke;o+=2)f=x[o],B=x[o+1],a=U(f,a,c,E,B),c=U(a,c,u,$,B),u=U(c,u,d,Ae,B),p=U(u,d,p,Le,B),x[o]=p,d=u,u=c,c=a,a=f;for(;i<n;)for(E=e.charCodeAt(r+(a=i)),p=++i,o=0;o<ke;o+=2)f=x[o],x[o]=p=U(f,a,p,E,x[o+1]),a=f;return p}var P=class{constructor(e,t,n){this.displayString=e,this.properties=t,this.form=n}},L=class{constructor(e,t){this.value=e,this.maxDist=t,this.displayString=typeof e=="string"?e:e.toString()}static fromData(e,t){let n=t.maxDist??0,r=t.type;if(r==="number")return new Se(e,n,t.distanceMode??"linear");if(r==="string")return new Z(e,n,t.caseSensitive??!1,t.substitutions??{});if(r==="list"){let i,o={};return typeof e=="string"?i=e:("source"in e||console.error("Source of list property missing."),i=e.source,"alts"in e&&(o=e.alts)),new q(i,n,o,t)}else console.error(`Unknown property type "${t.type}"`)}grade(e){let t=this.gradeSingle(e,this.value);return[t,e.length>0?[this.markGradedText(e,t)]:[],[this.markGradedText(this.displayString,t)]]}static passes(e){return e>=.5}gradeSingle(e,t){let n=this.distance(e,t);return n<=this.maxDist?this.maxDist===0?1:Math.pow(2,-n/this.maxDist):0}markGradedText(e,t){let n=document.createElement("SPAN");return n.dataset.correct=t===1?"true":t>0?"partially":"false",n.textContent=e,n}distance(e,t){console.error("Not implemented.")}},Se=class extends L{constructor(e,t,n="linear"){let r,i;typeof e=="string"?(r=parseFloat(e),isNaN(r)&&console.error(`Invalid number property value "${e}"`),i=e):(r=e,i=e.toString()),n==="log"&&r===0&&console.error('Invalid value 0 for NumberProperty with distanceMode "log"'),super(r,t),this.displayString=i,this.distanceMode=n}distance(e,t){return this.distanceMode==="linear"?Math.abs(e-t):Math.abs(Math.log(e/t))}},Z=class extends L{constructor(e,t,n=!1,r={}){super(e,t),this.caseSensitive=n,this.substitutions=r}distance(e,t){return ye(this.standardizeString(e),this.standardizeString(t))}standardizeString(e){e=e.trim();for(let[t,n]of Object.entries(this.substitutions))e=e.replaceAll(new RegExp(t,"g"),n);return e=e.normalize("NFKD").replaceAll(/\p{M}/gu,""),this.caseSensitive||(e=e.toLowerCase()),e}},q=class extends Z{constructor(e,t,n={},{listMode:r="best",caseSensitive:i=!1,splitter:o="[,;/]",excludeFromList:a=["\\(.*?\\)"],substitutions:c={}}){e=e.trim(),super(e,t,i,c),this.splitter=o,this.values=this.constructor.getValues(e,t,this.splitter,a),n?this.alternatives=h.map(n,u=>typeof u=="string"?[u]:u):this.alternatives={},this.listMode=r}static getValues(e,t,n,r){let i=[new ee(e)];for(let o of[...r,n])i=i.map(a=>a.split(o)).flat().map(a=>a.trim()).filter(a=>a.end>a.start);return i.length===0&&console.warn("No values in list."),i}grade(e){let t=new ee(e).split(this.splitter).map(o=>o.trim()),n=new Array(t.length).fill(0),r=new Array(this.values.length).fill(0);for(let[o,a]of this.values.entries())for(let[c,u]of t.entries()){let d=this.gradeSingle(u.str,a.str);a.str in this.alternatives&&(d=Math.max(d,...this.alternatives[a.str].map(p=>this.gradeSingle(u.str,p)))),d>0&&(r[o]=Math.max(r[o],d),n[c]=Math.max(n[c],d))}return[this.listMode==="best"?Math.max(...r):g.avg(n),this.markSubStrings(t,n),this.markSubStrings(this.values,r)]}markSubStrings(e,t){if(e.length===0)return[];let n=e[0].source,r=[],i=0;for(let[o,a]of e.entries())i<a.start&&r.push(document.createTextNode(n.substring(i,a.start))),a.start<a.end&&(r.push(this.markGradedText(a.str,t[o])),i=a.end);return i<n.length&&r.push(document.createTextNode(n.substring(i))),r}},ee=class s{constructor(e,t=0,n=null){e instanceof s&&(t+=e.start,n===null?n=e.end:n+=e.start,e=e.source),n===null&&(n=e.length),this.source=e,this.str=e.substring(t,n),this.start=t,this.end=n}split(e,t=!1){let n=[],r=this.str.matchAll(e),i=0;for(let o of r)!t&&i===o.index||(n.push(new this.constructor(this,i,o.index)),i=o.index+o[0].length);return(t||i<this.end-this.start)&&n.push(new this.constructor(this,i)),n}trim(){let e=this.str.match(/^\s*/)[0].length,t=this.str.match(/\s*$/)[0].length;return e===0&&t===0?this:new this.constructor(this.source,this.start+e,this.end-t)}};l.registerTemplates({eval:`<div class="item-eval">
    <span class="submitted"></span><span class="solution"></span>
</div>`,symbolContainer:`<div class="symbol-container">
    <div class="symbol-display-container"><span class="symbol"></span></div>
    <div class="symbol-label-container"><span class="symbol-label"></span></div>
</div>`});var V=class{constructor(e,t,n,r){this.dataset=e,this.properties=n,this.language=r,this.dealer=new X(t),this.onFinish=new I,this.updateProgressBar(),this.onInputKeydown=this.onInputKeydown.bind(this),this._show=this._show.bind(this),this.loadAndUpdateSymbolFont=this.loadAndUpdateSymbolFont.bind(this)}static genericSettings(){return b.createFrom({seed:C.createInput("text","Seed (optional)",{id:"game-seed"})})}setup(){return this.setupSymbolContainer(),this.setupInputs(),this.setupEvals(),document.getElementById("item-next-button").textContent="Next",this.setupFontSettings()}getInputMode(e){return e==="real"||e==="integer"?"numeric":"text"}setupSymbolContainer(){let e=document.querySelector("#symbol-current .symbol");e.classList.add("symbol-"+this.dataset.displayData.type),e.setAttribute("lang",this.dataset.metadata.lang),e.setAttribute("dir",this.dataset.metadata.dir)}setupInputs(){this.inputs=h.mapKeyArrayToValues(this.properties,t=>{let n=document.createElement("INPUT");return l.setAttrs(n,{type:"text",inputmode:this.getInputMode(this.dataset.propsData[t].type),placeholder:this.dataset.propsData[t].label}),this.language&&this.language!=="default"&&n.setAttribute("lang",this.language),n});let e=document.getElementById("game-inputs");e.replaceChildren(...Object.values(this.inputs)),e.addEventListener("keydown",this.onInputKeydown)}onInputKeydown(e){let t=e.target.closest("INPUT");t&&(e.key==="Enter"?t.nextElementSibling?t.nextElementSibling.focus():document.getElementById("item-submit-button").focus():e.key==="Backspace"&&e.target.value===""&&t.previousElementSibling&&(t.previousElementSibling.focus(),e.preventDefault()))}setupEvals(){this.evals={};let e=document.getElementById("game-evals");for(let t of this.properties){let n=l.getTemplate("eval");this.evals[t]=n,e.append(n)}}updateSymbolWeight(e){document.querySelector("#game-symbols").style.setProperty("--symbol-weight",e.toString())}loadAndUpdateSymbolFont(e=null){return e??=this.fontSettings.getValue("family"),v.loadFont(this.dataset.getFont(e)).then(()=>this.updateSymbolFontFamily(e)).catch(t=>console.error(t))}updateSymbolFontFamily(e){e??=this.fontSettings.getValue("family"),document.querySelectorAll("#game-symbols .symbol-string").forEach(t=>{this.setSymbolFont(t,e)}),this.updateSymbolWeightRange(e)}updateSymbolWeightRange(e){let t=this.dataset.getFont(e).family,n=v.getFontData(t),r=this.fontSettings.settings.weight;if(n.variationSettings&&n.variationSettings.wght){let[i,o]=n.variationSettings.wght.split(" ").map(a=>parseInt(a,10));r.setMin(i),r.setMax(o),l.show(r.node)}else l.hide(r.node)}setupFontSettings(){let e=this.dataset.displayData.defaultWeight??500,t=D.create(100,900,e);return t.label("Weight"),this.fontSettings=b.createFrom({family:this.dataset.fontFamilySetting(),weight:t}),document.querySelector("#font-settings").replaceChildren(...this.fontSettings.nodeList()),this.fontSettings.addUpdateListener("weight",this.updateSymbolWeight),this.fontSettings.addUpdateListener("family",()=>l.transition(this.loadAndUpdateSymbolFont)),this.updateSymbolWeight(e),this.loadAndUpdateSymbolFont()}setSymbolFont(e,t){v.setFont(e,this.dataset.getFont(t))}setReferenceItems(e){this.referenceItems=e}seed(e){this.dealer.seed(e)}cleanup(){this.clearItemDisplay(),this.updateProgressBar(0),document.getElementById("game-inputs").removeEventListener("keydown",this.onInputKeydown),document.getElementById("game-inputs").replaceChildren(),document.getElementById("game-evals").replaceChildren()}finish(){setTimeout(()=>this.cleanup(),100),this.onFinish.call(this)}currentItem(){return this.dealer.currentItem()}submitRound(){let e=0,t=this.currentItem();for(let[n,r]of Object.entries(this.inputs)){let i=this.evals[n],o=t.properties[n],[a,c,u]=o.grade(r.value);if(e+=a,!L.passes(a)){let d=this.getReferenceItems(t.form,n,r.value);if(d.length>0){let p=this.referenceItemsNodes(d,n);document.getElementById("game-symbols").append(...p),this.updateSymbolFontFamily(this.fontSettings.getValue("family"));for(let f of p)this.scaleItemNodeContents(f);for(let f of d)this.dealer.punish(this.dealer.getItemIndex(f),1/d.length)}}i.querySelector(".submitted").replaceChildren(...c),i.querySelector(".solution").replaceChildren(...u),l.classIfElse(o instanceof q&&o.listMode==="best",i,"best-mode")}e/=this.properties.length,this.dealer.enterScore(e),this.updateProgressBar(),this.dealer.isEmpty()&&(document.getElementById("item-next-button").textContent="Finish"),this.show("evals"),window.scrollY>0&&window.scrollTo({top:0,behavior:"smooth"})}getReferenceItems(e,t,n){if(!this.referenceItems)return[];let r=[];for(let[i,o]of this.referenceItems[e].entries()){let a=o.properties[t].grade(n)[0];L.passes(a)&&r.push([i,a])}return r.sort(([i,o],[a,c])=>c-o||i-a),r.length>0&&r[0][1]===1&&(r=r.filter(([i,o])=>o===1)),r.map(([i,o])=>this.referenceItems[e][i])}referenceItemsNodes(e,t){return e.map(n=>this.referenceItemNode(n,t))}referenceItemNode(e,t){let n=l.getTemplate("symbolContainer");return n.classList.add("symbol-reference"),n.querySelector(".symbol").classList.add("symbol-"+this.dataset.displayData.type),this.updateItemNode(n,e,t,!1),n}updateItemNode(e,t,n=null,r=!0){n??=this.properties[0],e.querySelector(".symbol").textContent=t.displayString,e.querySelector(".symbol-label").textContent=t.properties[n].displayString,r&&this.scaleItemNodeContents(e)}scaleItemNodeContents(e){l.scaleToFit(e.querySelector(".symbol")),l.scaleToFit(e.querySelector(".symbol-label"))}clearInputs(){for(let e of Object.values(this.inputs))e.value=""}show(e){this.shown=e,requestAnimationFrame(this._show)}_show(){l.toggleShown(this.shown==="inputs",[document.getElementById("game-inputs"),document.getElementById("item-submit-button")],[document.getElementById("game-evals"),document.getElementById("item-next-button")]),l.toggleShown(this.shown==="inputs",null,document.querySelector("#symbol-current .symbol-label"),"visibility"),this.shown==="inputs"?(document.querySelectorAll("#game-symbols .symbol-reference").forEach(e=>{e.remove()}),this.focus()):document.getElementById("item-next-button").focus()}updateProgressBar(e=null){e??=this.dealer.progress(),document.getElementById("progress-bar").style.setProperty("--progress",e)}newRound(){if(this.dealer.isEmpty()){this.finish();return}this.dealer.nextItem(),this.displayItem(this.currentItem()),this.clearInputs(),this.show("inputs")}focus(){this.inputs[this.properties[0]].focus({preventScroll:!0})}displayItem(e){this.updateItemNode(document.getElementById("symbol-current"),e)}clearItemDisplay(){document.querySelector("#symbol-current .symbol").textContent="",document.querySelector("#symbol-current .symbol-label").textContent=""}};var w=g.range,Qe={buttonMinWidth:"--button-min-width",buttonMaxWidth:"--button-max-width",symbolSize:"--symbol-size",labelGap:"--label-gap",symbolMinWidth:"--symbol-min-width"},sn=["mode","indices","transpose","nColumns","dblClickGroups","rowLabels","columnLabels","rowLabelPosition","columnLabelPosition","rangeSelectionMode"],G=class{constructor(e,t){this.items=e,this.itemIndices=new Set(g.range(e.length)),this.dataset=t,this.formsData=t.formsData,this.selectorData=t.selectorData,this.updateListeners=new I,this.metadata={},this.activeForms=[],this.onBlockLabelClick=this.onBlockLabelClick.bind(this),this.onBlockButtonClick=this.onBlockButtonClick.bind(this),this.onBlockButtonEnter=this.onBlockButtonEnter.bind(this),this.onBlockLabelPointerOverOut=this.onBlockLabelPointerOverOut.bind(this),this.onBlockLabelPointerDown=this.onBlockLabelPointerDown.bind(this),this.onBlockLabelPointerUpCancel=this.onBlockLabelPointerUpCancel.bind(this),this.onBlockRangePointerDown=this.onBlockRangePointerDown.bind(this),this.onBlockRangePointerMove=this.onBlockRangePointerMove.bind(this),this.onBlockRangePointerUpCancel=this.onBlockRangePointerUpCancel.bind(this)}setup(e=null){this.node=e||l.createElement("div.item-selector"),this.node.dataset.dataset=this.dataset.key,this.setupButtons(),this.setupBlocks(),new ResizeObserver(this.scaleButtons.bind(this)).observe(e)}assertSetup(){if(!this.buttons||!this.blocks)throw new Error("Selector not setup yet.")}setMetadata(e){this.assertSetup(),e=h.onlyKeys(e,["lang","dir"]),Object.keys(e).length!==0&&(this.node.querySelectorAll(".symbol").forEach(t=>l.setAttrs(t,e)),e.dir&&this.blocks.forEach(t=>t.node.setAttribute("dir",e.dir)))}setItemIndices(e){this.assertSetup(),this.itemIndices=new Set(e),this.updateButtonsForms()}setSymbolFont(e){this.assertSetup(),this.node.querySelectorAll(".symbol-string").forEach(t=>v.setFont(t,e))}setupButtons(){this.itemsActive=new Array(this.items.length).fill(!0),this.buttons=this.items.map((e,t)=>this.getItemButton(e,t))}setupBlocks(){let e=this.selectorData.block?[this.selectorData.block]:this.selectorData.blocks?this.selectorData.blocks:[{mode:"flex"}];this.blocks=e.map(n=>h.onlyKeys(n,sn,!0));let t=this.processIndexSubsets(e.map(n=>n.indices??"rest"),this.items.length,!0);for(let[n,r]of this.blocks.entries()){r.node=l.createElement("div.selector-block"),r.indices=t[n],this.standardizeBlockIndices(r),r.elements=[];for(let[i,o]of r.indices.entries()){let a=o===null?this._gridGapElement():this.buttons[o];r.elements.push(a),r.node.append(a),a.dataset.indexWithinBlock=i}r.mode==="grid"?(r.node.classList.add("selector-block-grid"),r.node.style.setProperty("--columns",r.nColumns)):r.node.classList.add("selector-block-flex"),r.node.setAttribute("data-block-index",n.toString()),this.applyBlockStyle(r,this.selectorData.style,r.style),this.processListenerIndices(r),this.setupBlockListeners(r),this.node.append(r.node);try{this.addBlockLabels(r)}catch(i){console.error("Error occured while trying to add block labels."),console.error(i)}}}addBlockLabels(e){let t=e.nColumns,n=Math.round(e.indices.length/t);if(e.rowLabels){if(typeof e.rowLabels=="string"&&(e.rowLabels=e.rowLabels.split("")),!Array.isArray(e.rowLabels)||e.rowLabels.length!==n)throw new Error("Row labels no array or don't match number of rows.");let[r,i,o]=this._processLabelPosition(e.rowLabelPosition);[e.rowLabelStart,e.rowLabelEnd]=[i,o],e.node.classList.add(`has-row-labels-${r}`);for(let[a,c]of e.rowLabels.entries()){let u=this._labelElement("row",c,a);e.rowLabelStart&&e.elements[a*t].insertAdjacentElement("beforebegin",u),e.rowLabelEnd&&(e.rowLabelStart&&(u=u.cloneNode(!0)),a===t-1?e.node.insertAdjacentElement("beforeend",u):e.elements[a*(t+1)].insertAdjacentElement("beforebegin",u))}}if(e.columnLabels){if(typeof e.columnLabels=="string"&&(e.columnLabels=e.columnLabels.split("")),!Array.isArray(e.columnLabels)||e.columnLabels.length!==t)throw new Error("Column labels no array or don't match number of columns.");let[r,i,o]=this._processLabelPosition(e.columnLabelPosition);[e.columnLabelStart,e.columnLabelEnd]=[i,o];let a=e.columnLabels.map((c,u)=>this._labelElement("column",c,u));"rowLabels"in e&&(e.rowLabelStart&&a.splice(0,0,this._gridGapElement(!0)),e.rowLabelEnd&&a.push(this._gridGapElement(!0))),e.columnLabelStart&&e.node.prepend(...a),e.columnLabelEnd&&(e.columnLabelStart&&(a=a.map(c=>c.cloneNode(!0))),e.node.append(...a))}}applyBlockStyle(e,...t){let n=Object.assign({},...t);"buttonWidth"in n&&(n.buttonMinWidth=n.buttonWidth,n.buttonMaxWidth=n.buttonWidth,delete n.buttonWidth);for(let[r,i]of Object.entries(n))r in Qe||console.error(`Invalid selector block style property ${r}.`),e.node.style.setProperty(Qe[r],i)}_gridGapElement(e=!1){return l.createElement(`span.selector-grid-${e?"label-":""}gap`)}_labelElement(e,t,n){if(t===null)return this._gridGapElement(!0);let r=l.createElement(`span.block-label.block-${e}-label`);return r.setAttribute("tabindex",0),r.textContent=t,r.dataset.index=n.toString(),r}getButtonsFromIndices(e){return e?e.filter(t=>t!==null).map(t=>this.buttons[t]):[]}buttonsClassIfElse(e,t,n,r=null){l.classIfElse(e,this.getButtonsFromIndices(t),n,r)}buttonsRemoveClass(e,t){l.removeClass(this.getButtonsFromIndices(e),t)}buttonsAddClass(e,t){l.addClass(this.getButtonsFromIndices(e),t)}_processLabelPosition(e){return e??="start",e==="both"?[e,!0,!0]:e==="end"?[e,!1,!0]:(e!=="start"&&console.error("Invalid label position, use 'start', 'end' or 'both'."),["start",!0,!1])}processListenerIndices(e){e.mode==="grid"&&(e.indicesByRow=w(e.nRows).map(t=>w(e.nColumns).map(n=>e.indices[t*e.nColumns+n]).filter(n=>n!==null)),e.indicesByColumn=w(e.nColumns).map(t=>w(e.nRows).map(n=>e.indices[n*e.nColumns+t]).filter(n=>n!==null))),e.dblClickGroups??=[w(e.indices.length)],e.dblClickGroups=this.processIndexSubsets(e.dblClickGroups,e.indices.length);for(let[t,n]of e.dblClickGroups.entries())for(let r of n)e.elements[r].dataset.dblClickGroup=t;e.dblClickGroups=e.dblClickGroups.map(t=>t.map(n=>e.indices[n]).filter(n=>n!==null))}setupBlockListeners(e){e.node.addEventListener("click",this.onBlockButtonClick),e.node.addEventListener("keydown",this.onBlockButtonEnter),this.resetRangeSelection(),e.node.addEventListener("pointerdown",this.onBlockRangePointerDown),e.mode==="grid"&&(e.node.addEventListener("click",this.onBlockLabelClick),e.node.addEventListener("keydown",this.onBlockLabelClick),e.node.addEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerdown",this.onBlockLabelPointerDown))}removeBlockListeners(e){e.node.removeEventListener("click",this.onBlockButtonClick),e.node.removeEventListener("keydown",this.onBlockButtonClick),e.node.removeEventListener("pointerdown",this.onBlockRangePointerDown),e.node.removeEventListener("pointermove",this.onBlockRangePointerMove),e.mode==="grid"&&(e.node.removeEventListener("click",this.onBlockLabelClick),e.node.removeEventListener("keydown",this.onBlockLabelClick),e.node.removeEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerdown",this.onBlockLabelPointerDown))}onBlockButtonClick(e){let t=e.target.closest(".selector-item-button, .selector-grid-gap");if(!t)return;let n=this.getBlockIndexFromEvent(e);if(e.detail%2===0&&this.lastBlockClicked===n&&this.lastButtonClicked===t.dataset.indexWithinBlock){let r=this.getBlockFromEvent(e),i=t.dataset.dblClickGroup,o=r.dblClickGroups[i];this.toggleItems(o,{updateIfDisabled:!0})}this.lastButtonClicked=t.dataset.indexWithinBlock,this.lastBlockClicked=n}onBlockButtonEnter(e){if(e.key!=="Enter")return;let t=e.target.closest(".selector-item-button");t&&this.toggleItems([t.dataset.index])}getBlockIndexFromEvent(e){let t=e.target.closest(".selector-block");return t?t.dataset.blockIndex:null}getBlockFromEvent(e){let t=this.getBlockIndexFromEvent(e);return t!==null?this.blocks[t]:null}getIndicesFromBlockLabelEvent(e){let t=e.target.closest(".block-label");if(!t)return;let n=t.classList.contains("block-row-label")?"indicesByRow":"indicesByColumn",r=t.dataset.index;return this.getBlockFromEvent(e)[n][r]}onBlockLabelClick(e){if(e.type==="keydown"&&e.key!=="Enter")return;let t=this.getIndicesFromBlockLabelEvent(e);t&&this.toggleItems(t)}onBlockLabelPointerOverOut(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&this.buttonsClassIfElse(e.type==="pointerover",t,"hover")}onBlockLabelPointerDown(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&(this.buttonsAddClass(t,"active"),this.blockLabelActiveIndices=t,document.addEventListener("pointerup",this.onBlockLabelPointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockLabelPointerUpCancel,{once:!0}))}onBlockLabelPointerUpCancel(){let e=this.blockLabelActiveIndices;e&&this.buttonsRemoveClass(e,"active"),this.blockLabelActiveIndices=null,this.removeDocumentLabelListeners()}resetRangeSelection(){this.rangeSelectingBlockIndex=null,this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=null,this.rangeSelectStartIndex=null,this.rangeSelectStopIndex=null,this.rangeSelectionActiveIndices=null}onBlockRangePointerMove(e){if(this.rangeSelectingBlockIndex===null)return;let n=document.elementFromPoint(e.clientX,e.clientY).closest(".selector-item-button, .selector-grid-gap");if(!n||n.closest(".selector-block").dataset.blockIndex!==this.rangeSelectingBlockIndex)return;let i=n.dataset.indexWithinBlock;this.rangeSelectStopIndex!==i&&(this.rangeSelectStartIndex??=i,this.rangeSelectStopIndex=i,this.updateRangeSelection())}onBlockRangePointerDown(e){let t=this.getBlockIndexFromEvent(e);if(t===null)return;this.rangeSelectingBlockIndex=t;let n=e.target.closest(".selector-item-button, .selector-grid-gap");n&&(this.rangeSelectStartIndex=n.dataset.indexWithinBlock,this.rangeSelectStopIndex=this.rangeSelectStartIndex,this.updateRangeSelection()),document.addEventListener("pointerup",this.onBlockRangePointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockRangePointerUpCancel,{once:!0}),this.blocks[t].node.addEventListener("pointermove",this.onBlockRangePointerMove)}onBlockRangePointerUpCancel(e){this.rangeSelectingBlockIndex!==null&&(e.type==="pointerup"&&this.getBlockIndexFromEvent(e)===this.rangeSelectingBlockIndex&&this.rangeSelectionActiveIndices&&this.toggleItems(this.rangeSelectionActiveIndices),this.blocks[this.rangeSelectingBlockIndex].node.removeEventListener("pointermove",this.onBlockRangePointerMove),this.removeDocumentRangeListeners(),this.resetRangeSelection())}removeDocumentLabelListeners(){document.removeEventListener("pointerup",this.onBlockLabelPointerUpCancel),document.removeEventListener("pointercancel",this.onBlockLabelPointerUpCancel)}removeDocumentRangeListeners(){document.removeEventListener("pointerup",this.onBlockRangePointerUpCancel),document.removeEventListener("pointercancel",this.onBlockRangePointerUpCancel)}updateRangeSelection(){this.rangeSelectionActiveIndices&&this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=this.getIndicesInRangeSelection(),this.buttonsAddClass(this.rangeSelectionActiveIndices,"active")}getIndicesInRangeSelection(){if(this.rangeSelectStartIndex===null||this.rangeSelectStopIndex===null)return[];let[e,t]=te(this.rangeSelectStartIndex,this.rangeSelectStopIndex),n=this.blocks[this.rangeSelectingBlockIndex];if(n.mode==="grid")if(n.rangeSelectionMode??="grid",n.rangeSelectionMode==="grid"){let[r,i]=ve(e,n.nColumns),[o,a]=ve(t,n.nColumns);return[r,o]=te(r,o),[i,a]=te(i,a),w(r,o+1).map(c=>w(c*n.nColumns+i,c*n.nColumns+a+1)).flat().map(c=>n.indices[c])}else if(n.rangeSelectionMode==="walkColumns"){let r=this.transposeIndex(e,n.nRows,n.nColumns),i=this.transposeIndex(t,n.nRows,n.nColumns);[r,i]=te(r,i);let o=this.transposedRange(n.nColumns,n.nRows);return w(r,i+1).map(a=>o[a]).map(a=>n.indices[a])}else n.rangeSelectionMode!=="walkRows"&&console.error("Invalid range selection mode, use grid, walkRows or walkColumns.");return w(e,t+1).map(r=>n.indices[r])}standardizeBlockIndices(e){if(e.mode==="grid"){if(!e.nColumns)throw new Error("Block columns not set.");e.nRows=Math.ceil(e.indices.length/e.nColumns);let t=e.indices.length%e.nColumns;if(t!==0){let n=e.nColumns-t;e.indices.push(...new Array(n).fill(null))}e.transpose&&this.transposeBlock(e)}}transposeBlock(e){e.indices=this.transposeIndices(e.indices,e.nRows,e.nColumns)}transposeIndices(e,t,n){if(e.length!==t*n)throw new Error("Dimensions don't match.");return this.transposedRange(t,n).map(r=>e[r])}transposedRange(e,t){return w(e*t).map(n=>this.transposeIndex(n,e,t))}transposeIndex(e,t,n){let[r,i]=ve(e,n);return i*t+r}processIndexSubsets(e,t,n=!1){let r=[],i=new Array(t).fill(!1);for(let[a,c]of e.entries()){if(c==="rest"){a!==e.length-1&&console.error("Can only have subset 'rest' at the end."),r.push(g.filterIndices(i,d=>!d));break}let u=[];for(let d of this.processIndices(c,n))if(u.push(d),d!==null){if(i[d])throw new Error(`Duplicate subset index ${d}.`);i[d]=!0}r.push(u)}let o=g.filterIndices(e,a=>!a);if(o.length!==0)throw new Error(`Not all indices were covered: missing ${o}.`);return r}updateButtonsForms({scale:e=!0}={}){for(let[t,n]of this.buttons.entries())this.itemIndices.has(t)?this._updateButtonForms(n):n.setAttribute("aria-disabled",!0);e&&this.scaleButtons()}_updateButtonForms(e){let t=!0;e.querySelectorAll(".symbol-form").forEach(n=>{let r=this.activeForms.includes(n.dataset.form);l.toggleShown(r,n),r&&(t=!1)}),e.setAttribute("aria-disabled",t)}toggleItems(e,{updateIfDisabled:t=!1}={}){e=e.filter(r=>r!==null);let n=e.map(r=>this.itemsActive[r]).includes(!1);for(let r of e)this.updateItem(r,n,{updateIfDisabled:t,callUpdateListeners:!1});this.updateListeners.call(this)}updateItem(e,t,{updateIfDisabled:n=!1,callUpdateListeners:r=!0}={}){this.itemsActive[e]=t,(this.buttons[e].getAttribute("aria-disabled")!=="true"||n)&&this.buttons[e].setAttribute("aria-checked",t.toString()),r&&this.updateListeners.call(this)}activeQuizItemCount(){let e=0;for(let t of this.itemIndices)this.itemsActive[t]&&(e+=this.items[t].countQuizItems(this.activeForms));return e}scaleButtons(){if(this.node.clientWidth!==0)for(let e of this.blocks){let t=e.indices.filter(n=>n!==null).map(n=>this.buttons[n]).filter(n=>n.getAttribute("aria-disabled")!=="true");l.scaleAllToFit(t.map(n=>n.querySelector(".symbol")),{containers:t,uniform:.75}),this.selectorData.label&&l.scaleAllToFit(t.map(n=>n.querySelector(".selector-item-label")),{containers:t,uniform:.75})}}processItemsActive(e){if(e==="all"||e==="none")return new Array(this.items.length).fill(e==="all");let t=new Array(this.items.length).fill(!1);for(let n of this.processIndices(e))t[n]=!0;return t}setActive(e){if(typeof e=="string")try{e=this.processItemsActive(e)}catch(t){console.error(t);return}else{if(e.length!==this.items.length){console.error("Items Active length doens't match number of items.");return}e.map(t=>([!0,!1,0,1].includes(t)||console.warn("Invalid itemsActive, should be array of booleans or 0s and 1s."),!!t))}for(let[t,n]of e.entries())this.updateItem(t,n,{updateIfDisabled:!0,callUpdateListeners:!1});this.updateButtonsForms()}getItemButton(e,t){let n=l.createElement("div.selector-item-button"),r=l.uniqueIdPrefix("selectorButton")+t.toString();if(l.setAttrs(n,{id:r,role:"checkbox",tabindex:"0","aria-checked":"false","aria-labelledby":r}),n.append(this.getSymbolElement(e)),this.selectorData.label){let i=l.createElement("span.selector-item-label"),o=this.selectorData.label,a=e.properties[o.property];if(o.splitFirst??!0){let c=o.splitter??"[,;/]";a=a.split(new RegExp(`s*(${c})s*`))[0]}i.textContent=a,n.append(i)}return n.dataset.index=t.toString(),n}getSymbolElement(e){let t=l.createElement("span.symbol.symbol-string");return t.append(...Object.values(e.getFormNodes())),t}removeListeners(){for(let e of this.blocks)this.removeBlockListeners(e);this.removeDocumentRangeListeners(),this.removeDocumentLabelListeners()}setActiveForms(e,t={}){this.activeForms=e,this.updateButtonsForms(t)}activeIndices(){return g.filterIndices(this.itemsActive,e=>e).filter(e=>this.buttons[e].getAttribute("aria-disabled")!=="true")}processIndices(e,t=!1){if(typeof e=="string")return this.parseRanges(e,t);if(typeof e=="number")return[e];if(!Array.isArray(e))throw new Error("Invalid indices datatype: need string, number or Array<number>.");e=e.sort();let n=e.length;return e=e.filter((r,i,o)=>i===0||r!==o[i-1]),e.length!==n&&console.warn("Indices contain duplicates."),e}parseRanges(e,t=!1){return[].concat(...e.split(",").map(n=>{if(t&&n.substring(0,3)==="gap"){let r=n.length===3?1:this.parseInt(n.substring(3));return new Array(r).fill(null)}else if(n.substring(0,5)==="block")return this.blocks[n.substring(5)].indices;return this.parseRange(n)}))}parseRange(e){let t=e.split(":").map(o=>this.parseInt(o));if(t.length===1)return t;if(t.length===0||t.length>3)throw new Error("Invalid range, 2-3 numbers.");let n=t[0],r=t[t.length-1],i=t.length===3?t[1]:1;if(r<n||i<1)throw new Error("Invalid range, must have start <= stop and step >= 1.");return w(n,r+1,i)}parseInt(e){let t=parseInt(e);if(isNaN(t))throw new Error("Not a number.");return t}};function ve(s,e){let t=s%e;return[Math.round((s-t)/e),t]}function te(s,e){return[Math.min(s,e),Math.max(s,e)]}var T={arabic:{name:"Arabic",file:"arabic.json"},elements:{name:"Atomic Elements",file:"elements.json"},cyrillic:{name:"Cyrillic",file:"cyrillic.json"},elder_futhark:{name:"Elder Futhark",file:"elder_futhark.json"},greek:{name:"Greek",file:"greek.json"},hebrew:{name:"Hebrew",file:"hebrew.json"},japanese:{name:"Japanese Kana",file:"japanese.json"},phoenician:{name:"Phoenician",file:"phoenician.json"}};l.registerTemplate("headingElement",'<div class="heading-element"><span class="heading-element-number"></span><span class="heading-element-symbol"></span></div>');var on="./json/datasets/",Xe="elder_futhark",an={gameHeading:"Kadmos",terms:{letter:"letter"},lang:"en",dir:"ltr"},Ze=["letter","letters"],ln={keys:["default"],setting:{default:{label:"Default",active:!0}},defaultForm:"default",singleForm:!0},cn={languages:["en"],default:"en"},un={en:"English",de:"German"},K=class{static _cache={};constructor(e){this.name=e.name,this.metadata=this.processMetadata(e.metadata),this.processFonts(e.fonts),this.displayData=e.displayData??{},this.displayData.type??="string",this.formsData=e.formsData??ln,this.propsData=e.propsData,this.selectorData=e.selectorData??{},this.variantsData=this.processVariants(e.variantsData),this.languageData=e.languageData??cn,this.languageData.default??=this.languageData.languages[0],this.items=this.processItems(e.symbolsData)}static fetch(e){return e in T?e in this._cache?Promise.resolve(this._cache[e]):fetch(on+T[e].file).then(t=>t.json()).then(t=>{let n=new this(t);return n.key=e,this._cache[e]=n,n}).catch(l.printError):(console.error(`Invalid dataset key "${e}".`),null)}processMetadata(e){return e=Object.assign({},an,e),e.terms.letter??="letter",e.terms.letters??=e.terms.letter+"s",e}processVariants(e){if(!e||!e.variants)return null;for(let[t,n]of Object.entries(e.variants))typeof n=="string"&&(e.variants[t]={label:n}),e.variants[t].lang??=t;return e}getGameSettings(e){let t={};return this.hasPropsSetting()&&(t.properties=this.propertySetting(e.properties)),this.hasLanguageSetting()&&(t.language=this.languageSetting(e.language)),b.createFrom(t)}getFilterSettings(e){let t={};return this.hasVariantSetting()&&(t.variant=this.variantSetting(e.variant)),this.hasFormsSetting()&&(t.forms=this.formsSetting(e.forms)),b.createFrom(t)}propertySetting(e=null){return A.from(h.map(this.propsData,t=>t.label),{label:"Properties",checked:e??h.map(this.propsData,t=>!!t.active)})}languageSetting(e=null){return A.from(h.onlyKeys(un,this.languageData.languages),{label:"Language",checked:e??this.languageData.default,exclusive:!0})}formsSetting(e=null){if(!this.hasFormsSetting())return null;let t=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");return A.from(h.map(this.formsData.setting,n=>n.label),{label:t,exclusive:!!this.formsData.exclusive,checked:e??h.map(this.formsData.setting,n=>n.active??!1)})}getFormsFromSettingsValue(e){return typeof e=="string"&&(e=[e]),e.map(t=>this.formsData.setting[t].keys??[t]).flat()}variantSetting(e=null){return C.createSelect(h.map(this.variantsData.variants,t=>t.label),{label:"Variant",selected:e??this.variantsData.default??Object.keys(this.variantsData.variants)[0],groups:Object.values(this.variantsData.groups)??[]})}hasSetting(e){switch(e){case"properties":return Object.keys(this.propsData).length>1;case"language":return this.languageData.languages.length>1;case"variant":return!!this.variantsData;case"forms":return this.formsData.showSetting??Object.keys(this.formsData.setting).length>1;case"font-family":return Object.keys(this.fonts).length>1;default:throw new Error(`Invalid settings key ${e}.`)}}hasPropsSetting(){return Object.keys(this.propsData).length>1}hasLanguageSetting(){return this.languageData.languages.length>1}hasVariantSetting(){return!!this.variantsData}hasFormsSetting(){return this.formsData.showSetting??Object.keys(this.formsData.setting).length>1}hasFontFamilySetting(){return Object.keys(this.fonts).length>1}getItemSelector(e=null){let t=new G(this.items,this);return t.setup(e),t.setMetadata(h.onlyKeys(this.metadata,["lang","dir"])),this.selectorData.defaultActive&&t.setActive(this.selectorData.defaultActive),t.setSymbolFont(this.getSelectorDisplayFont()),t}getVariantItemIndices(e){return g.filterIndices(this.items,t=>t.variants.has(e))}getFont(e){return e?(typeof e=="string"&&(e={key:e}),e.key??=this._defaultFontKey,!e.key in this.fonts&&(console.error(`Unknown font key "${e.key}".`),e.key=this._defaultFontKey),h.withoutKeys(Object.assign({},this.fonts[e.key],e),["key","default","label"])):this.defaultFont()}getSelectorDisplayFont(){return this.getFont(this.selectorData.font)}processFonts(e){this.fonts=e;let t=Object.entries(e).find(([n,r])=>r.default);this._defaultFontKey=t?t[0]:Object.keys(e)[0]}defaultFont(){return this.fonts[this._defaultFontKey]}fontFamilySetting(e=null){let t=A.from(h.map(this.fonts,n=>n.label??n.family),{label:"Font",exclusive:!0,checked:e??this._defaultFontKey});return t.node.classList.add("font-family-setting"),t}processItems(e){let t=e.rows;if(!Array.isArray(t))throw new Error("symbol rows must be an array.");e.template&&this.applyTemplateToRows(t,e.template);let n=new Array(t.length),r;for(let[i,o]of t.entries()){try{r=this.processItem(o)}catch(a){console.warn("Error occured processing item at index",i),console.error(a);continue}n[i]=r}return n}applyTemplateToRows(e,t){for(let[n,r]of e.entries()){if(!Array.isArray(r))continue;let i={};for(let[o,a]of r.entries())i[t[o]]=a;e[n]=i}return e}processItem(e){let t=this.hasVariantSetting()?this.processItemVariants(e.variants):null;return new we(this.processDisplayForms(e.display),this.processItemProperties(e),t)}processItemProperties(e){let t={};for(let[n,r]of Object.entries(e)){if(n.substring(0,2)!=="p:")continue;let i=n.substring(2);t[i]=r}return t}processItemVariants(e){if(!e||e==="*")return Object.keys(this.variantsData.variants);if(Array.isArray(e))return e;let t=e.substring(0,2)!=="*-";t||(e=e.substring(2));let n=h.map(this.variantsData.variants,()=>!t);for(let r of e.split(","))if(r in this.variantsData.variants)n[r]=t;else if(this.variantsData.groups&&r in this.variantsData.groups)for(let i of this.variantsData.groups[r])n[i]=t;return h.filterKeys(n,r=>r)}processDisplayForms(e){if(this.formsData.singleForm)return Object.fromEntries([[this.formsData.defaultForm,e]]);if(typeof e=="string"&&(e=e.split("")),Array.isArray(e)){let n={};for(let[r,i]of e.entries())i&&(n[this.formsData.keys[r]]=i);return n}if(typeof e!="object")throw new Error("Invalid display format: need array or object.");let t=Object.keys(e).filter(n=>!this.formsData.keys.includes(n));if(t.length>0)throw new Error(`Invalid display Form key "${t[0]}".`);return e}getQuizItems(e,t,n,r=null){let i=[];for(let o of e){let a=this.items[o].getDisplayStrings(t),c=this.items[o].getItemProperties(n,this.propsData,r);i.push(...Object.entries(a).map(([u,d])=>new P(d,c,u)))}return i}referencePropsData(){let e=Object.assign({},this.propsData);for(let[t,n]of Object.entries(e))if("referenceMaxDist"in n){let r=Object.assign({},n);r.maxDist=n.referenceMaxDist,e[t]=r}return e}getReferenceItems(e,t=null){let n,r=this.referencePropsData();if(this.formsData.exclusive){let i=this.items.map(a=>a.getItemProperties(e,r,t)),o={};for(let a of this.formsData.keys)o[a]=this.items.map((c,u)=>new P(c.getFormsDisplayString([a]),i[u],a));return o}else return n=this.items.map(i=>new P(i.getFormsDisplayString(this.formsData.keys),i.getItemProperties(e,r,t),"all")),Object.fromEntries(this.formsData.keys.map(i=>[i,n]))}setupGameHeading(e){let t=this.metadata.gameHeading;if(v.setFont(e,this.getFont(t.font)),this.name==="Atomic Elements"){let n=document.createElement("div");n.classList.add("element-heading-container");let r=[];for(let[i,o]of[[19,"K"],[85,"At"],[42,"Mo"],[16,"S"]]){let a=l.getTemplate("headingElement");a.querySelector(".heading-element-symbol").textContent=o,a.querySelector(".heading-element-number").textContent=i,r.push(a)}n.replaceChildren(...r),e.replaceChildren(n)}else e.replaceChildren(t.string);e.setAttribute("lang",t.lang??this.metadata.lang),e.setAttribute("dir",t.dir??this.metadata.dir)}},we=class{constructor(e,t,n=null){this.displayForms=e,this.properties=t,this.variants=new Set(n)}getDisplayStrings(e){return h.onlyKeys(this.displayForms,e)}getItemProperties(e,t,n=null){let r={};for(let i of e){if(!(i in this.properties)){console.error(`Missing property key "${i}".`);continue}r[i]=this.properties[i]}if(n)for(let i of e){let o=i+"_"+n;this.properties[o]&&(r[i]=this.properties[o])}return h.map(r,(i,o)=>L.fromData(i,t[o]))}getFormNode(e){let t=l.createElement("span.symbol-form");return t.dataset.form=e,t.textContent=this.displayForms[e],t}getFormNodes(e=null){return h.mapKeyArrayToValues(e??Object.keys(this.displayForms),t=>this.getFormNode(t))}getFormsDisplayString(e){return Object.values(this.getDisplayStrings(e)).join("")}countQuizItems(e){return e.reduce((t,n)=>n in this.displayForms?t+1:t,0)}};var S=null,m=null,k=new b,O=new b,Ee=new b,y=null,et=null;function rt(){dn(),mn(),Ee.replaceSelf(V.genericSettings()),document.getElementById("generic-game-settings").append(...Ee.nodeList()),window.addEventListener("popstate",()=>l.transition(st)),hn(),st(!1)}function dn(){document.getElementById("start-game-button").addEventListener("click",()=>l.transition(at)),document.getElementById("stop-game-button").addEventListener("click",()=>{S.finish()}),document.getElementById("item-submit-button").addEventListener("click",()=>{l.transition(()=>{S.submitRound()},["game"])}),document.getElementById("item-next-button").addEventListener("click",()=>{l.transition(()=>{S.newRound()},["game"])})}function hn(){let s=document.getElementById("datasetSelect");l.setOptions(s,h.map(T,e=>e.name)),s.addEventListener("change",e=>{let t=e.target.value;K.fetch(t).then(n=>l.transition(()=>it(n))).catch(console.error)})}function xe(s){s||l.showPage(document.getElementById("game-filters"),{transition:!1}),l.toggleShown(s,[document.getElementById("game-container"),document.getElementById("stop-game-button"),document.getElementById("progress-bar")],[document.getElementById("new-game-settings")])}function mn(){et=b.createFrom({accentColor:gn(),colorMode:bn()}),document.querySelector("#page-settings .settings").replaceChildren(...et.nodeList()),document.getElementById("open-settings-button").addEventListener("click",()=>{l.transition(fn,["page-settings","ease-in"])}),document.getElementById("close-settings-button").addEventListener("click",()=>{l.transition(pn,["page-settings","ease-out"])})}function fn(){l.show(document.getElementById("page-settings-container")),document.documentElement.style.overflowY="hidden"}function pn(){l.hide(document.getElementById("page-settings-container")),document.documentElement.style.removeProperty("overflow-y")}function gn(){let s=window.localStorage.getItem("accentHue")||250;tt(s);let e=D.create(0,360,s);return e.label("Accent Hue"),e.updateListeners.push(t=>tt(t)),e.node.id="accentHueSlider",e}function tt(s){document.documentElement.style.setProperty("--accent-hue",s),window.localStorage.setItem("accentHue",s)}function bn(){let s=window.matchMedia("(prefers-color-scheme: dark)"),e=window.localStorage.getItem("colorMode")||(s.matches?"dark":"light");Ie(e);let t=A.from({dark:"Dark Mode",light:"Light Mode"},{label:"Color Mode",exclusive:!0,checked:e});return s.addEventListener("change",n=>{let r=n.matches?"dark":"light";t.value=[r],Ie(r)}),t.updateListeners.push(n=>l.transition(()=>Ie(n,{updateLocalStorage:!0}))),t}function Ie(s,{updateLocalStorage:e=!1}={}){if(s!=="dark"&&s!=="light")throw new Error(`Invalid color mode ${s}, use dark or light.`);l.classIfElse(s==="dark",document.documentElement,"dark-mode","light-mode"),e&&window.localStorage.setItem("colorMode",s)}function it(s){m=s,l.setSearchParams({dataset:s.key});let e=In(),t=m.metadata.gameHeading;return pe([m.getFont(t.font),m.getSelectorDisplayFont()]).then(()=>{yn(),l.showPage(document.getElementById("game-filters"),{transition:!1}),m.setupGameHeading(document.querySelector("#game-heading h1")),vn(e),Sn(e)})}function yn(){for(let s of Ze){let e=m.metadata.terms[s];document.querySelectorAll(".term-"+s).forEach(t=>{t.textContent=e})}}function Sn(s={}){y&&(y.removeListeners(),y.node.remove());let e=l.createElement("div.item-selector");document.getElementById("dataset-filter-settings").append(e),y=m.getItemSelector(e),s.items&&y.setActive(s.items),y.setActiveForms(ot(),{scale:!1}),m.hasVariantSetting()&&y.setItemIndices(m.getVariantItemIndices(k.getValue("variant"))),y.updateListeners.push(nt,ne),nt()}function vn(s){k.replaceSelf(m.getFilterSettings(s)),O.replaceSelf(m.getGameSettings(s)),k.addUpdateListener(ne),O.addUpdateListener(ne),m.hasFormsSetting()&&k.getSetting("forms").updateListeners.push(e=>l.transition(()=>{y.setActiveForms(m.getFormsFromSettingsValue(e))},["selector-forms"])),m.hasVariantSetting()&&k.getSetting("variant").updateListeners.push(e=>l.transition(()=>{y.setItemIndices(m.getVariantItemIndices(e))})),document.getElementById("dataset-filter-settings").replaceChildren(...k.nodeList()),document.getElementById("dataset-game-settings").replaceChildren(...O.nodeList())}function ot(){return m.hasFormsSetting()?m.getFormsFromSettingsValue(k.getValue("forms")):m.formsData.keys}function wn(){return O.getDefault("properties",Object.keys(m.propsData))}function nt(){l.setAttrs(document.querySelector(".pages-next-button"),{disabled:y.activeQuizItemCount()===0})}function at(){S&&S.cleanup(),ne();let s=wn(),e=O.getDefault("language",null),t=m.getQuizItems(y.activeIndices(),ot(),s,e),n=m.getReferenceItems(s,e);S=new V(m,t,s,e);let r=Ee.getValue("seed");r&&S.seed(r),S.setReferenceItems(n),S.onFinish.push(()=>{xe(!1)}),S.setup().then(()=>{xe(!0),S.newRound(),S.focus()}).catch(i=>console.error(i))}function st(){let s=new URLSearchParams(location.search),e=s.get("dataset");(!e||!(e in T))&&(e=Xe),document.getElementById("datasetSelect").value=e,K.fetch(e).then(t=>it(t)).then(()=>{["1","true"].includes(s.get("play"))?at():xe(!1)})}function lt(s=null){return"settings_"+(s||m.key)}function ne(){l.setSearchParams({dataset:m.key});let s=Object.assign({items:H.encodeBase64BoolArray(y.itemsActive)},k.getValues(),O.getValues());window.localStorage.setItem(lt(),JSON.stringify(s))}function In(){let s=window.localStorage.getItem(lt());if(!s)return{};try{let e=JSON.parse(s);return e.items=H.decodeBase64BoolArray(e.items),e}catch(e){return console.error(e),{}}}(function(){En(),l.transition(rt),document.querySelectorAll(".ribbon").forEach(s=>{xn(s,s.classList.contains("ribbon-closable"))}),document.querySelectorAll(".pages-container").forEach(s=>{l.setupPages(s)})})();function En(){let s=new URLSearchParams(location.search);["1","true"].includes(s.get("darkmode"))?document.documentElement.classList.add("dark-mode"):["1","true"].includes(s.get("lightmode"))&&document.documentElement.classList.add("light-mode")}function xn(s,e=!1){let t=s.querySelector(".ribbon-contents"),n=s.querySelectorAll(".ribbon-buttons input[type=checkbox]");s.dataset.closable=e.toString();let r=s.dataset.openId;if(!r){for(let i of n)if(i.checked){r=i.dataset.contentId;break}}l.hide(t.querySelectorAll(".ribbon-content")),!r&&!e&&(r=n[0].dataset.contentId,n[0].checked=!0),r?l.show([document.getElementById(r),t]):e&&s.classList.add("contents-hidden"),s.querySelector(".ribbon-buttons").addEventListener("change",An)}function An(s){l.transition(()=>{let e=s.target,t=e.closest(".ribbon"),n=t.querySelector(".ribbon-contents");if(e.checked){let r=t.dataset.openId;!t.classList.contains("contents-hidden")&&r&&(l.hide(document.getElementById(r)),t.querySelector(`.ribbon-buttons input[data-content-id="${r}"]`).checked=!1),t.dataset.openId=e.dataset.contentId,l.show([document.getElementById(e.dataset.contentId),n]),t.classList.remove("contents-hidden")}else t.dataset.closable==="true"?(t.classList.add("contents-hidden"),l.hide(n),t.dataset.openId=""):e.checked=!0},{transition:!0})}})();
//# sourceMappingURL=index.js.map
