(()=>{var dt=Object.defineProperty;var T=(s,e)=>{for(var t in e)dt(s,t,{get:e[t],enumerable:!0})};var h={};T(h,{extractKeys:()=>bt,filter:()=>pt,filterKeys:()=>gt,map:()=>ae,mapKeyArrayToValues:()=>St,mapKeys:()=>yt,onlyKeys:()=>le,subsetToBoolRecord:()=>vt,withoutKeys:()=>z});var g={};T(g,{arraysEqual:()=>oe,avg:()=>ht,bisectLeft:()=>ie,cumSums:()=>re,filterIndices:()=>mt,range:()=>ft,sum:()=>Fe});function re(s){return s.map((e=>t=>e+=t)(0))}function ie(s,e){let t=0,n=e.length,r;for(;t<n;)r=t+n>>1,e[r]<s?t=r+1:n=r;return t}function Fe(s){return s.reduce((e,t)=>e+t,0)}function ht(s){return s.length===0?(console.error("Cannot compute average of empty array."),0):Fe(s)/s.length}function oe(s,e){return s.length===e.length&&s.every((t,n)=>t===e[n])}function mt(s,e){return Array.from(s.entries()).filter(([t,n])=>e(n,t,s)).map(([t,n])=>t)}function ft(s,e=null,t=1){e===null&&(e=s,s=0);let n=Math.ceil((e-s)/t);return new Array(n).fill(0).map((r,i)=>s+t*i)}function ae(s,e){return Object.fromEntries(Object.entries(s).map(([t,n],r)=>[t,e(n,t,r)]))}function pt(s,e){return Object.fromEntries(Object.entries(s).filter(([t,n],r)=>e(n,t,r)))}function gt(s,e){return Object.entries(s).filter(([t,n],r)=>e(n,t,r)).map(([t,n])=>t)}function z(s,e){typeof e=="string"&&(e=[e]);let t=Object.assign({},s);for(let n of e)delete t[n];return t}function bt(s,e,t=!0){let n=e.map(r=>s[r]??null);return t&&n.push(z(s,e)),n}function le(s,e,t=!1){let n=new Set(e),r={};for(let[i,o]of Object.entries(s))n.has(i)?r[i]=o:t&&console.warn(`Filtered out key "${i}".`);return r}function yt(s,e){return Object.fromEntries(Object.entries(s).map(([t,n])=>[e(t),n]))}function St(s,e){return Object.fromEntries(s.map(t=>[t,e(t)]))}function vt(s,e){if(s==="none")s=[];else if(s==="all")s=e;else if(typeof s=="string")throw new Error('Invalid subset string specifier - use "none" or "all".');if(Array.isArray(s)){let t=Object.fromEntries(e.map(n=>[n,!1]));for(let n of s)t[n]=!0;return t}return oe(Object.keys(s).sort(),e.sort())||(console.log(s,e),console.warn("Subset object keys don't match keys list."),console.log(Object.keys(s).sort(),e.sort())),Object.fromEntries(e.map(t=>[t,!!s[t]]))}var l={};T(l,{addClass:()=>Ge,appendChildren:()=>Mt,batchUpdate:()=>Ut,button:()=>Ct,classIfElse:()=>j,classesToList:()=>fe,computeScaleToFit:()=>be,createElement:()=>Ot,elementSize:()=>pe,forEachElement:()=>X,getTemplate:()=>he,hide:()=>_,htmlToElement:()=>Pt,htmlToElements:()=>He,label:()=>Dt,log:()=>Vt,printError:()=>qt,promiseWrapper:()=>ge,registerTemplate:()=>_e,registerTemplates:()=>Re,removeClass:()=>jt,scaleAllToFit:()=>Ht,scaleToFit:()=>_t,setAttrOnKeys:()=>Nt,setAttrs:()=>Ue,setDefaultId:()=>Ve,setOptions:()=>Tt,setSearchParams:()=>Wt,setupPages:()=>Gt,show:()=>R,showPage:()=>J,toggleShown:()=>me,uniqueIdPrefix:()=>qe,updateDOM:()=>$t});var S={};T(S,{clearFont:()=>Te,getFontData:()=>kt,loadFont:()=>De,loadFonts:()=>N,setFont:()=>Lt,setFontProperties:()=>de,supportsStylesets:()=>ue,supportsVariableFonts:()=>Oe});var Be=[{family:"Noto Serif Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Hebrew",scale:1.25,shift:-.15,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Rashi Hebrew",scale:1.25,shift:-.05,fallback:"serif",variationSettings:{wght:"100 900"}},{family:"Noto Serif",fallback:"serif",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans",variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Sans Japanese",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Serif Japanese",fallback:"serif",shift:-.06,variationSettings:{wght:"100 900"}},{family:"Noto Sans Arabic",scale:.94,variationSettings:{wght:"100 900",wdth:"100"}},{family:"Noto Kufi Arabic",variationSettings:{wght:"100 900"}},{family:"Noto Naskh Arabic",variationSettings:{wght:"400 700"}},{family:"Noto Sans Phoenician"},{family:"Junicode",fallback:"serif",variationSettings:{wght:"300 700",wdth:"100",ENLA:"0"},styleset:{"Early-English-futhorc":12,"Elder-futhark":13,"Younger-futhark":14,"Long-branch-to-short-twig":15,"Latin-to-Gothic":19}}];var M=Object.fromEntries(Be.map(s=>[s.family,s])),It={display:"swap",weight:400,style:"normal"},Y={},ce={family:"font-family",weight:"font-weight",scale:"--font-scale",shift:"--font-shift",styleset:"font-variant-alternates",letterSpacing:"--letter-spacing",lineHeight:"--line-height"},Ce=["shift","scale","letterSpacing"];function De(s){return s?(s in Y||(Y[s]=Et(s),document.fonts.add(Y[s])),Y[s].load()):Promise.reject("No family given.")}function N(s){return Promise.all(s.map(e=>De(e)))}function xt(s){let e=`/kadmos/assets/fonts/${s.replaceAll(" ","")}.woff2`,t=Oe()?"woff2-variations":"woff2";return`url("${e}") format("${t}")`}function Pe(){return"CSS"in window&&"supports"in CSS}function ue(){return Pe()&&CSS.supports("font-variant-alternates","styleset(x)")}function Oe(){return Pe()&&CSS.supports("font-variation-settings","normal")}function Et(s){let e=Object.assign({},It,M[s]);if("styleset"in e&&ue()&&(document.styleSheets[0].insertRule(`@font-feature-values "${s}" {@styleset {`+Object.entries(e.styleset).map(([t,n])=>`${t}: ${n};`).join("")+"}}"),delete e.styleset),"variationSettings"in e){let t=At(e.variationSettings);delete e.variationSettings,Object.assign(e,t)}return new FontFace(s,e.url??xt(s),e)}function At(s){let e={};return"wght"in s&&(e.weight=s.wght,s=z(s,"wght")),Object.keys(s).length>0&&(e.variationSettings=Object.entries(s).map(([t,n])=>`"${t}" ${n}`).join(",")),e}function Lt(s,e,t={}){Te(s),Ft(s,e);let n=Object.assign({},t),r=M[e];"shift"in r&&(n.shift=r.shift+(t.shift??0)),"scale"in r&&(n.scale=r.scale*(t.scale??1)),de(s,n)}function kt(s){return M[s]}function de(s,e){let t=!1;for(let[n,r]of Object.entries(e))if(n!=="family"){if(!(n in ce)){console.warn(`Unknown font property '${n}'`);continue}Ce.includes(n)&&(t=!0),n==="styleset"?"family"in e?Bt(s,r,e.family):console.error("Cannot set styleset without knowing family."):s.style.setProperty(ce[n],r)}j(t,s,"font-transform")}function Ft(s,e){let t=M[e];s.style.fontFamily=e+", "+(t.fallback??"system-ui, sans-serif"),de(s,le(t,Ce))}function Te(s){for(let e of Object.values(ce))s.style.removeProperty(e)}function Bt(s,e,t){e=Array.isArray(e)?e:[e];let n=`styleset(${e.join(", ")})`;if(ue())s.style.setProperty("font-variant-alternates",n);else{let i=e.map(o=>M[t].styleset[o]).map(o=>`"ss${o.toString().padStart(2,"0")}"`).join(", ");s.style.setProperty("font-feature-settings",i)}}var Me=0;window.hasTouch="ontouchstart"in window;var Q={};function Re(s){for(let[e,t]of Object.entries(s))_e(e,t)}function _e(s,e){s in Q&&console.warn(`Overwriting existing template key ${s}.`);let t=document.createElement("TEMPLATE");typeof e=="string"?t.insertAdjacentHTML("beforeend",e):t.append(e),Q[s]=t}function he(s){return s in Q||console.error("Unknown template key "+s),Q[s].firstChild.cloneNode(!0)}Re({buttonLabel:'<label class="button"></label>',buttonInput:'<input class="button-check form-input" autocomplete="off">'});function Ct(s,e,t=null,n=null){let r=he("buttonInput"),i=he("buttonLabel");return n??=qe("button")+e,Ue(r,{type:s,value:e,id:n}),i.setAttribute("for",n),t&&(typeof t=="string"&&(t=document.createTextNode(t)),i.appendChild(t)),[r,i]}function Dt(s,e,t=null){let n=document.createElement("LABEL");return s instanceof Node&&(s=Ve(s,t)),n.setAttribute("for",s),n.textContent=e,n}function He(s){let e=document.createElement("TEMPLATE");return e.innerHTML=s,e.content.children}function Pt(s){let e=He(s);if(e.length!==1)throw new Error("HTML doesn't contain exactly one element.");return e[0]}function Ot(s){let[e,...t]=s.split("."),[n,r]=e.split("#"),i=document.createElement(n);return r&&(i.id=r),i.classList.add(...t),i}function Tt(s,e,{selected:t=null,disabled:n=[],groups:r=[]}={}){t??=Object.keys(e)[0];let i=ae(e,()=>!1),o=null;for(let{label:a,keys:c}of r){let u=document.createElement("OPTGROUP");u.label=a;for(let d of c){if(!(d in e)){console.warn(`Unknown grouped key ${d} in group ${a}.`);continue}u.append(Ne(d,e[d],t,n)),i[d]=!0}s.add(u),o||(o=u)}for(let[a,c]of Object.entries(e))i[a]||s.add(Ne(a,c,t,n),o)}function Ne(s,e,t,n){let r=document.createElement("OPTION");return r.value=s,r.textContent=e,t===s&&(r.selected="selected"),n.includes(s)&&(r.disabled="disabled"),r}function Mt(s,e){for(let t of e)s.appendChild(t)}function Nt(s,e,t,n=""){if(e){typeof e=="string"&&(e=[e]);for(let r of e)s[r].setAttribute(t,n)}}function Ue(s,e){for(let[t,n]of Object.entries(e))typeof n=="boolean"?n?s.setAttribute(t,t):s.removeAttribute(t):t==="class"?Ge(s,n):s.setAttribute(t,n)}function qe(s,e="_"){return Me+=1,s+Me+e}function Ve(s,e){return s.hasAttribute("id")?(s.id=e,e):s.id}function X(s,e){if(s)if(s instanceof Node)e(s);else for(let t of s)e(t)}function j(s,e,t,n=null){s||([t,n]=[n,t]),t=fe(t),n=fe(n),X(e,r=>{r.classList.remove(...n),r.classList.add(...t)})}function Ge(s,e){j(!0,s,e)}function jt(s,e){j(!1,s,e)}function R(s,e="display"){X(s,t=>{t.style.removeProperty(e)})}var Rt={display:"none",visibility:"hidden",opacity:"0"};function _(s,e="display"){X(s,t=>{t.style.setProperty(e,Rt[e])})}function me(s,e,t=null,n="display"){s?(t&&_(t,n),R(e,n)):(_(e,n),t&&R(t,n))}function fe(s){return s??=[],typeof s=="string"?s.split(" "):Array.from(s)}function pe(s,e="border-box",t=!1){let n=t?s.scrollWidth:s.clientWidth,r=t?s.scrollHeight:s.clientHeight,i=window.getComputedStyle(s),o=i.scale;return!o||o==="none"?o=1:o=parseFloat(o),e==="border-box"?(n+=o*(parseFloat(i.borderLeftWidth||0)+parseFloat(i.borderRightWidth||0)),r+=o*(parseFloat(i.borderTopWidth||0)+parseFloat(i.borderBottomWidth||0))):e==="content-box"?(n-=o*(parseFloat(i.paddingLeft||0)+parseFloat(i.paddingRight||0)),r-=o*(parseFloat(i.paddingTop||0)+parseFloat(i.paddingBottom||0))):e!=="padding-box"&&console.error("Invalid value for element size box, use padding-box, content-box or border-box."),[n,r]}function be(s,{container:e=null,dimension:t="width",elementBox:n="border-box",containerBox:r="content-box",grow:i=!1}={}){e??=s.parentElement;let[o,a]=pe(s,n,!0),[c,u]=pe(e,r),d=je(o,c,i),p=je(a,u,i);return["width","height","both"].includes(t)||(console.error("Invalid dimension, use 'width', 'height' or 'both'."),t="width"),t==="width"?d:t==="height"?p:Math.min(d,p)}function _t(s,e={}){s.style.scale=be(s,e)}function Ht(s,e={}){let t=e.uniform??0,n=e.containers??s.map(i=>i.parentElement);if("container"in e&&(console.warn("Can't set single container for scaleAllToFit."),delete e.container),!Array.isArray(n)||n.length!==s.length){console.error("Containers and elements length don't match.");return}let r=s.map((i,o)=>be(i,Object.assign(e,{container:n[o]})));if(t>0){let o=Math.min(...r)/t;for(let[a,c]of r.entries())r[a]=Math.min(o,c)}for(let[i,o]of s.entries())o.style.scale=r[i]}function je(s,e,t=!1){if(s===0)return console.warn("getScale: Element's size is 0."),1;if(isNaN(s))return console.error("Element size is NaN."),1;if(isNaN(e))return console.error("Container size is NaN."),1;let n=e/s;return t?n:Math.min(n,1)}function Ut(s,e=[]){N(e).then(()=>requestAnimationFrame(()=>{for(let[t,...n]of s)t(...n)}),t=>console.error(t))}function qt(s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(s.toString(),document.createElement("br")),console.error(s)}function Vt(...s){new URLSearchParams(window.location.search).has("debug","true")&&document.getElementById("errorlog").append(...s.map(t=>t.toString()),document.createElement("br")),console.log(...s)}function Gt(s){J(s.querySelector(".page-content"),{container:s,transition:!1}),s.querySelector(".pages-next-button").addEventListener("click",()=>{J(document.getElementById(s.dataset.openPage).nextElementSibling,{container:s})}),s.querySelector(".pages-back-button").addEventListener("click",()=>{J(document.getElementById(s.dataset.openPage).previousElementSibling,{container:s})})}function J(s,{container:e=null,transition:t=!0}={}){let n=()=>Kt(s,e??s.closest(".pages-container"));t?document.startViewTransition(n):n()}function Kt(s,e){_(e.querySelectorAll(".page-content")),_(e.querySelectorAll(".page-heading")),R(s),R(e.querySelector(`.page-heading[data-for="${s.id}"]`)),e.dataset.openPage=s.id,me(!!s.previousElementSibling,e.querySelector(".pages-back-button")),me(!!s.nextElementSibling,e.querySelector(".pages-next-button"),e.querySelector(".pages-finish-button")),s.nextElementSibling||e.querySelector(".pages-finish-button").focus()}function Wt(s){let e=new URL(location),t=!1;for(let[n,r]of Object.entries(s)){let i=encodeURIComponent(r);e.searchParams.get(n)!==i&&(e.searchParams.set(n,i),t=!0)}t&&history.pushState({},"",e)}function ge(s,e,t){return()=>{try{e(s())}catch(n){t(n)}}}function $t(s,{transition:e=!0,types:t=[]}={}){return e?document.startViewTransition?new Promise((n,r)=>{document.startViewTransition({update:ge(s,n,r),types:t})}):new Promise((n,r)=>{requestAnimationFrame(ge(s,n,r))}):Promise.resolve(s())}function zt(s){let e=1779033703,t=3144134277,n=1013904242,r=2773480762;for(let i=0;i<s.length;i++){let o=s.charCodeAt(i);e=t^Math.imul(e^o,597399067),t=n^Math.imul(t^o,2869860233),n=r^Math.imul(n^o,951274213),r=e^Math.imul(r^o,2716044179)}return e=Math.imul(n^e>>>18,597399067),t=Math.imul(r^t>>>22,2869860233),n=Math.imul(e^n>>>17,951274213),r=Math.imul(t^r>>>19,2716044179),e^=t^n^r,t^=e,n^=e,r^=e,[e>>>0,t>>>0,n>>>0,r>>>0]}function Yt(s,e,t,n){return function(){s|=0,e|=0,t|=0,n|=0;let r=(s+e|0)+n|0;return n=n+1|0,s=e^e>>>9,e=t+(t<<3)|0,t=t<<21|t>>>11,t=t+r|0,(r>>>0)/4294967296}}function Jt(s){return Yt(...zt(s))}var H=class{constructor(s=Math.random){this._rand=s}rand(s=null,e=null){return e===null?this._rand()*(s??1):(s??=0,this._rand()*(e-s)+s)}seed(s){this._rand=Jt(s)}randInt(s,e){return Math.floor(this.rand(s,e))}shuffle(s){for(let e=s.length;e>0;e--){let t=this.randInt(e);t!==e-1&&([s[e-1],s[t]]=[s[t],s[e-1]])}}randIndexFromWeights(s){let e=re(s);return ie(this.rand(e[e.length-1]),e)}};var U={};T(U,{decodeBase64BoolArray:()=>Xt,decodeBase64Number:()=>We,encodeBase64BoolArray:()=>Qt,encodeBase64Number:()=>Ke});function Qt(s){return $e(Zt(s))+"~"+Ke(s.length)}function Xt(s){let[e,t]=s.split("~");return en(ze(e),We(t))}function Ke(s){return $e(tn(s))}function We(s){return nn(ze(s))}function Zt(s){let e=new Array(Math.ceil(s.length/6)),t;for(let n=0;n<e.length;n++){t=0;for(let r=0;r<6;r++)s[6*n+r]&&(t+=1<<r);e[n]=t}return e}function en(s,e){if(Math.ceil(e/6)!==s.length)throw new Error("Lengths of base 64 values and resultant length don't match.");let t=new Array(e);for(let[n,r]of s.entries())for(let i=0;i<6;i++){let o=6*n+i;if(o>=e)break;t[o]=(r&1<<i)!==0}return t}function tn(s){let e=[];for(;s>0;)e.push(s&63),s>>=6;return e}function nn(s){let e=0;for(let[t,n]of s.entries())e+=n<<6*t;return e}function $e(s){return String.fromCharCode(...s.map(e=>sn(e)))}function ze(s){let e=new Array(s.length);for(let t=0;t<s.length;t++)e[t]=rn(s.charCodeAt(t));return e}function sn(s){return s&=63,s<26?s+65:s<52?s+71:s<62?s+-5:s===62?45:95}function rn(s){if(s>=65&&s<91)return s-65;if(s>=97&&s<123)return s-97+26;if(s>=48&&s<58)return s-48+53;if(s===45)return 62;if(s===95)return 63;throw new Error("Unknown base 64 char code.")}var I=class{constructor(){this._funcs=new Set}push(...e){for(let t of e)this._funcs.add(t)}remove(e){this._funcs.delete(e)}call(...e){for(let t of this._funcs)t.call(...e)}clear(){this._funcs.clear()}};var b=class{constructor(){this.settings={},this.keys=[]}static createFrom(e,t=null){let n=new this;return n.put(e,t),n}put(e,t=null){t??=Object.keys(e);for(let n of t)this.add(n,e[n])}extend(e){this.put(e.settings,e.keys)}add(e,t,n="end",r=null){if(this.settings[e]=t,n==="end")this.keys.push(e);else{let i;n==="begin"?i=0:(i=this.keys.indexOf(r),n==="afterKey"?i++:n!=="beforeKey"&&console.error("Invalid insert setting insert position.")),this.keys.splice(i,0,e)}}remove(e){this.settings[e].remove(),delete this.settings[e]}removeAll(){for(let e of Object.values(this.settings))e.remove();this.settings={},this.keys=[]}replace(e,t){this.settings[e].node.replaceWith(t.node),this.settings[e].remove(),this.settings[e]=t}replaceSelf(e){this.removeAll(),this.put(e.settings)}getValues(){return h.map(this.settings,e=>e.value)}setValues(e){for(let[t,n]of Object.entries(e))this.settings[t].value=n}getValue(e){return this.settings[e].value}getNode(e){return this.settings[e].node}getSetting(e){return this.settings[e]}nodeList(){return this.keys.map(e=>this.settings[e].node)}addUpdateListener(e,...t){if(typeof e=="function")for(let n of Object.values(this.settings))n.updateListeners.push(e,...t);else{typeof e=="string"&&(e=[e]);for(let n of e)this.settings[n].updateListeners.push(...t)}}},B=class{static idCount=0;static updateEvent="change";node;valueNode;updateListeners;constructor(e){let t;if(this.constructor.isValueNode(e))t=e;else if(t=e.querySelector("input, textarea, select"),!this.constructor.isValueNode(t))throw new Error("Couldn't find element of type input, textarea or select.");this.node=l.createElement("div.setting.labeled-value-element"),this.node.append(e),this.valueNode=t,this.updateListeners=new I,this._onChange=this._onChange.bind(this),this.valueNode.addEventListener(this.constructor.updateEvent,this._onChange)}static createInput(e,t=null,n=null){let r=document.createElement("INPUT");r.type=e,n&&l.setAttrs(r,n);let i=new this(r);return t&&i.label(t),i}static createSelect(e,t={}){let n=document.createElement("select");l.setOptions(n,e,t);let r=l.createElement("div.styled-select");r.append(n);let i=new this(r);return t.id&&i.setId(t.id),t.label&&i.label(t.label),i}static isValueNode(e){let t=e.tagName;return t==="SELECT"||t==="TEXTAREA"||t==="INPUT"&&e.type!=="hidden"}isCheckbox(){return this.valueNode.tagName==="INPUT"&&this.valueNode.type==="checkbox"}get value(){return this.isCheckbox()?this.valueNode.checked:this.valueNode.value}set value(e){this.isCheckbox()?this.valueNode.checked=e:this.valueNode.value=e}_onChange(){this.updateListeners.call(this,this.value)}setDisabled(e){this.valueNode.disabled=e}setId(e={prefix:""}){let t=typeof e=="string"?e:this.constructor.generateId(e.prefix);this.valueNode.id=t;let n=this.node.querySelector("label");return n&&(n.htmlFor=t),t}static generateId(e=""){return"ve_"+e+this.idCount.toString().padStart(4,"0")}label(e){if(!e)return;let t=this.node.querySelector("label");t||(t=document.createElement("label"),this.valueNode.id||this.setId(),t.htmlFor=this.valueNode.id,this.node.prepend(t)),t.textContent=e}remove(){this.valueNode.removeEventListener(this.constructor.updateEvent,this._onChange),this.node.remove()}};l.registerTemplate("buttonGroupContainer",l.createElement("fieldset.button-group"));var A=class{static nameCount=0;node;inputs;constructor(e,t,n=!1){this.node=e,this.updateListeners=new I,this.inputs=Object.fromEntries(Array.from(this.node.querySelectorAll("INPUT")).map(r=>[r.value,r])),this.exclusive=t,this.decheckable=n,this._onChange=this._onChange.bind(this),this.node.addEventListener("change",this._onChange)}static from(e,{exclusive:t=!1,name:n=null,checked:r=null,disabled:i=null,decheckable:o=!1,label:a=null}={}){Array.isArray(e)&&(e=Object.fromEntries(e.map(f=>[f,f])));let c=Object.keys(e),u=t?"radio":"checkbox";n??=this.generateName();let d=l.getTemplate("buttonGroupContainer");t&&(d.setAttribute("role","radiogroup"),typeof r=="string"&&(r=[r]),!o&&!r&&(r=[c[0]])),r=h.subsetToBoolRecord(r??"none",c),i=h.subsetToBoolRecord(i??"none",c);for(let[f,F]of Object.entries(e)){let[x,$]=l.button(u,f,F);x.name=t?n:`${n}_${f}`,x.disabled=i[f],x.checked=r[f],d.append(x,$)}t&&o&&d.addEventListener("click",f=>{f.target.tagName==="INPUT"&&f.target.checked&&(f.target.checked=!1)});let p=new this(d,t,o);return a&&p.label(a),p}static generateName(){return this.nameCount++,"buttongroup_"+this.nameCount.toString().padStart(4,"0")}_onChange(){this.updateListeners.call(this,this.value)}buttonCount(){return Object.keys(this.inputs).length}disableIfSingleButton(e=null){this.buttonCount()===1?(this.setDisabled(!0),e!==null&&(this.value=e?Object.keys(this.inputs):[])):this.setDisabled(!1)}get value(){if(this.exclusive&&!this.decheckable){for(let e of Object.values(this.inputs))if(e.checked)return e.value;return null}return h.filterKeys(this.inputs,e=>e.checked)}set value(e){e=h.subsetToBoolRecord(e,Object.keys(this.inputs));for(let[t,n]of Object.entries(this.inputs))n.checked=e[t]}setDisabled(e){for(let t of Object.values(this.inputs))t.disabled=e}label(e){let t=document.createElement("LEGEND");t.textContent=e,this.node.prepend(t)}remove(){this.node.addEventListener("change",this._onChange),this.node.remove()}};l.registerTemplate("slider",`<div class="slider-container">
    <span class="range-min"></span><span class="range-value"></span><span class="range-max"></span>
    <input type="range" class="form-range">
</div>`);var C=class extends B{static updateEvent="input";constructor(e,t,n){if(super(e),this.valueNode.tagName!=="INPUT"||this.valueNode.type!=="range")throw new Error("Couldn't find input type='range' element.");this.min=t,this.max=n,this.displayValue=this.displayValue.bind(this),this.updateProgress=this.updateProgress.bind(this),this.displayMinMax()}static create(e,t,n=null){let r=l.getTemplate("slider"),i=r.lastElementChild;i.min=e,i.max=t,i.setAttribute("step",1);let o=new this(r,e,t);return n!==null&&(o.value=n),o}_onChange(){super._onChange(),this.updateProgress(),this.displayValue()}updateProgress(){this.valueNode.style.setProperty("--range-progress",this.getProgress().toString())}getProgress(){return(this.value-this.min)/(this.max-this.min)}displayValue(){this.node.querySelector(".range-value").textContent=this.formatValue(this.value)}displayMinMax(){this.node.querySelector(".range-min").textContent=this.formatValue(this.min),this.node.querySelector(".range-max").textContent=this.formatValue(this.max)}isCheckbox(){return!1}set value(e){(this.min>e||this.max<e)&&console.warn("Slider value outside range."),super.value=e.toString(),this.displayValue(),this.updateProgress()}get value(){return parseFloat(this.valueNode.value)}formatValue(e){return(Math.round(e*100)/100).toString()}setMin(e){this.valueNode.value<e&&(this.valueNode.value=e,this._onChange()),this.min=e,this.valueNode.min=e,this.updateProgress(),this.displayMinMax()}setMax(e){this.valueNode.value>e&&(this.valueNode.value=e,this._onChange()),this.max=e,this.valueNode.max=e,this.updateProgress(),this.displayMinMax()}};var Z=class{_punishFactor=2;_manualPunish=1;_previousDampFactor=.5;constructor(e){this.items=e,this.rng=new H;let t=this.itemCount=e.length;this.hitCount=0,this.scores=new Array(t).fill(0),this.tries=new Array(t).fill(0),this.triesLeft=new Array(t).fill(1),this.totalTriesLeft=t,this.maxTriesLeft=t,this.currentIndex=this.rng.randInt(0,t),this.previousIndex=null}seed(e){this.rng.seed(e)}currentItem(){return this.items[this.currentIndex]}nextItem(){return this.previousIndex=this.currentIndex,this.currentIndex=this.rng.randIndexFromWeights(this.getWeights()),this.currentItem()}getWeights(){let e=this.triesLeft.slice();return this.previousIndex!==null&&(e[this.previousIndex]*=this._previousDampFactor),e}updateTotalTriesLeft(){let e=g.sum(this.triesLeft);e>this.totalTriesLeft&&(this.maxTriesLeft+=e-this.totalTriesLeft),this.totalTriesLeft=e}progress(){return 1-this.totalTriesLeft/this.maxTriesLeft}enterScore(e){let t=++this.tries[this.currentIndex];t===1&&this.hitCount++,this.scores[this.currentIndex]=Math.max(this.scores[this.currentIndex],e*this.scoreAtTryFactor(t)),this.triesLeft[this.currentIndex]+=this._triesBoost(e)-1,this.triesLeft[this.currentIndex]<=0&&(this.triesLeft[this.currentIndex]=0,this.itemCount--),this.updateTotalTriesLeft()}isEmpty(){return this.itemCount===0}_triesBoost(e){return this._punishFactor*(1-e)}scoreAtTryFactor(e){return 1/e}getItemIndex(e){return this.items.indexOf(e)}punish(e,t=1){this.triesLeft[e]+=this._manualPunish*t,this.updateTotalTriesLeft()}absoluteScore(){return g.sum(this.scores)}scoreString(e="ratio"){let t=this.absoluteScore(),n=`${Je(t,1,2)}/${this.hitCount}`,r=this.hitCount>0?Ye(t/this.hitCount):Ye(0);if(e==="ratio")return n;if(e==="percent")return r;if(e==="both")return`${n} (${r})`;console.error(`Unknown mode: ${e}`)}};function Ye(s,e=0){return String(Je(s*100,e))+"%"}function Je(s,e=0,t=1){let n=Math.pow(10,e)*t;return Math.floor(s*n)/n}function q(s,e,t,n,r){return s<e||t<e?s>t?t+1:s+1:n===r?e:e+1}function ye(s,e){if(s===e)return 0;if(s.length>e.length){let ut=s;s=e,e=ut}let t=s.length,n=e.length;for(;t>0&&s.charCodeAt(t-1)===e.charCodeAt(n-1);)t--,n--;let r=0;for(;r<t&&s.charCodeAt(r)===e.charCodeAt(r);)r++;if(t-=r,n-=r,t===0||n<3)return n;let i=0,o,a,c,u,d,p,f,F,x,$,Ae,Le,E=new Array(2*t);for(o=0;o<t;o++)E[2*o]=o+1,E[2*o+1]=s.charCodeAt(r+o);let ke=E.length-1;for(;i<n-3;)for(x=e.charCodeAt(r+(a=i)),$=e.charCodeAt(r+(c=i+1)),Ae=e.charCodeAt(r+(u=i+2)),Le=e.charCodeAt(r+(d=i+3)),p=i+=4,o=0;o<ke;o+=2)f=E[o],F=E[o+1],a=q(f,a,c,x,F),c=q(a,c,u,$,F),u=q(c,u,d,Ae,F),p=q(u,d,p,Le,F),E[o]=p,d=u,u=c,c=a,a=f;for(;i<n;)for(x=e.charCodeAt(r+(a=i)),p=++i,o=0;o<ke;o+=2)f=E[o],E[o]=p=q(f,a,p,x,E[o+1]),a=f;return p}var D=class{constructor(e,t,n){this.displayString=e,this.properties=t,this.form=n}},L=class{constructor(e,t){this.value=e,this.maxDist=t,this.displayString=typeof e=="string"?e:e.toString()}static fromData(e,t){let n=t.maxDist??0,r=t.type;if(r==="number")return new Se(e,n,t.distanceMode??"linear");if(r==="string")return new ee(e,n,t.caseSensitive??!1,t.substitutions??{});if(r==="list"){let i,o={};return typeof e=="string"?i=e:("source"in e||console.error("Source of list property missing."),i=e.source,"alts"in e&&(o=e.alts)),new V(i,n,o,t)}else console.error(`Unknown property type "${t.type}"`)}grade(e){let t=this.gradeSingle(e,this.value);return[t,e.length>0?[this.markGradedText(e,t)]:[],[this.markGradedText(this.displayString,t)]]}static passes(e){return e>=.5}gradeSingle(e,t){let n=this.distance(e,t);return n<=this.maxDist?this.maxDist===0?1:Math.pow(2,-n/this.maxDist):0}markGradedText(e,t){let n=document.createElement("SPAN");return n.dataset.correct=t===1?"true":t>0?"partially":"false",n.textContent=e,n}distance(e,t){console.error("Not implemented.")}},Se=class extends L{constructor(e,t,n="linear"){let r,i;typeof e=="string"?(r=parseFloat(e),isNaN(r)&&console.error(`Invalid number property value "${e}"`),i=e):(r=e,i=e.toString()),n==="log"&&r===0&&console.error('Invalid value 0 for NumberProperty with distanceMode "log"'),super(r,t),this.displayString=i,this.distanceMode=n}distance(e,t){return this.distanceMode==="linear"?Math.abs(e-t):Math.abs(Math.log(e/t))}},ee=class extends L{constructor(e,t,n=!1,r={}){super(e,t),this.caseSensitive=n,this.substitutions=r}distance(e,t){return ye(this.standardizeString(e),this.standardizeString(t))}standardizeString(e){e=e.trim();for(let[t,n]of Object.entries(this.substitutions))e=e.replaceAll(new RegExp(t,"g"),n);return e=e.normalize("NFKD").replaceAll(/\p{M}/gu,""),this.caseSensitive||(e=e.toLowerCase()),e}},V=class extends ee{constructor(e,t,n={},{listMode:r="best",caseSensitive:i=!1,splitter:o="[,;/]",excludeFromList:a=["\\(.*?\\)"],substitutions:c={}}){e=e.trim(),super(e,t,i,c),this.splitter=o,this.values=this.constructor.getValues(e,t,this.splitter,a),n?this.alternatives=h.map(n,u=>typeof u=="string"?[u]:u):this.alternatives={},this.listMode=r}static getValues(e,t,n,r){let i=[new te(e)];for(let o of[...r,n])i=i.map(a=>a.split(o)).flat().map(a=>a.trim()).filter(a=>a.end>a.start);return i.length===0&&console.warn("No values in list."),i}grade(e){let t=new te(e).split(this.splitter).map(o=>o.trim()),n=new Array(t.length).fill(0),r=new Array(this.values.length).fill(0);for(let[o,a]of this.values.entries())for(let[c,u]of t.entries()){let d=this.gradeSingle(u.str,a.str);a.str in this.alternatives&&(d=Math.max(d,...this.alternatives[a.str].map(p=>this.gradeSingle(u.str,p)))),d>0&&(r[o]=Math.max(r[o],d),n[c]=Math.max(n[c],d))}return[this.listMode==="best"?Math.max(...r):g.avg(n),this.markSubStrings(t,n),this.markSubStrings(this.values,r)]}markSubStrings(e,t){if(e.length===0)return[];let n=e[0].source,r=[],i=0;for(let[o,a]of e.entries())i<a.start&&r.push(document.createTextNode(n.substring(i,a.start))),a.start<a.end&&(r.push(this.markGradedText(a.str,t[o])),i=a.end);return i<n.length&&r.push(document.createTextNode(n.substring(i))),r}},te=class s{constructor(e,t=0,n=null){e instanceof s&&(t+=e.start,n===null?n=e.end:n+=e.start,e=e.source),n===null&&(n=e.length),this.source=e,this.str=e.substring(t,n),this.start=t,this.end=n}split(e,t=!1){let n=[],r=this.str.matchAll(e),i=0;for(let o of r)!t&&i===o.index||(n.push(new this.constructor(this,i,o.index)),i=o.index+o[0].length);return(t||i<this.end-this.start)&&n.push(new this.constructor(this,i)),n}trim(){let e=this.str.match(/^\s*/)[0].length,t=this.str.match(/\s*$/)[0].length;return e===0&&t===0?this:new this.constructor(this.source,this.start+e,this.end-t)}};l.registerTemplates({eval:`<div class="item-eval">
    <span class="submitted"></span><span class="solution"></span>
</div>`,symbolContainer:`<div class="symbol-container">
    <div class="symbol-display-container"><span class="symbol"></span></div>
    <div class="symbol-label-container"><span class="symbol-label"></span></div>
</div>`});var G=class{constructor(e,t,n,r){this.dataset=e,this.properties=n,this.language=r,this.dealer=new Z(t),this.onFinish=new I,this.updateProgressBar(),this.onInputKeydown=this.onInputKeydown.bind(this),this._show=this._show.bind(this),this.loadAndUpdateSymbolFont=this.loadAndUpdateSymbolFont.bind(this)}static genericSettings(){return b.createFrom({seed:B.createInput("text","Seed (optional)",{id:"game-seed"})})}setup(){return this.setupSymbolContainer(),this.setupInputs(),this.setupEvals(),document.getElementById("item-next-button").textContent="Next",this.setupFontSettings()}getInputMode(e){return e==="real"||e==="integer"?"numeric":"text"}setupSymbolContainer(){let e=document.querySelector("#symbol-current .symbol");e.classList.add("symbol-"+this.dataset.displayData.type),e.setAttribute("lang",this.dataset.metadata.lang),e.setAttribute("dir",this.dataset.metadata.dir)}setupInputs(){this.inputs=h.mapKeyArrayToValues(this.properties,t=>{let n=document.createElement("INPUT");return l.setAttrs(n,{type:"text",inputmode:this.getInputMode(this.dataset.propsData[t].type),placeholder:this.dataset.propsData[t].label}),this.language&&this.language!=="default"&&n.setAttribute("lang",this.language),n});let e=document.getElementById("game-inputs");e.replaceChildren(...Object.values(this.inputs)),e.addEventListener("keydown",this.onInputKeydown)}onInputKeydown(e){let t=e.target.closest("INPUT");t&&(e.key==="Enter"?t.nextElementSibling?t.nextElementSibling.focus():document.getElementById("item-submit-button").focus():e.key==="Backspace"&&e.target.value===""&&t.previousElementSibling&&(t.previousElementSibling.focus(),e.preventDefault()))}setupEvals(){this.evals={};let e=document.getElementById("game-evals");for(let t of this.properties){let n=l.getTemplate("eval");this.evals[t]=n,e.append(n)}}updateSymbolWeight(e){document.querySelector("#game-symbols").style.setProperty("--symbol-weight",e.toString())}loadAndUpdateSymbolFont({key:e=null,transition:t=!0}={}){return e??=this.fontSettings.getValue("family"),S.loadFont(this.dataset.getFontFamily(e)).then(()=>l.updateDOM(()=>this.updateSymbolFontFamily(e),{transition:t}),n=>console.error(n))}updateSymbolFontFamily(e){e??=this.fontSettings.getValue("family"),document.querySelectorAll("#game-symbols .symbol-string").forEach(t=>{this.setSymbolFont(t,e)}),this.updateSymbolWeightRange(e)}updateSymbolWeightRange(e){let t=this.dataset.getFontFamily(e),n=S.getFontData(t),r=this.fontSettings.settings.weight;if(n.variationSettings&&n.variationSettings.wght){let[i,o]=n.variationSettings.wght.split(" ").map(a=>parseInt(a,10));r.setMin(i),r.setMax(o),l.show(r.node)}else l.hide(r.node)}setupFontSettings(){let e=this.dataset.displayData.defaultWeight??500,t=C.create(100,900,e);return t.label("Weight"),this.fontSettings=b.createFrom({family:this.dataset.fontFamilySetting(),weight:t}),document.querySelector("#font-settings").replaceChildren(...this.fontSettings.nodeList()),this.fontSettings.addUpdateListener("weight",this.updateSymbolWeight),this.fontSettings.addUpdateListener("family",this.loadAndUpdateSymbolFont),this.updateSymbolWeight(e),this.loadAndUpdateSymbolFont({transition:!1})}setSymbolFont(e,t){S.setFont(e,...this.dataset.getFont(t))}setReferenceItems(e){this.referenceItems=e}seed(e){this.dealer.seed(e)}cleanup(){this.clearItemDisplay(),this.updateProgressBar(0),document.getElementById("game-inputs").removeEventListener("keydown",this.onInputKeydown),document.getElementById("game-inputs").replaceChildren(),document.getElementById("game-evals").replaceChildren()}finish(){setTimeout(()=>this.cleanup(),100),this.onFinish.call(this)}currentItem(){return this.dealer.currentItem()}submitRound(){let e=0,t=this.currentItem();for(let[n,r]of Object.entries(this.inputs)){let i=this.evals[n],o=t.properties[n],[a,c,u]=o.grade(r.value);if(e+=a,!L.passes(a)){let d=this.getReferenceItems(t.form,n,r.value);if(d.length>0){let p=this.referenceItemsNodes(d,n);document.getElementById("game-symbols").append(...p),this.updateSymbolFontFamily(this.fontSettings.getValue("family"));for(let f of p)this.scaleItemNodeContents(f);for(let f of d)this.dealer.punish(this.dealer.getItemIndex(f),1/d.length)}}i.querySelector(".submitted").replaceChildren(...c),i.querySelector(".solution").replaceChildren(...u),l.classIfElse(o instanceof V&&o.listMode==="best",i,"best-mode")}e/=this.properties.length,this.dealer.enterScore(e),this.updateProgressBar(),this.dealer.isEmpty()&&(document.getElementById("item-next-button").textContent="Finish"),this.show("evals"),window.scrollY>0&&window.scrollTo({top:0,behavior:"smooth"})}getReferenceItems(e,t,n){if(!this.referenceItems)return[];let r=[];for(let[i,o]of this.referenceItems[e].entries()){let a=o.properties[t].grade(n)[0];L.passes(a)&&r.push([i,a])}return r.sort(([i,o],[a,c])=>c-o||i-a),r.length>0&&r[0][1]===1&&(r=r.filter(([i,o])=>o===1)),r.map(([i,o])=>this.referenceItems[e][i])}referenceItemsNodes(e,t){return e.map(n=>this.referenceItemNode(n,t))}referenceItemNode(e,t){let n=l.getTemplate("symbolContainer");return n.classList.add("symbol-reference"),n.querySelector(".symbol").classList.add("symbol-"+this.dataset.displayData.type),this.updateItemNode(n,e,t,!1),n}updateItemNode(e,t,n=null,r=!0){n??=this.properties[0],e.querySelector(".symbol").textContent=t.displayString,e.querySelector(".symbol-label").textContent=t.properties[n].displayString,r&&this.scaleItemNodeContents(e)}scaleItemNodeContents(e){l.scaleToFit(e.querySelector(".symbol")),l.scaleToFit(e.querySelector(".symbol-label"))}clearInputs(){for(let e of Object.values(this.inputs))e.value=""}show(e){this.shown=e,requestAnimationFrame(this._show)}_show(){l.toggleShown(this.shown==="inputs",[document.getElementById("game-inputs"),document.getElementById("item-submit-button")],[document.getElementById("game-evals"),document.getElementById("item-next-button")]),l.toggleShown(this.shown==="inputs",null,document.querySelector("#symbol-current .symbol-label"),"visibility"),this.shown==="inputs"?(document.querySelectorAll("#game-symbols .symbol-reference").forEach(e=>{e.remove()}),this.focus()):document.getElementById("item-next-button").focus()}updateProgressBar(e=null){e??=this.dealer.progress(),document.getElementById("progress-bar").style.setProperty("--progress",e)}newRound(){if(this.dealer.isEmpty()){this.finish();return}this.dealer.nextItem(),this.displayItem(this.currentItem()),this.clearInputs(),this.show("inputs")}focus(){this.inputs[this.properties[0]].focus({preventScroll:!0})}displayItem(e){this.updateItemNode(document.getElementById("symbol-current"),e)}clearItemDisplay(){document.querySelector("#symbol-current .symbol").textContent="",document.querySelector("#symbol-current .symbol-label").textContent=""}};var w=g.range,Qe={buttonMinWidth:"--button-min-width",buttonMaxWidth:"--button-max-width",symbolSize:"--symbol-size",labelGap:"--label-gap",symbolMinWidth:"--symbol-min-width"},on=["mode","indices","transpose","nColumns","dblClickGroups","rowLabels","columnLabels","rowLabelPosition","columnLabelPosition","rangeSelectionMode"],K=class{constructor(e,t){this.items=e,this.itemIndices=new Set(g.range(e.length)),this.dataset=t,this.formsData=t.formsData,this.selectorData=t.selectorData,this.updateListeners=new I,this.metadata={},this.activeForms=[],this.onBlockLabelClick=this.onBlockLabelClick.bind(this),this.onBlockButtonClick=this.onBlockButtonClick.bind(this),this.onBlockButtonEnter=this.onBlockButtonEnter.bind(this),this.onBlockLabelPointerOverOut=this.onBlockLabelPointerOverOut.bind(this),this.onBlockLabelPointerDown=this.onBlockLabelPointerDown.bind(this),this.onBlockLabelPointerUpCancel=this.onBlockLabelPointerUpCancel.bind(this),this.onBlockRangePointerDown=this.onBlockRangePointerDown.bind(this),this.onBlockRangePointerMove=this.onBlockRangePointerMove.bind(this),this.onBlockRangePointerUpCancel=this.onBlockRangePointerUpCancel.bind(this)}setup(e=null){this.node=e||l.createElement("div.item-selector"),this.node.dataset.dataset=this.dataset.key,this.setupButtons(),this.setupBlocks(),new ResizeObserver(this.scaleButtons.bind(this)).observe(e)}setMetadata(e){Object.assign(this.metadata,h.onlyKeys(e,["lang","dir"])),this.node&&(this.node.querySelectorAll(".symbol").forEach(this.updateSymbolMetadata.bind(this)),this.blocks.forEach(t=>l.classIfElse(this.metadata.dir==="rtl",t.node,"flex-rtl")))}setItemIndices(e,{transition:t=!0}={}){return this.itemIndices=new Set(e),this.updateButtonsForms({transition:t})}setupButtons(){this.itemsActive=new Array(this.items.length).fill(!1),this.buttons=this.items.map((e,t)=>this.getItemButton(e,t))}setupBlocks(){let e=this.selectorData.block?[this.selectorData.block]:this.selectorData.blocks?this.selectorData.blocks:[{mode:"flex"}];this.blocks=e.map(n=>h.onlyKeys(n,on,!0));let t=this.processIndexSubsets(e.map(n=>n.indices??"rest"),this.items.length,!0);for(let[n,r]of this.blocks.entries()){r.node=l.createElement("div.selector-block"),r.indices=t[n],this.standardizeBlockIndices(r),r.elements=[];for(let[i,o]of r.indices.entries()){let a=o===null?this._gridGapElement():this.buttons[o];r.elements.push(a),r.node.append(a),a.dataset.indexWithinBlock=i}r.mode==="grid"?(r.node.classList.add("selector-block-grid"),r.node.style.setProperty("--columns",r.nColumns)):(r.node.classList.add("selector-block-flex"),this.metadata.dir==="rtl"&&r.node.classList.add("flex-rtl")),r.node.setAttribute("data-block-index",n.toString()),this.applyBlockStyle(r,this.selectorData.style,r.style),this.processListenerIndices(r),this.setupBlockListeners(r),this.node.append(r.node);try{this.addBlockLabels(r)}catch(i){console.error("Error occured while trying to add block labels."),console.error(i)}}}addBlockLabels(e){let t=e.nColumns,n=Math.round(e.indices.length/t);if(e.rowLabels){if(typeof e.rowLabels=="string"&&(e.rowLabels=e.rowLabels.split("")),!Array.isArray(e.rowLabels)||e.rowLabels.length!==n)throw new Error("Row labels no array or don't match number of rows.");let[r,i,o]=this._processLabelPosition(e.rowLabelPosition);[e.rowLabelStart,e.rowLabelEnd]=[i,o],e.node.classList.add(`has-row-labels-${r}`);for(let[a,c]of e.rowLabels.entries()){let u=this._labelElement("row",c,a);e.rowLabelStart&&e.elements[a*t].insertAdjacentElement("beforebegin",u),e.rowLabelEnd&&(e.rowLabelStart&&(u=u.cloneNode(!0)),a===t-1?e.node.insertAdjacentElement("beforeend",u):e.elements[a*(t+1)].insertAdjacentElement("beforebegin",u))}}if(e.columnLabels){if(typeof e.columnLabels=="string"&&(e.columnLabels=e.columnLabels.split("")),!Array.isArray(e.columnLabels)||e.columnLabels.length!==t)throw new Error("Column labels no array or don't match number of columns.");let[r,i,o]=this._processLabelPosition(e.columnLabelPosition);[e.columnLabelStart,e.columnLabelEnd]=[i,o];let a=e.columnLabels.map((c,u)=>this._labelElement("column",c,u));"rowLabels"in e&&(e.rowLabelStart&&a.splice(0,0,this._gridGapElement(!0)),e.rowLabelEnd&&a.push(this._gridGapElement(!0))),e.columnLabelStart&&e.node.prepend(...a),e.columnLabelEnd&&(e.columnLabelStart&&(a=a.map(c=>c.cloneNode(!0))),e.node.append(...a))}}applyBlockStyle(e,...t){let n=Object.assign({},...t);"buttonWidth"in n&&(n.buttonMinWidth=n.buttonWidth,n.buttonMaxWidth=n.buttonWidth,delete n.buttonWidth);for(let[r,i]of Object.entries(n))r in Qe||console.error(`Invalid selector block style property ${r}.`),e.node.style.setProperty(Qe[r],i)}_gridGapElement(e=!1){return l.createElement(`span.selector-grid-${e?"label-":""}gap`)}_labelElement(e,t,n){if(t===null)return this._gridGapElement(!0);let r=l.createElement(`span.block-label.block-${e}-label`);return r.setAttribute("tabindex",0),r.textContent=t,r.dataset.index=n.toString(),r}getButtonsFromIndices(e){return e?e.filter(t=>t!==null).map(t=>this.buttons[t]):[]}buttonsClassIfElse(e,t,n,r=null){l.classIfElse(e,this.getButtonsFromIndices(t),n,r)}buttonsRemoveClass(e,t){l.removeClass(this.getButtonsFromIndices(e),t)}buttonsAddClass(e,t){l.addClass(this.getButtonsFromIndices(e),t)}_processLabelPosition(e){return e??="start",e==="both"?[e,!0,!0]:e==="end"?[e,!1,!0]:(e!=="start"&&console.error("Invalid label position, use 'start', 'end' or 'both'."),["start",!0,!1])}processListenerIndices(e){e.mode==="grid"&&(e.indicesByRow=w(e.nRows).map(t=>w(e.nColumns).map(n=>e.indices[t*e.nColumns+n]).filter(n=>n!==null)),e.indicesByColumn=w(e.nColumns).map(t=>w(e.nRows).map(n=>e.indices[n*e.nColumns+t]).filter(n=>n!==null))),e.dblClickGroups??=[w(e.indices.length)],e.dblClickGroups=this.processIndexSubsets(e.dblClickGroups,e.indices.length);for(let[t,n]of e.dblClickGroups.entries())for(let r of n)e.elements[r].dataset.dblClickGroup=t;e.dblClickGroups=e.dblClickGroups.map(t=>t.map(n=>e.indices[n]).filter(n=>n!==null))}setupBlockListeners(e){e.node.addEventListener("click",this.onBlockButtonClick),e.node.addEventListener("keydown",this.onBlockButtonEnter),this.resetRangeSelection(),e.node.addEventListener("pointerdown",this.onBlockRangePointerDown),e.mode==="grid"&&(e.node.addEventListener("click",this.onBlockLabelClick),e.node.addEventListener("keydown",this.onBlockLabelClick),e.node.addEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.addEventListener("pointerdown",this.onBlockLabelPointerDown))}removeBlockListeners(e){e.node.removeEventListener("click",this.onBlockButtonClick),e.node.removeEventListener("keydown",this.onBlockButtonClick),e.node.removeEventListener("pointerdown",this.onBlockRangePointerDown),e.node.removeEventListener("pointermove",this.onBlockRangePointerMove),e.mode==="grid"&&(e.node.removeEventListener("click",this.onBlockLabelClick),e.node.removeEventListener("keydown",this.onBlockLabelClick),e.node.removeEventListener("pointerover",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerout",this.onBlockLabelPointerOverOut),e.node.removeEventListener("pointerdown",this.onBlockLabelPointerDown))}onBlockButtonClick(e){let t=e.target.closest(".selector-item-button, .selector-grid-gap");if(!t)return;let n=this.getBlockIndexFromEvent(e);if(e.detail%2===0&&this.lastBlockClicked===n&&this.lastButtonClicked===t.dataset.indexWithinBlock){let r=this.getBlockFromEvent(e),i=t.dataset.dblClickGroup,o=r.dblClickGroups[i];this.toggleItems(o,{updateIfDisabled:!0})}this.lastButtonClicked=t.dataset.indexWithinBlock,this.lastBlockClicked=n}onBlockButtonEnter(e){if(e.key!=="Enter")return;let t=e.target.closest(".selector-item-button");t&&this.toggleItems([t.dataset.index])}getBlockIndexFromEvent(e){let t=e.target.closest(".selector-block");return t?t.dataset.blockIndex:null}getBlockFromEvent(e){let t=this.getBlockIndexFromEvent(e);return t!==null?this.blocks[t]:null}getIndicesFromBlockLabelEvent(e){let t=e.target.closest(".block-label");if(!t)return;let n=t.classList.contains("block-row-label")?"indicesByRow":"indicesByColumn",r=t.dataset.index;return this.getBlockFromEvent(e)[n][r]}onBlockLabelClick(e){if(e.type==="keydown"&&e.key!=="Enter")return;let t=this.getIndicesFromBlockLabelEvent(e);t&&this.toggleItems(t)}onBlockLabelPointerOverOut(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&this.buttonsClassIfElse(e.type==="pointerover",t,"hover")}onBlockLabelPointerDown(e){let t=this.getIndicesFromBlockLabelEvent(e);t&&(this.buttonsAddClass(t,"active"),this.blockLabelActiveIndices=t,document.addEventListener("pointerup",this.onBlockLabelPointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockLabelPointerUpCancel,{once:!0}))}onBlockLabelPointerUpCancel(){let e=this.blockLabelActiveIndices;e&&this.buttonsRemoveClass(e,"active"),this.blockLabelActiveIndices=null,this.removeDocumentLabelListeners()}resetRangeSelection(){this.rangeSelectingBlockIndex=null,this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=null,this.rangeSelectStartIndex=null,this.rangeSelectStopIndex=null,this.rangeSelectionActiveIndices=null}onBlockRangePointerMove(e){if(this.rangeSelectingBlockIndex===null)return;let n=document.elementFromPoint(e.clientX,e.clientY).closest(".selector-item-button, .selector-grid-gap");if(!n||n.closest(".selector-block").dataset.blockIndex!==this.rangeSelectingBlockIndex)return;let i=n.dataset.indexWithinBlock;this.rangeSelectStopIndex!==i&&(this.rangeSelectStartIndex??=i,this.rangeSelectStopIndex=i,this.updateRangeSelection())}onBlockRangePointerDown(e){let t=this.getBlockIndexFromEvent(e);if(t===null)return;this.rangeSelectingBlockIndex=t;let n=e.target.closest(".selector-item-button, .selector-grid-gap");n&&(this.rangeSelectStartIndex=n.dataset.indexWithinBlock,this.rangeSelectStopIndex=this.rangeSelectStartIndex,this.updateRangeSelection()),document.addEventListener("pointerup",this.onBlockRangePointerUpCancel,{once:!0}),document.addEventListener("pointercancel",this.onBlockRangePointerUpCancel,{once:!0}),this.blocks[t].node.addEventListener("pointermove",this.onBlockRangePointerMove)}onBlockRangePointerUpCancel(e){this.rangeSelectingBlockIndex!==null&&(e.type==="pointerup"&&this.getBlockIndexFromEvent(e)===this.rangeSelectingBlockIndex&&this.rangeSelectionActiveIndices&&this.toggleItems(this.rangeSelectionActiveIndices),this.blocks[this.rangeSelectingBlockIndex].node.removeEventListener("pointermove",this.onBlockRangePointerMove),this.removeDocumentRangeListeners(),this.resetRangeSelection())}removeDocumentLabelListeners(){document.removeEventListener("pointerup",this.onBlockLabelPointerUpCancel),document.removeEventListener("pointercancel",this.onBlockLabelPointerUpCancel)}removeDocumentRangeListeners(){document.removeEventListener("pointerup",this.onBlockRangePointerUpCancel),document.removeEventListener("pointercancel",this.onBlockRangePointerUpCancel)}updateRangeSelection(){this.rangeSelectionActiveIndices&&this.buttonsRemoveClass(this.rangeSelectionActiveIndices,"active"),this.rangeSelectionActiveIndices=this.getIndicesInRangeSelection(),this.buttonsAddClass(this.rangeSelectionActiveIndices,"active")}getIndicesInRangeSelection(){if(this.rangeSelectStartIndex===null||this.rangeSelectStopIndex===null)return[];let[e,t]=ne(this.rangeSelectStartIndex,this.rangeSelectStopIndex),n=this.blocks[this.rangeSelectingBlockIndex];if(n.mode==="grid")if(n.rangeSelectionMode??="grid",n.rangeSelectionMode==="grid"){let[r,i]=ve(e,n.nColumns),[o,a]=ve(t,n.nColumns);return[r,o]=ne(r,o),[i,a]=ne(i,a),w(r,o+1).map(c=>w(c*n.nColumns+i,c*n.nColumns+a+1)).flat().map(c=>n.indices[c])}else if(n.rangeSelectionMode==="walkColumns"){let r=this.transposeIndex(e,n.nRows,n.nColumns),i=this.transposeIndex(t,n.nRows,n.nColumns);[r,i]=ne(r,i);let o=this.transposedRange(n.nColumns,n.nRows);return w(r,i+1).map(a=>o[a]).map(a=>n.indices[a])}else n.rangeSelectionMode!=="walkRows"&&console.error("Invalid range selection mode, use grid, walkRows or walkColumns.");return w(e,t+1).map(r=>n.indices[r])}standardizeBlockIndices(e){if(e.mode==="grid"){if(!e.nColumns)throw new Error("Block columns not set.");e.nRows=Math.ceil(e.indices.length/e.nColumns);let t=e.indices.length%e.nColumns;if(t!==0){let n=e.nColumns-t;e.indices.push(...new Array(n).fill(null))}e.transpose&&this.transposeBlock(e)}}transposeBlock(e){e.indices=this.transposeIndices(e.indices,e.nRows,e.nColumns)}transposeIndices(e,t,n){if(e.length!==t*n)throw new Error("Dimensions don't match.");return this.transposedRange(t,n).map(r=>e[r])}transposedRange(e,t){return w(e*t).map(n=>this.transposeIndex(n,e,t))}transposeIndex(e,t,n){let[r,i]=ve(e,n);return i*t+r}processIndexSubsets(e,t,n=!1){let r=[],i=new Array(t).fill(!1);for(let[a,c]of e.entries()){if(c==="rest"){a!==e.length-1&&console.error("Can only have subset 'rest' at the end."),r.push(g.filterIndices(i,d=>!d));break}let u=[];for(let d of this.processIndices(c,n))if(u.push(d),d!==null){if(i[d])throw new Error(`Duplicate subset index ${d}.`);i[d]=!0}r.push(u)}let o=g.filterIndices(e,a=>!a);if(o.length!==0)throw new Error(`Not all indices were covered: missing ${o}.`);return r}updateButtonsForms({scale:e=!0,transition:t=!0}={}){return l.updateDOM(()=>{for(let[n,r]of this.buttons.entries())this.itemIndices.has(n)?this._updateButtonForms(r):r.setAttribute("aria-disabled",!0);e&&this.scaleButtons()},{transition:t,types:["selector-forms"]})}_updateButtonForms(e){let t=!0;e.querySelectorAll(".symbol-form").forEach(n=>{let r=this.activeForms.includes(n.dataset.form);l.toggleShown(r,n),r&&(t=!1)}),e.setAttribute("aria-disabled",t)}toggleItems(e,{updateIfDisabled:t=!1}={}){e=e.filter(r=>r!==null);let n=e.map(r=>this.itemsActive[r]).includes(!1);for(let r of e)this.updateItem(r,n,{updateIfDisabled:t,callUpdateListeners:!1});this.updateListeners.call(this)}updateItem(e,t,{updateIfDisabled:n=!1,callUpdateListeners:r=!0}={}){this.itemsActive[e]=t,(this.buttons[e].getAttribute("aria-disabled")!=="true"||n)&&this.buttons[e].setAttribute("aria-checked",t.toString()),r&&this.updateListeners.call(this)}activeQuizItemCount(){let e=0;for(let t of this.itemIndices)this.itemsActive[t]&&(e+=this.items[t].countQuizItems(this.activeForms));return e}scaleButtons(){if(this.node.clientWidth===0){console.warn("scaleButtons: node size is 0, cannot scale buttons.");return}for(let e of this.blocks){let t=e.indices.filter(n=>n!==null).map(n=>this.buttons[n]).filter(n=>n.getAttribute("aria-disabled")!=="true");l.scaleAllToFit(t.map(n=>n.querySelector(".symbol")),{containers:t,uniform:.75}),this.selectorData.label&&l.scaleAllToFit(t.map(n=>n.querySelector(".selector-item-label")),{containers:t,uniform:.75})}}processItemsActive(e){if(e==="all"||e==="none")return new Array(this.items.length).fill(e==="all");let t=new Array(this.items.length).fill(!1);for(let n of this.processIndices(e))t[n]=!0;return t}setActive(e){if(typeof e=="string")try{e=this.processItemsActive(e)}catch(t){console.error(t);return}else{if(e.length!==this.items.length){console.error("Items Active length doens't match number of items.");return}e.map(t=>([!0,!1,0,1].includes(t)||console.warn("Invalid itemsActive, should be array of booleans or 0s and 1s."),!!t))}for(let[t,n]of e.entries())this.updateItem(t,n,{updateIfDisabled:!0,callUpdateListeners:!1});this.updateButtonsForms({transition:!1})}getItemButton(e,t){let n=l.createElement("div.selector-item-button"),r=l.uniqueIdPrefix("selectorButton")+t.toString();if(l.setAttrs(n,{id:r,role:"checkbox",tabindex:"0","aria-checked":"false","aria-labelledby":r}),n.append(this.getSymbolElement(e)),this.selectorData.label){let i=l.createElement("span.selector-item-label"),o=this.selectorData.label,a=e.properties[o.property];if(o.splitFirst??!0){let c=o.splitter??"[,;/]";a=a.split(new RegExp(`s*(${c})s*`))[0]}i.textContent=a,n.append(i)}return n.dataset.index=t.toString(),n}getSymbolElement(e){let t=l.createElement("span.symbol.symbol-string");return S.setFont(t,...this.dataset.getSelectorDisplayFont()),this.updateSymbolMetadata(t),t.append(...Object.values(e.getFormNodes())),t}updateSymbolMetadata(e){this.metadata&&l.setAttrs(e,this.metadata)}removeListeners(){for(let e of this.blocks)this.removeBlockListeners(e);this.removeDocumentRangeListeners(),this.removeDocumentLabelListeners()}setActiveForms(e,t={}){return this.activeForms=e,this.updateButtonsForms(t)}activeIndices(){return g.filterIndices(this.itemsActive,e=>e).filter(e=>this.buttons[e].getAttribute("aria-disabled")!=="true")}processIndices(e,t=!1){if(typeof e=="string")return this.parseRanges(e,t);if(typeof e=="number")return[e];if(!Array.isArray(e))throw new Error("Invalid indices datatype: need string, number or Array<number>.");e=e.sort();let n=e.length;return e=e.filter((r,i,o)=>i===0||r!==o[i-1]),e.length!==n&&console.warn("Indices contain duplicates."),e}parseRanges(e,t=!1){return[].concat(...e.split(",").map(n=>{if(t&&n.substring(0,3)==="gap"){let r=n.length===3?1:this.parseInt(n.substring(3));return new Array(r).fill(null)}else if(n.substring(0,5)==="block")return this.blocks[n.substring(5)].indices;return this.parseRange(n)}))}parseRange(e){let t=e.split(":").map(o=>this.parseInt(o));if(t.length===1)return t;if(t.length===0||t.length>3)throw new Error("Invalid range, 2-3 numbers.");let n=t[0],r=t[t.length-1],i=t.length===3?t[1]:1;if(r<n||i<1)throw new Error("Invalid range, must have start <= stop and step >= 1.");return w(n,r+1,i)}parseInt(e){let t=parseInt(e);if(isNaN(t))throw new Error("Not a number.");return t}};function ve(s,e){let t=s%e;return[Math.round((s-t)/e),t]}function ne(s,e){return[Math.min(s,e),Math.max(s,e)]}var P={arabic:{name:"Arabic",file:"arabic.json"},elements:{name:"Atomic Elements",file:"elements.json"},cyrillic:{name:"Cyrillic",file:"cyrillic.json"},elder_futhark:{name:"Elder Futhark",file:"elder_futhark.json"},greek:{name:"Greek",file:"greek.json"},hebrew:{name:"Hebrew",file:"hebrew.json"},japanese:{name:"Japanese Kana",file:"japanese.json"},phoenician:{name:"Phoenician",file:"phoenician.json"}};l.registerTemplate("headingElement",'<div class="heading-element"><span class="heading-element-number"></span><span class="heading-element-symbol"></span></div>');var ln="./json/datasets/",Xe="elder_futhark",cn={gameHeading:"Kadmos",terms:{letter:"letter"},lang:"en",dir:"ltr"},Ze=["letter","letters"],un={keys:["default"],setting:{default:{label:"Default",active:!0}},defaultForm:"default",singleForm:!0},dn={languages:["en"],default:"en"},hn={en:"English",de:"German"},W=class{static _cache={};constructor(e){this.name=e.name,this.metadata=this.processMetadata(e.metadata),this.processFonts(e.fonts),this.displayData=e.displayData??{},this.displayData.type??="string",this.formsData=e.formsData??un,this.propsData=e.propsData,this.selectorData=e.selectorData??{},this.variantsData=this.processVariants(e.variantsData),this.languageData=e.languageData??dn,this.languageData.default??=this.languageData.languages[0],this.items=this.processItems(e.symbolsData)}static fetch(e){return e in P?e in this._cache?Promise.resolve(this._cache[e]):fetch(ln+P[e].file).then(t=>t.json()).then(t=>{let n=new this(t);return n.key=e,this._cache[e]=n,n}).catch(l.printError):(console.error(`Invalid dataset key "${e}".`),null)}processMetadata(e){return e=Object.assign({},cn,e),e.terms.letter??="letter",e.terms.letters??=e.terms.letter+"s",e}processVariants(e){if(!e||!e.variants)return null;for(let[t,n]of Object.entries(e.variants))typeof n=="string"&&(e.variants[t]={label:n}),e.variants[t].lang??=t;return e}getGameSettings(e){let t={};return this.hasPropsSetting()&&(t.properties=this.propertySetting(e.properties)),this.hasLanguageSetting()&&(t.language=this.languageSetting(e.language)),b.createFrom(t)}getFilterSettings(e){let t={};return this.hasFormsSetting()&&(t.forms=this.formsSetting(e.forms)),this.hasVariantSetting()&&(t.variant=this.variantSetting(e.variant)),b.createFrom(t)}propertySetting(e=null){return A.from(h.map(this.propsData,t=>t.label),{label:"Properties",checked:e??h.map(this.propsData,t=>!!t.active)})}languageSetting(e=null){return A.from(h.onlyKeys(hn,this.languageData.languages),{label:"Language",checked:e??this.languageData.default,exclusive:!0})}formsSetting(e=null){if(!this.hasFormsSetting())return null;let t=this.formsData.label??(this.formsData.exclusive?"Form":"Forms");return A.from(h.map(this.formsData.setting,n=>n.label),{label:t,exclusive:!!this.formsData.exclusive,checked:e??h.map(this.formsData.setting,n=>n.active??!1)})}getFormsFromSettingsValue(e){return typeof e=="string"&&(e=[e]),e.map(t=>this.formsData.setting[t].keys??[t]).flat()}variantSetting(e=null){return B.createSelect(h.map(this.variantsData.variants,t=>t.label),{label:"Variants",selected:e??this.variantsData.default??Object.keys(this.variantsData.variants)[0],groups:Object.values(this.variantsData.groups)??[]})}hasPropsSetting(){return Object.keys(this.propsData).length>1}hasLanguageSetting(){return this.languageData.languages.length>1}hasVariantSetting(){return!!this.variantsData}hasFormsSetting(){return this.formsData.showSetting??Object.keys(this.formsData.setting).length>1}hasFontFamilySetting(){return Object.keys(this.fonts).length>1}getItemSelector(e=null){let t=new K(this.items,this);return t.setMetadata({lang:this.metadata.lang??null,dir:this.metadata.dir}),t.setup(e),this.selectorData.defaultActive&&t.setActive(this.selectorData.defaultActive),t}getVariantItemIndices(e){return g.filterIndices(this.items,t=>t.variants.has(e))}_getFont(e){return e?(typeof e=="string"&&(e={key:e}),e.key??=this._defaultFontKey,!e.key in this.fonts&&(console.error(`Unknown font key "${e.key}".`),e.key=this._defaultFontKey),Object.assign({},this.fonts[e.key],h.withoutKeys(e,["key"]))):this.defaultFont()}getFont(e){let t=h.withoutKeys(this._getFont(e),["default","label"]);return[t.family,t]}getFontFamily(e){return this.getFont(e)[0]}getSelectorDisplayFont(){return this.getFont(this.selectorData.font)}processFonts(e){this.fonts=e;let t=Object.entries(e).find(([n,r])=>r.default);this._defaultFontKey=t?t[0]:Object.keys(e)[0]}defaultFont(){return this.fonts[this._defaultFontKey]}fontFamilySetting(e=null){let t=A.from(h.map(this.fonts,n=>n.label??n.family),{label:"Font",exclusive:!0,checked:e??this._defaultFontKey});return t.node.classList.add("font-family-setting"),t}processItems(e){let t=e.rows;if(!Array.isArray(t))throw new Error("symbol rows must be an array.");e.template&&this.applyTemplateToRows(t,e.template);let n=new Array(t.length),r;for(let[i,o]of t.entries()){try{r=this.processItem(o)}catch(a){console.warn("Error occured processing item at index",i),console.error(a);continue}n[i]=r}return n}applyTemplateToRows(e,t){for(let[n,r]of e.entries()){if(!Array.isArray(r))continue;let i={};for(let[o,a]of r.entries())i[t[o]]=a;e[n]=i}return e}processItem(e){let t=this.hasVariantSetting()?this.processItemVariants(e.variants):null;return new we(this.processDisplayForms(e.display),this.processItemProperties(e),t)}processItemProperties(e){let t={};for(let[n,r]of Object.entries(e)){if(n.substring(0,2)!=="p:")continue;let i=n.substring(2);t[i]=r}return t}processItemVariants(e){if(!e||e==="*")return Object.keys(this.variantsData.variants);if(Array.isArray(e))return e;let t=e.substring(0,2)!=="*-";t||(e=e.substring(2));let n=h.map(this.variantsData.variants,()=>!t);for(let r of e.split(","))if(r in this.variantsData.variants)n[r]=t;else if(this.variantsData.groups&&r in this.variantsData.groups)for(let i of this.variantsData.groups[r])n[i]=t;return h.filterKeys(n,r=>r)}processDisplayForms(e){if(this.formsData.singleForm)return Object.fromEntries([[this.formsData.defaultForm,e]]);if(typeof e=="string"&&(e=e.split("")),Array.isArray(e)){let n={};for(let[r,i]of e.entries())i&&(n[this.formsData.keys[r]]=i);return n}if(typeof e!="object")throw new Error("Invalid display format: need array or object.");let t=Object.keys(e).filter(n=>!this.formsData.keys.includes(n));if(t.length>0)throw new Error(`Invalid display Form key "${t[0]}".`);return e}getQuizItems(e,t,n,r=null){let i=[];for(let o of e){let a=this.items[o].getDisplayStrings(t),c=this.items[o].getItemProperties(n,this.propsData,r);i.push(...Object.entries(a).map(([u,d])=>new D(d,c,u)))}return i}referencePropsData(){let e=Object.assign({},this.propsData);for(let[t,n]of Object.entries(e))if("referenceMaxDist"in n){let r=Object.assign({},n);r.maxDist=n.referenceMaxDist,e[t]=r}return e}getReferenceItems(e,t=null){let n,r=this.referencePropsData();if(this.formsData.exclusive){let i=this.items.map(a=>a.getItemProperties(e,r,t)),o={};for(let a of this.formsData.keys)o[a]=this.items.map((c,u)=>new D(c.getFormsDisplayString([a]),i[u],a));return o}else return n=this.items.map(i=>new D(i.getFormsDisplayString(this.formsData.keys),i.getItemProperties(e,r,t),"all")),Object.fromEntries(this.formsData.keys.map(i=>[i,n]))}setupGameHeading(e){let t=this.metadata.gameHeading;if(S.setFont(e,...this.getFont(t.font)),this.name==="Atomic Elements"){let n=document.createElement("div");n.classList.add("element-heading-container");let r=[];for(let[i,o]of[[19,"K"],[85,"At"],[42,"Mo"],[16,"S"]]){let a=l.getTemplate("headingElement");a.querySelector(".heading-element-symbol").textContent=o,a.querySelector(".heading-element-number").textContent=i,r.push(a)}n.replaceChildren(...r),e.replaceChildren(n)}else e.replaceChildren(t.string);e.setAttribute("lang",t.lang??this.metadata.lang),e.setAttribute("dir",t.dir??this.metadata.dir)}},we=class{constructor(e,t,n=null){this.displayForms=e,this.properties=t,this.variants=new Set(n)}getDisplayStrings(e){return h.onlyKeys(this.displayForms,e)}getItemProperties(e,t,n=null){let r={};for(let i of e){if(!(i in this.properties)){console.error(`Missing property key "${i}".`);continue}r[i]=this.properties[i]}if(n)for(let i of e){let o=i+"_"+n;this.properties[o]&&(r[i]=this.properties[o])}return h.map(r,(i,o)=>L.fromData(i,t[o]))}getFormNode(e){let t=l.createElement("span.symbol-form");return t.dataset.form=e,t.textContent=this.displayForms[e],t}getFormNodes(e=null){return h.mapKeyArrayToValues(e??Object.keys(this.displayForms),t=>this.getFormNode(t))}getFormsDisplayString(e){return Object.values(this.getDisplayStrings(e)).join("")}countQuizItems(e){return e.reduce((t,n)=>n in this.displayForms?t+1:t,0)}};var v=null,m=null,k=new b,O=new b,xe=new b,y=null,et=null;function rt(){return mn(),pn(),xe.replaceSelf(G.genericSettings()),document.getElementById("generic-game-settings").append(...xe.nodeList()),window.addEventListener("popstate",st),l.updateDOM(()=>{fn(),st(!1)},{transition:!0})}function mn(){document.getElementById("start-game-button").addEventListener("click",lt),document.getElementById("stop-game-button").addEventListener("click",()=>{v.finish()}),document.getElementById("item-submit-button").addEventListener("click",()=>{l.updateDOM(()=>{v.submitRound()},{types:["game"]})}),document.getElementById("item-next-button").addEventListener("click",()=>{l.updateDOM(()=>{v.newRound()},{types:["game"]})})}function fn(){let s=document.getElementById("datasetSelect");l.setOptions(s,h.map(P,e=>e.name)),s.addEventListener("change",e=>{let t=e.target.value;W.fetch(t).then(n=>it(n)).catch(console.error)})}function Ee(s,{transition:e=!0}={}){return l.updateDOM(()=>{s||l.showPage(document.getElementById("game-filters"),{transition:!1}),l.toggleShown(s,[document.getElementById("game-container"),document.getElementById("stop-game-button"),document.getElementById("progress-bar")],[document.getElementById("new-game-settings")])},{transition:e})}function pn(){et=b.createFrom({accentColor:yn(),colorMode:Sn()}),document.querySelector("#page-settings .settings").replaceChildren(...et.nodeList()),document.getElementById("open-settings-button").addEventListener("click",()=>{l.updateDOM(gn,{types:["page-settings","ease-in"]})}),document.getElementById("close-settings-button").addEventListener("click",()=>{l.updateDOM(bn,{types:["page-settings","ease-out"]})})}function gn(){l.show(document.getElementById("page-settings-container")),document.documentElement.style.overflowY="hidden"}function bn(){l.hide(document.getElementById("page-settings-container")),document.documentElement.style.removeProperty("overflow-y")}function yn(){let s=window.localStorage.getItem("accentHue")||250;tt(s);let e=C.create(0,360,s);return e.label("Accent Hue"),e.updateListeners.push(t=>tt(t)),e.node.id="accentHueSlider",e}function tt(s){document.documentElement.style.setProperty("--accent-hue",s),window.localStorage.setItem("accentHue",s)}function Sn(){let s=window.matchMedia("(prefers-color-scheme: dark)"),e=window.localStorage.getItem("colorMode")||(s.matches?"dark":"light");Ie(e,{transition:!1});let t=A.from({dark:"Dark Mode",light:"Light Mode"},{label:"Color Mode",exclusive:!0,checked:e});return s.addEventListener("change",n=>{let r=n.matches?"dark":"light";t.value=[r],Ie(r,{transition:!1})}),t.updateListeners.push(n=>Ie(n,{updateLocalStorage:!0})),t}function Ie(s,{updateLocalStorage:e=!1,transition:t=!0}={}){if(s!=="dark"&&s!=="light")throw new Error(`Invalid color mode ${s}, use dark or light.`);l.updateDOM(()=>{l.classIfElse(s==="dark",document.documentElement,"dark-mode","light-mode")},{transition:t}),e&&window.localStorage.setItem("colorMode",s)}function it(s,{transition:e=!0}={}){m=s,l.setSearchParams({dataset:s.key});let t=xn(),n=m.metadata.gameHeading;return N([m.getFontFamily(n.font),m.getSelectorDisplayFont()[0]]).then(()=>l.updateDOM(()=>{vn(),l.showPage(document.getElementById("game-filters"),{transition:!1}),m.setupGameHeading(document.querySelector("#game-heading h1")),In(t),wn(t)},{transition:e}))}function vn(){for(let s of Ze){let e=m.metadata.terms[s];document.querySelectorAll(".term-"+s).forEach(t=>{t.textContent=e})}}function wn(s={}){y&&(y.removeListeners(),y.node.remove());let e=l.createElement("div.item-selector");document.getElementById("dataset-filter-settings").append(e),y=m.getItemSelector(e),s.items&&y.setActive(s.items),y.setActiveForms(ot(),{transition:!1,scale:!1}),m.hasVariantSetting()&&y.setItemIndices(m.getVariantItemIndices(k.getValue("variant")),{transition:!1}),y.updateListeners.push(nt,se),nt()}function In(s){k.replaceSelf(m.getFilterSettings(s)),O.replaceSelf(m.getGameSettings(s)),k.addUpdateListener(se),O.addUpdateListener(se),m.hasFormsSetting()&&k.getSetting("forms").updateListeners.push(e=>y.setActiveForms(m.getFormsFromSettingsValue(e))),m.hasVariantSetting()&&k.getSetting("variant").updateListeners.push(e=>y.setItemIndices(m.getVariantItemIndices(e))),document.getElementById("dataset-filter-settings").replaceChildren(...k.nodeList()),document.getElementById("dataset-game-settings").replaceChildren(...O.nodeList())}function ot(){return m.hasFormsSetting()?m.getFormsFromSettingsValue(k.getValue("forms")):m.formsData.keys}function at(){return m.hasPropsSetting()?O.getValue("properties"):Object.keys(m.propsData)}function nt(){l.setAttrs(document.querySelector(".pages-next-button"),{disabled:y.activeQuizItemCount()===0})}function lt(s){v&&v.cleanup(),se();let e=at(),t=m.hasLanguageSetting()?O.getValue("language"):null,n=m.getQuizItems(y.activeIndices(),ot(),e,t),r=m.getReferenceItems(e,t);v=new G(m,n,e,t);let i=xe.getValue("seed");return i&&v.seed(i),v.setReferenceItems(r),v.onFinish.push(()=>{Ee(!1)}),v.setup().then(()=>l.updateDOM(()=>Ee(!0,{transition:!1}),{transition:s})).then(()=>{v.newRound(),v.focus()}).catch(o=>console.error(o))}function st(s=!0){let e=new URLSearchParams(location.search),t=e.get("dataset");(!t||!(t in P))&&(t=Xe),document.getElementById("datasetSelect").value=t,W.fetch(t).then(n=>it(n,{transition:!1})).then(()=>["1","true"].includes(e.get("play"))?lt(s):Ee(!1,{transition:s}))}function ct(s=null){return"settings_"+(s||m.key)}function se(){l.setSearchParams({dataset:m.key});let s={items:U.encodeBase64BoolArray(y.itemsActive)};m.hasPropsSetting()&&(s.properties=at("properties")),m.hasLanguageSetting()&&(s.language=O.getValue("language")),m.hasFormsSetting()&&(s.forms=k.getValue("forms")),window.localStorage.setItem(ct(),JSON.stringify(s))}function xn(){let s=window.localStorage.getItem(ct());if(!s)return{};try{let e=JSON.parse(s);return typeof e.items=="string"&&(e.items=U.decodeBase64BoolArray(e.items)),e}catch(e){return console.error(e),{}}}(function(){En(),rt(),document.querySelectorAll(".ribbon").forEach(s=>{An(s,s.classList.contains("ribbon-closable"))}),document.querySelectorAll(".pages-container").forEach(s=>{l.setupPages(s)})})();function En(){let s=new URLSearchParams(location.search);["1","true"].includes(s.get("darkmode"))?document.documentElement.classList.add("dark-mode"):["1","true"].includes(s.get("lightmode"))&&document.documentElement.classList.add("light-mode")}function An(s,e=!1){let t=s.querySelector(".ribbon-contents"),n=s.querySelectorAll(".ribbon-buttons input[type=checkbox]");s.dataset.closable=e.toString();let r=s.dataset.openId;if(!r){for(let i of n)if(i.checked){r=i.dataset.contentId;break}}l.hide(t.querySelectorAll(".ribbon-content")),!r&&!e&&(r=n[0].dataset.contentId,n[0].checked=!0),r?l.show([document.getElementById(r),t]):e&&s.classList.add("contents-hidden"),s.querySelector(".ribbon-buttons").addEventListener("change",Ln)}function Ln(s){l.updateDOM(()=>{let e=s.target,t=e.closest(".ribbon"),n=t.querySelector(".ribbon-contents");if(e.checked){let r=t.dataset.openId;!t.classList.contains("contents-hidden")&&r&&(l.hide(document.getElementById(r)),t.querySelector(`.ribbon-buttons input[data-content-id="${r}"]`).checked=!1),t.dataset.openId=e.dataset.contentId,l.show([document.getElementById(e.dataset.contentId),n]),t.classList.remove("contents-hidden")}else t.dataset.closable==="true"?(t.classList.add("contents-hidden"),l.hide(n),t.dataset.openId=""):e.checked=!0},{transition:!0})}})();
//# sourceMappingURL=index.js.map
